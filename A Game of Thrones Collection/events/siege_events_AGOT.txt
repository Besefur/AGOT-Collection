namespace = siege_agot

#Originally by waylit
#Extended and adjusted for AGOT

#on_siege_won_leader events
#siege_agot.1
#siege_agot.2
#siege_agot.3
#siege_agot.4


#Siege Maintenance
character_event = {
	id = siege_agot.1
	desc = "EVTDESCsiegeprestige"
	picture = "GFX_evt_siege"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		FROM = {
			holder_scope = {
				NOT = { culture_group = unoccupied_group }
			}
			NOT = { holding_type = nomad }
		}
	}

	immediate = {
		FROM = { #Destroy Colony
			if = {
				limit = { is_capital = yes }
				location = {
					if = {
						limit = {
							has_province_flag = colony_province
							owner = {
								NOT = { culture_group = unoccupied_group }
								any_demesne_title = { title = ROOT_FROM }
							}
						}
						random = {
							chance = 25
							province_event = { id = unoccupied.7 days = 1 }
						}
					}
				}
			}
			holder_scope = { #Destroy Infrastructure
				if = {
					limit = { #Owns province
						OR = {
							character = ROOT
							same_realm = ROOT
							ROOT = {
								is_ruler = yes
								is_allied_with = PREV
							}
							ROOT = {
								is_ruler = no
								liege = { is_allied_with = PREVPREV }
							}
						}
					}
					random = {
						chance = 30
						character_event = { id = siege_agot.9 }
					}
				}
				if = {
					limit = { #Does not own province
						NOR = {
							character = ROOT
							same_realm = ROOT
							ROOT = {
								is_ruler = yes
								is_allied_with = PREV
							}
							ROOT = {
								is_ruler = no
								liege = { is_allied_with = PREVPREV }
							}
						}
					}
					character_event = { id = siege_agot.9 }
					if = {
						limit = { #Destroy flagship
							any_artifact = { has_artifact_flag = flagship }
							NAND = {
								in_command = yes
								NOT = { at_location = ROOT }
							}
							NAND = {
								trait = wikid
								OR = {
									has_character_flag = wikid_take_flagship
									has_character_flag = wikid_flag_ship_taken
								}
							}
							NAND = {
								trait = on_reaving
								has_character_flag = flagship_on_reaving
							}
						}
						random = {
							chance = 50
							character_event = { id = ironborn_events.89 }
						}
					}
					if = {
						limit = { #Burn them all?
							trait = lunatic
							society_member_of = alchemists_guild
							is_incapable = no
							NOT = { trait = kind }
							NOT = { trait = honorable }
							at_location = ROOT
							ROOT_FROM = {
								location = {
									owner = { character = PREVPREVPREV }
									has_province_modifier = alchemist_guild
									OR = { #Must have large stockpile
										has_province_modifier = wildfire_4
										has_province_modifier = wildfire_5
									}
									NOT = { has_province_modifier = wildfire_outbreak }
								}
							}
						}
						location = { save_event_target_as = siege_location }
						character_event = { id = wildfire.180 }
					}
				}
			}
			if = {
				limit = { #Nickname
					ROOT = {
						has_nickname = no
					}
					is_capital = yes
					location = {
						is_capital = yes
						NOT = { has_province_flag = prohibited_nickname_location }
					}
					holder_scope = {
						NOT = { character = ROOT }
						NOT = { is_vassal_or_below = ROOT }
					}
					OR = { #only important locations
						holder_scope = { higher_tier_than = DUKE }
						location = { num_of_max_settlements = 5 }
						AND = {
							ROOT = { is_ruler = no }
							location = { num_of_settlements = 3 }
						}
					}
				}
				ROOT = {
					random_list = {
						2000 = {
							modifier = {
								factor = 2
								higher_tier_than = DUKE #less likely for high rank characters
							}
						}
						5 = { give_nickname = nick_of_the_scourge_of_location }
						5 = { give_nickname = nick_of_the_bane_of_location }
						5 = { give_nickname = nick_of_the_butcher_of_location }
						5 = { give_nickname = nick_of_the_burner_of_location }
						5 = { give_nickname = nick_of_the_breaker_of_location }
						5 = { give_nickname = nick_of_the_hammer_of_location }
						5 = { give_nickname = nick_of_the_fist_of_location }
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTAsiegewinprestige"
		ai_chance = {
			factor = 1
		}
		FROM = {
			tooltip = { show_portrait = yes }
		}
	}

	# option = {
		# name = "EVTOPTAsiegewinbanner"
		# trigger = {
			# FROM = { holder_scope = { war_with = ROOT } }
		# }

		# ai_chance = {
			# factor = 0.2
			# modifier = {
				# factor = 10
				# trait = wroth
			# }
			# modifier = {
				# factor = 10
				# trait = envious
			# }
			# modifier = {
				# factor = 20
				# trait = proud
			# }
			# modifier = {
				# factor = 0.1
				# trait = humble
			# }
		# }

		# prestige = 5

		# FROM = {
			# holder_scope = {
				# prestige = -5
				# opinion = {
					# modifier = stolen_banner
					# who = ROOT
					# months = 12
				# }
			# }
		# }
	# }
}

#Attacker gets imprisonment options
character_event = {
	id = siege_agot.299

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		NOT = { any_liege = { has_landed_title = e_rebels } }
		NOT = { culture_group = winter_group }
		FROM = {
			NOT = { holding_type = nomad }
			holder_scope = {
				NOT = { culture_group = unoccupied_group }
				NOT = { culture_group = winter_group }
				capital_holding = { #Only captured at capital holding (or secondary holdings if that is occupied)
					OR = {
						title = ROOT_FROM
						controller = {
							NOT = { character = PREVPREV }
						}
					}
				}
				OR = { #Conditions fo capture...
					#High Rank
					higher_tier_than = DUKE
					#Enemies in war
					AND = {
						OR = {
							is_primary_war_defender = yes
							is_primary_war_attacker = yes
						}
						ROOT = {
							OR = {
								war_with = PREV
								any_liege = { war_with = PREVPREV }
							}
						}
					}
					any_current_enemy = {
						OR = {
							character = ROOT
							is_vassal_or_below = ROOT
						}
					}
					liege_before_war = {
						war_with = PREV
						OR = {
							character = ROOT
							is_vassal_or_below = ROOT
						}
					}
					# #Military commanders
					# AND = {
						# is_military_command_trigger = yes
						# tier = BARON
					# }
					#Vengeance/feud
					reverse_has_opinion_modifier = { who = ROOT modifier = opinion_vengeance }
					reverse_has_opinion_modifier = { who = ROOT modifier = opinion_blood_feud }
					#War enemy is at court.location
					any_courtier = {
						OR = {
							is_primary_war_defender = yes
							is_primary_war_attacker = yes
						}
						ROOT = {
							OR = {
								war_with = PREV
								any_liege = { war_with = PREVPREV }
							}
						}
					}
					AND = {
						ROOT_FROM = { is_capital = yes }
						any_liege = {
							NOT = { in_command = yes }
							at_location = ROOT
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
								liege_before_war = {
									war_with = PREV
									OR = {
										character = ROOT
										is_vassal_or_below = ROOT
									}
								}
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
					}
				}
			}
		}
	}

	immediate = {
		FROM = {
			holder_scope = {
				save_event_target_as = siege_location_owner
				if = {
					limit = {
						at_location = ROOT
						NOT = { is_inaccessible_trigger = yes }
						prisoner = no
					}
					set_character_flag = at_siege_location
				}
			}
		}
		if = {
			limit = { is_ruler = yes }
			character_event = { id = siege_agot.2 }
		}
		else = {
			liege = { character_event = { id = siege_agot.2 } }
		}
	}
}
character_event = {
	id = siege_agot.2
	picture = "GFX_evt_siege"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	desc = {
		text = "EVTDESCsiege_agot.2A" #Leading siege, enemy is at location
		trigger = {
			character = FROM
			event_target:siege_location_owner = { has_character_flag = at_siege_location }
		}
	}
	desc = {
		text = "EVTDESCsiege_agot.2B" #Leading siege, enemy is NOT at location
		trigger = {
			character = FROM
			event_target:siege_location_owner = { NOT = { has_character_flag = at_siege_location } }
		}
	}
	desc = {
		text = "EVTDESCsiege_agot.2C" #NOT Leading siege, enemy is at location
		trigger = {
			NOT = { character = FROM }
			event_target:siege_location_owner = { has_character_flag = at_siege_location }
		}
	}
	desc = {
		text = "EVTDESCsiege_agot.2D" #NOT Leading siege, enemy is NOT at location
		trigger = {
			NOT = { character = FROM }
			event_target:siege_location_owner = { NOT = { has_character_flag = at_siege_location } }
		}
	}
	immediate = {
		if = {
			limit = {
				liege = {
					event_target:siege_location_owner = {
						OR = {
							war_with = ROOT
							war_with = PREV
						}
						any_courtier = {
							OR = {
								AND = {
									dynasty = PREV
									is_lowborn = no
								}
								is_close_relative = PREV
								is_married = PREV
								AND = {
									OR = {
										is_primary_war_defender = yes
										is_primary_war_attacker = yes
									}
									ROOT = {
										OR = {
											war_with = PREV
											any_liege = { war_with = PREVPREV }
										}
									}
								}
								AND = { #Commanders
									is_military_command_trigger = yes
									tier = BARON
								}
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_vengeance }
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_blood_feud }
							}
							NOT = { in_command = yes }
							NOT = { character = ROOT }
							NOT = { character = PREV }
							at_location = FROM
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
							NOT = { is_child_of = ROOT }
							NOT = { father = { is_child_of = ROOT } }
							NOT = { mother = { is_child_of = ROOT } }
							NOT_mythical_creature_trigger = yes
						}
					}
				}
			}
			set_character_flag = prisoners_available
		}
	}

	option = {
		name = "EVTOPTAsiege_agot.2" #Imprison only leader
		trigger = {
			liege = {
				event_target:siege_location_owner = {
					has_character_flag = at_siege_location
					OR = {
						war_with = ROOT
						war_with = PREV
					}
				}
			}
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 0.2
				has_character_flag = prisoners_available
				OR = {
					trait = slave_trader
					event_target:siege_location_owner = {
						AND = {
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
					}
				}
			}
		}
		event_target:siege_location_owner = {
			#Always imprison direct war enemies
			any_courtier = {
				limit = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
					ROOT = {
						OR = {
							war_with = PREV
							any_liege = { war_with = PREVPREV }
						}
					}
					NOT = { in_command = yes }
					NOT = { character = ROOT }
					NOT = { character = PREV }
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT_mythical_creature_trigger = yes
				}
				set_character_flag = captured_in_battle
				set_character_flag = asked_for_better_prison
				imprison = ROOT
				hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
			}
			any_liege = {
				limit = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
					ROOT = {
						OR = {
							war_with = PREV
							any_liege = { war_with = PREVPREV }
						}
					}
					NOT = { in_command = yes }
					NOT = { character = ROOT }
					NOT = { character = PREV }
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT_mythical_creature_trigger = yes
				}
				guardian = {
					if = {
						limit = {
							NOT = { in_command = yes }
							at_location = FROM
							NOT = { character = ROOT }
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
						}
						set_character_flag = captured_in_battle
						set_character_flag = asked_for_better_prison
						imprison = ROOT
						hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
					}
				}
				set_character_flag = captured_in_battle
				set_character_flag = asked_for_better_prison
				imprison = ROOT
				hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
			}

			###
			set_character_flag = captured_in_battle
			set_character_flag = asked_for_better_prison
			imprison = ROOT
			hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
		}
	}

	option = { #Imprison everyone in dungeon
		name = {
			text = "EVTOPTBsiege_agot.2"
			trigger = {
				character = FROM
				event_target:siege_location_owner = { has_character_flag = at_siege_location }
			}
		}
		name = {
			text = "EVTOPTBsiege_agot.2B"
			trigger = {
				character = FROM
				NOT = { event_target:siege_location_owner = { has_character_flag = at_siege_location } }
			}
		}
		name = {
			text = "EVTOPTBsiege_agot.2C"
			trigger = {
				NOT = { character = FROM }
			}
		}
		trigger = {
			has_character_flag = prisoners_available
			liege = {
				event_target:siege_location_owner = {
					OR = {
						war_with = ROOT
						war_with = PREV
					}
				}
			}
		}

		ai_chance = {
			factor = 10

			modifier = {
				factor = 0
				trait = kind
			}
			modifier = {
				factor = 3
				trait = impaler
			}
			modifier = {
				factor = 3
				trait = cruel
			}
			modifier = {
				factor = 3
				trait = ruthless
			}
		}
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
				NOT = { trait = greedy }
				NOT = { trait = charitable }
			}
			random = {
				chance = 10
				add_trait = greedy
				hidden_tooltip = {
					character_event = {
						id = 38252 #Notify
					}
				}
			}
		}
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
				NOT = { trait = cruel }
			}
			random = {
				chance = 10
				if = {
					limit = { NOT = { trait = kind } }
					add_trait = cruel
					hidden_tooltip = {
						character_event = {
							id = 38259 #Notify
						}
					}
				}
				if = {
					limit = { trait = kind }
					remove_trait = kind
					hidden_tooltip = {
						character_event = {
							id = 38307 #Notify
						}
					}
				}
			}
		}
		event_target:siege_location_owner = {
			any_courtier = {
				limit = {
					OR = {
						is_close_relative = PREV
						AND = {
							dynasty = PREV
							is_lowborn = no
						}
					}
					NOT = { character = ROOT }
					NOT = { is_liege_or_above = ROOT }
					has_guardian = yes
					NOT_mythical_creature_trigger = yes
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					guardian = {
						in_command = no
						at_location = FROM
						NOT = { character = ROOT }
						NOT = { is_inaccessible_trigger = yes }
						prisoner = no
					}
				}
				guardian = {
					set_character_flag = captured_in_battle
					set_character_flag = asked_for_better_prison
					imprison = ROOT
					hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
				}
			}
			any_courtier = {
				limit = {
					OR = {
						AND = {
							dynasty = PREV
							is_lowborn = no
						}
						is_close_relative = PREV
						is_married = PREV
						AND = {
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
						AND = { #Commanders
							is_military_command_trigger = yes
							tier = BARON
						}
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_vengeance }
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_blood_feud }
					}
					NOT = { in_command = yes }
					NOT_mythical_creature_trigger = yes
					NOT = { character = ROOT }
					NOT = { character = PREV }
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT = { is_child_of = ROOT }
					NOT = { father = { is_child_of = ROOT } }
					NOT = { mother = { is_child_of = ROOT } }
				}
				set_character_flag = captured_in_battle
				set_character_flag = asked_for_better_prison
				imprison = ROOT
				hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
			}
			if = {
				limit = {
					ROOT = { is_drowned_god_religion_trigger = yes }
					NOT = { is_drowned_god_religion_trigger = yes }
				}
				random_courtier = {
					limit = {
						is_female = yes
						age = 16
						NOT = { in_command = yes }
						NOT = { character = ROOT }
						NOT = { is_liege_or_above = ROOT }
						NOT = { dynasty = ROOT }
						at_location = FROM
						NOT = { is_inaccessible_trigger = yes }
						prisoner = no
						NOT = { is_child_of = ROOT }
						NOT = { father = { is_child_of = ROOT } }
						NOT = { mother = { is_child_of = ROOT } }
						NOT_mythical_creature_trigger = yes
					}
					set_character_flag = captured_in_battle
					set_character_flag = asked_for_better_prison
					imprison = ROOT
					hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
				}
			}
			if = {
				limit = { has_character_flag = at_siege_location }
				set_character_flag = captured_in_battle
				set_character_flag = asked_for_better_prison
				imprison = ROOT
				hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
			}
			#Always imprison direct war enemies
			any_liege = {
				limit = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
					ROOT = {
						OR = {
							war_with = PREV
							any_liege = { war_with = PREVPREV }
						}
					}
					NOT = { in_command = yes }
					NOT = { character = ROOT }
					NOT = { character = PREV }
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT_mythical_creature_trigger = yes
				}
				guardian = {
					if = {
						limit = {
							NOT = { in_command = yes }
							at_location = FROM
							NOT = { character = ROOT }
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
						}
						set_character_flag = captured_in_battle
						set_character_flag = asked_for_better_prison
						imprison = ROOT
						hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
					}
				}
				set_character_flag = captured_in_battle
				set_character_flag = asked_for_better_prison
				imprison = ROOT
				hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
			}
		}
		piety = -30
	}

	option = { #Imprison everyone in house arrest
		name = {
			text = "EVTOPTCsiege_agot.2A"
			trigger = {
				character = FROM
				event_target:siege_location_owner = { has_character_flag = at_siege_location }
			}
		}
		name = {
			text = "EVTOPTCsiege_agot.2B"
			trigger = {
				character = FROM
				NOT = { event_target:siege_location_owner = { has_character_flag = at_siege_location } }
			}
		}
		name = {
			text = "EVTOPTCsiege_agot.2C"
			trigger = {
				NOT = { character = FROM }
			}
		}
		trigger = {
			has_character_flag = prisoners_available
			liege = {
				event_target:siege_location_owner = {
					OR = {
						war_with = ROOT
						war_with = PREV
					}
				}
			}
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 3
				trait = honorable
			}
			modifier = {
				factor = 3
				trait = just
			}
		}
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
				NOT = { trait = greedy }
				NOT = { trait = charitable }
			}
			random = {
				chance = 10
				add_trait = greedy
				hidden_tooltip = {
					character_event = {
						id = 38252 #Notify
					}
				}
			}
		}
		event_target:siege_location_owner = {
			any_courtier = {
				limit = {
					OR = {
						is_close_relative = PREV
						AND = {
							dynasty = PREV
							is_lowborn = no
						}
					}
					NOT = { character = ROOT }
					NOT = { is_liege_or_above = ROOT }
					has_guardian = yes
					NOT_mythical_creature_trigger = yes
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					guardian = {
						in_command = no
						at_location = FROM
						NOT = { character = ROOT }
						NOT = { is_inaccessible_trigger = yes }
						prisoner = no
					}
				}
				guardian = {
					set_character_flag = captured_in_battle
					imprison = ROOT
					hidden_tooltip = {
						remove_character_modifier = the_dungeon
						add_character_modifier = { name = house_arrest duration = -1 }
						if = {
							limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_merciful } } }
							opinion = { who = ROOT modifier = opinion_merciful months = 24 }
						}
						character_event = { id = siege_agot.6 } #Inform
					}
				}
			}
			any_courtier = {
				limit = {
					OR = {
						AND = {
							dynasty = PREV
							is_lowborn = no
						}
						is_close_relative = PREV
						is_married = PREV
						AND = {
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
						AND = { #Commanders
							is_military_command_trigger = yes
							tier = BARON
						}
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_vengeance }
						reverse_has_opinion_modifier = { who = ROOT modifier = opinion_blood_feud }
					}
					NOT = { in_command = yes }
					NOT_mythical_creature_trigger = yes
					NOT = { character = ROOT }
					NOT = { character = PREV }
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT = { is_child_of = ROOT }
					NOT = { father = { is_child_of = ROOT } }
					NOT = { mother = { is_child_of = ROOT } }
				}
				set_character_flag = captured_in_battle
				imprison = ROOT
				hidden_tooltip = {
					remove_character_modifier = the_dungeon
					add_character_modifier = { name = house_arrest duration = -1 }
					if = {
						limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_merciful } } }
						opinion = { who = ROOT modifier = opinion_merciful months = 24 }
					}
					character_event = { id = siege_agot.6 } #Inform
				}
			}
			if = {
				limit = {
					ROOT = { is_drowned_god_religion_trigger = yes }
					NOT = { is_drowned_god_religion_trigger = yes }
				}
				random_courtier = {
					limit = {
						is_female = yes
						age = 16
						NOT = { in_command = yes }
						NOT = { character = ROOT }
						NOT = { is_liege_or_above = ROOT }
						NOT = { dynasty = ROOT }
						at_location = FROM
						NOT = { is_inaccessible_trigger = yes }
						prisoner = no
						NOT = { is_child_of = ROOT }
						NOT = { father = { is_child_of = ROOT } }
						NOT = { mother = { is_child_of = ROOT } }
						NOT_mythical_creature_trigger = yes
					}
					set_character_flag = captured_in_battle
					imprison = ROOT
					hidden_tooltip = {
						remove_character_modifier = the_dungeon
						add_character_modifier = { name = house_arrest duration = -1 }
						if = {
							limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_merciful } } }
							opinion = { who = ROOT modifier = opinion_merciful months = 24 }
						}
						character_event = { id = siege_agot.6 } #Inform
					}
				}
			}
			if = {
				limit = { has_character_flag = at_siege_location }
				set_character_flag = captured_in_battle
				imprison = ROOT
				hidden_tooltip = {
					remove_character_modifier = the_dungeon
					add_character_modifier = { name = house_arrest duration = -1 }
					if = {
						limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_merciful } } }
						opinion = { who = ROOT modifier = opinion_merciful months = 24 }
					}
					character_event = { id = siege_agot.6 } #Inform
				}
			}
			#Always imprison direct war enemies
			any_liege = {
				limit = {
					OR = {
						is_primary_war_defender = yes
						is_primary_war_attacker = yes
					}
					ROOT = {
						OR = {
							war_with = PREV
							any_liege = { war_with = PREVPREV }
						}
					}
					NOT = { in_command = yes }
					NOT = { character = ROOT }
					NOT = { character = PREV }
					at_location = FROM
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
					NOT_mythical_creature_trigger = yes
				}
				guardian = {
					if = {
						limit = {
							NOT = { in_command = yes }
							at_location = FROM
							NOT = { character = ROOT }
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
						}
						set_character_flag = captured_in_battle
						imprison = ROOT
						hidden_tooltip = { character_event = { id = siege_agot.6 } } #Inform
					}
				}
				set_character_flag = captured_in_battle
				imprison = ROOT
				hidden_tooltip = {
					remove_character_modifier = the_dungeon
					add_character_modifier = { name = house_arrest duration = -1 }
					if = {
						limit = { NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_merciful } } }
						opinion = { who = ROOT modifier = opinion_merciful months = 24 }
					}
					character_event = { id = siege_agot.6 } #Inform
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPsiege_agot.2HOUSEARREST
		}
	}

	option = { #Leave everyone be
		name = {
			text = "EVTOPTDsiege_agot.2"
			trigger = {
				character = FROM
				event_target:siege_location_owner = { has_character_flag = at_siege_location }
			}
		}
		name = {
			text = "EVTOPTDsiege_agot.2B"
			trigger = {
				character = FROM
				NOT = { event_target:siege_location_owner = { has_character_flag = at_siege_location } }
			}
		}
		name = {
			text = "EVTOPTDsiege_agot.2C"
			trigger = {
				NOT = { character = FROM }
			}
		}
		trigger = {
			OR = {
				has_character_flag = prisoners_available
				event_target:siege_location_owner = { has_character_flag = at_siege_location }
			}
			liege = {
				event_target:siege_location_owner = {
					OR = {
						war_with = ROOT
						war_with = PREV
					}
				}
			}
		}
		ai_chance = {
			factor = 10
			modifier = {
				factor = 0.5
				event_target:siege_location_owner = { tier = DUKE }
			}
			modifier = {
				factor = 0.33
				event_target:siege_location_owner = { higher_tier_than = DUKE }
			}
			modifier = { #always imprison war enemies
				factor = 0
				event_target:siege_location_owner = {
					OR = {
						AND = {
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
						any_courtier = {
							NOT = { character = PREV }
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							at_location = FROM
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
						any_liege = {
							NOT = { character = PREV }
							NOT = { in_command = yes }
							at_location = FROM
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
						}
					}
				}
			}
			modifier = {
				factor = 5
				NOT = { any_current_enemy = { character = event_target:siege_location_owner } }
			}
			modifier = {
				factor = 0.2
				trait = slave_trader
			}

			modifier = {
				factor = 4
				OR = {
					is_close_relative = event_target:siege_location_owner
					is_friend = event_target:siege_location_owner
				}
			}
			modifier = {
				factor = 0.25
				OR = {
					is_foe = event_target:siege_location_owner
					is_rival = event_target:siege_location_owner
					has_opinion_modifier = { who = event_target:siege_location_owner modifier = opinion_vengeance }
					has_opinion_modifier = { who = event_target:siege_location_owner modifier = opinion_blood_feud }
				}
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:siege_location_owner value = 20 }
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:siege_location_owner value = 40 }
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:siege_location_owner value = 60 }
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:siege_location_owner value = 80 }
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:siege_location_owner value = 100 }
			}
			modifier = {
				factor = 0.66
				NOT = { opinion = { who = event_target:siege_location_owner value = -19 } }
			}
			modifier = {
				factor = 0.66
				NOT = { opinion = { who = event_target:siege_location_owner value = -39 } }
			}
			modifier = {
				factor = 0.66
				NOT = { opinion = { who = event_target:siege_location_owner value = -59 } }
			}
			modifier = {
				factor = 0.66
				NOT = { opinion = { who = event_target:siege_location_owner value = -79 } }
			}
			modifier = {
				factor = 0.66
				NOT = { opinion = { who = event_target:siege_location_owner value = -99 } }
			}

			modifier = {
				factor = 0.33
				trait = impaler
			}
			modifier = {
				factor = 0.33
				trait = cruel
			}
			modifier = {
				factor = 0.33
				trait = ruthless
			}
			modifier = {
				factor = 0.25
				trait = greedy
			}

			modifier = {
				factor = 4
				trait = kind
			}
			modifier = {
				factor = 4
				trait = charitable
			}
			modifier = {
				factor = 4
				trait = humble
			}
			modifier = {
				factor = 0.5
				trait = proud
			}
			modifier = {
				factor = 0.5
				trait = wroth
			}
		}
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
				NOT = { trait = kind }
			}
			random = {
				chance = 10
				if = {
					limit = { NOT = { trait = cruel } }
					add_trait = kind
					hidden_tooltip = {
						character_event = {
							id = 38268 #Notify
						}
					}
				}
				if = {
					limit = { trait = cruel }
					remove_trait = cruel
					hidden_tooltip = {
						character_event = {
							id = trait_notification.1 #Notify
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPsiege_agot.2LEAVEBE
			hidden_tooltip = {
				event_target:siege_location_owner = {
					any_courtier = {
						limit = {
							OR = {
								is_close_relative = PREV
								AND = {
									dynasty = PREV
									is_lowborn = no
								}
							}
							NOT = { character = ROOT }
							NOT = { is_liege_or_above = ROOT }
							has_guardian = yes
							NOT_mythical_creature_trigger = yes
							at_location = FROM
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
							guardian = {
								in_command = no
								at_location = FROM
								NOT = { character = ROOT }
								NOT = { is_inaccessible_trigger = yes }
								prisoner = no
							}
						}
						guardian = {
							opinion = { who = ROOT modifier = opinion_relieved months = 12 }
						}
					}
					any_courtier = {
						limit = {
							OR = {
								AND = {
									dynasty = PREV
									is_lowborn = no
								}
								is_close_relative = PREV
								is_married = PREV
								AND = {
									OR = {
										is_primary_war_defender = yes
										is_primary_war_attacker = yes
									}
									ROOT = {
										OR = {
											war_with = PREV
											any_liege = { war_with = PREVPREV }
										}
									}
								}
								AND = { #Commanders
									is_military_command_trigger = yes
									tier = BARON
								}
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_vengeance }
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_blood_feud }
							}
							NOT = { in_command = yes }
							NOT_mythical_creature_trigger = yes
							NOT = { character = ROOT }
							NOT = { character = PREV }
							at_location = FROM
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
							NOT = { is_child_of = ROOT }
							NOT = { father = { is_child_of = ROOT } }
							NOT = { mother = { is_child_of = ROOT } }
						}
						opinion = { who = ROOT modifier = opinion_relieved months = 12 }
					}
					if = {
						limit = {
							ROOT = { is_drowned_god_religion_trigger = yes }
							NOT = { is_drowned_god_religion_trigger = yes }
						}
						random_courtier = {
							limit = {
								is_female = yes
								age = 16
								NOT = { in_command = yes }
								NOT = { character = ROOT }
								NOT = { is_liege_or_above = ROOT }
								NOT = { dynasty = ROOT }
								at_location = FROM
								NOT = { is_inaccessible_trigger = yes }
								prisoner = no
								NOT = { is_child_of = ROOT }
								NOT = { father = { is_child_of = ROOT } }
								NOT = { mother = { is_child_of = ROOT } }
								NOT_mythical_creature_trigger = yes
							}
							opinion = { who = ROOT modifier = opinion_relieved months = 12 }
						}
					}
					if = {
						limit = { has_character_flag = at_siege_location }
						opinion = { who = ROOT modifier = opinion_relieved months = 12 }
					}
					#Always imprison direct war enemies
					any_liege = {
						limit = {
							OR = {
								is_primary_war_defender = yes
								is_primary_war_attacker = yes
							}
							ROOT = {
								OR = {
									war_with = PREV
									any_liege = { war_with = PREVPREV }
								}
							}
							NOT = { in_command = yes }
							NOT = { character = ROOT }
							NOT = { character = PREV }
							at_location = FROM
							NOT = { is_inaccessible_trigger = yes }
							prisoner = no
							NOT_mythical_creature_trigger = yes
						}
						guardian = {
							if = {
								limit = {
									NOT = { in_command = yes }
									at_location = FROM
									NOT = { character = ROOT }
									NOT = { is_inaccessible_trigger = yes }
									prisoner = no
								}
								opinion = { who = ROOT modifier = opinion_relieved months = 12 }
							}
						}
						opinion = { who = ROOT modifier = opinion_relieved months = 12 }
					}
				}
			}
		}
	}

	option = {  #No prisoners are available
		name = "EVTOPTEsiege_agot.2"
		trigger = {
			NOR = {
				has_character_flag = prisoners_available
				event_target:siege_location_owner = { has_character_flag = at_siege_location }
			}
			liege = {
				event_target:siege_location_owner = {
					OR = {
						war_with = ROOT
						war_with = PREV
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTFsiege_agot.2"#This is a relief/friendly siege
		trigger = {
			NOT = {
				liege = {
					event_target:siege_location_owner = {
						OR = {
							war_with = ROOT
							war_with = PREV
						}
					}
				}
			}
		}
		event_target:siege_location_owner = {
			any_courtier = {
				if = {
					limit = {
						NOT = { character = ROOT }
						at_location = FROM
						NOT = { war_with = ROOT }
					}
					opinion = {
						who = ROOT
						modifier = liberated
						months = 12
					}
				}
				hidden_tooltip = {
					if = {
						limit = {
							at_location = FROM
							NOT = { war_with = ROOT }
							trait = in_hiding
						}
						remove_trait = in_hiding
					}
				}
			}
		}
	}

	after = {
		clr_character_flag = prisoners_available
		event_target:siege_location_owner = { clr_character_flag = at_siege_location }
	}
}

#if dungeons have anybody worth freeing, there are options for that on siege win
character_event = {
	id = siege_agot.4
	desc = "EVTDESCWAYsearchdungeons"
	picture = "GFX_evt_siege"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	trigger = {
		NOT = { culture_group = winter_group }
		FROM = {
			NOT = { holding_type = nomad }
			holder_scope = {
				NOT = { culture_group = unoccupied_group }
				NOT = { culture_group = winter_group }
				NOT = { character = ROOT }
				NOT = { is_liege_or_above = ROOT }
				NOT = { is_vassal_or_below = ROOT }
				OR = {
					AND = {
						war_with = ROOT
						any_courtier = {
							prisoner = yes
							at_location = ROOT
							host = { character = PREVPREV }
						}
					}
					any_courtier = { #Rescue slaves/concubines
						OR = {
							trait = slave
							trait = salt_wife
							is_consort = yes
						}
						OR = {
							dynasty = ROOT
							is_close_relative = ROOT
							is_friend = ROOT
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_my_abducted_spouse }
						}
						liege = { character = PREVPREV }
						at_location = ROOT
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPWAYprisonrelease01"
		ai_chance = {
			factor = 5
			modifier = {
				factor = 2
				trait = kind
			}
			modifier = {
				factor = 2
				trait = trusting
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = arbitrary
			}
			modifier = {
				factor = 0.5
				trait = cruel
			}
			modifier = {
				factor = 0.5
				trait = wroth
			}
			modifier = {
				factor = 0.5
				trait = cynical
			}
			modifier = {
				factor = 0.5
				trait = paranoid
			}
			modifier = {
				factor = 0.5
				trait = just
			}
		}
		FROM = {
			holder_scope = {
				any_courtier = {
					limit = {
						prisoner = yes
						at_location = ROOT
						host = { character = PREVPREV }
					}
					prisoner = no
					opinion = {
						modifier = rescued_my_sorry_ass
						who = ROOT
					}
					clr_character_flag = captured_in_battle
					clr_character_flag = kidnapped_by_plot
					clr_character_flag = lost_trial_by_combat
					hidden_tooltip = { character_event = { id = siege_agot.7 } } #Inform
				}
				any_courtier = { #Rescue slaves/concubines
					limit = {
						OR = {
							trait = slave
							trait = salt_wife
							is_consort = yes
						}
						OR = {
							dynasty = ROOT
							is_close_relative = ROOT
							is_friend = ROOT
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_my_abducted_spouse }
						}
						liege = { character = PREVPREV }
						at_location = ROOT
						NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_my_owner } }
						NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_salt_wife } }
						NOT = { consort = { character = ROOT } }
					}
					if = {
						limit = {
							trait = slave
						}
						character_event = { id = slavery.0 tooltip = EVTTOOLTIPSLAVERY0 }
					}
					if = {
						limit = {
							trait = salt_wife
						}
						remove_trait = salt_wife
						clr_character_flag = no_court_invites
					}
					if = {
						limit = {
							is_consort = yes
						}
						any_spouse = { remove_spouse = PREV }
						consort = { remove_consort = PREV }
					}
					move_character = ROOT
					opinion = {
						modifier = rescued_my_sorry_ass
						who = ROOT
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPWAYprisonrelease02"
		trigger = {
			FROM = {
				holder_scope = {
					AND = {
						war_with = ROOT
						any_courtier = {
							prisoner = yes
							at_location = ROOT
							host = { character = PREVPREV }
							OR = {
								war_with = PREV
								any_liege = { war_with = PREVPREV }
								is_liege_or_above = ROOT
							}
						}
					}
				}
			}
		}
		ai_chance = {
			factor = 20
			modifier = {
				factor = 2
				trait = kind
			}
			modifier = {
				factor = 2
				trait = trusting
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 2
				trait = deceitful
			}
			modifier = {
				factor = 0.5
				trait = cruel
			}
			modifier = {
				factor = 0.5
				trait = wroth
			}
			modifier = {
				factor = 0.5
				trait = cynical
			}
			modifier = {
				factor = 0.5
				trait = paranoid
			}
			modifier = {
				factor = 0.5
				trait = honorable
			}
			modifier = {
				factor = 0.5
				trait = honest
			}
		}
		FROM = {
			holder_scope = {
				any_courtier = {
					limit = {
						prisoner = yes
						at_location = ROOT
						host = { character = PREVPREV }
						OR = {
							war_with = PREV
							any_liege = { war_with = PREVPREV }
							is_liege_or_above = ROOT
						}
					}
					prisoner = no
					opinion = {
						modifier = rescued_my_sorry_ass
						who = ROOT
					}
					clr_character_flag = captured_in_battle
					clr_character_flag = kidnapped_by_plot
					clr_character_flag = lost_trial_by_combat
					hidden_tooltip = { character_event = { id = siege_agot.7 } } #Inform
				}
				any_courtier = { #Rescue slaves/concubines
					limit = {
						OR = {
							trait = slave
							trait = salt_wife
							is_consort = yes
						}
						OR = {
							dynasty = ROOT
							is_close_relative = ROOT
							is_friend = ROOT
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_my_abducted_spouse }
						}
						liege = { character = PREVPREV }
						at_location = ROOT
						NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_my_owner } }
						NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_salt_wife } }
						NOT = { consort = { character = ROOT } }
					}
					if = {
						limit = { trait = slave }
						character_event = { id = slavery.0 tooltip = EVTTOOLTIPSLAVERY0 }
					}
					if = {
						limit = { trait = salt_wife }
						remove_trait = salt_wife
						clr_character_flag = no_court_invites
					}
					if = {
						limit = { is_consort = yes }
						any_spouse = { remove_spouse = PREV }
						consort = { remove_consort = PREV }
					}
					move_character = ROOT
					opinion = {
						modifier = rescued_my_sorry_ass
						who = ROOT
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPWAYprisonrelease03"
		trigger = {
			FROM = {
				holder_scope = {
					any_courtier = {
						prisoner = yes
						at_location = ROOT
						host = { character = PREVPREV }
						OR = {
							dynasty = ROOT
							is_close_relative = ROOT
							is_friend = ROOT
							is_married = ROOT
						}
					}
				}
			}
		} #trigger
		ai_chance = {
			factor = 40
			modifier = {
				factor = 2
				trait = kind
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = familyperson
			}
			modifier = {
				factor = 2
				trait = honorable
			}
		}
		FROM = {
			holder_scope = {
				any_courtier = {
					limit = {
						prisoner = yes
						at_location = ROOT
						host = { character = PREVPREV }
						OR = {
							dynasty = ROOT
							is_close_relative = ROOT
							is_friend = ROOT
							is_married = ROOT
						}
					}
					prisoner = no
					opinion = {
						modifier = rescued_my_sorry_ass
						who = ROOT
					}
					clr_character_flag = captured_in_battle
					clr_character_flag = kidnapped_by_plot
					clr_character_flag = lost_trial_by_combat
					hidden_tooltip = { character_event = { id = siege_agot.7 } } #Inform
				}
				any_courtier = { #Rescue slaves/concubines
					limit = {
						OR = {
							trait = slave
							trait = salt_wife
							is_consort = yes
						}
						OR = {
							dynasty = ROOT
							is_close_relative = ROOT
							is_friend = ROOT
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_my_abducted_spouse }
						}
						liege = { character = PREVPREV }
						at_location = ROOT
						NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_my_owner } }
						NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_salt_wife } }
						NOT = { consort = { character = ROOT } }
					}
					if = {
						limit = { trait = slave }
						character_event = { id = slavery.0 tooltip = EVTTOOLTIPSLAVERY0 }
					}
					if = {
						limit = { trait = salt_wife }
						remove_trait = salt_wife
						clr_character_flag = no_court_invites
					}
					if = {
						limit = { is_consort = yes }
						any_spouse = { remove_spouse = PREV }
						consort = { remove_consort = PREV }
					}
					move_character = ROOT
					opinion = {
						modifier = rescued_my_sorry_ass
						who = ROOT
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPWAYprisonrelease04"
		ai_chance = {
			factor = 5
			modifier = {
				factor = 0.5
				trait = kind
			}
			modifier = {
				factor = 0.5
				trait = trusting
			}
			modifier = {
				factor = 0.5
				trait = charitable
			}
			modifier = {
				factor = 0.5
				trait = arbitrary
			}
			modifier = {
				factor = 2
				trait = cruel
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = cynical
			}
			modifier = {
				factor = 2
				trait = paranoid
			}
			modifier = {
				factor = 2
				trait = just
			}
		}
		FROM = {
			holder_scope = {
				any_courtier = {
					limit = {
						prisoner = yes
						at_location = ROOT
						host = { character = PREVPREV }
					}
					opinion = {
						who = ROOT
						modifier = left_to_rot
						months = 60
					}
				}
			}
		}
	}
}

#Inform taken prisoner
character_event = {
	id = siege_agot.6
	desc = "EVTDESCsiege_agot.6"
	picture = "GFX_evt_siege"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = "EVTOPsiege_agot.6"
	}
}
#Inform released
character_event = {
	id = siege_agot.7
	desc = "EVTDESCsiege_agot.7"
	picture = "GFX_evt_siege"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = "EVTOPsiege_agot.7"
	}
}

#Siege destroys infrastructure
character_event = { #if triggered from pillage change holding scope
	id = siege_agot.8

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		character_event = { id = siege_agot.9 }
	}
}
character_event = {
	id = siege_agot.9
	desc = "EVTDESCsiege_agot.9"
	picture = "GFX_evt_siege"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	trigger = {
		FROM = {
			FROM = {
				num_of_buildings = 5
				OR = {
					has_building = ca_wall_1
					has_building = ca_wall_q_1
					has_building = ct_wall_1
					has_building = ct_wall_q_1
					NOR = {
						holding_type = castle
						holding_type = city
					}
				}
			}
		}
	}

	immediate = {
		FROM = {
			FROM = {
				siege_record_buildings_effect = yes #record base values and others just in case
				if = { #chance of damaging hospital
					limit = {
						is_capital = yes
						location = { hospital_level = 1 }
					}
					random = {
						chance = 33
						modifier = {
							factor = 2
							location = { hospital_has_any_building = yes }
						}
						set_title_flag = destroy_hospital
					}
				}
				#Select number of buldings to destroy
				random_list = {
					10 = {
						set_title_flag = destroy_buildings_1
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 6 }
						}
						set_title_flag = destroy_buildings_2
					}
					10 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 7 }
						}
						set_title_flag = destroy_buildings_3
					}
					5 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 8 }
						}
						set_title_flag = destroy_buildings_4
					}
					5 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 9 }
						}
						set_title_flag = destroy_buildings_5
					}
					3 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 11 }
						}
						set_title_flag = destroy_buildings_6
					}
					3 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 13 }
						}
						set_title_flag = destroy_buildings_7
					}
					3 = {
						modifier = {
							factor = 0
							NOT = { num_of_buildings = 15 }
						}
						set_title_flag = destroy_buildings_8
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPsiege_agot.9"
		FROM = {
			FROM = {
				#Always Destroy siege prep
				if = {
					limit = { holding_type = castle }
					if = {
						limit = { has_building = ca_wall_q_5 }
						remove_building = ca_wall_q_5
						remove_building = ca_wall_q_4
					}
					if = {
						limit = {
							has_building = ca_wall_q_4
							NOT = { has_building = ca_wall_q_5 }
						}
						remove_building = ca_wall_q_4
						remove_building = ca_wall_q_3
					}
					if = {
						limit = {
							has_building = ca_wall_q_3
							NOT = { has_building = ca_wall_q_4 }
						}
						remove_building = ca_wall_q_3
						remove_building = ca_wall_q_2
					}
					if = {
						limit = {
							has_building = ca_wall_q_2
							NOT = { has_building = ca_wall_q_3 }
						}
						remove_building = ca_wall_q_2
						remove_building = ca_wall_q_1
					}
					if = {
						limit = {
							has_building = ca_wall_q_1
							NOT = { has_building = ca_wall_q_2 }
						}
						remove_building = ca_wall_q_1
					}
				}
				if = {
					limit = { holding_type = city }
					if = {
						limit = { has_building = ct_wall_q_5 }
						remove_building = ct_wall_q_5
						remove_building = ct_wall_q_4
					}
					if = {
						limit = {
							has_building = ct_wall_q_4
							NOT = { has_building = ct_wall_q_5 }
						}
						remove_building = ct_wall_q_4
						remove_building = ct_wall_q_3
					}
					if = {
						limit = {
							has_building = ct_wall_q_3
							NOT = { has_building = ct_wall_q_4 }
						}
						remove_building = ct_wall_q_3
						remove_building = ct_wall_q_2
					}
					if = {
						limit = {
							has_building = ct_wall_q_2
							NOT = { has_building = ct_wall_q_3 }
						}
						remove_building = ct_wall_q_2
						remove_building = ct_wall_q_1
					}
					if = {
						limit = {
							has_building = ct_wall_q_1
							NOT = { has_building = ct_wall_q_2 }
						}
						remove_building = ct_wall_q_1
					}
				}
				if = {
					limit = { holding_type = temple }
					if = {
						limit = { has_building = tp_wall_q_5 }
						remove_building = tp_wall_q_5
						remove_building = tp_wall_q_4
					}
					if = {
						limit = {
							has_building = tp_wall_q_4
							NOT = { has_building = tp_wall_q_5 }
						}
						remove_building = tp_wall_q_4
						remove_building = tp_wall_q_3
					}
					if = {
						limit = {
							has_building = tp_wall_q_3
							NOT = { has_building = tp_wall_q_4 }
						}
						remove_building = tp_wall_q_3
						remove_building = tp_wall_q_2
					}
					if = {
						limit = {
							has_building = tp_wall_q_2
							NOT = { has_building = tp_wall_q_3 }
						}
						remove_building = tp_wall_q_2
						remove_building = tp_wall_q_1
					}
					if = {
						limit = {
							has_building = tp_wall_q_1
							NOT = { has_building = tp_wall_q_2 }
						}
						remove_building = tp_wall_q_1
					}
				}
				if = {
					limit = { has_title_flag = destroy_buildings_1 }
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_1
				}
				if = {
					limit = { has_title_flag = destroy_buildings_2 }
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_2
				}
				if = {
					limit = { has_title_flag = destroy_buildings_3 }
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_3
				}
				if = {
					limit = { has_title_flag = destroy_buildings_4 }
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_4
				}
				if = {
					limit = { has_title_flag = destroy_buildings_5 }
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_5
				}
				if = {
					limit = { has_title_flag = destroy_buildings_6 }
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_6
				}
				if = {
					limit = { has_title_flag = destroy_buildings_7 }
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_7
				}
				if = {
					limit = { has_title_flag = destroy_buildings_8 }
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					destroy_random_building = yes
					clr_title_flag = destroy_buildings_8
				}
				if = {
					limit = { has_title_flag = destroy_hospital }
					location = {
						if = {
							limit = { NOT = { hospital_has_any_building = yes } }
							destroy_hospital = THIS
						}
						if = {
							limit = { hospital_has_any_building = yes }
							if = {
								limit = { NOT = { hospital_has_building = hospital_building_1 } }
								random_list = {
									10 = {
										trigger = { hospital_has_building = soup_kitchen_1 }
										destroy_in_extra_holding = { type = hospital building = soup_kitchen_1 }
									}
									10 = {
										trigger = { hospital_has_building = chapel_1 }
										destroy_in_extra_holding = { type = hospital building = chapel_1 }
									}
									10 = {
										trigger = { hospital_has_building = pilgrims_inn_1 }
										destroy_in_extra_holding = { type = hospital building = pilgrims_inn_1 }
									}
									10 = {
										trigger = { hospital_has_building = leper_colony_1 }
										destroy_in_extra_holding = { type = hospital building = leper_colony_1 }
									}
								}
							}
							if = {
								limit = {
									hospital_has_building = hospital_building_1
									NOT = { hospital_has_building = hospital_building_2 }
								}
								destroy_in_extra_holding = { type = hospital building = hospital_building_1 }
							}
							if = {
								limit = {
									hospital_has_building = hospital_building_2
									NOT = { hospital_has_building = hospital_building_3 }
								}
								destroy_in_extra_holding = { type = hospital building = hospital_building_2 }
							}
							if = {
								limit = {
									hospital_has_building = hospital_building_3
									NOT = { hospital_has_building = hospital_building_4 }
								}
								destroy_in_extra_holding = { type = hospital building = hospital_building_3 }
							}
							if = {
								limit = {
									hospital_has_building = hospital_building_4
									NOT = { hospital_has_building = hospital_building_5 }
								}
								destroy_in_extra_holding = { type = hospital building = hospital_building_4 }
							}
							if = {
								limit = {
									hospital_has_building = hospital_building_5
								}
								destroy_in_extra_holding = { type = hospital building = hospital_building_5 }
							}
						}
					}
					clr_title_flag = destroy_hospital
				}
				repair_base_value_buildings_effect = yes		#make sure base value is retained
			}
		}
	}

	after = {
		repair_special_buildings_effect = yes #Rebuild undestroyable buildings
	}
}
province_event = { #repair base values
	id = siege_agot.10

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		event_target:repair_base_value = {
			if = {
				limit = {
					has_title_flag = base_value_1
					NOT = { base_value_1_trigger = yes }
				}
				set_title_flag = repair_base_value
				clr_title_flag = base_value_1
				increase_holding_base_value_effect = yes #this has a 'break' so subsequent event is needed
			}
			if = {
				limit = {
					has_title_flag = base_value_2
					NOT = { base_value_2_trigger = yes }
				}
				set_title_flag = repair_base_value
				clr_title_flag = base_value_2
				increase_holding_base_value_effect = yes
			}
			if = {
				limit = {
					has_title_flag = base_value_3
					NOT = { base_value_3_trigger = yes }
				}
				set_title_flag = repair_base_value
				clr_title_flag = base_value_3
				increase_holding_base_value_effect = yes
			}
			if = {
				limit = {
					has_title_flag = base_value_4
					NOT = { base_value_4_trigger = yes }
				}
				set_title_flag = repair_base_value
				clr_title_flag = base_value_4
				increase_holding_base_value_effect = yes
			}
			if = {
				limit = {
					has_title_flag = base_value_5
					NOT = { base_value_5_trigger = yes }
				}
				set_title_flag = repair_base_value
				clr_title_flag = base_value_5
				increase_holding_base_value_effect = yes
			}
			if = {
				limit = {
					has_title_flag = base_value_6
					NOT = { base_value_6_trigger = yes }
				}
				set_title_flag = repair_base_value
				clr_title_flag = base_value_6
				increase_holding_base_value_effect = yes
			}
		}
	}

	after = {
		if = { #this loops until original level is reached
			limit = { event_target:repair_base_value = { has_title_flag = repair_base_value } }
			event_target:repair_base_value = { clr_title_flag = repair_base_value }
			province_event = { id = siege_agot.10 }
		}
	}

	option = {
		name = OK
	}
}

#on_siege_pulse events


#on start of siege, give option to send family away or flee entirely
character_event = { #Trigger from owner
	id = siege_agot.20

	is_triggered_only = yes
	hide_window = yes
	only_rulers = yes
	min_age = 14
	only_capable = yes
	prisoner = no

	trigger = {
		siege = {
			is_attacker = no
			troops = { #enemy must have enough troops
				who = troops
				value = 1
				enemy = yes
			}
			location = {
				county = {
					any_direct_de_jure_vassal_title = {
						holder = ROOT
					}
				}
			}
			OR = {
				location = { is_capital = yes }
				ROOT = {
					capital_holding = {
						controller = {
							NOT = { character = PREVPREV }
						}
					}
				}
			}
		}
		OR = {
			higher_tier_than = DUKE
			is_primary_war_attacker = yes
			is_primary_war_defender = yes
		}
		NOT = { has_character_modifier = stalwart_defender }
		NOT = { trait = in_hiding }
		NOT = { has_character_modifier = siege_choice_made }
	}

	immediate = {
		siege = {
			enemy = {
				leader = {
					save_event_target_as = enemy_siege_leader
				}
			}
		}
		character_event = { id = siege_agot.22 }
	}

	option = {
		name = OK
	}
}
character_event = { #Trigger from courtier
	id = siege_agot.21

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		siege = {
			is_attacker = no
			troops = { #enemy must have enough troops
				who = troops
				value = 1
				enemy = yes
			}
			location = {
				county = {
					any_direct_de_jure_vassal_title = {
						holder_scope = { is_liege_of = ROOT }
					}
				}
			}
			OR = {
				location = { is_capital = yes }
				ROOT = {
					liege = {
						capital_holding = {
							controller = {
								NOT = { character = PREVPREV }
							}
						}
					}
				}
			}
			enemy = {
				leader = {
					OR = {
						ROOT = { liege = { war_with = PREVPREV } }
						any_liege = { ROOT = { liege = { war_with = PREVPREV } } }
					}
				}
			}
		}
		liege = {
			NOT = { character = ROOT }
			OR = {
				higher_tier_than = DUKE
				is_primary_war_attacker = yes
				is_primary_war_defender = yes
			}
			NOT = { has_character_modifier = stalwart_defender }
			NOT = { trait = in_hiding }
			prisoner = no
			NOT = { has_character_modifier = siege_choice_made }
		}
	}

	immediate = {
		siege = {
			enemy = {
				leader = {
					save_event_target_as = enemy_siege_leader
				}
			}
		}
		liege = {
			character_event = { id = siege_agot.22 }
		}
	}

	option = {
		name = OK
	}
}

character_event = {
	id = siege_agot.22
	desc = "EVTDESCWAYsiegepulseflee"
	title = "EVTNAMEWAYsiegepulseflee"

	picture = "GFX_evt_council"
	border = "GFX_event_normal_frame_war"

	is_triggered_only = yes

	immediate = {
		add_character_modifier = { name = siege_choice_made duration = 500 hidden = yes }
		#find war enemy
		event_target:enemy_siege_leader = {
			if = {
				limit = {
					is_ruler = yes
					OR = {
						any_current_enemy = { character = ROOT }
						liege_before_war = { character = ROOT }
					}
				}
				save_event_target_as = enemy_siege_owner
				break = yes
			}
			liege = { save_event_target_as = enemy_siege_owner }
		}
	}

	option = {
		name = "EVTOPTWAYsiegepulseDRAGON" #Dragon fly away
		trigger = {
			trait = dragon_rider
			OR = {
				character = FROM
				at_location = event_target:enemy_siege_leader
			}
			NOT = { is_inaccessible_trigger = yes }
			NAND = {
				in_command = yes
				NOT = { at_location = event_target:enemy_siege_leader }
			}
		}
		ai_chance = {
			factor = 20
			modifier = { #Enemy doesnt have overwhelming forces
				factor = 0.05
				relative_power = { who = event_target:enemy_siege_owner power = 0.5 }
				demesne_garrison_size = 1000
				FROM = {
					siege = {
						is_attacker = no
						NOT = {
							troops = {
								who = troops
								value = 3
								enemy = yes
							}
						}
					}
				}
			}
			modifier = { #Enemy has overwhelming forces
				factor = 10
				OR = {
					NOT = { demesne_garrison_size = 500 }
					NOT = { relative_power = { who = event_target:enemy_siege_owner power = 0.25 } }
					FROM = {
						siege = {
							is_attacker = no
							troops = {
								who = troops
								value = 3
								enemy = yes
							}
						}
					}
				}
			}
		}
		location = {
			random_neighbor_province = {
				limit = { is_land = yes }
				custom_tooltip = { text = TOOLTIPsiegepulseDRAGON }
				hidden_tooltip = {
					ROOT = {
						set_character_flag = sent_back_to_field
						spawn_unit = {
							province = PREV
							leader = ROOT
							#scaled_by_biggest_garrison = 0.6
							troops = {
								archers = { 50 50 }
								heavy_infantry = { 160 160 }
								light_infantry = { 220 220 }
								light_cavalry = { 40 40 }
								knights = { 30 30 }
							}
							attrition = 1.0
							earmark = dragon_unit
						}
					}
				}
			}
		}
		any_courtier = {
			limit = {
				OR = {
					is_close_relative = ROOT
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
				}
				NOT = { character = event_target:enemy_siege_owner }
				NOT = { is_liege_or_above = event_target:enemy_siege_owner }
				has_guardian = yes
				NOT_mythical_creature_trigger = yes
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				guardian = {
					in_command = no
					at_location = FROM
					NOT = { character = ROOT }
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
				}
			}
			guardian = {
				add_trait = in_hiding
				set_character_flag = hidden_from_siege
			}
		}
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = {
						OR = {
							is_primary_war_defender = yes
							is_primary_war_attacker = yes
						}
						war_with = event_target:enemy_siege_owner
					}
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_vengeance }
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_blood_feud }
				}
				NOT = { in_command = yes }
				NOT_mythical_creature_trigger = yes
				NOT = { character = ROOT }
				NOT = { character = event_target:enemy_siege_owner }
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				NOT = { is_child_of = event_target:enemy_siege_owner }
				NOT = { father = { is_child_of = event_target:enemy_siege_owner } }
				NOT = { mother = { is_child_of = event_target:enemy_siege_owner } }
			}
			add_trait = in_hiding
			set_character_flag = hidden_from_siege
		}
	}

	option = {
		name = "EVTOPTWAYsiegepulseflee01"	#Stay put
		ai_chance = {
			factor = 1

			modifier = { #Enemy doesnt have overwhelming forces
				factor = 10
				relative_power = { who = event_target:enemy_siege_owner power = 0.8 }
				demesne_garrison_size = 1000
				FROM = {
					siege = {
						is_attacker = no
						NOT = {
							troops = {
								who = troops
								value = 1.5
								enemy = yes
							}
						}
					}
				}
			}
			modifier = {
				factor = 2
				trait = brave
			}
			modifier = {
				factor = 2
				trait = zealous
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = honorable
			}
		}
		if = {
			limit = {
				NOT = { is_inaccessible_trigger = yes }
				age = 14
				is_incapable = no
			}
			add_character_modifier = {
				name = stalwart_defender
				duration = 730
			}
		}
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
			}
			random_list = {
				70 = {
				}
				10 = {
					trigger = {
						NOT = { trait = zealous }
						NOT = { trait = cynical }
					}
					add_trait = zealous
					hidden_tooltip = {
						character_event = {
							id = 38269 #Notify
						}
					}
				}
				10 = {
					trigger = {
						NOT = { trait = brave }
					}
					if = {
						limit = {
							NOT = { trait = craven }
						}
						add_trait = brave
						hidden_tooltip = {
							character_event = {
								id = 38270 #Notify
							}
						}
					}
					if = {
						limit = {
							trait = craven
						}
						remove_trait = craven
						hidden_tooltip = {
							character_event = {
								id = 38296 #Notify
							}
						}
					}
				}
				10 = {
					trigger = {
						NOT = { trait = proud }
						NOT = { trait = humble }
					}
					add_trait = proud
					hidden_tooltip = {
						character_event = {
							id = 38261 #Notify
						}
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTWAYsiegepulseflee02"
		trigger = {
			any_courtier = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = {
						OR = {
							is_primary_war_defender = yes
							is_primary_war_attacker = yes
						}
						war_with = event_target:enemy_siege_owner
					}
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_vengeance }
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_blood_feud }
				}
				NOT = { in_command = yes }
				NOT_mythical_creature_trigger = yes
				NOT = { character = ROOT }
				NOT = { character = event_target:enemy_siege_owner }
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				NOT = { is_child_of = event_target:enemy_siege_owner }
				NOT = { father = { is_child_of = event_target:enemy_siege_owner } }
				NOT = { mother = { is_child_of = event_target:enemy_siege_owner } }
			}
		}
		ai_chance = {
			factor = 1

			modifier = { #Enemy doesnt have overwhelming forces
				factor = 10
				relative_power = { who = event_target:enemy_siege_owner power = 0.5 }
				demesne_garrison_size = 1000
				FROM = {
					siege = {
						is_attacker = no
						NOT = {
							troops = {
								who = troops
								value = 2
								enemy = yes
							}
						}
					}
				}
			}

			modifier = {
				factor = 3
				trait = familyperson
			}
			modifier = {
				factor = 0.33
				trait = selfish
			}

			modifier = {
				factor = 2
				trait = brave
			}
			modifier = {
				factor = 2
				trait = zealous
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = honorable
			}
		}
		scaled_wealth = { value = -0.25 min = -35 max = -100 }
		if = {
			limit = {
				NOT = { is_inaccessible_trigger = yes }
				age = 14
				is_incapable = no
			}
			add_character_modifier = {
				name = stalwart_defender
				duration = 730
			}
		}
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
			}
			random_list = {
				70 = {
				}
				10 = {
					trigger = {
						NOT = { trait = familyperson }
						NOT = { trait = selfish }
					}
					add_trait = familyperson
					hidden_tooltip = {
						character_event = {
							id = trait_notification.16
						}
					}
				}
				10 = {
					trigger = {
						NOT = { trait = diligent }
						NOT = { trait = slothful }
					}
					add_trait = diligent
					hidden_tooltip = {
						character_event = {
							id = 38256 #Notify
						}
					}
				}
				10 = {
					trigger = {
						NOT = { trait = proud }
						NOT = { trait = humble }
					}
					add_trait = proud
					hidden_tooltip = {
						character_event = {
							id = 38261 #Notify
						}
					}
				}
			}
		}
		any_courtier = {
			limit = {
				OR = {
					is_close_relative = ROOT
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
				}
				NOT = { character = event_target:enemy_siege_owner }
				NOT = { is_liege_or_above = event_target:enemy_siege_owner }
				has_guardian = yes
				NOT_mythical_creature_trigger = yes
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				guardian = {
					in_command = no
					at_location = FROM
					NOT = { character = ROOT }
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
				}
			}
			guardian = {
				add_trait = in_hiding
				set_character_flag = hidden_from_siege
			}
		}
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = {
						OR = {
							is_primary_war_defender = yes
							is_primary_war_attacker = yes
						}
						war_with = event_target:enemy_siege_owner
					}
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_vengeance }
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_blood_feud }
				}
				NOT = { in_command = yes }
				NOT_mythical_creature_trigger = yes
				NOT = { character = ROOT }
				NOT = { character = event_target:enemy_siege_owner }
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				NOT = { is_child_of = event_target:enemy_siege_owner }
				NOT = { father = { is_child_of = event_target:enemy_siege_owner } }
				NOT = { mother = { is_child_of = event_target:enemy_siege_owner } }
			}
			add_trait = in_hiding
			set_character_flag = hidden_from_siege
		}
	}

	option = {
		name = "EVTOPTWAYsiegepulseflee03"
		trigger = {
			NOT = { trait = berserker }
			NOT = { is_inaccessible_trigger = yes }
		}
		ai_chance = {
			factor = 1
			modifier = { #Enemy has overwhelming forces
				factor = 10
				OR = {
					NOT = { demesne_garrison_size = 500 }
					NOT = { relative_power = { who = event_target:enemy_siege_owner power = 0.25 } }
					FROM = {
						siege = {
							is_attacker = no
							troops = {
								who = troops
								value = 3
								enemy = yes
							}
						}
					}
				}
			}

			modifier = {
				factor = 3
				trait = familyperson
			}

			modifier = {
				factor = 5
				trait = craven
			}
			modifier = {
				factor = 3
				trait = cynical
			}
			modifier = {
				factor = 3
				trait = humble
			}
			modifier = {
				factor = 3
				trait = ruthless
			}
		}
		scaled_wealth = { value = -0.35 min = -50 max = -150 }
		if = {
			limit = {
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
			}
			random_list = {
				70 = {
				}
				10 = {
					trigger = {
						NOT = { trait = craven }
					}
					if = {
						limit = {
							NOT = { trait = brave }
						}
						add_trait = craven
						hidden_tooltip = {
							character_event = {
								id = 38257 #Notify
							}
						}
					}
					if = {
						limit = {
							trait = brave
						}
						remove_trait = brave
					}
				}
				10 = {
					trigger = {
						trait = proud
					}
					remove_trait = proud
					hidden_tooltip = {
						character_event = {
							id = 38300 #Notify
						}
					}
				}
				10 = {
					trigger = {
						NOT = { trait = diligent }
					}
					if = {
						limit = {
							NOT = { trait = slothful }
						}
						add_trait = diligent
						hidden_tooltip = {
							character_event = {
								id = 38256 #Notify
							}
						}
					}
					if = {
						limit = {
							trait = slothful
						}
						remove_trait = slothful
						hidden_tooltip = {
							character_event = {
								id = 38298 #Notify
							}
						}
					}
				}
			}
		}
		add_trait = in_hiding
		set_character_flag = hidden_from_siege
		any_courtier = {
			limit = {
				OR = {
					is_close_relative = ROOT
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
				}
				NOT = { character = event_target:enemy_siege_owner }
				NOT = { is_liege_or_above = event_target:enemy_siege_owner }
				has_guardian = yes
				NOT_mythical_creature_trigger = yes
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				guardian = {
					in_command = no
					at_location = FROM
					NOT = { character = ROOT }
					NOT = { is_inaccessible_trigger = yes }
					prisoner = no
				}
			}
			guardian = {
				add_trait = in_hiding
				set_character_flag = hidden_from_siege
			}
		}
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = {
						OR = {
							is_primary_war_defender = yes
							is_primary_war_attacker = yes
						}
						war_with = event_target:enemy_siege_owner
					}
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_vengeance }
					reverse_has_opinion_modifier = { who = event_target:enemy_siege_owner modifier = opinion_blood_feud }
				}
				NOT = { in_command = yes }
				NOT_mythical_creature_trigger = yes
				NOT = { character = ROOT }
				NOT = { character = event_target:enemy_siege_owner }
				at_location = FROM
				NOT = { is_inaccessible_trigger = yes }
				prisoner = no
				NOT = { is_child_of = event_target:enemy_siege_owner }
				NOT = { father = { is_child_of = event_target:enemy_siege_owner } }
				NOT = { mother = { is_child_of = event_target:enemy_siege_owner } }
			}
			add_trait = in_hiding
			set_character_flag = hidden_from_siege
		}
	}
}

#Escape from a siege where you have not hidden
character_event = {
	id = siege_agot.23
	desc = "EVTDESCWAYsiegeescape"
	title = "EVTNAMEWAYnotifyofoutcome"

	picture = "GFX_evt_siege"
	border = "GFX_event_normal_frame_war"

	is_triggered_only = yes
	only_rulers = yes
	min_age = 13
	max_age = 65 #Glover/I'm gettin' too old for this shit
	prisoner = no
	only_capable = yes

	trigger = {
		NOT = { is_inaccessible_trigger = yes }
		OR = {
			tier = KING
			tier = EMPEROR
			is_primary_war_attacker = yes
			is_primary_war_defender = yes
		}
		is_ill = no
		siege = {
			is_attacker = no
			OR = {
				location = {
					is_capital = yes
				}
				ROOT = {
					capital_holding = {
						controller = {
							NOT = { character = ROOT }
						}
					}
				}
			}
			troops = { #enemy must have enough troops
				who = troops
				value = 1
				enemy = yes
			}
		}
	}

	option = {
		name = "EVTOPTWAYsiegesescapeattempt01"
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				trait = craven
			}
			modifier = {
				factor = 3
				trait = brave
			}
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 0.75
				trait = slothful
			}
		}
		random_list = {
			33 = {
				custom_tooltip = { text = EVTTOOLTIPsiegeescaped }
				hidden_tooltip = {
					character_event = { id = siege_agot.25 }
				}
			}
			66 = {
				ROOT = {
					custom_tooltip = { text = EVTTOOLTIPsiegecapturedenemy }
					set_character_flag = captured
				}
				hidden_tooltip = {
					ROOT = { character_event = { id = siege_agot.24 } }
					siege = { enemy = { leader = { character_event = { id = siege_agot.28 } } } }
				}
			}
		}
		if = {
			limit = {
				NOT = { trait = brave }
				NOT = { trait = craven }
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
			}
			random = {
				chance = 25
				add_trait = brave
				hidden_tooltip = {
					character_event = {
						id = 38270 #Notify
					}
				}
			}
		}
		if = {
			limit = {
				trait = craven
			}
			random = {
				chance = 15
				remove_trait = craven
				hidden_tooltip = {
					character_event = {
						id = 38296 #Notify
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTWAYsiegesescapeattempt02"
		ai_chance = {
			factor = 0.5
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 3
				trait = brave
			}
			modifier = {
				factor = 1.5
				trait = humble
			}
			modifier = {
				factor = 0
				trait = craven
			}
			modifier = {
				factor = 0.75
				trait = slothful
			}
		}
		random_list = {
			75 = {
				custom_tooltip = { text = EVTTOOLTIPsiegeescaped }
				hidden_tooltip = {
					character_event = { id = siege_agot.26 }
				}
			}
			25 = {
				ROOT = {
					custom_tooltip = { text = EVTTOOLTIPsiegecapturedenemy }
					set_character_flag = captured
				}

				hidden_tooltip = {
					ROOT = { character_event = { id = siege_agot.24 } }
					siege = { enemy = { leader = { character_event = { id = siege_agot.28 } } } }
				}

			}
		}
		if = {
			limit = {
				NOT = { trait = brave }
				NOT = { trait = craven }
				NOT = { personality_traits = 5 }#
				age = 14
				is_incapable = no
			}
			random = {
				chance = 25
				add_trait = brave
				hidden_tooltip = {
					character_event = {
						id = 38270 #Notify
					}
				}
			}
		}
		if = {
			limit = {
				trait = craven
			}
			random = {
				chance = 15
				remove_trait = craven
				hidden_tooltip = {
					character_event = {
						id = 38296 #Notify
					}
				}
			}
		}

		random_list = {
			80 = {
			}
			10 = {
				if = {
					limit = {
						NOT = {
							has_dlc = "Reapers"
						}
					}
					add_trait = ill
					hidden_tooltip = {
						character_event = {
							id = 38290
						}
					}
				}
				if = {
					limit = {
						has_dlc = "Reapers"
					}
					add_symptom_effect = yes
				}
			}
			4 = {
				add_trait = pneumonic
				hidden_tooltip = {
					character_event = {
						id = 38290 #Notify
					}
				}
			}
			4 = {
				modifier = {
					factor = 0
					OR = {
						trait = wounded
						is_maimed_trigger = yes
					}
				}
				add_trait_silently_wounded_effect = yes
				hidden_tooltip = {
					character_event = {
						id = 38280 #Notify
					}
				}
			}
			1 = {
				modifier = {
					factor = 0
					is_maimed_trigger = yes
				}
				add_maimed_trait_effect = yes
			}
			1 = {
				add_trait = has_bloody_flux
				hidden_tooltip = {
					character_event = {
						id = 38290 #Notify
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTWAYsiegesescapeattempt03"
		trigger = {
			NOT = { has_severe_disability_trigger = yes }
		}
		ai_chance = {
			factor = 0.1
			modifier = {
				factor = 1.5
				trait = ambitious
			}
			modifier = {
				factor = 20
				trait = lunatic
			}
			modifier = {
				factor = 20
				trait = possessed
			}
			modifier = {
				factor = 3
				trait = brave
			}
			modifier = {
				factor = 0
				trait = craven
			}
			modifier = {
				factor = 0.5
				trait = slothful
			}
			modifier = {
				factor = 0.1
				trait = clubfooted
			}

		}
		random_list = {
			70 = {
				custom_tooltip = { text = EVTTOOLTIPsiegeescaped }
				hidden_tooltip = {
					character_event = { id = siege_agot.27 }
				}
			}
			20 = {
				ROOT = {
					custom_tooltip = { text = EVTTOOLTIPsiegecapturedenemy }
					set_character_flag = captured
				}
				hidden_tooltip = {
					ROOT = { character_event = { id = siege_agot.24 } }
					siege = { enemy = { leader = { character_event = { id = siege_agot.28 } } } }
				}

			}
			10 = {
				ROOT = { death = { death_reason = death_battle } }
			}
		}
		if = {
			limit = {
				NOT = { trait = brave }
				NOT = { trait = craven }
				NOT = { personality_traits = 5 }
				age = 14
				is_incapable = no
			}
			random = {
				chance = 25
				add_trait = brave
				hidden_tooltip = {
					character_event = {
						id = 38270 #Notify
					}
				}
			}
		}
		if = {
			limit = {
				trait = craven
			}
			random = {
				chance = 15
				remove_trait = craven
				hidden_tooltip = {
					character_event = {
						id = 38296 #Notify
					}
				}
			}
		}
		random_list = {
			83 = {
			}
			10 = {
				modifier = {
					factor = 0
					trait = wounded
				}
				add_trait_silently_wounded_effect = yes
				hidden_tooltip = {
					character_event = {
						id = 38280 #Notify
					}
				}
			}
			5 = {
				add_maimed_trait_effect = yes
			}
			2 = {
				add_crippled_trait_effect = yes
			}
		}
	}
	option = {
		name = "EVTOPTWAYsiegesescapeattempt04"
		ai_chance = {
			factor = 5
			modifier = {
				factor = 3
				has_character_modifier = stalwart_defender
			}
			modifier = {
				factor = 2
				trait = content
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = slothful
			}
		}
		if = {
			limit = {
				NOT = { trait = stressed }
			}
			random = {
				chance = 15
				add_trait = stressed
				hidden_tooltip = {
					character_event = {
						id = 38282 #Notify
					}
				}
			}
		}
	}
} #evnt

#captured by the enemy

character_event = {
	id = siege_agot.24
	desc = "EVTDESCRWAYnotifyofcapture1"
	title = "EVTNAMEWAYnotifyofoutcome"

	picture = "GFX_evt_bloody_man"
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	option = {
		name = "EVTOPWAYsiegecapture02"
		tooltip = { imprison = yes }
		remove_character_modifier = stalwart_defender
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
				}
				NOT = { in_command = yes }
				NOT = { trait = dragon }
				NOT = { trait = white_walker }
				NOT = { trait = winter_wasteland }
				NOT = { character = ROOT }
				at_location = ROOT
				NOT = { is_inaccessible_trigger = yes }
			}
			opinion = {
				modifier = left_behind
				who = ROOT
				months = 12
			}
		}
	}
}

#escape by postern
character_event = {
	id = siege_agot.25
	desc = "EVTDESCRWAYnotifyofescape01"
	title = "EVTNAMEWAYnotifyofoutcome"

	picture = "GFX_evt_courier"
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	trigger = { is_alive = yes }

	option = {
		name = "EVTTOOLTIPsiegeescaped"
		remove_character_modifier = stalwart_defender
		add_trait = in_hiding
		set_character_flag = hidden_from_siege
		add_character_modifier = {
			name = escaped_siege
			duration = 365
		}
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
				}
				NOT = { in_command = yes }
				NOT = { trait = dragon }
				NOT = { trait = white_walker }
				NOT = { trait = winter_wasteland }
				NOT = { character = ROOT }
				at_location = ROOT
				NOT = { is_inaccessible_trigger = yes }
			}
			opinion = {
				modifier = left_behind
				who = ROOT
				months = 12
			}
		}
	}
}

#escape by sewer
character_event = {
	id = siege_agot.26
	desc = "EVTDESCRWAYnotifyofescape02"
	title = "EVTNAMEWAYnotifyofoutcome"

	picture = "GFX_evt_courier"
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	trigger = { is_alive = yes }

	option = {
		name = "EVTTOOLTIPsiegeescaped"
		remove_character_modifier = stalwart_defender
		add_trait = in_hiding
		set_character_flag = hidden_from_siege
		add_character_modifier = {
			name = escaped_siege
			duration = 365
		}
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
				}
				NOT = { in_command = yes }
				NOT = { trait = dragon }
				NOT = { trait = white_walker }
				NOT = { trait = winter_wasteland }
				NOT = { character = ROOT }
				at_location = ROOT
				NOT = { is_inaccessible_trigger = yes }
			}
			opinion = {
				modifier = left_behind
				who = ROOT
				months = 12
			}
		}
	}
}

#escape by wall
character_event = {
	id = siege_agot.27
	desc = "EVTDESCRWAYnotifyofescape03"
	title = "EVTNAMEWAYnotifyofoutcome"

	picture = "GFX_evt_courier"
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	trigger = { is_alive = yes }

	option = {
		name = "EVTTOOLTIPsiegeescaped"
		remove_character_modifier = stalwart_defender
		add_trait = in_hiding
		set_character_flag = hidden_from_siege
		add_character_modifier = {
			name = escaped_siege
			duration = 365
		}
		any_courtier = {
			limit = {
				OR = {
					AND = {
						dynasty = ROOT
						is_lowborn = no
					}
					is_close_relative = ROOT
					is_married = ROOT
					AND = { #Commanders
						is_military_command_trigger = yes
						tier = BARON
					}
				}
				NOT = { in_command = yes }
				NOT = { trait = dragon }
				NOT = { trait = white_walker }
				NOT = { trait = winter_wasteland }
				NOT = { character = ROOT }
				at_location = ROOT
				NOT = { is_inaccessible_trigger = yes }
			}
			opinion = {
				modifier = left_behind
				who = ROOT
				months = 12
			}
		}
	}
}

#capture event
character_event = {
	id = siege_agot.28
	desc = "EVTDESCRWAYnotifyofcapture2"
	title = "EVTNAMEWAYnotifyofoutcome"

	picture = "GFX_evt_into_the_dungeon"
	border = "GFX_event_normal_frame_war"
	is_triggered_only = yes

	option = {
		name = "EVTOPWAYsiegecapture01"
		FROM = {
			imprison = ROOT
			set_character_flag = captured_in_battle
			clr_character_flag = captured
		}
	}
}
# #surrender or die events
# character_event = { #attacker

	# id = siege_agot.29
	# desc = "EVTDESCsiege_agot.29"
	# picture = "GFX_evt_siege"
	# border = "GFX_event_normal_frame_war"

	# #is_triggered_only = yes #need a lesson about "on actions"

	# trigger = {

		# siege = {
			# is_attacker = yes
			# enemy = {
				# leader = {
					# is_primary_war_attacker = no
					# is_primary_war_defender = no
				# }

			# }
		# }


	# }
	# mean_time_to_happen = {

		# days = 70

		# modifier = { #every 12 days, no flag to mark cooldown, storm end wotu is like 6 months.
			# factor = 5
			# trait = wroth
		# }

		# modifier = {
			# factor = 1.75
			# martial = 7
		# }

		# modifier = {
			# factor = 0.8
			# martial = 12
		# }

		# modifier = {
			# factor = 0.8
			# diplomacy = 10
		# }
		# modifier = {
			# factor = 0.75
			# siege = {
				# enemy = {
					# leader = {
						# martial < 8
					# }
				# }
			# }
		# }
		# modifier = {
			# factor = 0.85
			# siege = {
				# enemy = {
					# leader = {
						# martial < 10
					# }
				# }
			# }
		# }
	# }

	# option = {
		# name = "EXCELLENT"	#Propose surrender
		# siege = { enemy = { leader = { character_event = { id = siege_agot.30  } } } }
	# }

# }

# character_event = { #defender

	# id = siege_agot.30
	# desc = "EVTDESCsiege_agot.30"
	# picture = "GFX_evt_siege"
	# border = "GFX_event_normal_frame_war"

	# is_triggered_only = yes

	# option = {
		# name = "OK"	#surrender
		# siege = {
			# morale = -1 #will surrender
		# }

		# ai_chance = {
			# factor = 3 #doesnt really matter but why is this a decimal? Ruthless, honorable etc but really need to tie the above comment for any of this to be justified.
			# modifier = {
				# factor = 1.5
				# trait = slothful
			# }
			# modifier = {
				# factor = 2
				# is_weak_trigger = yes
			# }

			# modifier = {
				# factor = 1.5
				# trait = craven
			# }

			# modifier = {
				# factor = 1.1
				# trait = humble
			# }

			# modifier = {
				# factor = 2.3
				# trait = depressed
			# }
			# modifier = {
				# factor = 2.1
				# trait = trusting
			# }

			# modifier = {
				# factor = 0.2
				# trait = paranoid
			# }


		# }
		# FROM = { character_event = { id = siege_agot.31 } }
	# }

	# option = {
		# name = "REFUSE"	#NEVA!
		# ai_chance = {
		# factor = 7
			# modifier = {
				# factor = 2
				# trait = proud
			# }

			# modifier = {
				# factor = 1.5
				# trait = knight
			# }

			# modifier = {
				# factor = 2
				# martial = 11
			# }

			# modifier = {
				# factor = 1.3
				# trait = trained_warrior
			# }

			# modifier = {
				# factor = 1.5
				# trait = skilled_warrior
			# }

			# modifier = {
				# factor = 2
				# trait = master_warrior
			# }

			# modifier = {
				# factor = 3
				# trait = brilliant_strategist
			# }

			# modifier = {
				# factor = 2
				# trait = wroth
			# }

			# modifier = {
				# factor = 4
				# trait = brave
			# }

		# }
		# FROM = { character_event = { id = siege_agot.32 } }


	# }

# }

# character_event = { #information accept

	# id = siege_agot.31
	# desc = "EVTDESCsiege_agot.31"
	# picture = "GFX_evt_siege"
	# border = "GFX_event_normal_frame_war"

	# is_triggered_only = yes

	# option = {
	# name = "EXCELLENT" }
# }

#Siege notification events for when player is commander for liege
character_event = { #won siege
	id = siege_agot.40
	desc = EVTDESCsiege_agot.40
	picture = GFX_evt_siege
	border = GFX_event_normal_frame_war

	is_triggered_only = yes
	notification = yes
	ai = no

	trigger = {
		has_minor_title = title_commander
		liege = {
			NOT = { character = ROOT }
			FROM = {
				holder_scope = {
					war_with = PREVPREV
				}
			}
		}
	}

	option = {
		name = OK
	}
}
