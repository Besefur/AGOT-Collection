#############################################
#
# Bankruptcy events
#
# Event ID 38000-38099 is reserved
#
#############################################

# Also contain AGOT banking society events

namespace = bankruptcy

# Take loan, select bank
character_event = {
	id = bankruptcy.1
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy
	desc = {
		text = EVTDESCbankruptcy.1
		trigger = {
			NOR = {
				has_character_flag = bankruptcy.1_DEFAULT
				has_character_flag = bankruptcy.1_RISKY
				has_character_flag = bankruptcy.1_SAFE
				has_character_flag = bankruptcy.1_WAR
				has_character_flag = no_bank_has_offered_loan
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1B
		trigger = {
			has_character_flag = bankruptcy.1_DEFAULT
			NOT = { has_character_flag = bankruptcy.1_WAR }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1C
		trigger = {
			has_character_flag = bankruptcy.1_RISKY
			NOT = { has_character_flag = bankruptcy.1_WAR }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1D
		trigger = {
			has_character_flag = bankruptcy.1_SAFE
			NOT = { has_character_flag = bankruptcy.1_WAR }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1E
		trigger = {
			NOR = {
				has_character_flag = bankruptcy.1_DEFAULT
				has_character_flag = bankruptcy.1_RISKY
				has_character_flag = bankruptcy.1_SAFE
			}
			has_character_flag = bankruptcy.1_WAR
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1F
		trigger = {
			OR = {
				has_character_flag = bankruptcy.1_DEFAULT
				has_character_flag = bankruptcy.1_RISKY
			}
			has_character_flag = bankruptcy.1_WAR
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1G
		trigger = {
			has_character_flag = bankruptcy.1_SAFE
			has_character_flag = bankruptcy.1_WAR
		}
	}
	desc = {
		text = EVTDESCbankruptcy.1H
		trigger = {
			has_character_flag = no_bank_has_offered_loan
		}
	}

	is_triggered_only = yes

	immediate = {
		if = {
			limit = { NOT = { has_character_flag = loan_amount_found } } #already set in previous event
			#Find loan amount
			if = {
				limit = { #AI may borrow just enough to get out of the red
					ai = yes
					NOT = { wealth = -25 }
					war = no
					prisoner = no
				}
				export_to_variable = { which = loan_amount value = wealth who = ROOT }
				multiply_variable = { which = loan_amount value = -1 }
				change_variable = { which = loan_amount value = 50 }

				#Check enough income to qualify for loan
				#2 years income
				export_to_variable = { which = max_loan value = yearly_income who = ROOT }
				multiply_variable = { which = max_loan value = 2 }
				if = {
					limit = {
						check_variable = { which = loan_amount which = max_loan }
					}
					set_variable = { which = loan_amount which = max_loan }
				}
				set_variable = { which = max_loan value = 0 }
			}
			else = {
				#2 years income
				export_to_variable = { which = loan_amount value = yearly_income who = ROOT }
				multiply_variable = { which = loan_amount value = 2 }


				if = { #Emperors get boost for mega wars
					limit = {
						tier = EMPEROR
						trait = civil_war
					}
					set_variable = { which = mega_war_loan_amount value = 0 }
					any_independent_ruler = {
						limit = {
							demesne_size = 1
							primary_title = {
								check_variable = { which = "de_facto_empire" value = 1 }
								ROOT = {
									any_demesne_title = {
										tier = EMPEROR
										is_variable_equal = { which = "de_facto_empire" which = PREVPREV }
										check_variable = { which = "de_facto_empire" value = 0.9 }
									}
								}
							}
							NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_granted_independence } }
						}
						export_to_variable = { which = mega_war_loan_amount value = yearly_income who = THIS }
						ROOT = { change_variable = { which = mega_war_loan_amount which = PREV } }
						set_variable = { which = mega_war_loan_amount value = 0 }
					}
					multiply_variable = { which = mega_war_loan_amount value = 0.2 }
					change_variable = { which = loan_amount which = mega_war_loan_amount }
					set_variable = { which = mega_war_loan_amount value = 0 }
				}
			}
			#Round down to integer for the player
			if = {
				limit = { ai = no }
				round_loan_to_integer_effect = yes
			}
			#AI difficulty boost
			if = {
				limit = { ai = yes }
				if = {
					limit = { difficulty = 3 }
					set_variable = { which = loan_ai_boost which = loan_amount }
					multiply_variable = { which = loan_ai_boost value = 0.5 }
				}
				else_if = {
					limit = { difficulty = 4 }
					set_variable = { which = loan_ai_boost which = loan_amount }
				}
			}
			#Check the character would not still be too deeply in the red
			if = {
				limit = { NOT = { wealth = -50 } }
				export_to_variable = { which = loan_wealth_check value = wealth who = ROOT }
				change_variable = { which = loan_wealth_check which = loan_amount }
				if = {
					limit = { NOT = { check_variable = { which = loan_wealth_check value = 0 } } }
					set_variable = { which = loan_wealth_check value = 0 }
					set_character_flag = no_bank_has_offered_loan
					clear_event_target = bank_option_1
					clear_event_target = bank_option_2
					break = yes
				}
				set_variable = { which = loan_wealth_check value = 0 }
			}
		}
		else = { clr_character_flag = loan_amount_found }
		set_variable = { which = cash_reserve which = loan_amount }	#so can be compared to bank's cash reserve

		hidden_tooltip = {
			#Find bank which can fund
			if = {
				limit = { check_variable = { which = loan_amount value = 50 } } #Major banks only bother with loans 50+
				random_society_member = {
					limit = {
						society = {
							has_flag = bank_society
							check_variable = { which = cash_reserve which = ROOT } #has enough cash for loan
							check_variable = { which = cash_reserve which = preferred_cash_reserve } #Is above preferred cash reserve
							persistent_event_target:location = { #Not at war with bank realm
								owner = {
									is_within_diplo_range = ROOT
									NOR = {
										war_with = ROOT
										any_liege = { war_with = ROOT }
									}
								}
							}
						}
					}
					society = { save_event_target_as = bank_option_1 }
				}
				random_society_member = {
					limit = {
						society = {
							has_flag = bank_society
							check_variable = { which = cash_reserve which = ROOT } #has enough cash for loan
							check_variable = { which = cash_reserve which = preferred_cash_reserve } #Is above preferred cash reserve
							NOT = { is_society = event_target:bank_option_1 }
							persistent_event_target:location = { #Not at war with bank realm
								owner = {
									is_within_diplo_range = ROOT
									NOR = {
										war_with = ROOT
										any_liege = { war_with = ROOT }
									}
								}
							}
						}
					}
					society = { save_event_target_as = bank_option_2 }
				}
			}
			if = { #Society members can get bank loans without restriction from own bank
				limit = {
					is_in_society = yes
					society = {
						has_flag = bank_society
						check_variable = { which = cash_reserve which = ROOT }
						NOT = { is_society = event_target:bank_option_2 }
					}
				}
				society = { save_event_target_as = bank_option_1 }
			}

			#Find base interest rate
			set_variable = { which = loan_interest value = 0.25 }
			#Trust
			if = {
				limit = { #defaulted
					OR = {
						has_character_flag = has_had_loan_default
						has_character_flag = personal_loan_default
					}
				}
				set_character_flag = bankruptcy.1_DEFAULT
				change_variable = { which = loan_interest value = 0.1 }
			}
			else_if = { #Risky
				limit = {
					OR = {
						age = 60
						is_adult = no
						prisoner = yes
						trait = incapable
						stewardship < 4
						has_epidemic = yes
						NOT = { ruled_years = 1 }
					}
				}
				set_character_flag = bankruptcy.1_RISKY
				change_variable = { which = loan_interest value = 0.05 }
			}
			else_if = { #Safe
				limit = {
					has_regent = no
					is_ill = no
					is_nomadic = no
					stewardship = 10
					ruled_years = 5
					NOT = { trait = lunatic }
					NOT = { trait = greedy }
					OR = {
						trait = just
						NOT = { trait = ruthless }
					}
					NOT = { trait = arbitrary }
					NOT = { trait = pirate }
					NOT = { trait = wildling }
				}
				set_character_flag = bankruptcy.1_SAFE
				change_variable = { which = loan_interest value = -0.05 }
			}

			#Struggling in a war
			if = {
				limit = {
					any_war = {
						OR = {
							AND = {
								attacker = { character = ROOT }
								OR = {
									NOT = { war_score = -50 }
									defender = { relative_power = { who = ROOT power = 2 } }
								}
							}
							AND = {
								defender = { character = ROOT }
								OR = {
									war_score = 50
									attacker = { relative_power = { who = ROOT power = 2 } }
								}
							}
						}
					}
				}
				set_character_flag = bankruptcy.1_WAR
				change_variable = { which = loan_interest value = 0.1 }
			}

			#Find values for player
			if = {
				limit = { ai = no }
				set_variable = { which = loan_interest_a which = loan_interest }
				if = {
					limit = { event_target:bank_option_1 = { has_flag = interest_strategy_low } }
					change_variable = { which = loan_interest_a value = -0.1 }
				}
				else_if = {
					limit = { event_target:bank_option_1 = { has_flag = interest_strategy_high } }
					change_variable = { which = loan_interest_a value = 0.05 }
				}
				multiply_variable = { which = loan_interest_a value = 100 }

				set_variable = { which = loan_interest_b which = loan_interest }
				if = {
					limit = { event_target:bank_option_2 = { has_flag = interest_strategy_low } }
					change_variable = { which = loan_interest_b value = -0.1 }
				}
				else_if = {
					limit = { event_target:bank_option_2 = { has_flag = interest_strategy_high } }
					change_variable = { which = loan_interest_b value = 0.05 }
				}
				multiply_variable = { which = loan_interest_b value = 100 }

				set_variable = { which = loan_interest_c which = loan_interest }
				change_variable = { which = loan_interest_c value = 0.1 }
				multiply_variable = { which = loan_interest_c value = 100 }
			}
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.1" #Bank 1
		trigger = {
			event_target:bank_option_1 = { always = yes }
		}
		ai_chance = {
			factor = 500

			modifier = {
				factor = 4
				event_target:bank_option_1 = { has_flag = interest_strategy_low }
			}
			modifier = {
				factor = 0.5
				event_target:bank_option_1 = { has_flag = interest_strategy_high }
			}
			modifier = {
				factor = 4
				is_in_society = event_target:bank_option_1
			}
		}
		wealth = loan_amount
		clr_character_flag = loan_bank_minor
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1
			event_target:bank_option_1 = {
				ROOT = { save_persistent_event_target = { name = loan_bank scope = PREV } }
				#Adjust banks records
				set_variable = { which = loan_amount which = ROOT }

				change_variable = { which = outstanding_loans which = loan_amount } #add loan to outstanding total

				multiply_variable = { which = loan_amount value = -1 }	#Then subtract from cash reserve
				change_variable = { which = cash_reserve which = loan_amount }

				set_variable = { which = loan_amount value = 0 } #clear variable

				if = {
					limit = { has_flag = new_bank_society }
					any_society_member = {
						limit = { ai = no }
						character_event = { id = bankruptcy.128 }
					}
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1_INTEREST_A
			if = {
				limit = { event_target:bank_option_1 = { has_flag = interest_strategy_low } }
				change_variable = { which = loan_interest value = -0.1 }
			}
			else_if = {
				limit = { event_target:bank_option_1 = { has_flag = interest_strategy_high } }
				change_variable = { which = loan_interest value = 0.05 }
			}
		}
	}
	option = {
		name = "EVTOPTBbankruptcy.1" #Bank 2
		trigger = {
			event_target:bank_option_2 = { always = yes }
		}
		ai_chance = {
			factor = 500

			modifier = {
				factor = 4
				event_target:bank_option_2 = { has_flag = interest_strategy_low }
			}
			modifier = {
				factor = 0.5
				event_target:bank_option_2 = { has_flag = interest_strategy_high }
			}
			modifier = {
				factor = 4
				is_in_society = event_target:bank_option_2
			}
		}
		wealth = loan_amount
		clr_character_flag = loan_bank_minor
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1B
			event_target:bank_option_2 = {
				ROOT = { save_persistent_event_target = { name = loan_bank scope = PREV } }
				#Adjust banks records
				set_variable = { which = loan_amount which = ROOT }

				change_variable = { which = outstanding_loans which = loan_amount } #add loan to outstanding total

				multiply_variable = { which = loan_amount value = -1 }	#Then subtract from cash reserve
				change_variable = { which = cash_reserve which = loan_amount }

				set_variable = { which = loan_amount value = 0 } #clear variable

				if = {
					limit = { has_flag = new_bank_society }
					any_society_member = {
						limit = { ai = no }
						character_event = { id = bankruptcy.128 }
					}
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1_INTEREST_B
			if = {
				limit = { event_target:bank_option_2 = { has_flag = interest_strategy_low } }
				change_variable = { which = loan_interest value = -0.1 }
			}
			else_if = {
				limit = { event_target:bank_option_2 = { has_flag = interest_strategy_high } }
				change_variable = { which = loan_interest value = 0.05 }
			}
		}
	}
	option = {
		name = "EVTOPTCbankruptcy.1" #High interest minor bank
		trigger = {
			NOT = { has_character_flag = no_bank_has_offered_loan }
		}
		ai_chance = { factor = 1 }
		if = {
			limit = { check_variable = { which = loan_amount value = 200 }	 } #A minor bank can only lend upto this amount
			wealth = 200
			hidden_tooltip = {
				set_variable = { which = loan_amount value = 200 }
				#AI difficulty boost
				if = {
					limit = { ai = yes }
					if = {
						limit = { difficulty = 3 }
						set_variable = { which = loan_ai_boost value = 100 }
					}
					else_if = {
						limit = { difficulty = 4 }
						set_variable = { which = loan_ai_boost value = 200 }
					}
				}
			}
		}
		else = {
			wealth = loan_amount
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1C
			set_character_flag = loan_bank_minor
			clear_persistent_event_target = loan_bank
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1_INTEREST_C
			change_variable = { which = loan_interest value = 0.1 }
		}
	}
	option = {
		name = "EVTOPTDbankruptcy.1" #Change Mind
		trigger = {
			ai = no
			NOT = { has_character_flag = no_bank_has_offered_loan }
		}
		hidden_tooltip = {
			set_variable = { which = loan_amount value = 0 }
			clr_character_flag = loan_taken
			remove_character_modifier = loan_timer
		}
	}
	option = {
		name = "EVTOPTEbankruptcy.1" #No bank offered loan
		trigger = { has_character_flag = no_bank_has_offered_loan }
		clr_character_flag = no_bank_has_offered_loan
		hidden_tooltip = {
			add_character_modifier = { name = loan_take_fail duration = 365 hidden = yes } #puts a cooldown on the AI

			set_variable = { which = loan_amount value = 0 }
			clr_character_flag = loan_taken
			remove_character_modifier = loan_timer
		}
	}
	after = {
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				if = { #this is calculated for the player so they can repay instantly
					limit = { has_character_flag = loan_taken }
					calculate_loan_repayable_effect = yes
				}
				set_variable = { which = loan_interest_a value = 0 }
				set_variable = { which = loan_interest_b value = 0 }
				set_variable = { which = loan_interest_c value = 0 }
			}

			set_variable = { which = cash_reserve value = 0 }
			if = {
				limit = { ai = yes }
				wealth = loan_ai_boost
				set_variable = { which = loan_ai_boost value = 0 }
			}
			clr_character_flag = bankruptcy.1_DEFAULT
			clr_character_flag = bankruptcy.1_RISKY
			clr_character_flag = bankruptcy.1_SAFE
			clr_character_flag = bankruptcy.1_WAR
		}
	}
}

# Moneylenders visit the heir
character_event = {
	id = 38001
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	only_rulers = yes
	has_character_flag = loan_taken

	trigger = {
		NOT = {
			persistent_event_target:loan_bank = { #Not at war with bank realm
				persistent_event_target:location = {
					owner = {
						OR = {
							war_with = ROOT
							any_liege = { war_with = ROOT }
						}
					}
				}
			}
		}
	}

	#Predeccesor is a person
	desc = {
		text = EVTDESC38001
		trigger = {
			event_target:bank_envoy = { always = yes }
			NOT = { event_target:debt_capital = { always = yes } }
		}
	}
	desc = {
		text = EVTDESC38001B
		trigger = {
			NOT = { event_target:bank_envoy = { always = yes } }
			NOT = { event_target:debt_capital = { always = yes } }
		}
	}
	#Predeccesor is a title
	desc = {
		text = EVTDESC38001C
		trigger = {
			event_target:bank_envoy = { always = yes }
			event_target:debt_capital = { always = yes }
		}
	}
	desc = {
		text = EVTDESC38001D
		trigger = {
			NOT = { event_target:bank_envoy = { always = yes } }
			event_target:debt_capital = { always = yes }
		}
	}

	immediate = {
		set_character_flag = loan_in_progress
		calculate_loan_repayable_effect = yes
		find_bank_envoy_effect = yes
		if = {
			limit = { ai = no }
			#Player can also choose to pay half
			set_variable = { which = loan_half_repayment which = loan_amount }
			multiply_variable = { which = loan_half_repayment value = 0.5 }
			change_variable = { which = loan_half_repayment which = loan_interest_payable }

			set_variable = { which = loan_half_repayment_negative which = loan_half_repayment }
			multiply_variable = { which = loan_half_repayment_negative value = -1 }
		}
	}

	option = { #Repay
		name = "EVTOPTA38002"
		trigger = {
			wealth = loan_total_repayable
		}
		ai_chance = {
			factor = 1
		}
		wealth = loan_total_repayable_negative
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}

			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_total_repayable }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clear_loan_flags_and_variables_effect = yes
		}
	}
	option = { #Repay half
		name = "EVTOPTE38002"
		trigger = {
			ai = no
			wealth = loan_half_repayment
		}
		ai_chance = {
			factor = 0
		}
		wealth = loan_half_repayment_negative
		custom_tooltip = {
			text = TOOLTIPloan_half_repayment
			multiply_variable = { which = loan_amount value = 0.5 }
		}
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_half_repayment }
					set_variable = { which = outstanding_loans which = loan_half_repayment }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clr_character_flag = loan_default
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_profits value = 0 }
			if = {
				limit = { ai = no }
				calculate_loan_repayable_effect = yes
			}
		}
	}
	option = { #Extend loan (Only if predeccessor did not default)
		trigger = { NOT = { has_character_flag = loan_default } }
		ai_chance = {
			factor = 1
		}
		name = "EVTOPTA38001"
		hidden_tooltip = {
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}
		}
		custom_tooltip = { text = EVTTOOLTIP38002C }
	}
	option = {
		name = "EVTOPTB38002" # Pay the interest (Predeccessor defaulted)
		trigger = {
			has_character_flag = loan_default
			OR = {
				wealth = loan_interest_payable
				NOT = { check_variable = { which = loan_interest_payable value = 2.5 } } #always allow interest payment if it is tiny
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				war = no
				prisoner = no
				wealth = loan_total_repayable
			}
		}
		wealth = loan_interest_payable_negative
		custom_tooltip = { text = EVTTOOLTIP38002B }
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_interest_payable }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clr_character_flag = loan_default
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = loan_profits value = 0 }
		}
	}
	option = {
		name = "EVTOPTC38002" # Cannot afford it (Predeccessor defaulted)
		trigger = {
			has_character_flag = loan_default
			NOR = {
				wealth = loan_interest_payable
				NOT = { check_variable = { which = loan_interest_payable value = 2.5 } } #always allow interest payment if it is tiny
			}
		}
		ai_chance = {
			factor = 1
		}
		prestige = loan_interest_payable_negative
		hidden_tooltip = {
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
		}
		custom_tooltip = { text = EVTTOOLTIP38002B }
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		set_character_flag = loan_default
		if = {
			limit = { NOT = { has_character_flag = has_had_loan_default } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.51DEFAULT
				set_character_flag = has_had_loan_default #effects trust/interest rates
			}
		}

		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				event_target:bank_envoy = { character_event = { id = bankruptcy.88 } }
			}
			else = {
				character_event = { id = bankruptcy.45 days = 5 } #consequences
			}
		}
	}
	option = { #Cancel
		name = "EVTOPTH38001"
		ai_chance = {
			factor = 0.2

			modifier = {
				factor = 2
				persistent_event_target:loan_bank = { NOT = { society_influence = 2 } }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 3 }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 5 }
			}

			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
				}
			}
		}
		prestige = loan_total_repayable_negative
		any_demesne_province = {
			add_province_modifier = {
				name = offended_moneylenders
				duration = 3650
			}
		}
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		if = { #Kick from bank
			limit = {
				is_in_society = yes
				society = { has_flag = bank_society }
				society_rank == 1
			}
			leave_society = yes
		}
		hidden_tooltip = {
			persistent_event_target:loan_bank = { #Adjust bank's records
				ROOT = {
					set_variable = { which = loan_losses which = loan_amount }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
				}
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_losses which = ROOT }
			}

			set_character_flag = offended_moneylenders
			set_character_flag = has_had_loan_default #effects trust/interest rates
			set_variable = { which = loan_interest value = 0.45 } #Punititive interest rate

			clr_character_flag = loan_taken
			set_variable = { which = loan_interest_payable value = 0 }
			set_variable = { which = loan_total_repayable value = 0 }
			set_variable = { which = loan_total_repayable_negative value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_losses value = 0 }
			remove_character_modifier = loan_timer
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				event_target:bank_envoy = { character_event = { id = bankruptcy.88 } }
			}
			else = {
				character_event = { id = bankruptcy.45 days = 5 } #consequences
			}
		}
	}
	after = {
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				set_variable = { which = loan_half_repayment value = 0 }
				set_variable = { which = loan_half_repayment_negative value = 0 }
			}
		}
		clr_character_flag = loan_in_progress
	}
}

# Moneylenders visit the heir (default)
character_event = {
	id = 38071
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	#Predeccesor is a person
	desc = {
		text = EVTDESC38071
		trigger = {
			event_target:bank_envoy = { always = yes }
			NOT = { event_target:debt_capital = { always = yes } }
			NOT = { has_character_flag = looted_bank }
		}
	}
	desc = {
		text = EVTDESC38071B
		trigger = {
			NOT = { event_target:bank_envoy = { always = yes } }
			NOT = { event_target:debt_capital = { always = yes } }
			NOT = { has_character_flag = looted_bank }
		}
	}
	#Predeccesor is a title
	desc = {
		text = EVTDESC38071C
		trigger = {
			event_target:bank_envoy = { always = yes }
			event_target:debt_capital = { always = yes }
			NOT = { has_character_flag = looted_bank }
		}
	}
	desc = {
		text = EVTDESC38071D
		trigger = {
			NOT = { event_target:bank_envoy = { always = yes } }
			event_target:debt_capital = { always = yes }
			NOT = { has_character_flag = looted_bank }
		}
	}
	#Money was stolen
	desc = {
		text = EVTDESC38071E
		trigger = { has_character_flag = looted_bank }
	}

	trigger = { is_ruler = yes }

	immediate = {
		set_character_flag = loan_in_progress
		calculate_loan_repayable_effect = yes
		#Check not facing an envoy
		clear_event_target = loan_insurer_war
		random_opinion_modifier_target = {
			limit = {
				war_with = ROOT
				has_flag = loan_insurer
				reverse_has_opinion_modifier = { who = ROOT modifier = opinion_debt_insurer }
				persistent_event_target:loan_insurance_target = { character = ROOT }
			}
			save_event_target_as = loan_insurer_war
		}

		find_bank_envoy_effect = yes
		if = {
			limit = { ai = no }
			#Player can also choose to pay half
			set_variable = { which = loan_half_repayment which = loan_amount }
			multiply_variable = { which = loan_half_repayment value = 0.5 }
			change_variable = { which = loan_half_repayment which = loan_interest_payable }

			set_variable = { which = loan_half_repayment_negative which = loan_half_repayment }
			multiply_variable = { which = loan_half_repayment_negative value = -1 }
		}
	}

	option = { #Pay off
		name = "EVTOPTA38002"
		trigger = {
			wealth = loan_total_repayable
			NOT = { event_target:loan_insurer_war = { always = yes } }
		}
		ai_chance = {
			factor = 1
		}
		wealth = loan_total_repayable_negative
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}

			persistent_event_target:loan_bank = { #Adjust bank's records
				ROOT = {
					set_variable = { which = cash_reserve which = loan_total_repayable }
					set_variable = { which = loan_losses which = loan_amount }
					multiply_variable = { which = loan_losses value = -1 }
					set_variable = { which = loan_profits which = loan_amount }
					multiply_variable = { which = loan_profits which = loan_interest }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = loan_losses which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clear_loan_flags_and_variables_effect = yes
		}
		clr_character_flag = offended_moneylenders
	}
	option = { #Repay half
		name = "EVTOPTE38002"
		trigger = {
			ai = no
			wealth = loan_half_repayment
			NOT = { event_target:loan_insurer_war = { always = yes } }
		}
		ai_chance = {
			factor = 0
		}
		wealth = loan_half_repayment_negative
		custom_tooltip = {
			text = TOOLTIPloan_half_repayment
			multiply_variable = { which = loan_amount value = 0.5 }
		}
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_half_repayment }
					set_variable = { which = outstanding_loans which = loan_half_repayment }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clr_character_flag = loan_default
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_profits value = 0 }
			if = {
				limit = { ai = no }
				calculate_loan_repayable_effect = yes
			}
		}
	}
	option = {
		name = "EVTOPTB38071" # Pay the interest
		trigger = {
			OR = {
				wealth = loan_interest_payable
				NOT = { check_variable = { which = loan_interest_payable value = 2.5 } } #always allow interest payment if it is tiny
			}
			NOT = { event_target:loan_insurer_war = { always = yes } }
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				war = no
				prisoner = no
				wealth = loan_total_repayable
			}
		}
		wealth = loan_interest_payable_negative
		custom_tooltip = { text = EVTTOOLTIP38002B }
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_interest_payable }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clr_character_flag = loan_default
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = loan_profits value = 0 }
		}
		clr_character_flag = offended_moneylenders
		clr_character_flag = looted_bank
	}
	option = { #Can't afford, but promise to repay
		name = "EVTOPTA38071"
		trigger = {
			NOR = {
				wealth = loan_interest_payable
				NOT = { check_variable = { which = loan_interest_payable value = 2.5 } } #always allow interest payment if it is tiny
			}
			NOT = { event_target:loan_insurer_war = { always = yes } }
		}
		ai_chance = {
			factor = 1
		}
		prestige = loan_interest_payable_negative
		hidden_tooltip = {
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
		}
		custom_tooltip = { text = EVTTOOLTIP38002B }
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		set_character_flag = loan_default
		if = {
			limit = { NOT = { has_character_flag = has_had_loan_default } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.51DEFAULT
				set_character_flag = has_had_loan_default #effects trust/interest rates
			}
		}

		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				event_target:bank_envoy = { character_event = { id = bankruptcy.88 } }
			}
			else = {
				character_event = { id = bankruptcy.45 days = 5 } #consequences
			}
		}
		clr_character_flag = offended_moneylenders
		clr_character_flag = looted_bank
	}
	option = { #Cancel
		name = "EVTOPTH38001"
		trigger = {
			NOT = { event_target:loan_insurer_war = { always = yes } }
		}
		ai_chance = {
			factor = 0.2

			modifier = {
				factor = 20
				has_character_flag = looted_bank
			}
			modifier = {
				factor = 2
				persistent_event_target:loan_bank = { NOT = { society_influence = 2 } }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 3 }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 5 }
			}

			modifier = {
				factor = 0
				trait = just
				NOT = { has_character_flag = looted_bank }
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
					has_character_flag = looted_bank
				}
			}
		}
		if = {
			limit = { NOT = { has_character_flag = looted_bank } }
			prestige = loan_total_repayable_negative
			any_demesne_province = {
				add_province_modifier = {
					name = offended_moneylenders
					duration = 3650
				}
			}
			if = {
				limit = { ai = no }
				chronicle = {
					entry = CHRONICLE_LOAN_DEAFULT
				}
			}
		}
		if = { #Kick from bank
			limit = {
				is_in_society = yes
				society = { has_flag = bank_society }
				society_rank == 1
			}
			leave_society = yes
		}
		hidden_tooltip = {
			set_character_flag = offended_moneylenders
			set_character_flag = has_had_loan_default #effects trust/interest rates
			set_variable = { which = loan_interest value = 0.45 } #Punititive interest rate

			clr_character_flag = loan_taken
			set_variable = { which = loan_interest_payable value = 0 }
			set_variable = { which = loan_total_repayable value = 0 }
			set_variable = { which = loan_total_repayable_negative value = 0 }
			remove_character_modifier = loan_timer

			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				event_target:bank_envoy = { character_event = { id = bankruptcy.88 } }
			}
			else = {
				character_event = { id = bankruptcy.45 days = 5 } #consequences
			}
		}
	}
	option = { #Bank has seeked insurance war
		name = "EVTOPTF38071"
		trigger = {
			event_target:loan_insurer_war = { always = yes }
		}
		hidden_tooltip = {
			remove_character_modifier = loan_timer
		}
		show_portrait = event_target:loan_insurer_war
		set_character_flag = loan_default
	}

	after = {
		clr_character_flag = loan_in_progress
	}
}
# Moneylenders visit the heir (second bank)
character_event = {
	id = 38072
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	trigger = {
		is_ruler = yes
	}

	desc = {
		text = EVTDESC38072
		trigger = {
			NOT = { has_flag = B_loan_default }
			event_target:bank_envoy = { always = yes }
		}
	}
	desc = {
		text = EVTDESC38072B
		trigger = {
			NOT = { has_flag = B_loan_default }
			NOT = { event_target:bank_envoy = { always = yes } }
		}
	}
	#Predeccesor defaulted
	desc = {
		text = EVTDESC38072C
		trigger = {
			has_flag = B_loan_default
			event_target:bank_envoy = { always = yes }
		}
	}
	desc = {
		text = EVTDESC38072D
		trigger = {
			has_flag = B_loan_default
			NOT = { event_target:bank_envoy = { always = yes } }
		}
	}

	immediate = {
		set_character_flag = loan_in_progress
		#1st loan
		calculate_loan_repayable_effect = yes
		#2nd loan
		hidden_tooltip = {
			random_society_member = {
				limit = {
					society = {
						has_flag = b_loan_@ROOT
					}
				}
				society = { save_event_target_as = B_loan_bank }
			}
		}
		set_variable = { which = B_loan_interest_payable which = B_loan_amount }
		multiply_variable = { which = B_loan_interest_payable which = B_loan_interest }

		set_variable = { which = B_loan_amount_repayable which = B_loan_amount }
		change_variable = { which = B_loan_amount_repayable which = B_loan_interest_payable }

		set_variable = { which = B_loan_amount_repayable_negative which = B_loan_amount_repayable }
		multiply_variable = { which = B_loan_amount_repayable_negative value = -1 }

		clear_event_target = bank_envoy
		find_bank_envoy_effect = yes
	}

	option = { #Repay 1st loan
		name = "EVTOPTA38072"
		trigger = {
			#wealth = loan_total_repayable
			NOT = { has_character_flag = loan_insurer }
			NOT = { has_character_flag = offended_moneylenders }
		}
		ai_chance = {
			factor = 1
			modifier = { #always pay smaller loan
				factor = 0
				NOT = { check_variable = { which = B_loan_amount_repayable which = loan_total_repayable } }
			}
		}
		wealth = loan_total_repayable_negative
		custom_tooltip = { text = EVTTOOLTIP38072A }
		hidden_tooltip = {
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_total_repayable }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clear_loan_flags_and_variables_effect = yes

			#Make 2nd new main loan
			set_character_flag = loan_taken
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
			if = {
				limit = { has_flag = B_loan_bank_minor }
				clear_persistent_event_target = loan_bank
				set_character_flag = loan_bank_minor
			}
			else = {
				clear_persistent_event_target = loan_bank
				save_persistent_event_target = { name = loan_bank scope = event_target:B_loan_bank }
			}
			set_variable = { which = loan_amount which = B_loan_amount }
			set_variable = { which = loan_interest which = B_loan_interest }
			if = {
				limit = { ai = no }
				calculate_loan_repayable_effect = yes
			}
		}
	}
	option = { #Repay 2nd loan
		name = "EVTOPTB38072"
		trigger = {
			#wealth = B_loan_amount_repayable
		}
		ai_chance = {
			factor = 1
			modifier = { #always pay smaller loan
				factor = 0
				NOT = { check_variable = { which = loan_amount_repayable which = B_loan_amount_repayable } }
				NOT = { has_character_flag = loan_insurer }
				NOT = { has_character_flag = offended_moneylenders }
			}
		}
		wealth = B_loan_amount_repayable_negative
		custom_tooltip = { text = EVTTOOLTIP38072B }
		hidden_tooltip = {
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				set_variable = { which = success_bonus which = B_loan_amount } #envoy gets 5% commission
				event_target:bank_envoy = { character_event = { id = bankruptcy.87 } }
			}

			#Adjust bank's records
			event_target:B_loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = B_loan_amount_repayable }
					set_variable = { which = outstanding_loans which = B_loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = B_loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
		}
	}
	option = { #Cancel
		name = "EVTOPTC38072"
		ai_chance = {
			factor = 0.2

			modifier = {
				factor = 2
				event_target:B_loan_bank = { NOT = { society_influence = 2 } }
			}
			modifier = {
				factor = 0.5
				event_target:B_loan_bank = { society_influence = 3 }
			}
			modifier = {
				factor = 0.5
				event_target:B_loan_bank = { society_influence = 5 }
			}

			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
				}
			}
		}
		prestige = B_loan_amount_repayable_negative
		any_demesne_province = {
			add_province_modifier = {
				name = offended_moneylenders
				duration = 3650
			}
		}
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		if = { #Kick from bank
			limit = {
				is_in_society = yes
				society = {
					has_flag = bank_society
					ROOT = { event_target:B_loan_bank = { is_society = PREVPREV } }
				}
				society_rank == 1
			}
			leave_society = yes
		}
		if = {
			limit = { NOT = { has_character_flag = has_had_loan_default } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.51DEFAULT
				set_character_flag = has_had_loan_default #effects trust/interest rates
			}
		}
		hidden_tooltip = {
			event_target:B_loan_bank = { #Adjust bank's records
				ROOT = {
					set_variable = { which = loan_losses which = B_loan_amount }
					set_variable = { which = outstanding_loans which = B_loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
				}
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_losses which = ROOT }
			}
			if = {
				limit = {
					event_target:bank_envoy = {
						has_quest = quest_bank_recover_debt
						quest_target = { character = ROOT }
					}
				}
				event_target:bank_envoy = { character_event = { id = bankruptcy.88 } }
			}
		}
	}
	after = {
		hidden_tooltip = {
			clr_character_flag = B_loan_bank_minor
			clr_character_flag = B_loan_default
			event_target:B_loan_bank = { clr_flag = b_loan_@ROOT }
			set_variable = { which = B_loan_amount value = 0 }
			set_variable = { which = B_loan_interest value = 0 }
			set_variable = { which = B_loan_interest_payable value = 0 }
			set_variable = { which = B_loan_amount_repayable value = 0 }
			set_variable = { which = B_loan_amount_repayable_negative value = 0 }
		}
		clr_character_flag = loan_in_progress
	}
}
# A loan is due
character_event = {
	id = 38002
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	only_rulers = yes
	has_character_flag = loan_taken

	desc = {
		text = "EVTDESC38002"
		trigger = { event_target:bank_envoy = { always = yes } }
	}
	desc = {
		text = "EVTDESC38002B"
		trigger = { NOT = { event_target:bank_envoy = { always = yes } } }
	}

	trigger = {
		NOT = { has_character_modifier = loan_timer }
		OR = {
			NOT = { has_character_flag = loan_in_progress }
			had_character_flag = { flag = loan_in_progress days = 50 }
		}
		NOT = {
			persistent_event_target:loan_bank = { #Not at war with bank realm
				persistent_event_target:location = {
					owner = {
						OR = {
							war_with = ROOT
							any_liege = { war_with = ROOT }
						}
					}
				}
			}
		}
	}

	immediate = {
		set_character_flag = loan_in_progress
		clr_character_flag = loan_default

		calculate_loan_repayable_effect = yes
		find_bank_envoy_effect = yes
		if = {
			limit = { ai = no }
			#Player can also choose to pay half
			set_variable = { which = loan_half_repayment which = loan_amount }
			multiply_variable = { which = loan_half_repayment value = 0.5 }
			change_variable = { which = loan_half_repayment which = loan_interest_payable }

			set_variable = { which = loan_half_repayment_negative which = loan_half_repayment }
			multiply_variable = { which = loan_half_repayment_negative value = -1 }
		}
	}

	mean_time_to_happen = { days = 1 }

	option = {
		name = "EVTOPTA38002" # Return the money
		trigger = {
			wealth = loan_total_repayable
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				OR = {
					war = yes
					prisoner = yes
				}
			}
		}
		wealth = loan_total_repayable_negative
		hidden_tooltip = {
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_total_repayable }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clear_loan_flags_and_variables_effect = yes
		}
	}
	option = { #Repay half
		name = "EVTOPTE38002"
		trigger = {
			ai = no
			wealth = loan_half_repayment
		}
		ai_chance = {
			factor = 0
		}
		wealth = loan_half_repayment_negative
		custom_tooltip = {
			text = TOOLTIPloan_half_repayment
			multiply_variable = { which = loan_amount value = 0.5 }
		}
		hidden_tooltip = {
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_half_repayment }
					set_variable = { which = outstanding_loans which = loan_half_repayment }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clr_character_flag = loan_default
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_profits value = 0 }
			if = {
				limit = { ai = no }
				calculate_loan_repayable_effect = yes
			}
		}
	}
	option = {
		name = "EVTOPTB38002" # Pay the interest
		trigger = {
			OR = {
				wealth = loan_interest_payable
				NOT = { check_variable = { which = loan_interest_payable value = 2.5 } } #always allow interest payment if it is tiny
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				war = no
				prisoner = no
				wealth = loan_total_repayable
			}
		}
		wealth = loan_interest_payable_negative
		custom_tooltip = { text = EVTTOOLTIP38002B }
		hidden_tooltip = {
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_interest_payable }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clr_character_flag = loan_default
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = loan_profits value = 0 }
		}
	}
	option = {
		name = "EVTOPTC38002" # Cannot afford it
		trigger = {
			NOR = {
				wealth = loan_interest_payable
				NOT = { check_variable = { which = loan_interest_payable value = 2.5 } } #always allow interest payment if it is tiny
			}
		}
		ai_chance = {
			factor = 1
		}
		prestige = loan_interest_payable_negative
		hidden_tooltip = {
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 730
			}
		}
		custom_tooltip = { text = EVTTOOLTIP38002B }
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		set_character_flag = loan_default
		if = {
			limit = { NOT = { has_character_flag = has_had_loan_default } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.51DEFAULT
				set_character_flag = has_had_loan_default #effects trust/interest rates
			}
		}

		character_event = { id = bankruptcy.45 days = 5 } #consequences
	}
	option = {
		name = "EVTOPTD38002" # Get rid of them!
		ai_chance = {
			factor = 0.2

			modifier = {
				factor = 2
				persistent_event_target:loan_bank = { NOT = { society_influence = 2 } }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 3 }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 5 }
			}

			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
				}
			}
		}
		prestige = loan_total_repayable_negative
		any_demesne_province = {
			add_province_modifier = {
				name = offended_moneylenders
				duration = 3650
			}
		}
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		if = { #Kick from bank
			limit = {
				is_in_society = yes
				society = { has_flag = bank_society }
				society_rank == 1
			}
			leave_society = yes
		}
		hidden_tooltip = {
			persistent_event_target:loan_bank = { #Adjust bank's records
				ROOT = {
					set_variable = { which = loan_losses which = loan_amount }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
				}
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_losses which = ROOT }
			}

			set_character_flag = offended_moneylenders
			set_character_flag = has_had_loan_default #effects trust/interest rates
			set_variable = { which = loan_interest value = 0.45 } #Punititive interest rate

			clr_character_flag = loan_taken
			set_variable = { which = loan_interest_payable value = 0 }
			set_variable = { which = loan_total_repayable value = 0 }
			set_variable = { which = loan_total_repayable_negative value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_losses value = 0 }
			remove_character_modifier = loan_timer

			character_event = { id = bankruptcy.45 days = 5 } #consequences
		}
	}
	after = {
		hidden_tooltip = {
			if = {
				limit = { ai = no }
				set_variable = { which = loan_half_repayment value = 0 }
				set_variable = { which = loan_half_repayment_negative value = 0 }
			}
		}
		clr_character_flag = loan_in_progress
	}
}

#Ruler in red, lean on vassals #Replaced by decisions
# character_event = {
	# id = 38010
	# desc = EVTDESC38010
	# picture = GFX_evt_council

	# only_playable = yes
	# prisoner = no

	# trigger = {
		# is_nomadic = no
		# OR = {
			# wealth < 0
			# has_character_flag = human_vassal_loan
		# }
		# NOT = { culture_group = unoccupied_group }
		# any_vassal = {
			# NOT = { has_character_flag = loan_taken }
			# OR = {
				# AND = {
					# ROOT = { NOT = { monthly_income = 3 } }
					# wealth = 125
				# }
				# AND = {
					# ROOT = {
						# monthly_income = 3
						# NOT = { monthly_income = 6 }
					# }
					# wealth = 225
				# }
				# AND = {
					# ROOT = {
						# monthly_income = 6
						# NOT = { monthly_income = 12 }
					# }
					# wealth = 450
				# }
				# AND = {
					# ROOT = { monthly_income = 12 }
					# wealth = 750
				# }
			# }
			# NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_liege_loan } }
			# NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = refused_money_request } }
			# NOT = {
				# AND = {
					# has_character_flag = mega_war_liege_loan
					# ROOT = { tier = EMPEROR }
				# }
			# }
		# }
		# NOT = { has_character_flag = vassal_loan_in_progress }
	# }

	# mean_time_to_happen = {
		# months = 60
		# modifier = {
			# factor = 0.25
			# has_character_flag = loan_taken
		# }
	# }

	# immediate = {
		# set_character_flag = vassal_loan_in_progress
		# clr_character_flag = human_vassal_loan
	# }

	# option = {
		# name = EVTOPTA38010 # Ask vassal
		# random_vassal = {
			# limit = {
				# NOT = { has_character_flag = loan_taken }
				# OR = {
					# AND = {
						# ROOT = { NOT = { monthly_income = 3 } }
						# wealth = 125
					# }
					# AND = {
						# ROOT = {
							# monthly_income = 3
							# NOT = { monthly_income = 6 }
						# }
						# wealth = 225
					# }
					# AND = {
						# ROOT = {
							# monthly_income = 6
							# NOT = { monthly_income = 12 }
						# }
						# wealth = 450
					# }
					# AND = {
						# ROOT = { monthly_income = 12 }
						# wealth = 750
					# }
				# }
				# NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_liege_loan } }
				# NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = refused_money_request } }
				# NOT = {
					# AND = {
						# has_character_flag = mega_war_liege_loan
						# ROOT = { tier = EMPEROR }
					# }
				# }
			# }
			# letter_event = { id = 38011 days = 5 tooltip = EVTTOOLTIP38013 }
		# }
	# }
# }
character_event = { #Ping from player decision
	id = 38911

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		FROM = { letter_event = { id = 38011 days = 5 } }
	}

	option = {
		name = OK
	}
}
#Request
letter_event = {
	id = 38011
	desc = EVTDESC38011
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	trigger = {
		FROM = { is_alive = yes }
		NOT = { has_character_flag = given_personal_loan }
		NOT = { has_character_flag = loan_taken }
	}

	option = {
		name = EVTOPTA_38011
		trigger = {
			has_dlc = "Zeus"
			NOT = { holds_favor_on = FROM }
		}
		ai_chance = {
			factor = 0.5

			modifier = { #has cancelled a personal loan in the past
				factor = 0
				FROM = {
					has_character_flag = personal_loan_refusal
				}
				NOT = { trait = trusting }
				NOT = { is_friend = FROM }
				NOT = { is_married = FROM }
				NOT = { is_parent_of = FROM }
				NOT = { is_child_of = FROM }
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 2
				opinion = { who = FROM value =  0 }
			}
			modifier = {
				factor = 0
				opinion = { who = FROM value =  25 }
			}
		}
		custom_tooltip = { text = TOOLTIP38011LOAN }
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
		if = {
			limit = { FROM = { NOT = { monthly_income = 3 } } }
			wealth = -75
			set_character_flag = liege_loan_75
		}
		if = {
			limit = {
				FROM = {
					monthly_income = 3
					NOT = { monthly_income = 6 }
				}
			}
			wealth = -150
			set_character_flag = liege_loan_150
		}
		if = {
			limit = {
				FROM = {
					monthly_income = 6
					NOT = { monthly_income = 12 }
				}
			}
			wealth = -300
			set_character_flag = liege_loan_300
		}
		if = {
			limit = { FROM = { monthly_income = 12 } }
			wealth = -500
			set_character_flag = liege_loan_500
		}
		add_favor = FROM
		hidden_tooltip = {
			FROM = {
				character_event = { id = 38016 }
				primary_title = { save_event_target_as = loan_title }
			}
			opinion = {
				who = FROM
				modifier = opinion_liege_loan
				years = 100
			}
			set_character_flag = given_personal_loan
			remove_character_modifier = liege_loan
			add_character_modifier = {
				name = "liege_loan"
				duration = "1825"
			}
			clear_persistent_event_target = loan_title
			save_persistent_event_target = { name = loan_title scope = event_target:loan_title } #the loan is linked to the title
		}
	}

	option = {
		name = ACCEPT
		ai_chance = {
			factor = 1.5

			modifier = { #has cancelled a personal loan in the past
				factor = 0
				FROM = {
					has_character_flag = personal_loan_refusal
				}
				NOT = { trait = trusting }
				NOT = { is_friend = FROM }
				NOT = { is_married = FROM }
				NOT = { is_parent_of = FROM }
				NOT = { is_child_of = FROM }
			}
			modifier = {
				factor = 0.33
				trait = greedy
			}
			modifier = {
				factor = 3
				trait = charitable
			}
			modifier = {
				factor = 3
				trait = trusting
			}
			modifier = {
				factor = 1.5
				opinion = { who = FROM value =  25 }
			}
			modifier = {
				factor = 2
				opinion = { who = FROM value =  50 }
			}
			modifier = {
				factor = 3
				opinion = { who = FROM value =  75 }
			}
		}
		custom_tooltip = { text = TOOLTIP38011LOAN }
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
		if = {
			limit = { FROM = { NOT = { monthly_income = 3 } } }
			wealth = -75
			set_character_flag = liege_loan_75
		}
		if = {
			limit = {
				FROM = {
					monthly_income = 3
					NOT = { monthly_income = 6 }
				}
			}
			wealth = -150
			set_character_flag = liege_loan_150
		}
		if = {
			limit = {
				FROM = {
					monthly_income = 6
					NOT = { monthly_income = 12 }
				}
			}
			wealth = -300
			set_character_flag = liege_loan_300
		}
		if = {
			limit = { FROM = { monthly_income = 12 } }
			wealth = -500
			set_character_flag = liege_loan_500
		}
		hidden_tooltip = {
			FROM = {
				letter_event = { id = 38015 }
				primary_title = { save_event_target_as = loan_title }
			}
			opinion = {
				who = FROM
				modifier = opinion_liege_loan
				years = 100
			}
			set_character_flag = given_personal_loan
			remove_character_modifier = liege_loan
			add_character_modifier = {
				name = "liege_loan"
				duration = "1825"
			}
			clear_persistent_event_target = loan_title
			save_persistent_event_target = { name = loan_title scope = event_target:loan_title } #the loan is linked to the title
		}
	}
	option = {
		name = DECLINE
		ai_chance = {
			factor = 1

			modifier = { #Motives to decline...
				factor = 0
				opinion = { who = FROM value = 0 } #Dislike
				NOT = { trait = paranoid }
				NOT = { trait = greedy }
				war = no
				is_liege_or_above = FROM
				FROM = { #Untrustworthy
					OR = {
						trait = just
						trait = honorable
						trait = honest
						trait = charitable
						NOR = {
							trait = arbitrary
							trait = greedy
							trait = selfish
							trait = lunatic
							trait = possessed
						}
					}
				}
				FROM = {
					NOR = {
						has_character_flag = offended_moneylenders
						has_character_flag = has_had_loan_default
						has_character_flag = personal_loan_refusal
						has_character_flag = personal_loan_default
					}
				}
			}
			modifier = {
				factor = 4
				FROM = {
					has_character_flag = personal_loan_refusal
				}
			}
			modifier = {
				factor = 3
				FROM = {
					OR = {
						has_character_flag = offended_moneylenders
						has_character_flag = has_had_loan_default
						has_character_flag = personal_loan_default
					}
				}
			}
			modifier = {
				factor = 3
				FROM = {
					OR = {
						trait = just
						trait = honorable
						trait = honest
						trait = charitable
						NOR = {
							trait = arbitrary
							trait = greedy
							trait = selfish
							trait = lunatic
							trait = possessed
						}
					}
				}
			}
			modifier = {
				factor = 0.25
				OR = {
					is_married = FROM
					is_close_relative = FROM
					is_friend = FROM
				}
			}
			modifier = {
				factor = 3
				war = yes
			}
			modifier = {
				factor = 2
				NOT = { is_liege_or_above = FROM }
			}
			modifier = {
				factor = 3
				trait = greedy
			}
			modifier = {
				factor = 3
				trait = paranoid
			}
			modifier = {
				factor = 1.5
				NOT = { opinion = { who = FROM value =  0 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = FROM value =  -25 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = FROM value =  -50 } }
			}
			modifier = {
				factor = 3
				NOT = { opinion = { who = FROM value =  -75 } }
			}
		}
		reverse_opinion = {
			modifier = refused_money_request
			who = FROM
			years = 5
		}
		hidden_tooltip = {
			FROM = { letter_event = { id = 38014 days = 1 } }
		}
	}
}

#Refusal to pay
letter_event = {
	id = 38014
	border = GFX_event_letter_frame_economy

	desc = {
		text = EVTDESC38014
		trigger = {
			NOT = { reverse_opinion = { who = FROM value = 0 } } #Dislike
		}
	}
	desc = {
		text = EVTDESC38014B
		trigger = {
			FROM = { trait = greedy }
		}
	}
	desc = {
		text = EVTDESC38014C
		trigger = {
			FROM = { war = yes }
		}
	}
	desc = {
		text = EVTDESC38014D
		trigger = {
			OR = {
				has_character_flag = offended_moneylenders
				has_character_flag = has_had_loan_default
				has_character_flag = personal_loan_refusal
				has_character_flag = personal_loan_default
			}
		}
	}
	desc = {
		text = EVTDESC38014E
		trigger = {
			NOT = { trait = just }
			NOT = { trait = honorable }
			NOT = { trait = honest }
			NOT = { trait = charitable }
			OR = {
				trait = arbitrary
				trait = greedy
				trait = selfish
				trait = lunatic
				trait = possessed
			}
		}
	}

	is_triggered_only = yes

	option = {
		name = OK
		clr_character_flag = vassal_loan_in_progress
	}
}

#Payment accepted
letter_event  = {
	id = 38015
	desc = EVTDESC38015
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = OK
		custom_tooltip = { text = TOOLTIP38015LOAN }
		if = {
			limit = { FROM = { has_character_flag = liege_loan_75 } }
			wealth = 75
		}
		if = {
			limit = { FROM = { has_character_flag = liege_loan_150 } }
			wealth = 150
		}
		if = {
			limit = { FROM = { has_character_flag = liege_loan_300 } }
			wealth = 300
		}
		if = {
			limit = { FROM = { has_character_flag = liege_loan_500 } }
			wealth = 500
		}
		if = {
			limit = { tier = EMPEROR }
			prestige = -50
		}
		if = {
			limit = { tier = KING }
			prestige = -40
		}
		if = {
			limit = { tier = DUKE }
			prestige = -30
		}
		if = {
			limit = { lower_tier_than = DUKE }
			prestige = -20
		}
		clr_character_flag = vassal_loan_in_progress
	}
}
#Payment accepted, for favor
character_event = {
	id = 38016
	desc = EVTDESC38016
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = OK
		custom_tooltip = { text = TOOLTIP38015LOAN }
		if = {
			limit = { FROM = { has_character_flag = liege_loan_75 } }
			wealth = 75
		}
		if = {
			limit = { FROM = { has_character_flag = liege_loan_150 } }
			wealth = 150
		}
		if = {
			limit = { FROM = { has_character_flag = liege_loan_300 } }
			wealth = 300
		}
		if = {
			limit = { FROM = { has_character_flag = liege_loan_500 } }
			wealth = 500
		}
		if = {
			limit = { tier = EMPEROR }
			prestige = -50
		}
		if = {
			limit = { tier = KING }
			prestige = -40
		}
		if = {
			limit = { tier = DUKE }
			prestige = -30
		}
		if = {
			limit = { lower_tier_than = DUKE }
			prestige = -20
		}
		clr_character_flag = vassal_loan_in_progress
		tooltip = { reverse_add_favor = FROM }
	}

}
# Personal loan is due
character_event = {
	id = bankruptcy.103
	desc = "EVTDESCbankruptcy.103"
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	has_character_flag = given_personal_loan

	trigger = {
		NOT = { has_character_modifier = liege_loan }
		OR = {
			NOT = { has_character_flag = liege_loan_in_progress }
			had_character_flag = { flag = liege_loan_in_progress days = 200 }
		}
	}

	immediate = {
		set_character_flag = liege_loan_in_progress
		clear_event_target = debtor_target
		#If liege was the person who took the loan, always make them the debtor regardless of title change
		liege = {
			if = {
				limit = { reverse_has_opinion_modifier = { who = ROOT modifier = opinion_liege_loan } }
				save_event_target_as = debtor_target
				primary_title = {
					ROOT = {
						clear_persistent_event_target = loan_title
						save_persistent_event_target = { name = loan_title scope = PREV }
					}
				}
				break = yes
			}
		}
		persistent_event_target:loan_title = {
			holder_scope = {
				save_event_target_as = debtor_target
				break = yes
			}
		}
		#If debtor is not found, try finding opinion target
		random_opinion_modifier_target = {
			limit = {
				is_ruler = yes
				reverse_has_opinion_modifier = { who = ROOT modifier = opinion_liege_loan }
			}
			save_event_target_as = debtor_target
			primary_title = {
				ROOT = {
					clear_persistent_event_target = loan_title
					save_persistent_event_target = { name = loan_title scope = PREV }
				}
			}
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.103"
		trigger = {
			event_target:debtor_target = { always = yes }
			NOR = {
				character = event_target:debtor_target
				war_with = event_target:debtor_target
				AND = {
					prisoner = yes
					host = { character = event_target:debtor_target }
				}
			}
		}
		ai_chance = {
			factor = 1
		}
		event_target:debtor_target = { letter_event = { id = bankruptcy.104 days = 4 tooltip = TOOLTIPbankruptcy.104 } }
	}

	option = {
		name = "EVTOPTBbankruptcy.103" #I can wait
		trigger = {
			event_target:debtor_target = { always = yes }
			NOR = {
				character = event_target:debtor_target
				war_with = event_target:debtor_target
				AND = {
					prisoner = yes
					host = { character = event_target:debtor_target }
				}
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				OR = {
					trait = greedy
					trait = ruthless
					liege = { NOT = { is_close_relative = ROOT } }
				}
			}
		}
		event_target:debtor_target = {
			if = {
				limit = { NOT = { is_close_relative = ROOT } }
				opinion = {
					who = ROOT
					modifier = opinion_extended_loan
					years = 2
				}
			}
			letter_event = { id = bankruptcy.109 days = 4 tooltip = TOOLTIPbankruptcy.109 }
		}
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			add_character_modifier = {
				name = "liege_loan"
				duration = "1825"
			}
			if = {
				limit = { NOT = { event_target:debtor_target = { reverse_has_opinion_modifier = { who = ROOT modifier = opinion_liege_loan } } } }
				event_target:debtor_target = {
					reverse_opinion = {
						who = ROOT
						modifier = opinion_liege_loan
						years = 100
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTCbankruptcy.103"
		trigger = { character = event_target:debtor_target }
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
	}
	option = {
		name = "EVTOPTDbankruptcy.103"
		trigger = { war_with = event_target:debtor_target }
		clr_character_flag = liege_loan_in_progress
		add_character_modifier = {
			name = "liege_loan"
			duration = "730"
		}
	}
	option = {
		name = "EVTOPTEbankruptcy.103"
		trigger = {
			prisoner = yes
			host = { character = event_target:debtor_target }
		}
		clr_character_flag = liege_loan_in_progress
		add_character_modifier = {
			name = "liege_loan"
			duration = "730"
		}
	}
	option = {
		name = "EVTOPTFbankruptcy.103"
		trigger = { NOT = { event_target:debtor_target = { always = yes } } }
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
	}
}
# Vassal calls in loan
letter_event = {
	id = bankruptcy.104
	border = GFX_event_letter_frame_economy

	desc = {
		text = "EVTDESCbankruptcy.104"
		trigger = { FROM = { NOT = { persistent_event_target:loan_title = { always = yes } } } }
	}
	desc = {
		text = "EVTDESCbankruptcy.104B"
		trigger = { FROM = { persistent_event_target:loan_title = { always = yes } } }
	}

	is_triggered_only = yes

	trigger = {
		FROM = { is_alive = yes }
	}

	option = {
		name = "EVTOPTAbankruptcy.104" # Return the money
		trigger = {
			OR = {
				AND = {
					FROM = { has_character_flag = liege_loan_75 }
					wealth = 93.75
				}
				AND = {
					FROM = { has_character_flag = liege_loan_150 }
					wealth = 187.5
				}
				AND = {
					FROM = { has_character_flag = liege_loan_300 }
					wealth = 375
				}
				AND = {
					FROM = { has_character_flag = liege_loan_500 }
					wealth = 625
				}
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				war = yes
			}
		}
		if = {
			limit = {
				FROM = {
					#has_character_flag = liege_loan_75
					NOT = { has_character_flag = liege_loan_150 }
					NOT = { has_character_flag = liege_loan_300 }
					NOT = { has_character_flag = liege_loan_500 }
				}
			}
			wealth = -93.75
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_150 }
			}
			wealth = -187.5
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_300 }
			}
			wealth = -375
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_500 }
			}
			wealth = -625
		}
		FROM = {
			letter_event = { id = bankruptcy.105 tooltip = TOOLTIPbankruptcy.105 }
		}
	}
	option = {
		name = "EVTOPTB38002" # Pay the interest
		trigger = {
			OR = {
				AND = {
					FROM = { has_character_flag = liege_loan_75 }
					wealth = 18.75
				}
				AND = {
					FROM = { has_character_flag = liege_loan_150 }
					wealth = 37.5
				}
				AND = {
					FROM = { has_character_flag = liege_loan_300 }
					wealth = 75
				}
				AND = {
					FROM = { has_character_flag = liege_loan_500 }
					wealth = 125
				}
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				war = no
				OR = {
					AND = {
						FROM = { has_character_flag = liege_loan_75 }
						wealth = 93.75
					}
					AND = {
						FROM = { has_character_flag = liege_loan_150 }
						wealth = 187.5
					}
					AND = {
						FROM = { has_character_flag = liege_loan_300 }
						wealth = 375
					}
					AND = {
						FROM = { has_character_flag = liege_loan_500 }
						wealth = 625
					}
				}
			}
		}
		if = {
			limit = {
				FROM = {
					#has_character_flag = liege_loan_75
					NOT = { has_character_flag = liege_loan_150 }
					NOT = { has_character_flag = liege_loan_300 }
					NOT = { has_character_flag = liege_loan_500 }
				}
			}
			wealth = -18.75
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_150 }
			}
			wealth = -37.5
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_300 }
			}
			wealth = -75
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_500 }
			}
			wealth = -125
		}
		FROM = {
			letter_event = { id = bankruptcy.106 tooltip = TOOLTIPbankruptcy.106 }
		}
	}
	option = {
		name = "EVTOPTC38002" # Cannot afford it
		trigger = {
			NOT = {
				OR = {
					AND = {
						FROM = { has_character_flag = liege_loan_75 }
						wealth = 18.75
					}
					AND = {
						FROM = { has_character_flag = liege_loan_150 }
						wealth = 37.5
					}
					AND = {
						FROM = { has_character_flag = liege_loan_300 }
						wealth = 75
					}
					AND = {
						FROM = { has_character_flag = liege_loan_500 }
						wealth = 125
					}
				}
			}
		}
		ai_chance = {
			factor = 1
		}
		if = {
			limit = {
				FROM = {
					#has_character_flag = liege_loan_75
					NOT = { has_character_flag = liege_loan_150 }
					NOT = { has_character_flag = liege_loan_300 }
					NOT = { has_character_flag = liege_loan_500 }
				}
			}
			prestige = -20
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_150 }
			}
			prestige = -40
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_300 }
			}
			prestige = -75
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_500 }
			}
			prestige = -125
		}
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_loan_default
				years = 5
			}
			letter_event = { id = bankruptcy.107 tooltip = TOOLTIPbankruptcy.107 }
		}
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_VASSAL_LOAN_DEFAULT
				portrait = [From.GetID]
			}
		}
	}
	option = {
		name = "EVTOPTD38002" # Get rid of them!
		ai_chance = {
			factor = 0.1
			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 0
				trait = honest
			}
			modifier = {
				factor = 0
				trait = charitable
			}
			modifier = {
				factor = 0
				NOT = {
					OR = {
						trait = arbitrary
						trait = greedy
						trait = selfish
						trait = lunatic
						trait = possessed
					}
				}
			}
		}
		if = {
			limit = {
				FROM = {
					#has_character_flag = liege_loan_75
					NOT = { has_character_flag = liege_loan_150 }
					NOT = { has_character_flag = liege_loan_300 }
					NOT = { has_character_flag = liege_loan_500 }
				}
			}
			prestige = -100
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_150 }
			}
			prestige = -200
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_300 }
			}
			prestige = -375
		}
		if = {
			limit = {
				FROM = { has_character_flag = liege_loan_500 }
			}
			prestige = -625
		}
		set_character_flag = personal_loan_refusal #makes less trustworthy for loans in future
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_cancelled_loan
				years = 15
			}
			letter_event = { id = bankruptcy.108 tooltip = TOOLTIPbankruptcy.108 }
		}
		change_variable = { which = "dishonorable" value = 10 }
		hidden_tooltip = { character_event = { id = maintenance.3 } } #dishonour trait
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_VASSAL_LOAN_DEFAULT
				portrait = [From.GetID]
			}
		}
	}
}
# Inform loan paid in full
letter_event = {
	id = bankruptcy.105
	desc = "EVTDESCbankruptcy.105"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.105"
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			remove_opinion = {
				who = FROM
				modifier = opinion_liege_loan
			}
		}
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		if = {
			limit = {
				#has_character_flag = liege_loan_75
				NOT = { has_character_flag = liege_loan_150 }
				NOT = { has_character_flag = liege_loan_300 }
				NOT = { has_character_flag = liege_loan_500 }
			}
			wealth = 93.75
			clr_character_flag = liege_loan_75
		}
		if = {
			limit = {
				has_character_flag = liege_loan_150
			}
			wealth = 187.5
			clr_character_flag = liege_loan_150
		}
		if = {
			limit = {
				has_character_flag = liege_loan_300
			}
			wealth = 375
			clr_character_flag = liege_loan_300
		}
		if = {
			limit = {
				has_character_flag = liege_loan_500
			}
			wealth = 625
			clr_character_flag = liege_loan_500
		}
	}
}
# Inform interest paid
letter_event = {
	id = bankruptcy.106
	desc = "EVTDESCbankruptcy.106"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.106"
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			add_character_modifier = {
				name = "liege_loan"
				duration = "1825"
			}
			if = {
				limit = { NOT = { has_opinion_modifier = { who = FROM modifier = opinion_liege_loan } } }
				opinion = {
					who = FROM
					modifier = opinion_liege_loan
					years = 100
				}
			}
		}
		clr_character_flag = liege_loan_in_progress
		if = {
			limit = {
				#has_character_flag = liege_loan_75
				NOT = { has_character_flag = liege_loan_150 }
				NOT = { has_character_flag = liege_loan_300 }
				NOT = { has_character_flag = liege_loan_500 }
			}
			wealth = 18.75
		}
		if = {
			limit = {
				has_character_flag = liege_loan_150
			}
			wealth = 37.5
		}
		if = {
			limit = {
				has_character_flag = liege_loan_300
			}
			wealth = 75
		}
		if = {
			limit = {
				has_character_flag = liege_loan_500
			}
			wealth = 125
		}
	}
}
# Inform loan default
letter_event = {
	id = bankruptcy.107
	desc = "EVTDESCbankruptcy.107"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	immediate = {
		remove_character_modifier = liege_loan
		add_character_modifier = {
			name = "liege_loan"
			duration = "1825"
		}
		if = {
			limit = { NOT = { has_opinion_modifier = { who = FROM modifier = opinion_liege_loan } } }
			opinion = {
				who = FROM
				modifier = opinion_liege_loan
				years = 100
			}
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.107"
		ai_chance = {
			factor = 0.1
		}
		FROM = { set_character_flag = personal_loan_default } #makes less trustworthy for loans in future
		clr_character_flag = liege_loan_in_progress
	}

	option = {
		name = "EVTOPTBbankruptcy.107" #Ask for land instead
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.005
				NOT = {
					OR = { #Only high value loans
						has_character_flag = liege_loan_300
						has_character_flag = liege_loan_500
					}
				}
			}
		}
		trigger = {
			OR = {
				is_ruler = yes
				can_press_claims_trigger = yes
			}
			FROM = {
				same_realm = ROOT
				demesne_size = 2
				any_demesne_title = {
					lower_tier_than = DUKE
					can_be_given_away = yes
					NOT = { is_primary_holder_title = yes }
					NOT = {
						AND = {
							tier = count
							location = { is_capital = yes }
						}
					}
					NOT = { title = c_bloody_gate }
					OR = {
						NOT = { title = c_dragonstone }
						NOT = { holder_scope = { has_landed_title = e_iron_throne } }
					}
					OR = {
						ROOT = { NOT = { tier = BARON } }
						tier = BARON
						holder_scope = { higher_tier_than = COUNT }
					}
				}
			}
		}
		FROM = { letter_event = { id = bankruptcy.500 tooltip = TOOLTIPbankruptcy.500 } }
	}

	option = {
		name = "EVTOPTCbankruptcy.107" #Ask to lower crown authority
		ai_chance = {
			factor = 50
		}
		trigger = {
			FROM = {
				higher_tier_than = DUKE
				is_liege_of = ROOT
			}
			OR = {
				in_faction = faction_lower_crown_authority
				leads_faction = faction_lower_crown_authority
			}
		}
		FROM = { letter_event = { id = bankruptcy.503 tooltip = TOOLTIPbankruptcy.503 } }
	}

	option = {
		name = "EVTOPTDbankruptcy.107" #Ask to raise faith authority
		ai_chance = {
			factor = 9999
		}
		trigger = {
			has_landed_title = k_the_most_devout
			FROM = {
				any_demesne_title = {
					higher_tier_than = DUKE
					is_titular = no
					NOT = { has_law = investiture_law_3 }
				}
			}
		}
		FROM = { letter_event = { id = bankruptcy.507 tooltip = TOOLTIPbankruptcy.507 } }
	}

	option = {
		name = "EVTOPTEbankruptcy.107" #Ask for a favour instead
		trigger = {
			has_dlc = "Zeus"
			NOT = { holds_favor_on = FROM }
		}
		ai_chance = {
			factor = 0.1

			modifier = {
				factor = 0.25
				OR = { #high value loans
					has_character_flag = liege_loan_300
					has_character_flag = liege_loan_500
				}
			}
			modifier = {
				factor = 0
				trait = greedy
			}
			modifier = {
				factor = 0
				trait = diligent
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 1.5
				opinion = { who = FROM value =  25 }
			}
			modifier = {
				factor = 2
				opinion = { who = FROM value =  50 }
			}
			modifier = {
				factor = 3
				opinion = { who = FROM value =  75 }
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = FROM value =  0 } }
			}
		}
		FROM = { letter_event = { id = bankruptcy.511 tooltip = TOOLTIPbankruptcy.511 } }
	}
}
# Inform loan cancelled
letter_event = {
	id = bankruptcy.108
	desc = "EVTDESCbankruptcy.108"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.108"
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			remove_opinion = {
				who = FROM
				modifier = opinion_liege_loan
			}
		}
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		if = {
			limit = {
				#has_character_flag = liege_loan_75
				NOT = { has_character_flag = liege_loan_150 }
				NOT = { has_character_flag = liege_loan_300 }
				NOT = { has_character_flag = liege_loan_500 }
			}
			prestige = -40
			clr_character_flag = liege_loan_75
		}
		if = {
			limit = {
				has_character_flag = liege_loan_150
			}
			prestige = -75
			clr_character_flag = liege_loan_150
		}
		if = {
			limit = {
				has_character_flag = liege_loan_300
			}
			prestige = -150
			clr_character_flag = liege_loan_300
		}
		if = {
			limit = {
				has_character_flag = liege_loan_500
			}
			prestige = -250
			clr_character_flag = liege_loan_500
		}
	}
}
# Inform debtor vassal extends loan
letter_event = {
	id = bankruptcy.109
	desc = "EVTDESCbankruptcy.109"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.109"
	}
}
# Vassal offers to cancel debt in exchange for land
letter_event = {
	id = bankruptcy.500
	desc = "EVTDESCbankruptcy.500"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.500" #Accept
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0.4
				FROM = { has_character_flag = liege_loan_150	}
			}
			modifier = {
				factor = 0.2
				FROM = { has_character_flag = liege_loan_75	}
			}
			modifier = {
				factor = 0.5
				OR = {
					trait = wroth
					trait = selfish
					trait = lunatic
					trait = possessed
					trait = proud
					trait = greedy
					trait = arbitrary
				}
			}
		}
		random_demesne_title = {
			limit = {
				lower_tier_than = DUKE
				can_be_given_away = yes
				NOT = { is_primary_holder_title = yes }
				NOT = {
					AND = {
						tier = count
						location = { is_capital = yes }
					}
				}
				NOT = { title = c_bloody_gate }
				OR = {
					NOT = { title = c_dragonstone }
					NOT = { holder_scope = { has_landed_title = e_iron_throne } }
				}
				OR = {
					FROM = { NOT = { tier = BARON } }
					tier = BARON
					holder_scope = { higher_tier_than = COUNT }
				}
			}
			hidden_tooltip = { save_event_target_as = loan_title }
			gain_title = FROM
		}
		FROM = {
			remove_opinion = {
				who = ROOT
				modifier = opinion_loan_default
			}
			letter_event = { id = bankruptcy.501 tooltip = TOOLTIPbankruptcy.501 }
		}
	}
	option = {
		name = "EVTOPTBbankruptcy.500" #Reject
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				FROM = {
					OR = { #Only high value loans
						has_character_flag = liege_loan_300
						has_character_flag = liege_loan_500
					}
				}
				NOT = {
					OR = {
						trait = wroth
						trait = selfish
						trait = lunatic
						trait = possessed
						trait = proud
						trait = greedy
						trait = arbitrary
					}
				}
			}
		}
		set_character_flag = personal_loan_default #makes less trustworthy for loans in future
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_loan_default
				years = 5
				multiplier = 0.5
			}
			hidden_tooltip = { letter_event = { id = bankruptcy.502 } }
		}
	}
}
# Inform land offer accepted
letter_event = {
	id = bankruptcy.501
	desc = "EVTDESCbankruptcy.501"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.501"
		tooltip = { event_target:loan_title = { gain_title = ROOT } }
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			remove_opinion = {
				who = FROM
				modifier = opinion_liege_loan
			}
			clear_event_target = loan_title
		}
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
	}
}
# Inform land offer rejected
letter_event = {
	id = bankruptcy.502
	desc = "EVTDESCbankruptcy.502"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.502"
		clr_character_flag = liege_loan_in_progress
	}
}
# Vassal offers to cancel debt in exchange for lowering crown authority
letter_event = {
	id = bankruptcy.503
	desc = "EVTDESCbankruptcy.503"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.503" #Accept
		ai_chance = {
			factor = 1
		}
		hidden_tooltip = {
			random_vassal = {
				limit = { leads_faction = faction_lower_crown_authority }
				opinion = {
					modifier = opinion_lowered_crown_authority
					who = ROOT
					months = 12
				}
			}
		}
		any_demesne_title = {
			limit = {
				higher_tier_than = DUKE
				is_titular = no
				NOT = { has_law = centralization_0 }
				FROM = { #I must have land in the title or it is my crownlaw title
					OR = {
						crownlaw_title = { title = PREVPREV }
						any_demesne_title = { de_jure_liege_or_above = PREVPREV }
					}
				}
			}
			if = {
				limit = { has_law = centralization_1 }
				add_law = centralization_0
			}
			if = {
				limit = { has_law = centralization_2 }
				add_law = centralization_1
			}
			if = {
				limit = { has_law = centralization_3 }
				add_law = centralization_2
			}
			if = {
				limit = { has_law = centralization_4 }
				add_law = centralization_3
			}
		}
		FROM = {
			remove_opinion = {
				who = ROOT
				modifier = opinion_loan_default
			}
			letter_event = { id = bankruptcy.504 tooltip = TOOLTIPbankruptcy.501 }
		}
	}
	option = {
		name = "EVTOPTBbankruptcy.503" #Reject
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				NOT = {
					OR = {
						trait = wroth
						trait = selfish
						trait = lunatic
						trait = possessed
						trait = proud
						trait = greedy
						trait = arbitrary
					}
				}
			}
		}
		set_character_flag = personal_loan_default #makes less trustworthy for loans in future
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_loan_default
				years = 5
				multiplier = 0.5
			}
			hidden_tooltip = { letter_event = { id = bankruptcy.505 } }
		}
	}
}
# Inform CA offer accepted
letter_event = {
	id = bankruptcy.504
	desc = "EVTDESCbankruptcy.504"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.504"
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			remove_opinion = {
				who = FROM
				modifier = opinion_liege_loan
			}
			FROM = {
				any_realm_lord = {
					limit = {
						ai = no
						NOT = { character = ROOT }
					}
					character_event = { id = bankruptcy.506 }
				}
			}
		}
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
	}
}
# Inform CA offer rejected
letter_event = {
	id = bankruptcy.505
	desc = "EVTDESCbankruptcy.505"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.502"
		clr_character_flag = liege_loan_in_progress
	}
}
# Inform realm CA
character_event = {
	id = bankruptcy.506
	desc = "EVTDESCbankruptcy.506"
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	show_from_from = yes

	option = {
		name = "EVTOPTAbankruptcy.506"
	}
}
# High Septon offers to cancel debt in exchange for raising faith authority
letter_event = {
	id = bankruptcy.507
	desc = "EVTDESCbankruptcy.507"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.507" #Accept
		ai_chance = {
			factor = 1
		}
		any_demesne_title = {
			limit = {
				higher_tier_than = DUKE
				is_titular = no
				NOT = { has_law = investiture_law_3 }
			}
			if = {
				limit = { has_law = investiture_law_2 }
				add_law = investiture_law_3
			}
			if = {
				limit = {
					OR = {
						has_law = investiture_law_1
						has_law = investiture_law_0
					}
				}
				add_law = investiture_law_2
			}
		}
		piety = 250
		FROM = {
			remove_opinion = {
				who = ROOT
				modifier = opinion_loan_default
			}
			if = {
				limit = {
					has_opinion_modifier = {
						who = ROOT
						modifier = coronation_rejected
					}
				}
				remove_opinion = {
					who = ROOT
					modifier = coronation_rejected
				}
			}
			letter_event = { id = bankruptcy.508 tooltip = TOOLTIPbankruptcy.501 }
		}
	}
	option = {
		name = "EVTOPTBbankruptcy.507" #Reject
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				NOT = {
					OR = {
						trait = wroth
						trait = selfish
						trait = lunatic
						trait = possessed
						trait = proud
						trait = greedy
						trait = arbitrary
					}
				}
			}
		}
		piety = -250
		set_character_flag = personal_loan_default #makes less trustworthy for loans in future
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_loan_default
				years = 5
				multiplier = 0.5
			}
			hidden_tooltip = { letter_event = { id = bankruptcy.509 } }
		}
	}
}
# Inform faith authority offer accepted
letter_event = {
	id = bankruptcy.508
	desc = "EVTDESCbankruptcy.508"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.508"
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			remove_opinion = {
				who = FROM
				modifier = opinion_liege_loan
			}
			FROM = {
				any_realm_lord = {
					limit = {
						ai = no
						NOT = { character = ROOT }
					}
					character_event = { id = bankruptcy.510 }
				}
			}
		}
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
	}
}
# Inform faith authorityoffer rejected
letter_event = {
	id = bankruptcy.509
	desc = "EVTDESCbankruptcy.509"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.509"
		clr_character_flag = liege_loan_in_progress
	}
}
# Inform realm faith authority
character_event = {
	id = bankruptcy.510
	desc = "EVTDESCbankruptcy.510"
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.510"
	}
}

# Vassal offers to cancel debt in exchange for a favor
letter_event = {
	id = bankruptcy.511
	desc = "EVTDESCbankruptcy.511"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.511" #Accept
		ai_chance = {
			factor = 1
		}
		FROM = {
			tooltip = { add_favor = ROOT }
			remove_opinion = {
				who = ROOT
				modifier = opinion_loan_default
			}
			letter_event = { id = bankruptcy.512 tooltip = TOOLTIPbankruptcy.501 }
		}
	}
	option = {
		name = "EVTOPTBbankruptcy.500" #Reject
		ai_chance = {
			factor = 0
		}
		set_character_flag = personal_loan_default #makes less trustworthy for loans in future
		FROM = {
			opinion = {
				who = ROOT
				modifier = opinion_loan_default
				years = 5
				multiplier = 0.5
			}
			hidden_tooltip = { letter_event = { id = bankruptcy.513 } }
		}
	}
}
# Inform offer accepted
letter_event = {
	id = bankruptcy.512
	desc = "EVTDESCbankruptcy.512"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.501"
		add_favor = FROM
		hidden_tooltip = {
			remove_character_modifier = liege_loan
			remove_opinion = {
				who = FROM
				modifier = opinion_liege_loan
			}
		}
		clr_character_flag = given_personal_loan
		clear_persistent_event_target = loan_title
		clr_character_flag = liege_loan_in_progress
		clr_character_flag = liege_loan_75
		clr_character_flag = liege_loan_150
		clr_character_flag = liege_loan_300
		clr_character_flag = liege_loan_500
	}
}
# Inform offer rejected
letter_event = {
	id = bankruptcy.513
	desc = "EVTDESCbankruptcy.513"
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.502"
		clr_character_flag = liege_loan_in_progress
	}
}


#Ruler is in the red. Seize Church Properties
character_event = {
	id = 38020
	desc = EVTDESC38020
	picture = GFX_evt_pope_feast
	border = GFX_event_normal_frame_economy

	only_playable = yes
	prisoner = no

	trigger = {
		NOT = { wealth = -1 }
		NOT = { has_character_flag = stolen_church_properties }
		NOT = { trait = zealous }
		any_vassal = {
			is_theocracy = yes
			religion = ROOT
		}
		is_unorganised_religion_trigger = no
	}

	mean_time_to_happen = {
		months = 48
	}

	option = {
		name = EVTOPTA38020 # There are fat bishop, seize them !
		trigger = {
			any_vassal = {
				is_theocracy = yes
				religion = ROOT
				any_demesne_title = {
					tier = baron
					num_of_buildings = 3
				}
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				NOR = {
					trait = cynical
					trait = selfish
					trait = greedy
					trait = ruthless
				}
			}
			modifier = {
				factor = 0
				OR = {
					trait = honorable
					trait = just
					trait = patient
				}
			}
		}
		random_vassal = {
			limit = {
				is_theocracy = yes
				any_demesne_title = {
					tier = baron
					num_of_buildings = 3
				}
			}

			character_event = { id = 38021 days = 1 tooltip = EVTTOOLTIP38021 }
			opinion = {
				who = ROOT
				modifier = opinion_arrest_attempt
				months = 240
			}
			imprison = yes
		}
		wealth = 250
		piety = -250
		change_variable = { which = "tyrant" value = 15 }
		character_event = { id = maintenance.1 } #tyrant trait
		if = {
			limit = {
				NOT = { trait = ruthless }
				NOT = { trait = honorable }
				NOT = { personality_traits = 6 }
			}
			add_trait = ruthless
		}
		set_character_flag = stolen_church_properties
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_SEIZED_FAITH_PROPERTY
			}
		}
	}
	option = {
		name = EVTOPTB38020 # Time are harsh, force them to share the costs !
		wealth = 100
		piety = -100
		change_variable = { which = "tyrant" value = 5 }
		character_event = { id = maintenance.1 } #tyrant trait
		random = {
			chance = 25
			random_vassal = {
				limit = {
					is_theocracy = yes
					religion = ROOT
				}
				character_event = { id = 38021 days = 1 tooltip = EVTTOOLTIP38021 }
			}
		}
		set_character_flag = stolen_church_properties
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_SEIZED_FAITH_PROPERTY
			}
		}
	}
	option = {
		name = EVTOPTC38020 # Compromise with them to find money !
		wealth = 50
		piety = 25
		prestige = -50
		set_character_flag = stolen_church_properties
	}
	option = {
		name = EVTOPTD38020 # Never ! I will save my Christian soul !
		piety = 50
		if = {
			limit = {
				NOT = { trait = zealous }
				NOT = { trait = cynical }
				NOT = { personality_traits = 6 }
			}
			change_stewardship = -1
			add_trait = zealous
		}
		set_character_flag = stolen_church_properties
	}
}

#If a building is specified, then that one is exempt
character_event = {
	id = 38021
	desc = EVTDESC38021
	picture = GFX_evt_lunatic
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		random_demesne_title = {
			limit = {
				tier = baron
				num_of_buildings = 3
			}
			destroy_random_building = yes
		}
		wealth = -100
	}

	option = {
		name = EVTOPTA38021 # They are cursed in the eyes of God!
		trigger = { religion = the_seven }
		ai_chance = {
			factor = 1
			modifier = {
				factor = 10
				NOT = { opinion = { who = FROM value =  50 } }
			}
			modifier = {
				factor = 10
				trait = zealous
			}
			modifier = {
				factor = 100
				prisoner = yes
			}
		}
		FROM = { character_event = { id = 38022 days = 63 tooltip = EVTTOOLTIP38022 } }
	}
	option = {
		name = EVTOPTB38021 # Jesus said to forgive them for their sins.
		ai_chance = {
			factor = 1
			modifier = {
				factor = 2
				trait = kind
			}
			modifier = {
				factor = 1.5
				trait = humble
			}
			modifier = {
				factor = 0
				prisoner = yes
			}
		}
		opinion = {
			modifier = grudge_from_sin
			who = ROOT
			years = 5
		}
	}
}

#We have been judged in the eyes of God
character_event = {
	id = 38022
	desc = EVTDESC38022
	picture = GFX_evt_bad_news
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	only_rulers = yes

	trigger = { has_character_flag = stolen_church_properties }

	option = {
		name = EVTOPTA38022
		excommunicate_effect = yes
		piety = -50
	}
}

#Ruler is in the red. Raise harsh tax
character_event = {
	id = 38023
	desc = EVTDESC38023
	picture = GFX_evt_pope_feast
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	only_playable = yes
	prisoner = no

	trigger = {
		NOT = { wealth = -25 }
		higher_tier_than = COUNT
		capital_scope = { NOT = { has_province_modifier = high_taxes } }
		NOT = { trait = charitable }
		job_treasurer = {
			stewardship = 15
			NOT = { trait = just }
			NOT = { trait = charitable }
		}
	}

	option = {
		name = EVTOPTA38023 # Yes!
		ai_chance = {
			factor = 25
			modifier = {
				factor = 6
				trait = greedy
			}
			modifier = {
				factor = 2.5
				trait = ruthless
			}
			modifier = {
				factor = 2.5
				trait = selfish
			}
			modifier = {
				factor = 2.5
				trait = cruel
			}
			modifier = {
				factor = 2.5
				trait = arbitrary
			}
			modifier = {
				factor = 2.5
				trait = wroth
			}


			modifier = {
				factor = 0.25
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = kind
			}
			modifier = {
				factor = 0.25
				trait = just
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
		}
		scaled_wealth = { value = 0.5 min = 25 }
		custom_tooltip = {
			text = TOOLTIP38023
			any_vassal = {
				if = {
					limit = { ai = yes }
					scaled_wealth = { value = -0.2 }
				}
				else = {
					character_event = { id = 38024 }
				}
			}
		}
		capital_scope = {
			add_province_modifier = {
				name = high_taxes
				duration = 1825
			}
		}
		change_variable = { which = "tyrant" value = 15 }
		hidden_tooltip = { character_event = { id = maintenance.1 } } #tyrant trait
	}
	option = {
		name = EVTOPTB38023 # No
		ai_chance = {
			factor = 75
		}
	}
}
character_event = { #Inform vassal
	id = 38024
	desc = EVTDESC38024
	picture = GFX_evt_pope_feast
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTA38024
		scaled_wealth = { value = -0.2 }
		tooltip = {
			FROM = {
				change_variable = { which = "tyrant" value = 15 }
			}
		}
	}
}
#On-Action: Mercs go on a rampage
letter_event = {
	id = 38050
	desc = EVTDESC38050

	is_triggered_only = yes

	ai = no

	option = {
		name = EVTOPTA38050
		chronicle = {
			entry = CHRONICLE_MERC_RAMPAGE
			portrait = [From.GetID]
		}
	}
}

#On-Action: Mercs leave in disgust
letter_event = {
	id = 38051
	desc = EVTDESC38051

	is_triggered_only = yes

	ai = no

	option = {
		name = EVTOPTA38051
		chronicle = {
			entry = CHRONICLE_MERC_LEAVE
			portrait = [From.GetID]
		}
	}
}

#On-Action: Mercs switch side FROM you
letter_event = {
	id = 38052
	desc = EVTDESC38052

	is_triggered_only = yes

	ai = no

	option = {
		name = EVTOPTA38052
		chronicle = {
			entry = CHRONICLE_MERC_BETRAY
			portrait = [From.GetID]
		}
	}
}

#On-Action: Mercs switch side TO you
letter_event = {
	id = 38053
	desc = EVTDESC38053

	is_triggered_only = yes

	ai = no

	option = {
		name = EVTOPTA38053
		chronicle = {
			entry = CHRONICLE_MERC_DEFECT_TO_ME
			portrait = [From.GetID]
		}
	}
}

#On-Action: Holy Order leaves your service
letter_event = {
	id = 38054
	desc = EVTDESC38054
	border = GFX_event_letter_frame_war

	is_triggered_only = yes

	ai = no

	option = {
		name = EVTOPTA38054
	}
}


# Offer to buy a title from indebted liege
character_event = {
	id = 38069

	only_playable = yes
	prisoner = no
	only_capable = yes
	min_age = 16
	hide_window = yes

	trigger = {
		is_nomadic = no
		wealth < 0
		any_demesne_title = {
			can_be_given_away = yes
			NAND = {
				tier = COUNT
				location = { is_capital = yes }
			}
			NAND = {
				tier = BARON
				holding_type = temple
			}
			NOT = { higher_tier_than = DUKE }
			NOT = { location = { has_province_flag = colony_province } }
			NOT = { has_title_flag = military_command }
			NOT = { title = c_ghastongrey } #no-one wants this crappy rock
			NAND = { #is not valyrian colony
				has_law = valyria_colony
				holder_scope = { top_liege = { is_valyrian_freehold_trigger = yes } }
			}
		}
	}

	mean_time_to_happen = {
		months = 60

		modifier = {
			factor = 0.75
			NOT = { wealth = -50 }
		}
		modifier = {
			factor = 0.75
			NOT = { wealth = -75 }
		}
		modifier = {
			factor = 0.75
			NOT = { wealth = -100 }
		}
		modifier = {
			factor = 0.75
			NOT = { wealth = -125 }
		}
	}

	immediate = {
		random_courtier_or_vassal = {
			limit = {
				prisoner = no
				is_incapable = no
				age = 16
				is_nomadic = no
				wealth = 250
				can_press_claims_trigger = yes
				liege = { character = ROOT }
				OR = {
					is_ruler = no
					is_feudal = yes
					is_patrician = yes
					higher_tier_than = BARON
				}
				NOT = { has_character_flag = loan_taken }
				ROOT = {
					any_demesne_title = {
						can_be_given_away = yes
						NAND = {
							tier = COUNT
							location = { is_capital = yes }
						}
						NAND = {
							tier = BARON
							holding_type = temple
						}
						NOT = { higher_tier_than = DUKE }
						NOT = { location = { has_province_flag = colony_province } }
						NOT = { has_title_flag = military_command }
						NOT = { title = c_ghastongrey } #no-one wants this crappy rock
						NAND = { #is not valyrian colony
							has_law = valyria_colony
							holder_scope = { top_liege = { is_valyrian_freehold_trigger = yes } }
						}
						OR = {
							AND = {
								PREVPREV = { is_ruler = yes }
								OR = {
									de_jure_liege_or_above = PREVPREV
									has_de_jure_pretension = PREVPREV
								}
							}
							AND = {
								PREVPREV = { is_ruler = no }
								lower_tier_than = DUKE
							}
						}
					}
				}
			}
			character_event = { id = 38060 }
		}
	}

	option = {
		name = OK
	}
}
character_event = {
	id = 38060
	desc = EVTDESC38060
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		liege = {
			random_demesne_title = {
				limit = {
					can_be_given_away = yes
					NAND = {
						tier = COUNT
						location = { is_capital = yes }
					}
					NAND = {
						tier = BARON
						holding_type = temple
					}
					NOT = { higher_tier_than = DUKE }
					NOT = { location = { has_province_flag = colony_province } }
					NOT = { has_title_flag = military_command }
					NOT = { title = c_ghastongrey } #no-one wants this crappy rock
					NAND = { #is not valyrian colony
						has_law = valyria_colony
						holder_scope = { top_liege = { is_valyrian_freehold_trigger = yes } }
					}
					OR = {
						AND = {
							PREVPREV = { is_ruler = yes }
							OR = {
								de_jure_liege_or_above = PREVPREV
								has_de_jure_pretension = PREVPREV
							}
						}
						AND = {
							PREVPREV = { is_ruler = no }
							lower_tier_than = DUKE
						}
					}
				}
				save_event_target_as = title_for_sale
				if = {
					limit = {
						tier = COUNT
						any_direct_de_jure_vassal_title = { base_value_6_trigger = yes }
					}
					set_title_flag = sale_title_value_400
					break = yes
				}
				if = {
					limit = {
						OR = {
							tier = DUKE
							AND = {
								tier = COUNT
								any_direct_de_jure_vassal_title = { base_value_5_trigger = yes }
							}
						}
					}
					set_title_flag = sale_title_value_325
					break = yes
				}
				if = {
					limit = {
						OR = {
							AND = {
								tier = COUNT
								any_direct_de_jure_vassal_title = { base_value_4_trigger = yes }
							}
							AND = {
								tier = BARON
								base_value_6_trigger = yes
							}
						}
					}
					set_title_flag = sale_title_value_250
					break = yes
				}
				if = {
					limit = {
						OR = {
							AND = {
								tier = COUNT
								any_direct_de_jure_vassal_title = { base_value_3_trigger = yes }
							}
							AND = {
								tier = BARON
								base_value_5_trigger = yes
							}
						}
					}
					set_title_flag = sale_title_value_200
					break = yes
				}
				if = {
					limit = {
						OR = {
							tier = COUNT
							AND = {
								tier = BARON
								base_value_3_trigger = yes
							}
						}
					}
					set_title_flag = sale_title_value_150
					break = yes
				}
				set_title_flag = sale_title_value_100
			}
		}
	}

	option = {
		trigger = {
			has_dlc = "Zeus"
			NOT = {
				liege = { owes_favor_to = ROOT }
			}
		}
		name = EVTOPTC38060
		ai_chance = { factor = 100 }
		liege = {
			character_event = { id = 38062 days = 1 tooltip = EVTTOOLTIP38061 }
			tooltip = {
				event_target:title_for_sale = {
					grant_title = ROOT
					if = {
						limit = { has_title_flag = sale_title_value_400 }
						ROOT = { wealth = -400 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_325 }
						ROOT = { wealth = -325 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_250 }
						ROOT = { wealth = -250 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_200 }
						ROOT = { wealth = -200 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_150 }
						ROOT = { wealth = -150 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_100 }
						ROOT = { wealth = -100 }
					}
				}
				ROOT = { add_favor = PREV }
			}
		}
	}

	option = {
		name = EVTOPTA38060
		ai_chance = { factor = 100 }
		liege = {
			character_event = { id = 38061 days = 1 tooltip = EVTTOOLTIP38061 }
			tooltip = {
				event_target:title_for_sale = {
					grant_title = ROOT
					if = {
						limit = { has_title_flag = sale_title_value_400 }
						ROOT = { wealth = -400 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_325 }
						ROOT = { wealth = -325 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_250 }
						ROOT = { wealth = -250 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_200 }
						ROOT = { wealth = -200 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_150 }
						ROOT = { wealth = -150 }
					}
					if = {
						limit = { has_title_flag = sale_title_value_100 }
						ROOT = { wealth = -100 }
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTB38060
		ai_chance = { factor = 0 }
	}
}

# Liege receives offer to sell land
character_event = {
	id = 38061
	desc = EVTDESC38061
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTA38061
		ai_chance = { factor = 100 }
		event_target:title_for_sale = {
			if = {
				limit = { has_title_flag = sale_title_value_400 }
				ROOT = { wealth = 400 }
				FROM = { wealth = -400 }
				clr_title_flag = sale_title_value_400
			}
			if = {
				limit = { has_title_flag = sale_title_value_325 }
				ROOT = { wealth = 325 }
				FROM = { wealth = -325 }
				clr_title_flag = sale_title_value_325
			}
			if = {
				limit = { has_title_flag = sale_title_value_250 }
				ROOT = { wealth = 250 }
				FROM = { wealth = -250 }
				clr_title_flag = sale_title_value_250
			}
			if = {
				limit = { has_title_flag = sale_title_value_200 }
				ROOT = { wealth = 200 }
				FROM = { wealth = -200 }
				clr_title_flag = sale_title_value_200
			}
			if = {
				limit = { has_title_flag = sale_title_value_150 }
				ROOT = { wealth = 150 }
				FROM = { wealth = -150 }
				clr_title_flag = sale_title_value_150
			}
			if = {
				limit = { has_title_flag = sale_title_value_100 }
				ROOT = { wealth = 100 }
				FROM = { wealth = -100 }
				clr_title_flag = sale_title_value_100
			}
			grant_title = FROM
		}
	}
	option = {
		name = EVTOPTB38061
		ai_chance = { factor = 0 }
	}
}
# Liege receives offer to sell land for favor
character_event = {
	id = 38062
	desc = EVTDESC38062
	picture = GFX_evt_council
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTA38062
		ai_chance = { factor = 100 }
		event_target:title_for_sale = {
			if = {
				limit = { has_title_flag = sale_title_value_400 }
				ROOT = { wealth = 400 }
				FROM = { wealth = -400 }
				clr_title_flag = sale_title_value_400
			}
			if = {
				limit = { has_title_flag = sale_title_value_325 }
				ROOT = { wealth = 325 }
				FROM = { wealth = -325 }
				clr_title_flag = sale_title_value_325
			}
			if = {
				limit = { has_title_flag = sale_title_value_250 }
				ROOT = { wealth = 250 }
				FROM = { wealth = -250 }
				clr_title_flag = sale_title_value_250
			}
			if = {
				limit = { has_title_flag = sale_title_value_200 }
				ROOT = { wealth = 200 }
				FROM = { wealth = -200 }
				clr_title_flag = sale_title_value_200
			}
			if = {
				limit = { has_title_flag = sale_title_value_150 }
				ROOT = { wealth = 150 }
				FROM = { wealth = -150 }
				clr_title_flag = sale_title_value_150
			}
			if = {
				limit = { has_title_flag = sale_title_value_100 }
				ROOT = { wealth = 100 }
				FROM = { wealth = -100 }
				clr_title_flag = sale_title_value_100
			}
			grant_title = FROM
		}
		FROM = {
			add_favor = ROOT
		}
	}
	option = {
		name = EVTOPTB38062
		ai_chance = { factor = 0 }
	}
}
###New Iron Bank Events
#Iron bank funds you against indebted enemy
character_event = {
	id = bankruptcy.100
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	desc = {
		text = "EVTDESCbankruptcy.100"
		trigger = { NOT = { character = FROM } }
	}
	desc = {
		text = "EVTDESCbankruptcy.100B" #Recoverer is funding own claim
		trigger = { character = FROM }
	}

	is_triggered_only = yes

	immediate = {
		set_variable = { which = insurance_loan which = FROM }
	}

	option = { #Funding against enemy
		name = {
			text = "EVTOPTAbankruptcy.100"
			trigger = { NOT = { character = FROM } }
		}
		name = {
			text = "EVTOPTAbankruptcy.100B"
			trigger = { character = FROM }
		}
		ai_chance = {
			factor = 60

			modifier = {
				factor = 4
				has_character_modifier = planning_claimant_adventure
			}
			modifier = {
				factor = 2
				war_with = event_target:debtor_target
			}
			modifier = {
				factor = 0
				vassal_of = event_target:debtor_target
				opinion = { who = event_target:debtor_target value = 50 }
				NOT = { trait = ruthless }
				NOT = { trait = lunatic }
			}
			modifier = {
				factor = 0.66
				event_target:debtor_target = { reverse_opinion = { who = ROOT value = 30 } }
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 0.66
				event_target:debtor_target = { reverse_opinion = { who = ROOT value = 10 } }
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { NOT = { reverse_opinion = { who = ROOT value = -30 } } }
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { NOT = { reverse_opinion = { who = ROOT value = -50 } } }
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { NOT = { reverse_opinion = { who = ROOT value = -70 } } }
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { NOT = { reverse_opinion = { who = ROOT value = -90 } } }
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 0
				trait = honorable
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}
			modifier = {
				factor = 0.25
				trait = content
				NOT = { war_with = event_target:debtor_target }
				NOT = { has_character_modifier = planning_claimant_adventure }
			}

			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 4
				trait = just
				OR = {
					war_with = event_target:debtor_target
					has_character_modifier = planning_claimant_adventure
					event_target:debtor_target = {
						primary_title = { ROOT = { has_claim = PREV } }
						NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = opinion_fought_for_claimant } }
						OR = {
							AND = {
								trait = bastard
								ROOT = { NOT = { trait = bastard } }
							}
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_suspected_bastard }
							AND = {
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_usurped_title }
								primary_title = { any_previous_holder = { character = ROOT } }
							}
						}
					}
				}
			}
			modifier = {
				factor = 0
				trait = just
				NOR = {
					war_with = event_target:debtor_target
					has_character_modifier = planning_claimant_adventure
					event_target:debtor_target = {
						primary_title = { ROOT = { has_claim = PREV } }
						NOT = { reverse_has_opinion_modifier = { who = ROOT modifier = opinion_fought_for_claimant } }
						OR = {
							AND = {
								trait = bastard
								ROOT = { NOT = { trait = bastard } }
							}
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_suspected_bastard }
							AND = {
								reverse_has_opinion_modifier = { who = ROOT modifier = opinion_usurped_title }
								primary_title = { any_previous_holder = { character = ROOT } }
							}
						}
					}
				}
			}

			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 4
				trait = ambitious
			}
			modifier = {
				factor = 4
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 0.5
				trait = patient
			}
			modifier = {
				factor = 0.25
				trait = greedy
			}
			modifier = {
				factor = 0.25
				trait = content
			}
			modifier = {
				factor = 0.25
				trait = honorable
			}
		}
		set_character_flag = loan_insurer
		save_persistent_event_target = { name = loan_insurance_target scope = event_target:debtor_target }
		event_target:debtor_target = {
			show_portrait = THIS
			hidden_tooltip = {
				character_event = { id = bankruptcy.102 }
				opinion = { who = ROOT modifier = opinion_debt_insurer }
			}
			ROOT = {
				wealth = insurance_loan
				custom_tooltip = {
					text = TOOLTIPloan_insurance
					set_character_flag = loan_taken
					clr_character_flag = loan_bank_minor
					remove_character_modifier = loan_timer
					add_character_modifier = { name = "loan_timer" duration = 1825 }
					change_variable = { which = loan_amount which = insurance_loan }
					set_variable = { which = loan_interest value = 0.1 }
					FROM = {
						society = {
							ROOT = { save_persistent_event_target = { name = loan_bank scope = PREV } }
						}
					}
					if = { #this is calculated for the player so they can repay instantly
						limit = { ai = no }
						calculate_loan_repayable_effect = yes
					}
					set_variable = { which = insurance_loan value = 0 }
				}
				if = {
					limit = { ai = no }
					chronicle = {
						entry = CHRONICLE_IRON_BANK_FUNDING_ENEMY
						portrait = [Prev.GetID]
					}
				}
			}
			#Start war if needed
			if = {
				limit = {
					NOT = { any_current_enemy = { character = ROOT } }
					ROOT = {
						is_ruler = yes
						vassal_of = PREV
					}
				}
				ROOT = { #Leads claimant faction
					if = {
						limit = {
							leads_faction = faction_claimant
							faction_power = { faction = faction_claimant power = 0.5 }
							is_decision_potential = faction_claimant_ultimatum
							is_decision_allowed = faction_claimant_ultimatum
							supported_claimant = {
								OR = {
									NOT = { has_character_flag = loan_insurer }
									had_character_flag = { flag = loan_insurer days = 3650 }
								}
								NOT = { has_character_flag = offended_moneylenders }
								NOT = { has_character_flag = loan_default }
								NOT = { has_character_flag = loan_taken }
							}
						}
						set_character_flag = faction_claimant_ultimatum_taken
						hidden_tooltip = {
							if = {
								limit = {
									faction_power = { faction = faction_claimant power = 1.0 }
								}
								random = {
									chance = 25
									liege = { character_event = { id = 45002 days = 120 } } # Loyalists flock to the liege's banner
								}
							}
							if = {
								limit = {
									NOT = { faction_power = { faction = faction_claimant power = 0.75 } }
								}
								random_list = {
									50 = {
									}
									30 = {
										character_event = { id = 45000 days = 17 } # A great number of rebels flock to the revolter's banner
									}
									20 = {
										character_event = { id = 45004 days = 17 } # Rebels flock to the revolter's banner
									}
								}
							}
							if = {
								limit = {
									faction_power = { faction = faction_claimant power = 0.75 }
									NOT = { faction_power = { faction = faction_claimant power = 1.5 } }
								}
								random_list = {
									75 = {
									}
									5 = {
										character_event = { id = 45000 days = 17 } # A great number of rebels flock to the revolter's banner
									}
									20 = {
										character_event = { id = 45004 days = 17 } # Rebels flock to the revolter's banner
									}
								}
							}
							if = {
								limit = {
									supported_claimant = {
										character = ROOT
									}
								}
								faction_claimant = { # The target (title) of the faction
									reverse_war = {
										target = ROOT
										casus_belli = claim_on_liege
										faction = faction_claimant
									}
								}
							}
							else = {
								if = { #If external ruler flag as such so top liege can intervene
									limit = {
										supported_claimant = {
											is_ruler = yes
											independent = no
											NOT = { is_liege_or_above = event_target:debtor_target }
										}
									}
									set_character_flag = external_claimant
								}
								hidden_tooltip = {
									supported_claimant = {
										reverse_opinion = {
											who = ROOT
											modifier = opinion_supported_claimant
											years = 100
										}
										reverse_opinion = { who = event_target:debtor_target modifier = opinion_debt_insurer }
										#Claimant takes on target's loans
										set_character_flag = loan_insurer
										save_persistent_event_target = { name = loan_insurance_target scope = event_target:debtor_target }
										ROOT = {
											clr_character_flag = loan_insurer
											clear_persistent_event_target = loan_insurance_target
											reverse_remove_opinion = { who = event_target:debtor_target modifier = opinion_debt_insurer }
										}

									}
								}
								faction_claimant = { # The target (title) of the faction
									reverse_war = {
										target = ROOT
										casus_belli = other_claim_on_liege
										faction = faction_claimant
									}
								}
							}

							clr_character_flag = faction_claimant_ultimatum_taken
							hidden_tooltip = {
								event_target:debtor_target = { remove_character_modifier = mega_war_no_levies }
							}
						}
					}
					else = { #Else start own claim war
						event_target:debtor_target = {
							primary_title = {
								if = {
									limit = {
										NOT = { ROOT = { has_claim = PREV } }
									}
									add_weak_claim = ROOT
								}
								ROOT = { set_character_flag = faction_claimant_ultimatum_taken }
								reverse_war = {
									target = ROOT
									casus_belli = claim_on_liege
								}
								ROOT = { clr_character_flag = faction_claimant_ultimatum_taken }
							}
						}
					}
				}
			}
			else_if = { #external claimant
				limit = {
					NOT = { any_current_enemy = { character = ROOT } }
					ROOT = {
						is_ruler = yes
						OR = {
							same_liege = PREV
							PREV = { independent = yes }
						}
					}
				}
				event_target:debtor_target = {
					primary_title = {
						if = {
							limit = {
								NOT = { ROOT = { has_claim = PREV } }
							}
							add_weak_claim = ROOT
						}
						ROOT = { set_character_flag = claimant_adventurer }
						reverse_war = {
							target = ROOT
							casus_belli = claim
						}
						ROOT = { clr_character_flag = claimant_adventurer }
					}
				}
			}
			else_if = { #Start landless adventure
				limit = {
					ROOT = {
						reverse_has_opinion_modifier = { who = PREV modifier = opinion_targeted_by_adventurer }
						has_character_modifier = planning_claimant_adventure
						is_ruler = no
					}
				}
				ROOT = {
					set_character_flag = TOG.1202
					character_event = { id = TOG.1202 }
				}
			}
			else_if = { #Start landless adventure
				limit = {
					ROOT = { is_ruler = no }
				}
				reverse_opinion = {
					who = ROOT
					modifier = opinion_claimant_adventure_target
				}
				character_event = {
					id = TOG.1201 # Warn the target
				}
				ROOT = {
					set_character_flag = planning_claimant_adventure
					add_character_modifier = {
						name = planning_claimant_adventure
						hidden = yes
						duration = -1
					}
					end_inaccessibility_effect = yes #removes in hiding or in_seclusion
					set_character_flag = TOG.1202
					character_event = { id = TOG.1202 }
				}
			}
		}
		character_event = { id = bankruptcy.190 }
		FROM = { character_event = { id = bankruptcy.188 } }
	}
	option = {
		name = "EVTOPTDbankruptcy.100" #NO
		trigger = { NOT = { character = FROM } }
		ai_chance = {
			factor = 20
		}
		set_character_flag = no_to_iron_bank_insurance
		FROM = { character_event = { id = bankruptcy.189 } }
	}
}
#Inform bank envoy accepted
character_event = {
	id = bankruptcy.188
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	desc = {
		text = "EVTDESCbankruptcy.188"
		trigger = { NOT = { character = FROM } }
	}
	desc = {
		text = "EVTDESCbankruptcy.188B" #Recoverer is funding own claim
		trigger = { character = FROM }
	}

	is_triggered_only = yes

	immediate = {
		society = {
			set_variable = { which = insurance_mercs which = ROOT }
			multiply_variable = { which = insurance_mercs value = -1 }
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.188"
		society = {
			change_variable = { which = cash_reserve which = insurance_mercs }
			hidden_tooltip = {
				change_variable = { which = expenses which = insurance_mercs }
				set_variable = { which = insurance_mercs value = 0 }
			}
		}
		hidden_tooltip = {
			set_variable = { which = insurance_loan value = 0 }
			set_variable = { which = insurance_mercs value = 0 }

			set_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			character_event = { id = bankruptcy.48 days = 180 } #check progress
		}
	}
}
#Inform bank envoy rejected
character_event = {
	id = bankruptcy.189
	desc = "EVTDESCbankruptcy.189"
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.189"
		hidden_tooltip = {
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			set_variable = { which = insurance_loan value = 0 }
			set_variable = { which = insurance_mercs value = 0 }
			character_event = { id = bankruptcy.48 days = 7 }
		}
	}
}
#Spawn Iron bank mercs
character_event = {
	id = bankruptcy.190

	hide_window = yes
	is_triggered_only = yes

	immediate = {
		set_variable = { which = insurance_mercs which = FROMFROM }
		if = {
			limit = { check_variable = { which = insurance_mercs value = 500 } }
			ROOT = {
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 333 333 }
								heavy_infantry = { 867 867 }
								light_infantry = { 1467 1467 }
								light_cavalry = { 500 500 }
								knights = { 167 167 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 333 333 }
								heavy_infantry = { 867 867 }
								light_infantry = { 1467 1467 }
								light_cavalry = { 500 500 }
								knights = { 167 167 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 334 334 }
								heavy_infantry = { 866 866 }
								light_infantry = { 1466 1466 }
								light_cavalry = { 500 500 }
								knights = { 166 166 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 100 100 }
									}
									earmark = iron_bank_mercs
									disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = { check_variable = { which = insurance_mercs value = 400 } }
			ROOT = {
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 267 267 }
								heavy_infantry = { 693 693 }
								light_infantry = { 1173 1173 }
								light_cavalry = { 400 400 }
								knights = { 133 133 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 267 267 }
								heavy_infantry = { 693 693 }
								light_infantry = { 1173 1173 }
								light_cavalry = { 400 400 }
								knights = { 133 133 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 266 266 }
								heavy_infantry = { 694 694 }
								light_infantry = { 1174 1174 }
								light_cavalry = { 400 400 }
								knights = { 134 134 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 80 80 }
									}
									earmark = iron_bank_mercs
									disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = { check_variable = { which = insurance_mercs value = 300 } }
			ROOT = {
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 200 200 }
								heavy_infantry = { 520 520 }
								light_infantry = { 880 880 }
								light_cavalry = { 300 300 }
								knights = { 100 100 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 200 200 }
								heavy_infantry = { 520 520 }
								light_infantry = { 880 880 }
								light_cavalry = { 300 300 }
								knights = { 100 100 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 200 200 }
								heavy_infantry = { 520 520 }
								light_infantry = { 880 880 }
								light_cavalry = { 300 300 }
								knights = { 100 100 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 60 60 }
									}
									earmark = iron_bank_mercs
									disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = { check_variable = { which = insurance_mercs value = 200 } }
			ROOT = {
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 133 133 }
								heavy_infantry = { 347 347 }
								light_infantry = { 587 587 }
								light_cavalry = { 200 200 }
								knights = { 67 67 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 133 133 }
								heavy_infantry = { 347 347 }
								light_infantry = { 587 587 }
								light_cavalry = { 200 200 }
								knights = { 67 67 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 134 134 }
								heavy_infantry = { 346 346 }
								light_infantry = { 586 586 }
								light_cavalry = { 200 200 }
								knights = { 66 66 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 40 40 }
									}
									earmark = iron_bank_mercs
									disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = { check_variable = { which = insurance_mercs value = 100 } }
			ROOT = {
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 67 67 }
								heavy_infantry = { 173 173 }
								light_infantry = { 293 293 }
								light_cavalry = { 100 100 }
								knights = { 33 33 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 67 67 }
								heavy_infantry = { 173 173 }
								light_infantry = { 293 293 }
								light_cavalry = { 100 100 }
								knights = { 33 33 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 66 66 }
								heavy_infantry = { 174 174 }
								light_infantry = { 294 294 }
								light_cavalry = { 100 100 }
								knights = { 34 34 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 20 20 }
									}
									earmark = iron_bank_mercs
									disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
		else_if = {
			limit = { check_variable = { which = insurance_mercs value = 50 } }
			ROOT = {
				clr_character_flag = spawn_100
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 33 33 }
								heavy_infantry = { 87 87 }
								light_infantry = { 147 147 }
								light_cavalry = { 50 50 }
								knights = { 17 17 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 33 33 }
								heavy_infantry = { 87 87 }
								light_infantry = { 147 147 }
								light_cavalry = { 50 50 }
								knights = { 17 17 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 34 34 }
								heavy_infantry = { 86 86 }
								light_infantry = { 146 146 }
								light_cavalry = { 50 50 }
								knights = { 16 16 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 10 10 }
									}
									earmark = iron_bank_mercs
									disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
		else = {
			ROOT = {
				capital_scope = {
					ROOT = {
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 17 17 }
								heavy_infantry = { 43 43 }
								light_infantry = { 73 73 }
								light_cavalry = { 25 25 }
								knights = { 8 8 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 17 17 }
								heavy_infantry = { 43 43 }
								light_infantry = { 73 73 }
								light_cavalry = { 25 25 }
								knights = { 8 8 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
						spawn_unit = {
							province = PREV
							owner = ROOT
							troops = {
								archers = { 16 16 }
								heavy_infantry = { 44 44 }
								light_infantry = { 74 74 }
								light_cavalry = { 25 25 }
								knights = { 9 9 }
							}
							attrition = 1.0
							earmark = iron_bank_mercs disband_on_peace = yes
						}
					}
					if = {
						limit = { #If AI ships to move them
							ROOT = { ai = yes }
						}
						sea_zone = {
							ROOT = {
								spawn_unit = {
									province = PREV
									owner = ROOT
									troops = {
										galleys = { 5 5 }
									}
									earmark = iron_bank_mercs disband_on_peace = yes
								}
							}
						}
					}
				}
			}
		}
	}

	option = {
		name = OK
		set_variable = { which = insurance_mercs value = 0 }
	}
}
#Usurped debtor, take on loan
character_event = {
	id = bankruptcy.101
	desc = "EVTDESCbankruptcy.101"
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	has_character_flag = loan_insurer
	show_from_from = yes

	trigger = {
		persistent_event_target:loan_insurance_target = {
			character = FROMFROM
			check_variable = { which = loan_amount value = 1 }
			OR = {
				has_character_flag = offended_moneylenders
				has_character_flag = loan_default
			}
		}
		FROMFROM = {
			NOT = { higher_tier_than = ROOT_FROM }
		}
		NOT = { has_character_flag = loan_insurance_event }
	}

	immediate = {
		set_character_flag = loan_insurance_event

		clr_character_flag = loan_insurer
		disband_event_forces = iron_bank_mercs
		clear_persistent_event_target = loan_insurance_target

		change_variable = { which = loan_amount which = FROMFROM }
		set_variable = { which = loan_interest value = 0.1 }
		clr_character_flag = loan_bank_minor
		FROMFROM = {
			set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
			any_quester_targeting_this = {
				limit = { has_quest = quest_bank_recover_debt }
				save_event_target_as = bank_envoy
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }

			set_variable = { which = outstanding_loans which = loan_amount }
			set_variable = { which = loan_losses which = loan_amount }
			multiply_variable = { which = loan_losses value = -1 }
			persistent_event_target:loan_bank = {
				ROOT = { save_persistent_event_target = { name = loan_bank scope = PREV } }
				#Adjust bank's records
				change_variable = { which = outstanding_loans which = PREV }
				change_variable = { which = loan_losses which = PREV }
			}
			remove_opinion = { who = ROOT modifier = opinion_debt_insurer }
			clear_loan_flags_and_variables_effect = yes
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_losses value = 0 }
		}
		calculate_loan_repayable_effect = yes
	}

	option = {
		name = "EVTOPTA38002"
		trigger = {
			wealth = loan_total_repayable
		}
		ai_chance = {
			factor = 1
		}
		wealth = loan_total_repayable_negative
		hidden_tooltip = {
			event_target:bank_envoy = { character_event = { id = bankruptcy.115 } }
			#Adjust bank's records
			persistent_event_target:loan_bank = {
				ROOT = {
					set_variable = { which = cash_reserve which = loan_total_repayable }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			clear_loan_flags_and_variables_effect = yes
		}
	}
	option = {
		ai_chance = {
			factor = 1
		}
		name = "EVTOPTA38001"
		hidden_tooltip = {
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
			event_target:bank_envoy = { character_event = { id = bankruptcy.115 } }
		}
		show_portrait = event_target:bank_envoy
		set_character_flag = loan_taken
		custom_tooltip = { text = EVTTOOLTIPbankruptcy.101C }
	}
	option = {
		name = "EVTOPTH38001"
		ai_chance = {
			factor = 0.1
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 3 }
			}
			modifier = {
				factor = 0.5
				persistent_event_target:loan_bank = { society_influence = 5 }
			}

			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
				}
			}
		}
		prestige = loan_total_repayable_negative
		any_demesne_province = {
			add_province_modifier = {
				name = offended_moneylenders
				duration = 3650
			}
		}
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_LOAN_DEAFULT
			}
		}
		if = { #Kick from bank
			limit = {
				is_in_society = yes
				society = { has_flag = bank_society }
				society_rank == 1
			}
			leave_society = yes
		}
		hidden_tooltip = {
			event_target:bank_envoy = { character_event = { id = bankruptcy.116 } }
			persistent_event_target:loan_bank = { #Adjust bank's records
				ROOT = {
					set_variable = { which = loan_losses which = loan_amount }
					set_variable = { which = outstanding_loans which = loan_amount }
					multiply_variable = { which = outstanding_loans value = -1 }
				}
				change_variable = { which = outstanding_loans which = ROOT }
				change_variable = { which = loan_losses which = ROOT }
			}

			set_character_flag = offended_moneylenders
			set_character_flag = has_had_loan_default #effects trust/interest rates
			set_variable = { which = loan_interest value = 0.45 } #Punititive interest rate

			clr_character_flag = loan_taken
			set_variable = { which = loan_interest_payable value = 0 }
			set_variable = { which = loan_total_repayable value = 0 }
			set_variable = { which = loan_total_repayable_negative value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_losses value = 0 }
			remove_character_modifier = loan_timer

			character_event = { id = bankruptcy.45 days = 5 } #consequences
		}
	}
	after = {
		clr_character_flag = loan_insurance_event
	}
}

#Inform debtor of insurance
character_event = {
	id = bankruptcy.102
	desc = "EVTDESCbankruptcy.102"
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.102"
		if = {
			limit = { ai = no }
			chronicle = {
				entry = CHRONICLE_IRON_BANK_FUNDING_TARGET
				portrait = [From.GetID]
			}
		}
	}
}
#Inform bank envoy of success
character_event = {
	id = bankruptcy.115
	desc = "EVTDESCbankruptcy.115"
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.115"
		show_portrait = FROMFROMFROM
		wealth = success_bonus
		add_society_currency_medium_effect = yes
		add_mission_succeed_influence_effect = yes
		hidden_tooltip = {
			society = {
				set_variable = { which = success_bonus which = ROOT }
				multiply_variable = { which = success_bonus value = -1 }
				change_variable = { which = cash_reserve which = success_bonus }
				change_variable = { which = expenses which = success_bonus }
				set_variable = { which = success_bonus value = 0 }
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			clear_delayed_event = { id = bankruptcy.48 }
			clr_quest = quest_bank_recover_debt
			set_variable = { which = success_bonus value = 0 }
		}
	}
}
#Inform bank envoy insurer won, but then refused to honour debt
character_event = {
	id = bankruptcy.116
	desc = "EVTDESCbankruptcy.116"
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.116"
		show_portrait = FROMFROMFROM
		detract_society_currency_medium_effect = yes
		if = {
			limit = { FROM = { higher_tier_than = COUNT } }
			add_mission_fail_influence_effect = yes
		}
		clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_DELEGATION
		clr_character_flag = quest_bank_recover_debt_ASSASSIN
		clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
		clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
		clr_character_flag = quest_bank_recover_debt_HEAVIES
		clr_character_flag = quest_bank_recover_debt_ARTIFACT
		clear_delayed_event = { id = bankruptcy.48 }
		clr_quest = { id = quest_bank_recover_debt failure = yes }
	}
}
#Insurer defeated
character_event = {
	id = bankruptcy.117

	is_triggered_only = yes
	hide_window =  yes

	trigger = {
		FROM = {
			has_character_flag = loan_insurer
			persistent_event_target:loan_insurance_target = {
				character = ROOT
				check_variable = { which = loan_amount value = 1 }
				OR = {
					has_character_flag = offended_moneylenders
					has_character_flag = loan_default
				}
			}
		}
	}

	immediate = {
		FROM = {
			clr_character_flag = loan_insurer
			disband_event_forces = iron_bank_mercs
			clear_persistent_event_target = loan_insurance_target
			ROOT = {
				any_quester_targeting_this = {
					limit = { has_quest = quest_bank_recover_debt }
					character_event = { id = bankruptcy.118 }
				}
				remove_opinion = { who = PREV modifier = opinion_debt_insurer }
			}
		}
	}

	option = {
		name = OK
	}
}
#Inform bank envoy failiure
character_event = {
	id = bankruptcy.118
	desc = "EVTDESCbankruptcy.118"
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.118"
		show_portrait = FROMFROM
		hidden_tooltip = {
			clear_delayed_event = { id = bankruptcy.48 }
			character_event = { id = bankruptcy.48 days = 7 }
		}
	}
}
#Debt inheritance workaround for rulers with no defined heir
province_event = {
	id = bankruptcy.110

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		FROM = {
			primary_title = {
				holder_scope = {
					save_event_target_as = debt_inheritor
				}
			}
		}
		inherit_debt_effect = yes
	}

	option = {
		name = OK
	}
}

###Society Events###
#Initialise banks
character_event = {
	id = bankruptcy.20

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		##Iron Bank
		if = {
			limit = { has_global_flag = iron_bank_founded }
			k_braavos = {
				holder_scope = {
					join_society = iron_bank
					society_rank_up = 3
					set_variable = { which = shares value = 5 }
					society = {
						set_flag = bank_society
						set_variable = { which = cash_reserve value = 7500 }
						set_variable = { which = preferred_cash_reserve value = 2500 }
					}
					470 = {
						set_province_flag = location_has_bank
						iron_bank = { save_persistent_event_target = { name = location scope = PREV } }
					}
					b_braavos = {
						add_building = ct_bank_fortifications
					}
					random_vassal = {
						limit = {
							is_patrician = yes
							is_in_society = no
							is_adult = yes
						}
						join_society = iron_bank
						society_rank_up = 3
						set_variable = { which = shares value = 5 }
						set_society_grandmaster = yes
						character_event = { id = bankruptcy.21 days = 2 } #bookkeeping
					}
					random_vassal = {
						limit = {
							is_patrician = yes
							is_in_society = no
							is_adult = yes
						}
						join_society = iron_bank
						society_rank_up = 3
						set_variable = { which = shares value = 5 }
					}
					any_vassal = {
						limit = {
							is_patrician = yes
							is_in_society = no
						}
						join_society = iron_bank
						society_rank_up = 2
						set_variable = { which = shares value = 5 }
					}
					any_vassal = {
						limit = {
							demesne_size = 1
							is_theocracy = no
							is_in_society = no
						}
						count = 2
						join_society = iron_bank
						society_rank_up = 2
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							demesne_size = 1
							is_theocracy = no
							is_in_society = no
							is_military_command_trigger = no
						}
						join_society = iron_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
						#Create family for keyholders
						if = {
							limit = {
								is_female = no
								is_married = no
								is_betrothed = no
								can_marry_trigger = yes
							}
							character_event = { id = roberts_rebellion.150 }
						}
						if = {
							limit = {
								is_married = yes
								spouse = { is_alive = yes }
								NOR = {
									num_of_children = 3
									any_sibling_even_if_dead = { count = 2 }
								}
							}
							character_event = { id = roberts_rebellion.151 }
						}
					}
					any_realm_character = {
						limit = {
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							stewardship = 10
							is_female = no
							OR = {
								father_even_if_dead = { always = yes }
								is_councillor = yes
							}
							can_press_claims_trigger = yes
						}
						count = 5
						join_society = iron_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
						set_immune_to_pruning = yes
						#Create family for keyholders
						if = {
							limit = {
								is_female = no
								is_married = no
								is_betrothed = no
								can_marry_trigger = yes
							}
							character_event = { id = roberts_rebellion.150 }
						}
						if = {
							limit = {
								is_married = yes
								spouse = { is_alive = yes }
								NOR = {
									num_of_children = 3
									any_sibling_even_if_dead = { count = 2 }
								}
							}
							character_event = { id = roberts_rebellion.151 }
						}
					}
					any_realm_character = {
						limit = {
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							OR = {
								stewardship = 8
								prestige = 200
							}
						}
						count = 15
						join_society = iron_bank
					}
				}
			}
		}
		##Rogare Bank
		if = {
			limit = { has_global_flag = rogare_bank_founded }
			c_108300539 = { #Lysandro Rogare
				join_society = rogare_bank
				society_rank_up = 3
				set_variable = { which = shares value = 5 }
				society = {
					set_flag = bank_society
					set_variable = { which = cash_reserve value = 5000 }
					set_variable = { which = preferred_cash_reserve value = 2000 }
				}
				368 = {
					set_province_flag = location_has_bank
					rogare_bank = { save_persistent_event_target = { name = location scope = PREV } }
				}
				set_society_grandmaster = yes
				character_event = { id = bankruptcy.21 days = 2 } #bookkeeping
				c_109300539 = { #Drazenko Rogare
					join_society = rogare_bank
					society_rank_up = 2
					set_variable = { which = shares value = 5 }
				}
				any_courtier = {
					limit = {
						OR = {
							demesne_size = 1
							AND = {
								is_ruler = no
								liege = {
									demesne_size = 1
									is_theocracy = no
								}
							}
						}
						is_theocracy = no
						is_in_society = no
						age = 16
						is_incapable = no
						OR = {
							stewardship = 8
							prestige = 200
						}
						culture = lysene
					}
					count = 3
					join_society = rogare_bank
				}
			}
			k_lys = {
				holder_scope = {
					if = {
						limit = {
							demesne_size = 1
							is_theocracy = no
							is_in_society = no
							is_military_command_trigger = no
							is_adult = yes
							culture = lysene
						}
						join_society = rogare_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
					}
					any_realm_character = {
						limit = {
							NAND = {
								is_ruler = yes
								NOT = { demesne_size = 1 }
							}
							OR = {
								is_ruler = yes
								stewardship = 8
								prestige = 200
							}
							is_theocracy = no
							is_in_society = no
							is_military_command_trigger = no
							is_adult = yes
							culture = lysene
						}
						preferred_limit = {
							is_patrician = yes
						}
						preferred_limit = {
							higher_tier_than = BARON
						}
						count = 9
						join_society = rogare_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
					}
					any_realm_character = {
						limit = {
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							OR = {
								stewardship = 8
								prestige = 200
							}
							culture = lysene
						}
						count = 4
						join_society = rogare_bank
					}
				}
			}
		}
		##Qarth Bank
		if = {
			limit = { has_global_flag = qarth_bank_founded }
			k_qarth = {
				holder_scope = {
					random_realm_lord = {
						limit = {
							is_in_society = no
							is_adult = yes
							is_incapable = no
						}
						preferred_limit = {
							is_patrician = yes
						}
						join_society = qarth_bank
						society_rank_up = 3
						set_variable = { which = shares value = 5 }
						set_society_grandmaster = yes
						society = {
							set_flag = bank_society
							set_variable = { which = cash_reserve value = 2500 }
							set_variable = { which = preferred_cash_reserve value = 1100 }
						}
						663 = {
							set_province_flag = location_has_bank
							qarth_bank = { save_persistent_event_target = { name = location scope = PREV } }
						}
						character_event = { id = bankruptcy.21 days = 2 } #bookkeeping
					}
					random_realm_lord = {
						limit = {
							is_in_society = no
							is_adult = yes
						}
						preferred_limit = {
							is_patrician = yes
						}
						join_society = qarth_bank
						society_rank_up = 3
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							is_in_society = no
						}
						preferred_limit = {
							is_patrician = yes
						}
						count = 5
						join_society = qarth_bank
						society_rank_up = 2
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							demesne_size = 1
							is_theocracy = no
							is_in_society = no
						}
						count = 2
						join_society = qarth_bank
						society_rank_up = 2
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							demesne_size = 1
							is_theocracy = no
							is_in_society = no
							is_military_command_trigger = no
						}
						count = 6
						join_society = qarth_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
						#Create family for keyholders
						if = {
							limit = {
								is_female = no
								is_married = no
								is_betrothed = no
								can_marry_trigger = yes
							}
							character_event = { id = roberts_rebellion.150 }
						}
						if = {
							limit = {
								is_married = yes
								spouse = { is_alive = yes }
								NOR = {
									num_of_children = 3
									any_sibling_even_if_dead = { count = 2 }
								}
							}
							character_event = { id = roberts_rebellion.151 }
						}
					}
					any_realm_character = {
						limit = {
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							stewardship = 10
							is_female = no
							OR = {
								father_even_if_dead = { always = yes }
								is_councillor = yes
							}
							can_press_claims_trigger = yes
							lower_tier_than = DUKE
						}
						count = 4
						join_society = qarth_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
						set_immune_to_pruning = yes
						#Create family for keyholders
						if = {
							limit = {
								is_female = no
								is_married = no
								is_betrothed = no
								can_marry_trigger = yes
							}
							character_event = { id = roberts_rebellion.150 }
						}
						if = {
							limit = {
								is_married = yes
								spouse = { is_alive = yes }
								NOR = {
									num_of_children = 3
									any_sibling_even_if_dead = { count = 2 }
								}
							}
							character_event = { id = roberts_rebellion.151 }
						}
					}
					any_realm_character = {
						limit = {
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							OR = {
								stewardship = 8
								prestige = 200
							}
							lower_tier_than = DUKE
						}
						count = 10
						join_society = qarth_bank
					}
				}
			}
		}
		##Valyria Bank
		if = {
			limit = { has_global_flag = valyria_bank_founded }
			e_new_valyria = {
				holder_scope = {
					random_realm_lord = {
						limit = {
							culture = high_valyrian
							is_in_society = no
							is_adult = yes
							is_incapable = no
							is_feudal = yes
						}
						preferred_limit = {
							is_patrician = yes
						}
						preferred_limit = {
							higher_tier_than = COUNT
						}
						join_society = valyria_bank
						society_rank_up = 3
						set_variable = { which = shares value = 5 }
						set_society_grandmaster = yes
						society = {
							set_flag = bank_society
							set_variable = { which = cash_reserve value = 7500 }
							set_variable = { which = preferred_cash_reserve value = 2500 }
						}
						597 = {
							set_province_flag = location_has_bank
							valyria_bank = { save_persistent_event_target = { name = location scope = PREV } }
						}
						character_event = { id = bankruptcy.21 days = 2 } #bookkeeping
					}
					random_realm_lord = {
						limit = {
							culture = high_valyrian
							is_in_society = no
							is_adult = yes
							is_feudal = yes
						}
						preferred_limit = {
							is_patrician = yes
						}
						preferred_limit = {
							higher_tier_than = COUNT
						}
						join_society = valyria_bank
						society_rank_up = 3
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							culture = high_valyrian
							is_in_society = no
							is_feudal = yes
						}
						preferred_limit = {
							is_patrician = yes
						}
						preferred_limit = {
							higher_tier_than = BARON
						}
						count = 5
						join_society = valyria_bank
						society_rank_up = 2
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							culture = high_valyrian
							demesne_size = 1
							is_feudal = yes
							is_in_society = no
						}
						count = 2
						join_society = valyria_bank
						society_rank_up = 2
						set_variable = { which = shares value = 5 }
					}
					any_realm_lord = {
						limit = {
							culture = high_valyrian
							demesne_size = 1
							is_feudal = yes
							is_in_society = no
							is_military_command_trigger = no
						}
						count = 6
						join_society = valyria_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
						#Create family for keyholders
						if = {
							limit = {
								is_female = no
								is_married = no
								is_betrothed = no
								can_marry_trigger = yes
							}
							character_event = { id = roberts_rebellion.150 }
						}
						if = {
							limit = {
								is_married = yes
								spouse = { is_alive = yes }
								NOR = {
									num_of_children = 3
									any_sibling_even_if_dead = { count = 2 }
								}
							}
							character_event = { id = roberts_rebellion.151 }
						}
					}
					any_realm_character = {
						limit = {
							culture = high_valyrian
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							stewardship = 10
							is_female = no
							OR = {
								father_even_if_dead = { always = yes }
								is_councillor = yes
							}
							can_press_claims_trigger = yes
							lower_tier_than = DUKE
						}
						count = 4
						join_society = valyria_bank
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
						set_immune_to_pruning = yes
						#Create family for keyholders
						if = {
							limit = {
								is_female = no
								is_married = no
								is_betrothed = no
								can_marry_trigger = yes
							}
							character_event = { id = roberts_rebellion.150 }
						}
						if = {
							limit = {
								is_married = yes
								spouse = { is_alive = yes }
								NOR = {
									num_of_children = 3
									any_sibling_even_if_dead = { count = 2 }
								}
							}
							character_event = { id = roberts_rebellion.151 }
						}
					}
					any_realm_character = {
						limit = {
							culture = high_valyrian
							OR = {
								demesne_size = 1
								AND = {
									is_ruler = no
									liege = {
										demesne_size = 1
										is_theocracy = no
									}
								}
							}
							is_theocracy = no
							is_in_society = no
							age = 16
							is_incapable = no
							OR = {
								stewardship = 8
								prestige = 200
							}
							lower_tier_than = DUKE
						}
						count = 10
						join_society = valyria_bank
					}
				}
			}
		}
	}

	option = {
		name = OK
	}
}
character_event = { #scripted historical debt, change bank records
	id = bankruptcy.2099

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		persistent_event_target:loan_bank = {
			change_variable = { which = outstanding_loans which = ROOT }
			change_variable = { which = cash_reserve which = ROOT }
		}
		set_variable = { which = cash_reserve value = 0 }
		set_variable = { which = outstanding_loans value = 0 }
	}

	option = {
		name = OK
	}
}
#5 Yearly bookkeeping
character_event = {
	id = bankruptcy.21
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	desc = {
		text = EVTDESCbankruptcy.21
		trigger = { society = { NOT = { has_flag = new_bank_society } } }
	}
	desc = {
		text = EVTDESCbankruptcy.21B
		trigger = { society = { has_flag = new_bank_society } }
	}

	is_triggered_only = yes
	is_in_society = yes

	trigger = {
		OR = {
			is_society_grandmaster = yes
			has_character_flag = viewing_bank_accounts #using decision to view accounts, does not apply dividends, write offs etc
		}
		society = { has_flag = bank_society }
	}

	immediate = {
		hidden_tooltip = {
			society = {
				#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
				set_variable = { which = shares value = 0 }
				any_society_member = {
					limit = { society_rank > 2 }
					society = { change_variable = { which = shares value = 5 } }
				}
				any_society_member = {
					limit = { society_rank == 2 }
					society = { change_variable = { which = shares value = 1 } }
				}

				clr_flag = issue_dividend
				clr_flag = loss_write_off
				if = {
					limit = { ROOT = { NOT = { has_character_flag = viewing_bank_accounts } } }
					#Subract expenses from cash reserves/expenses (2% of outstanding loans + 2% of cash reserves)
					set_variable = { which = running_costs which = cash_reserve }
					multiply_variable = { which = running_costs value = 0.02 }

					multiply_variable = { which = outstanding_loans value = 0.02 }
					change_variable = { which = running_costs which = outstanding_loans }
					divide_variable = { which = outstanding_loans value = 0.02 }

					subtract_variable = { which = cash_reserve which = running_costs }

					#Determine profit vs loss
					if = { #Losses and profits cannot be negative
						limit = { NOT = { check_variable = { which = loan_losses value = 0 } } }
						set_variable = { which = loan_losses value = 0 }
					}
					if = {
						limit = { NOT = { check_variable = { which = loan_profits value = 0 } } }
						set_variable = { which = loan_profits value = 0 }
					}
					#Expenses are always recorded negatively
					if = {
						limit = { check_variable = { which = expenses value = 0 } }
						set_variable = { which = expenses value = 0 }
					}
					if = {
						limit = { check_variable = { which = withdrawn_cash value = 0 } }
						set_variable = { which = withdrawn_cash value = 0 }
					}
					if = {
						limit = { check_variable = { which = lost_coin value = 0 } }
						set_variable = { which = lost_coin value = 0 }
					}
					if = {
						limit = { check_variable = { which = looted_cash value = 0 } }
						set_variable = { which = looted_cash value = 0 }
					}

					set_variable = { which = profit_vs_loss which = loan_profits }
					change_variable = { which = profit_vs_loss which = investment_profits }
					subtract_variable = { which = profit_vs_loss which = loan_losses }
					subtract_variable = { which = profit_vs_loss which = running_costs }
					#Expenses are always recorded negatively
					change_variable = { which = profit_vs_loss which = expenses }
					change_variable = { which = profit_vs_loss which = withdrawn_cash }
					change_variable = { which = profit_vs_loss which = lost_coin }
					change_variable = { which = profit_vs_loss which = looted_cash }

					set_variable = { which = displayed_profit which = profit_vs_loss }

					if = { #If in profit, issue a dividend
						limit = {
							check_variable = { which = profit_vs_loss value = 100 }
							OR = {
								check_variable = { which = cash_reserve value = 1100 } #Want to keep at least 1000, and distribute 100
								AND = {
									check_variable = { which = cash_reserve value = 600 } #If few shareholders, Want to keep at least 500
									NOT = { check_variable = { which = shares value = 11 } }
								}
							}
						}
						set_flag = issue_dividend

						#Cash to distribute as dividends (75% of profits)
						multiply_variable = { which = profit_vs_loss value = 0.75 }
						if = { #want to keep at least 1000 in reserve
							limit = { check_variable = { which = cash_reserve value = 1100 } }
							change_variable = { which = profit_vs_loss value = 1000 }
						}
						else = { #want to keep at least 500 in reserve
							change_variable = { which = profit_vs_loss value = 500 }
						}

						if = { #check enough cash in reserve, if not distribute everything above threshold
							limit = { NOT = { check_variable = { which = cash_reserve which = profit_vs_loss } } }
							set_variable = { which = profit_vs_loss which = cash_reserve }
						}

						#determine dividend value per share
						if = { #want to keep at least 1000 in reserve
							limit = { check_variable = { which = cash_reserve value = 1100 } }
							change_variable = { which = profit_vs_loss value = -1000 }
						}
						else = { #want to keep at least 500 in reserve
							change_variable = { which = profit_vs_loss value = -500 }
						}
						divide_variable = { which = profit_vs_loss which = shares }

						any_society_member = {
							limit = { society_rank > 2 }
							set_variable = { which = profit_vs_loss which = PREV }
							multiply_variable = { which = profit_vs_loss value = 5 }
						}
						any_society_member = {
							limit = { society_rank == 2 }
							set_variable = { which = profit_vs_loss which = PREV }
						}
					}
					else_if = { #If in loss, write of portion of losses minus debt profit
						limit = { NOT = { check_variable = { which = profit_vs_loss value = 0 } } }
						set_flag = loss_write_off
					}
				}
				ROOT = { #societies cannot display values in loc
					set_variable = { which = loan_profits which = PREV }
					set_variable = { which = investment_profits which = PREV }
					set_variable = { which = cash_reserve which = PREV }
					set_variable = { which = outstanding_loans which = PREV }
					set_variable = { which = loan_losses which = PREV }
					set_variable = { which = running_costs which = PREV }
					set_variable = { which = displayed_profit which = PREV }
					set_variable = { which = expenses which = PREV }
					set_variable = { which = withdrawn_cash which = PREV }
					set_variable = { which = lost_coin which = PREV }
					set_variable = { which = looted_cash which = PREV }
					multiply_variable = { which = expenses value = -1 } #Expenses are always recorded negatively
					multiply_variable = { which = withdrawn_cash value = -1 }
					multiply_variable = { which = lost_coin value = -1 }
					multiply_variable = { which = looted_cash value = -1 }
				}
				#Determine bank value
				set_variable = { which = bank_value which = cash_reserve }
				change_variable = { which = bank_value which = outstanding_loans }
				if = {
					limit = { ROOT = { NOT = { has_character_flag = viewing_bank_accounts } } }
					#Bank influence modifiers based on value
					if = {
						limit = { check_variable = { which = bank_value value = 10000 } }
						ROOT = { add_society_modifier = { modifier = massive_bank years = 5 } }
						set_variable = { which = preferred_cash_reserve value = 3000 } #The amount of cash the bank likes to keep in reserve
					}
					else_if = {
						limit = { check_variable = { which = bank_value value = 7500 } }
						ROOT = { add_society_modifier = { modifier = powerful_bank years = 5 } }
						set_variable = { which = preferred_cash_reserve value = 2500 }
					}
					else_if = {
						limit = { check_variable = { which = bank_value value = 5000 } }
						ROOT = { add_society_modifier = { modifier = large_bank years = 5 } }
						set_variable = { which = preferred_cash_reserve value = 2000 }
					}
					else_if = {
						limit = { check_variable = { which = bank_value value = 3500 } }
						ROOT = { add_society_modifier = { modifier = medium_bank years = 5 } }
						set_variable = { which = preferred_cash_reserve value = 1500 }
					}
					else_if = {
						limit = { check_variable = { which = bank_value value = 2000 } }
						ROOT = { add_society_modifier = { modifier = small_bank years = 5 } }
						set_variable = { which = preferred_cash_reserve value = 1100 }
					}
					else = {
						ROOT = { add_society_modifier = { modifier = minor_bank years = 5 } }
						set_variable = { which = preferred_cash_reserve value = 100 }
					}

					#Check if bank is currently accepting investment
					clr_flag = not_accepting_investment
					set_variable = { which = loan_perc_value_check which = outstanding_loans }
					divide_variable = { which = loan_perc_value_check which = bank_value }
					if = { #Not accepting if above preferred cash reserve and outstanding loans make up less than 50% of a bank's value
						limit = {
							check_variable = { which = cash_reserve value = 1000 }
							check_variable = { which = cash_reserve which = preferred_cash_reserve }
							NOT = { check_variable = { which = loan_perc_value_check value = 0.5 } }
						}
						set_flag = not_accepting_investment
					}

					#Inform Members
					any_society_member = {
						limit = {
							society_rank >= 2
							NOT = { character = ROOT }
						}
						character_event = { id = bankruptcy.22 }
					}
					#If cash reserves are low, ask for funds from members
					if = {
						limit = {
							ROOT = { NOT = { has_character_flag = issue_dividend } }
							NOT = { check_variable = { which = cash_reserve value = 100 } }
						}
						set_variable = { which = cash_investment value = 500 } #Ideally want at least 500
						subtract_variable = { which = cash_investment which = cash_reserve }
						divide_variable = { which = cash_investment which = shares }
						any_society_member = {
							limit = { society_rank >= 2 }
							character_event = { id = bankruptcy.23 days = 2 }
						}
						character_event = { id = bankruptcy.2397 days = 10 } #check for bank disbanding
					}
					if = {
						limit = { NOT = { is_society_rank_full = { society = THIS rank = 1 } } }
						persistent_event_target:location = { #Find new members
							kingdom = {
								any_de_jure_vassal = {
									limit = {
										NOT_mythical_creature_trigger = yes
										capital_scope = { kingdom = { title = PREVPREVPREV } }
										has_tribal_or_nomadic_government_trigger = no
									}
									if = {
										limit = {
											is_adult = yes
											is_incapable = no
											prisoner = no
											is_in_society = no
											has_ROOT_bank_society_prerequisites = yes
											ai = yes
											NOT = { has_character_flag = offended_moneylenders }
											is_nomadic = no
										}
										character_event = { id = bankruptcy.2298 }
									}
									any_courtier = {
										limit = {
											is_ruler = no
											OR = {
												stewardship = 10
												prestige = 200
												wealth = 75
											}
											OR = {
												is_female = no
												stewardship = 15
												prestige = 400
												wealth = 125
											}

											is_adult = yes
											is_incapable = no
											prisoner = no
											is_in_society = no
											has_ROOT_bank_society_prerequisites = yes
											ai = yes
											NOT = { has_character_flag = offended_moneylenders }
											NOT_mythical_creature_trigger = yes
											is_nomadic = no
										}
										character_event = { id = bankruptcy.2298 }
									}
								}
							}
						}
					}
					#Members leave society
					any_society_member = {
						limit = {
							is_adult = yes
							is_incapable = no
							prisoner = no
							society_rank < 4
							OR = {
								#Another society is attractive
								#Alchemists
								trait = mystic
								trait = scholar
								trait = fire_obsessed
								trait = lunatic
								trait = erudite
								AND = { #Satanists
									NOT = { has_game_rule = { name = devil_worshipers value = none } }
									OR = {
										trait = cynical
										trait = hedonist
										trait = cannibal_trait
										trait = impaler
										trait = ruthless
										trait = cruel
										trait = possessed
										trait = lunatic
									}
								}
								#I'm very poor
								NOT = { wealth = -200 }
							}
						}
						random_list = {
							95 = { }
							5 = { leave_society = yes }
						}
					}
					#If only high councillor, try and find another
					if = {
						limit = {
							NOT = {
								any_society_member = {
									society_rank == 4
									is_adult = yes
									is_incapable = no
									NOT = { character = ROOT }
								}
							}
						}
						random_society_member = {
							limit = {
								society_rank == 3
								is_adult = yes
								is_incapable = no
								prisoner = no
								ai = yes
							}
							preferred_limit = {
								society_currency >= 2000
							}
							preferred_limit = {
								society_currency >= 1000
							}
							preferred_limit = {
								society_currency >= 500
							}
							preferred_limit = {
								society_currency >= 250
							}
							society_rank_up = 1
						}
					}
				}
			}
			character_event = { id = bankruptcy.240 days = 1 } #review interest strategy
		}
	}

	option = {
		name = EVTOPTAbankruptcy.21
		custom_tooltip = { text = TOOLTIPbankruptcy.21 }
		if = {
			limit = { society = { has_flag = issue_dividend } }
			custom_tooltip = { text = TOOLTIPbankruptcy.21A }
		}
		else_if = {
			limit = { society = { has_flag = loss_write_off } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.21writeoff
			}
		}
		else = {
			custom_tooltip = { text = TOOLTIPbankruptcy.21info }
		}
	}
	option = {
		name = EVTOPTBbankruptcy.21 #Loan List
		trigger = { ai = no }
		tooltip = {
			any_character = {
				limit = {
					has_character_flag = loan_taken
					NOT = { has_character_flag = loan_default }
					check_variable = { which = loan_amount value = 1 }
					persistent_event_target:loan_bank = { ROOT = { society_member_of = PREV } }
				}
				show_scope_change = no
				count = 50
				score_value = { #list in order of loan size
					value = 1
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 25 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 50 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 75 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 100 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 150 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 200 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 250 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 300 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 400 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 500 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 650 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 800 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 1000 }
					}
				}
				show_portrait = THIS
				custom_tooltip = { text = TOOLTIPbankruptcy.21B }
			}
		}
	}
	option = {
		name = EVTOPTCbankruptcy.21 #Loan default List
		trigger = { ai = no }
		tooltip = {
			custom_tooltip = { text = TOOLTIPbankruptcy.21C }
			any_character = {
				limit = {
					has_character_flag = loan_taken
					has_character_flag = loan_default
					check_variable = { which = loan_amount value = 1 }
					persistent_event_target:loan_bank = { ROOT = { society_member_of = PREV } }
				}
				show_scope_change = no
				count = 50
				score_value = { #list in order of loan size
					value = 1
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 25 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 50 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 75 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 100 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 150 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 200 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 250 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 300 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 400 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 500 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 650 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 800 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 1000 }
					}
				}
				show_portrait = THIS
				custom_tooltip = { text = TOOLTIPbankruptcy.21B }
			}
		}
	}
	option = {
		name = EVTOPTDbankruptcy.21 #Loan loss List
		trigger = { ai = no }
		tooltip = {
			custom_tooltip = { text = TOOLTIPbankruptcy.21D }
			any_character = {
				limit = {
					has_character_flag = offended_moneylenders
					NOT = { has_character_flag = loan_taken }
					check_variable = { which = loan_amount value = 1 }
					persistent_event_target:loan_bank = { ROOT = { society_member_of = PREV } }
				}
				show_scope_change = no
				count = 50
				score_value = { #list in order of loan size
					value = 1
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 25 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 50 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 75 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 100 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 150 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 200 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 250 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 300 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 400 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 500 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 650 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 800 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 1000 }
					}
				}
				show_portrait = THIS
				custom_tooltip = { text = TOOLTIPbankruptcy.21B }
			}
		}
	}
	after = {
		hidden_tooltip = {
			clr_character_flag = viewing_bank_accounts
			if = {
				limit = { society = { has_flag = issue_dividend } }
				wealth = profit_vs_loss
			}
			#apply dividend/write off, delayed so other members get accurate accounts
			society = { save_event_target_as = bank_society }
			capital_scope = { province_event = { id = bankruptcy.2299 days = 2 } } #province event in case ROOT dies
		}
	}
}
character_event = { #Inform members
	id = bankruptcy.22
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	desc = {
		text = EVTDESCbankruptcy.21
		trigger = { society = { NOT = { has_flag = new_bank_society } } }
	}
	desc = {
		text = EVTDESCbankruptcy.21B
		trigger = { society = { has_flag = new_bank_society } }
	}

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.21
		custom_tooltip = { text = TOOLTIPbankruptcy.21 }
		if = {
			limit = { society = { has_flag = issue_dividend } }
			custom_tooltip = { text = TOOLTIPbankruptcy.21A }
		}
		else_if = {
			limit = { society = { has_flag = loss_write_off } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.21writeoff
			}
		}
		else = {
			custom_tooltip = { text = TOOLTIPbankruptcy.21info }
		}
	}
	option = {
		name = EVTOPTBbankruptcy.21 #Loan List
		trigger = { ai = no }
		tooltip = {
			any_character = {
				limit = {
					has_character_flag = loan_taken
					NOT = { has_character_flag = loan_default }
					check_variable = { which = loan_amount value = 1 }
					persistent_event_target:loan_bank = { ROOT = { society_member_of = PREV } }
				}
				show_scope_change = no
				count = 50
				score_value = { #list in order of loan size
					value = 1
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 25 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 50 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 75 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 100 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 150 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 200 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 250 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 300 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 400 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 500 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 650 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 800 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 1000 }
					}
				}
				show_portrait = THIS
				custom_tooltip = { text = TOOLTIPbankruptcy.21B }
			}
		}
	}
	option = {
		name = EVTOPTCbankruptcy.21 #Loan default List
		trigger = { ai = no }
		tooltip = {
			custom_tooltip = { text = TOOLTIPbankruptcy.21C }
			any_character = {
				limit = {
					has_character_flag = loan_taken
					has_character_flag = loan_default
					check_variable = { which = loan_amount value = 1 }
					persistent_event_target:loan_bank = { ROOT = { society_member_of = PREV } }
				}
				show_scope_change = no
				count = 50
				score_value = { #list in order of loan size
					value = 1
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 25 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 50 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 75 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 100 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 150 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 200 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 250 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 300 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 400 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 500 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 650 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 800 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 1000 }
					}
				}
				show_portrait = THIS
				custom_tooltip = { text = TOOLTIPbankruptcy.21B }
			}
		}
	}
	option = {
		name = EVTOPTDbankruptcy.21 #Loan loss List
		trigger = { ai = no }
		tooltip = {
			custom_tooltip = { text = TOOLTIPbankruptcy.21D }
			any_character = {
				limit = {
					has_character_flag = offended_moneylenders
					NOT = { has_character_flag = loan_taken }
					check_variable = { which = loan_amount value = 1 }
					persistent_event_target:loan_bank = { ROOT = { society_member_of = PREV } }
				}
				show_scope_change = no
				count = 50
				score_value = { #list in order of loan size
					value = 1
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 25 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 50 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 75 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 100 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 150 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 200 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 250 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 300 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 400 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 500 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 650 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 800 }
					}
					additive_modifier = {
						value = 5
						check_variable = { which = loan_amount value = 1000 }
					}
				}
				show_portrait = THIS
				custom_tooltip = { text = TOOLTIPbankruptcy.21B }
			}
		}
	}
	after = {
		hidden_tooltip = {
			if = {
				limit = { society = { has_flag = issue_dividend } }
				wealth = profit_vs_loss
				set_variable = { which = cash_reserve which = profit_vs_loss }
				multiply_variable = { which = cash_reserve value = -1 }
				society = {
					change_variable = { which = cash_reserve which = ROOT }
				}
				set_variable = { which = profit_vs_loss value = 0 }
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #AI decides whether to join bank
	id = bankruptcy.2298

	is_triggered_only = yes
	hide_window = yes

	option = {
		name = JOIN
		ai_chance = {
			factor = 5
			modifier = { #May prefer to wait for another society
				factor = 0.2
				OR = {
					#Alchemists
					trait = mystic
					trait = scholar
					trait = fire_obsessed
					trait = lunatic
					trait = erudite
					AND = { #Satanists
						NOT = { has_game_rule = { name = devil_worshipers value = none } }
						OR = {
							trait = cynical
							trait = hedonist
							trait = cannibal_trait
							trait = impaler
							trait = ruthless
							trait = cruel
							trait = possessed
							trait = lunatic
						}
					}
				}
			}
			modifier = { #The leader has reneged on debts
				factor = 0.2
				FROM = {
					society = {
						any_society_member = {
							is_society_grandmaster = yes
							OR = {
								has_character_flag = has_had_loan_default
								has_character_flag = personal_loan_default
							}
						}
					}
				}
			}
			modifier = {
				factor = 5
				has_education_stewardship_trigger = yes
			}
			modifier = {
				factor = 10
				has_lifestyle_stewardship_trigger = yes
			}
			modifier = {
				factor = 5
				wealth = 200
			}
			modifier = {
				factor = 5
				is_ruler = yes
			}
			modifier = {
				factor = 10
				is_patrician = yes
			}
			modifier = {
				factor = 10
				has_character_flag = has_been_bank_shareholder
			}
			modifier = {
				factor = 2
				trait = diligent
			}
			modifier = {
				factor = 0.5
				trait = slothful
			}
			modifier = {
				factor = 2
				trait = greedy
			}
			modifier = {
				factor = 0.5
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 0.5
				trait = content
			}
		}
		clr_character_flag = has_been_bank_shareholder
		FROM = { society = { ROOT = { join_society = PREV } } }
		if = { # Artificially increase society influence for balance purposes
			limit = {
				is_ruler = yes
				society_influence > 20
			}
			add_mission_succeed_influence_effect = yes
		}
		character_event = { id = bankruptcy.2698 days = 30 random = 70 } #Invest to rank up?
	}
	option = {
		name = NO
		ai_chance = {
			factor = 95
		}
	}
}
province_event = { #Apply dividend/write off
	id = bankruptcy.2299

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		event_target:bank_society = {
			if = {
				limit = { has_flag = issue_dividend }
				#Apply FROM's dividend to accounts
				FROM = {
					set_variable = { which = cash_reserve which = profit_vs_loss }
					multiply_variable = { which = cash_reserve value = -1 }
				}
				change_variable = { which = cash_reserve which = FROM }
				FROM = { set_variable = { which = profit_vs_loss value = 0 } }
				#reset
				set_variable = { which = loan_profits value = 0 }
				set_variable = { which = investment_profits value = 0 }
				set_variable = { which = loan_losses value = 0 }
				set_variable = { which = expenses value = 0 }
				set_variable = { which = withdrawn_cash value = 0 }
				set_variable = { which = lost_coin value = 0 }
				set_variable = { which = looted_cash value = 0 }
				clr_flag = issue_dividend
			}
			if = {
				limit = { has_flag = loss_write_off }
				subtract_variable = { which = loan_losses which = loan_profits }
				subtract_variable = { which = loan_losses which = investment_profits }
				multiply_variable = { which = loan_losses value = 0.66 }
				multiply_variable = { which = lost_coin value = 0.66 }
				multiply_variable = { which = looted_cash value = 0.66 }
				if = {
					limit = { NOT = { check_variable = { which = investment_profits value = -25 } } }
					multiply_variable = { which = investment_profits value = 0.66 }
				}
				else = {
					set_variable = { which = investment_profits value = 0 }
				}
				if = {
					limit = { NOT = { check_variable = { which = loan_losses value = 25 } } }
					set_variable = { which = loan_losses value = 0 }
				}
				if = {
					limit = { NOT = { check_variable = { which = lost_coin value = 25 } } }
					set_variable = { which = lost_coin value = 0 }
				}
				if = {
					limit = { NOT = { check_variable = { which = looted_cash value = 25 } } }
					set_variable = { which = looted_cash value = 0 }
				}
				set_variable = { which = loan_profits value = 0 }
				set_variable = { which = expenses value = 0 }
				set_variable = { which = withdrawn_cash value = 0 }
				set_variable = { which = profit_vs_loss value = 0 }
				clr_flag = loss_write_off
			}
			if = {
				limit = {
					has_flag = new_bank_society
					any_playable_ruler = {
						has_character_flag = loan_taken
						check_variable = { which = loan_amount value = 1 }
						persistent_event_target:loan_bank = { FROM = { society_member_of = PREV } }
					}
				}
				clr_flag = new_bank_society
			}

		}
		FROM = {
			set_variable = { which = loan_profits value = 0 }
			set_variable = { which = investment_profits value = 0 }
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = loan_losses value = 0 }
			set_variable = { which = expenses value = 0 }
			set_variable = { which = running_costs value = 0 }
			set_variable = { which = withdrawn_cash value = 0 }
			set_variable = { which = lost_coin value = 0 }
			set_variable = { which = looted_cash value = 0 }
			set_variable = { which = displayed_profit value = 0 }
		}
	}

	option = {
		name = OK
	}
}
character_event = { #Investment called
	id = bankruptcy.23
	desc = EVTDESCbankruptcy.23
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		society = {
			ROOT = {
				set_variable = { which = cash_investment which = PREV }
				if = {
					limit = { society_rank > 2 }
					multiply_variable = { which = cash_investment value = 5 }
				}
				if = { #check ROOT has enough wealth to invest
					limit = {
						NOT = { wealth = cash_investment }
						wealth = 10
					}
					#If not, invest all remaining wealth
					set_character_flag = partial_investment
					export_to_variable = { which = cash_investment value = wealth who = ROOT }
				}
				set_variable = { which = cash_reserve which = cash_investment }
				multiply_variable = { which = cash_investment value = -1 }
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.23 #Invest full amount
		trigger = {
			wealth = cash_reserve
			NOT = { has_character_flag = partial_investment }
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 3
				trait = diligent
			}
			modifier = {
				factor = 3
				trait = charitable
			}
		}
		wealth = cash_investment
		add_society_currency_medium_effect = yes
		society = { change_variable = { which = cash_reserve which = ROOT } }
	}
	option = {
		name = EVTOPTCbankruptcy.23 #Invest what you can
		trigger = {
			has_character_flag = partial_investment
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 3
				trait = diligent
			}
			modifier = {
				factor = 3
				trait = charitable
			}
		}
		wealth = cash_investment
		add_society_currency_tiny_effect = yes
		society = { change_variable = { which = cash_reserve which = ROOT } }
	}
	option = {
		name = EVTOPTBbankruptcy.23 #No
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				wealth = cash_reserve
				NOT = { trait = greedy }
				NOT = { trait = selfish }
			}
			modifier = {
				factor = 3
				check_variable = { which = cash_reserve value = 250 }
			}
			modifier = {
				factor = 3
				trait = greedy
			}
			modifier = {
				factor = 3
				trait = selfish
			}
			modifier = {
				factor = 3
				NOT = { wealth = cash_reserve }
			}
		}
		detract_society_currency_minor_effect = yes
	}
	after = {
		hidden_tooltip = {
			set_variable = { which = cash_investment value = 0 }
			set_variable = { which = cash_reserve value = 0 }
		}
		clr_character_flag = partial_investment
	}
}
character_event = { #Check for bank disbanding after investment call
	id = bankruptcy.2397
	desc = EVTDESCbankruptcy.2397
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	trigger = {
		is_society_grandmaster = yes
		society = {
			has_flag = bank_society
			NOT = { check_variable = { which = cash_reserve value = 400 } }
			NOT = { check_variable = { which = outstanding_loans value = 10 } }
		}
	}

	immediate = {
		society = {
			#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
			set_variable = { which = shares value = 0 }
			any_society_member = {
				limit = { society_rank > 2 }
				society = { change_variable = { which = shares value = 5 } }
			}
			any_society_member = {
				limit = { society_rank == 2 }
				society = { change_variable = { which = shares value = 1 } }
			}
			#Determine bank value
			set_variable = { which = bank_value which = cash_reserve }
			change_variable = { which = bank_value which = outstanding_loans }

			#Value per share
			divide_variable = { which = bank_value which = shares }
			if = {
				limit = { NOT = { check_variable = { which = bank_value value = 0 } } }
				set_variable = { which = bank_value value = 0 }
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.2397
		custom_tooltip = {
			text = TOOLTIPbankruptcy.2397A
			society = {
				save_event_target_as = disbanded_society
				persistent_event_target:location = {
					save_event_target_as = old_bank_location
					clr_province_flag = location_has_bank
				}
				clear_persistent_event_target = location
				#Distribute remaining cash
				any_society_member = {
					set_variable = { which = bank_value which = PREV }
					multiply_variable = { which = bank_value which = shares }
					wealth = bank_value
					set_variable = { which = bank_value value = 0 }
					set_variable = { which = shares value = 0 }
					leave_society = yes
				}
				if = {
					limit = { is_society = iron_bank }
					clr_global_flag = iron_bank_founded
				}
				if = {
					limit = { is_society = rogare_bank }
					clr_global_flag = rogare_bank_founded
				}
				if = {
					limit = { is_society = qarth_bank }
					clr_global_flag = qarth_bank_founded
				}
				if = {
					limit = { is_society = valyria_bank }
					clr_global_flag = valyria_bank_founded
				}
				if = {
					limit = { is_society = bank_1 }
					clr_global_flag = bank_1_founded
				}
				if = {
					limit = { is_society = bank_2 }
					clr_global_flag = bank_2_founded
				}
				if = {
					limit = { is_society = bank_3 }
					clr_global_flag = bank_3_founded
				}
				if = {
					limit = { is_society = bank_4 }
					clr_global_flag = bank_4_founded
				}
				if = {
					limit = { is_society = bank_5 }
					clr_global_flag = bank_5_founded
				}
			}
		}
		hidden_tooltip = {
			any_player = {
				limit = {
					ai = no
					NOT = { character = ROOT }
				}
				character_event = { id = bankruptcy.2398 }
			}
		}
	}
}
character_event = { #Inform world disband
	id = bankruptcy.2398
	desc = EVTDESCbankruptcy.2398
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.2398
	}
}
###JOINING###

#From on_character_ask_to_join_society
character_event = {
    id = bankruptcy.24
	hide_window = yes
    is_triggered_only = yes
    trigger = {
    	FROM = { has_flag = bank_society }
    }
    immediate = {
    	FROM = {
			random_society_member = {
				preferred_limit = {
					society_rank == 4
					is_within_diplo_range = ROOT
				}
				preferred_limit = {
					society_rank == 3
					is_within_diplo_range = ROOT
				}
				preferred_limit = {
					society_rank == 4
				}
				character_event = { id = bankruptcy.25 }
			}
		}
    }
}

#Ping event
character_event = {
    id = bankruptcy.25
	hide_window = yes
    is_triggered_only = yes
    immediate = {
    	FROM = { letter_event = { id = bankruptcy.26 } }
    }
}

#Welcome letter
letter_event = {
    id = bankruptcy.26
    desc = EVTDESCbankruptcy.26
    border = GFX_event_letter_frame_economy

    is_triggered_only = yes

    option = {
        name = EVTOPTAbankruptcy.26
		clr_character_flag = has_been_bank_shareholder
		FROM = {
			society = {
				ROOT = { join_society = PREV }
			}
		}
		hidden_tooltip = {
			society = {
				if = {
					limit = {
						NOT = {
							any_society_member = {
								is_society_grandmaster = yes
							}
						}
					}
				}
				random_society_member = {
					limit = {
						society_rank == 4
						is_adult = yes
						is_incapable = no
					}
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = {
						society_rank == 3
						is_adult = yes
						is_incapable = no
					}
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 4 }
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 3 }
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 2 }
					set_society_grandmaster = yes
					set_variable = { which = shares value = 5 }
					break = yes
				}
				random_society_member = {
					set_society_grandmaster = yes
					set_variable = { which = shares value = 5 }
					break = yes
				}
			}
		}
    }
}
#Ai member trys to rank up
character_event = {
    id = bankruptcy.2698

    is_triggered_only = yes
	hide_window = yes
	ai = yes
	prisoner = no
	only_capable = yes
	min_age = 16

	trigger = {
		society = { has_flag = bank_society }
		society_rank < 3
		society_can_rank_up = yes
		wealth = 50
		OR = {
			society_rank == 1
			society_currency >= 750
		}
		NAND = {
			society_rank == 1
			society = { has_flag = not_accepting_investment }
		}
	}

	immediate = {
		character_event = { id = bankruptcy.30 tooltip = TOOLTIPbankruptcy.30 }
	}

    option = {
        name = OK
	}
}
#Left bank, receive shares in cash
character_event = {
	id = bankruptcy.27
	desc = EVTDESCbankruptcy.27
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	trigger = {
		FROM = { has_flag = bank_society }
		check_variable = { which = shares value = 1 }
	}

	immediate = {
		FROM = {
			#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
			set_variable = { which = shares which = ROOT }
			any_society_member = {
				limit = {
					society_rank > 2
					NOT = { character = ROOT }
				}
				society = { change_variable = { which = shares value = 5 } }
			}
			any_society_member = {
				limit = {
					society_rank == 2
					NOT = { character = ROOT }
				}
				society = { change_variable = { which = shares value = 1 } }
			}

			#Determine bank value
			set_variable = { which = bank_value which = cash_reserve }
			change_variable = { which = bank_value which = outstanding_loans }

			#Value per share
			divide_variable = { which = bank_value which = shares }
			if = {
				limit = { NOT = { check_variable = { which = bank_value value = 0 } } }
				set_variable = { which = bank_value value = 0 }
			}

			#Value of ROOT's shares
			ROOT = {
				set_variable = { which = bank_value which = PREV }
				multiply_variable = { which = bank_value which = shares }
			}

			set_variable = { which = bank_value which = ROOT }
			if = { #Make sure enough cash is in reserve. if not ROOT gets remaining cash reserve
				limit = { NOT = { check_variable = { which = cash_reserve which = bank_value } } }
				set_variable = { which = bank_value which = cash_reserve }
				ROOT = { set_variable = { which = bank_value which = PREV } }
			}
			multiply_variable = { which = bank_value value = -1 }

			if = { #If the new grandmaster is NOT a shareholder, promote all members
				limit = {
					any_society_member = {
						is_society_grandmaster = yes
						NOT = { check_variable = { which = shares value = 1 } }
					}
					NOT = { #no other shareholders
						any_society_member = {
							society_rank > 2
							is_society_grandmaster = no
						}
					}
				}
				any_society_member = {
					limit = {
						society_rank == 2
						is_adult = yes
						is_incapable = no
						prisoner = no
					}
					society_rank_up = 1
					set_variable = { which = shares value = 5 }
				}
				any_society_member = {
					limit = {
						society_rank == 1
						is_adult = yes
						is_incapable = no
						prisoner = no
					}
					society_rank_up = 1
					set_variable = { which = shares value = 1 }
				}
			}
			random_society_member = {
				limit = {
					is_society_grandmaster = yes
				}
				set_variable = { which = shares value = 5 }
			}
		}
	}

	option = {
		name = OK
		wealth = bank_value
		hidden_tooltip = {
			if = {
				limit = {
					OR = {
						is_adult = no
						is_incapable = no
					}
				}
				set_character_flag = has_been_bank_shareholder #makes AI more likely to rejoin in future
			}
			FROM = {
				change_variable = { which = cash_reserve which = bank_value }
				change_variable = { which = withdrawn_cash which = bank_value }
				set_variable = { which = bank_value value = 0 }
				if = { #Only important shareholders
					limit = { ROOT = { check_variable = { which = shares value = 2 } } }
					any_society_member = { #Inform society
						limit = { ai = no }
						character_event = { id = bankruptcy.28 }
					}
				}
			}
			set_variable = { which = bank_value value = 0 }
			set_variable = { which = shares value = 0 }
		}
	}
}
character_event = { #Inform society
	id = bankruptcy.28
	desc = EVTDESCbankruptcy.28
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = OK
	}
}
#RANK UP INVESTMENT
character_event = { #Has request rank up, determine investment needed
	id = bankruptcy.30

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		society = {
			if = {
				limit = {
					NOT = {
						any_society_member = {
							is_society_grandmaster = yes
						}
					}
				}
				random_society_member = {
					limit = {
						society_rank == 4
						is_adult = yes
						is_incapable = no
					}
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = {
						society_rank == 3
						is_adult = yes
						is_incapable = no
					}
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 4 }
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 3 }
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = {
						society_rank == 2
						NOT = { character = ROOT }
					}
					set_society_grandmaster = yes
					set_variable = { which = shares value = 5 }
					break = yes
				}
				random_society_member = {
					limit = {
						NOT = { character = ROOT }
					}
					set_society_grandmaster = yes
					set_variable = { which = shares value = 5 }
					break = yes
				}
			}
		}
	}

	option = {
		name = OK
		society = {
			if = { #Put block on new keyholders if too much capital already
				limit = {
					ROOT = { society_rank == 1 }
					has_flag = not_accepting_investment
				}
				ROOT = {
					set_variable = { which = bank_value value = 0 }
					set_variable = { which = cash_reserve value = 0 }
					clr_character_flag = has_sent_request_to_rank_up
				}
				break = yes
			}

			set_variable = { which = shares value = 0 }
			#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
			any_society_member = {
				limit = { society_rank > 2 }
				society = { change_variable = { which = shares value = 5 } }
			}
			any_society_member = {
				limit = { society_rank == 2 }
				society = { change_variable = { which = shares value = 1 } }
			}

			#Determine bank value
			set_variable = { which = bank_value which = cash_reserve }
			change_variable = { which = bank_value which = outstanding_loans }

			#Value per share
			divide_variable = { which = bank_value which = shares }

			##Share price
			#bank_value variable is now = value of 1 share
			#formula: share price = bank_value * 1.05 + ( ( 1.5 * bank_value ) / shares )
			#( 2 * bank_value ) / shares = variable_a
			set_variable = { which = variable_a which = bank_value }
			multiply_variable = { which = variable_a value = 1.5 }
			divide_variable = { which = variable_a which = shares }

			multiply_variable = { which = bank_value value = 1.05 }
			change_variable = { which = bank_value which = variable_a }
			set_variable = { which = variable_a value = 0 }
			if = { #must be at least 50
				limit = { NOT = { check_variable = { which = bank_value value = 50 } } }
				set_variable = { which = bank_value value = 50 }
			}

			ROOT = {
				set_variable = { which = bank_value which = PREV }
				if = { #ranking up to rank 3 requires the purchase of 4 shares
					limit = { society_rank == 2 }
					multiply_variable = { which = bank_value value = 4 }
				}
				set_variable = { which = cash_reserve which = bank_value }
				multiply_variable = { which = bank_value value = -1 }
				if = { #If not enough cash, end and inform
					limit = { NOT = { wealth = cash_reserve } }
					character_event = { id = bankruptcy.31 }
				}
				else = {#Else proceed
					character_event = { id = bankruptcy.32 }
				}
			}
		}
	}
}
character_event = { #Not enough cash
	id = bankruptcy.31
	desc = EVTDESCbankruptcy.31
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		#Determine if can borrow for shares
		if = {
			limit = {
				is_ruler = yes
				wealth = 50
				NOT = { has_character_flag = loan_taken }
				NOT = { has_character_modifier = loan_timer }
				NOT = { has_character_flag = offended_moneylenders }
				OR = {
					NOT = { has_character_flag = loan_insurer }
					war = no
				}
			}
			set_character_flag = has_checked_for_loan
			#Determine loan needed
			export_to_variable = { which = loan_amount value = wealth who = ROOT }
			multiply_variable = { which = loan_amount value = -1 }
			change_variable = { which = loan_amount which = cash_reserve }

			#Check enough income to qualify for loan
			#3 years income for share buy deal
			export_to_variable = { which = max_loan value = yearly_income who = ROOT }
			multiply_variable = { which = max_loan value = 3 }
			subtract_variable = { which = max_loan which = loan_amount }
			if = {
				limit = {
					check_variable = { which = max_loan value = 0 }
				}
				set_character_flag = can_take_loan_for_shares
			}
			set_variable = { which = max_loan value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.31
		ai_chance = {
			factor = 0
		}
		hidden_tooltip = {
			if = {
				limit = { has_character_flag = has_checked_for_loan }
				set_variable = { which = loan_amount value = 0 }
			}
		}
	}
	option = {
		name = EVTOPTBbankruptcy.31 #Buy with loans
		trigger = {
			has_character_flag = can_take_loan_for_shares
			society = { check_variable = { which = cash_reserve which = ROOT } }
		}
		ai_chance = {
			factor = 1
		}
		if = {
			limit = { society_rank == 1 }
			set_variable = { which = shares value = 1 }
		}
		else_if = {
			limit = { society_rank == 2 }
			set_variable = { which = shares value = 5 }
		}
		hidden_tooltip = {
			society = {
				any_society_member = { #Inform society
					limit = {
						ai = no
						NOT = { character = ROOT }
					}
					character_event = { id = bankruptcy.33 }
				}
			}
		}
		#Rank up cost
		if = {
			limit = { society_rank == 1 }
			change_society_currency = -750
		}
		if = {
			limit = { society_rank == 2 }
			change_society_currency = -1000
		}
		society_rank_up = 1
		clear_wealth = yes
		custom_tooltip = {
			text = TOOLTIPbankruptcy.31LOAN
			hidden_tooltip = {
				set_character_flag = loan_taken
				add_character_modifier = { name = "loan_timer" duration = 1825 }
				set_variable = { which = loan_interest value = 0.3 }
				clr_character_flag = loan_bank_minor
				society = {
					ROOT = { save_persistent_event_target = { name = loan_bank scope = PREV } }
					#Adjust banks records
					set_variable = { which = loan_amount which = ROOT }

					change_variable = { which = outstanding_loans which = loan_amount } #add loan to outstanding total

					multiply_variable = { which = loan_amount value = -1 }	#Then subtract from cash reserve
					change_variable = { which = cash_reserve which = loan_amount }

					set_variable = { which = loan_amount value = 0 } #clear variable
				}
			}
		}
		society = { change_variable = { which = cash_reserve which = ROOT } }
	}
	after = {
		hidden_tooltip = {
			set_variable = { which = bank_value value = 0 }
			set_variable = { which = cash_reserve value = 0 }
			clr_character_flag = has_checked_for_loan
			clr_character_flag = can_take_loan_for_shares
			clr_character_flag = has_sent_request_to_rank_up
		}
	}
}
character_event = { #Has enough cash
	id = bankruptcy.32
	desc = EVTDESCbankruptcy.32
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.32
		wealth = bank_value
		if = {
			limit = { society_rank == 1 }
			change_society_currency = -750
		}
		if = {
			limit = { society_rank == 2 }
			change_society_currency = -1000
		}
		if = {
			limit = { society_rank == 1 }
			set_variable = { which = shares value = 1 }
		}
		else_if = {
			limit = { society_rank == 2 }
			set_variable = { which = shares value = 5 }
		}
		hidden_tooltip = {
			society = {
				any_society_member = { #Inform society
					limit = {
						ai = no
						NOT = { character = ROOT }
					}
					character_event = { id = bankruptcy.33 }
				}
			}
		}
		society_rank_up = 1
		society = { change_variable = { which = cash_reserve which = ROOT } }
	}
	option = {
		name = EVTOPTBbankruptcy.32 #Change mind
		trigger = {
			ai = no
		}
	}
	after = {
		hidden_tooltip = {
			set_variable = { which = bank_value value = 0 }
			set_variable = { which = cash_reserve value = 0 }
			clr_character_flag = has_sent_request_to_rank_up
		}
	}
}
character_event = { #Inform society
	id = bankruptcy.33
	desc = EVTDESCbankruptcy.33
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	trigger = {
		NOT = { has_character_flag = bankruptcy_33_no_inform }
	}

	option = {
		name = OK
	}
	option = {
		name = EVTOPTBbankruptcy.33
		set_character_flag = bankruptcy_33_no_inform
	}
}

#Inherit bank shares
character_event = {
	id = bankruptcy.36

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		clear_event_target = bank_share_heir
		set_variable = { which = shares value = 0 } #stops cash out event triggering
		if = {
			limit = { society_rank > 2 }
			add_trait = employchancelor
		}
		if = { #if grandmaster and no clear heir, make sure share inheritor becomes grandmaster
			limit = {
				is_society_grandmaster = yes
				NOT = { society = { any_society_member = { society_rank > 2 } } }
			}
			add_trait = employsteward
		}
		if = { #Unlanded keyholders can pass on shares as cash
			limit = {
				society_rank == 2
				is_ruler = no
			}
			add_trait = employmarshall
		}
		if = { #landed heirs can always inherit bank shares
			limit = {
				is_patrician = yes
				family_palace = {
					current_heir = {
						is_theocracy = no
						OR = {
							is_in_society = no
							AND = {
								same_society_as = ROOT
								society_rank < 3
								NAND = {
									society_rank == 2
									ROOT = { society_rank == 2 }
								}
							}
						}
					}
				}
			}
			family_palace = {
				current_heir = {
					save_event_target_as = bank_share_heir
					break = yes
				}
			}
		}
		if = {
			limit = {
				is_ruler = yes
				current_heir = {
					OR = {
						dynasty = ROOT
						is_close_relative = ROOT
					}
					is_theocracy = no
					OR = {
						is_in_society = no
						AND = {
							same_society_as = ROOT
							society_rank < 3
							NAND = {
								society_rank == 2
								ROOT = { society_rank == 2 }
							}
						}
					}
					is_alive = yes
				}
			}
			current_heir = {
				save_event_target_as = bank_share_heir
				break = yes
			}
		}
		#find preferred gender
		if = {
			limit = {
				is_patrician = yes
				family_palace = {
					OR = {
						has_law = enatic_cognatic_succession
						has_law = enatic_succession
					}
				}
			}
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				is_patrician = yes
				family_palace = { has_law = true_cognatic_succession }
			}
			add_trait = employpriest
			#set_character_flag = prefer_male_bank_heir
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				is_ruler = yes
				primary_title = {
					OR = {
						has_law = enatic_cognatic_succession
						has_law = enatic_succession
					}
				}
			}
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				is_ruler = yes
				primary_title = {  has_law = true_cognatic_succession }
			}
			add_trait = employpriest
			#set_character_flag = prefer_male_bank_heir
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				liege = {
					is_patrician = yes
					family_palace = {
						OR = {
							has_law = enatic_cognatic_succession
							has_law = enatic_succession
						}
					}
				}
			}
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				liege = {
					is_patrician = yes
					family_palace = { has_law = true_cognatic_succession }
				}
			}
			add_trait = employpriest
			#set_character_flag = prefer_male_bank_heir
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				liege = {
					primary_title = {
						OR = {
							has_law = enatic_cognatic_succession
							has_law = enatic_succession
						}
					}
				}
			}
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else_if = {
			limit = {
				liege = {
					primary_title = {  has_law = true_cognatic_succession }
				}
			}
			add_trait = employpriest
			#set_character_flag = prefer_male_bank_heir
			add_trait = employdebutante
			#set_character_flag = prefer_female_bank_heir
		}
		else = {
			add_trait = employpriest
		}
		random_child = {
			limit = {
				is_alive = yes
				can_inherit_titles_trigger = yes
				has_ROOT_bank_society_prerequisites = yes
				OR = {
					is_in_society = no
					AND = {
						same_society_as = ROOT
						society_rank < 3
						NAND = {
							society_rank == 2
							ROOT = { society_rank == 2 }
						}
					}
					ROOT = { trait = employmarshall } #can pass on as cash
				}
				OR = {
					AND = {
						is_female = no
						ROOT = { trait = employpriest }
					}
					AND = {
						is_female = yes
						ROOT = { trait = employdebutante }
					}
				}
				NOT = {
					ROOT = {
						any_child = {
							is_alive = yes
							NOT = { character = PREVPREV }
							is_older_than = PREVPREV
							NOT = { lower_tier_than = PREVPREV }
							can_inherit_titles_trigger = yes
							has_ROOT_bank_society_prerequisites = yes
							OR = {
								is_in_society = no
								AND = {
									same_society_as = ROOT
									society_rank < 3
									NAND = {
										society_rank == 2
										ROOT = { society_rank == 2 }
									}
								}
								ROOT = { trait = employmarshall } #can pass on as cash
							}
							OR = {
								AND = {
									is_female = no
									ROOT = { trait = employpriest }
								}
								AND = {
									is_female = yes
									ROOT = { trait = employdebutante }
								}
							}
						}
					}
				}
			}
			save_event_target_as = bank_share_heir
			character_event = { id = bankruptcy.37 }
			break = yes
		}
		random_child = {
			limit = {
				is_alive = yes
				can_inherit_titles_trigger = yes
				has_ROOT_bank_society_prerequisites = yes
				OR = {
					is_in_society = no
					AND = {
						same_society_as = ROOT
						society_rank < 3
						NAND = {
							society_rank == 2
							ROOT = { society_rank == 2 }
						}
					}
					ROOT = { trait = employmarshall } #can pass on as cash
				}
				NOT = {
					ROOT = {
						any_child = {
							is_alive = yes
							NOT = { character = PREVPREV }
							is_older_than = PREVPREV
							NOT = { lower_tier_than = PREVPREV }
							can_inherit_titles_trigger = yes
							has_ROOT_bank_society_prerequisites = yes
							OR = {
								is_in_society = no
								AND = {
									same_society_as = ROOT
									society_rank < 3
									NAND = {
										society_rank == 2
										ROOT = { society_rank == 2 }
									}
								}
								ROOT = { trait = employmarshall } #can pass on as cash
							}
						}
					}
				}
			}
			save_event_target_as = bank_share_heir
			character_event = { id = bankruptcy.37 }
			break = yes
		}
		random_close_relative = {
			limit = {
				is_alive = yes
				has_ROOT_bank_society_prerequisites = yes
				OR = {
					is_child_of = ROOT
					dynasty = ROOT
				}
				OR = {
					is_in_society = no
					AND = {
						same_society_as = ROOT
						society_rank < 3
						NAND = {
							society_rank == 2
							ROOT = { society_rank == 2 }
						}
					}
					ROOT = { trait = employmarshall } #can pass on as cash
				}
			}
			preferred_limit = {
				dynasty = ROOT
				is_child_of = ROOT
			}
			preferred_limit = {
				is_child_of = ROOT
			}
			preferred_limit = {
				is_descendant_of = ROOT
			}
			preferred_limit = {
				is_parent_of = ROOT
			}
			preferred_limit = {
				sibling = ROOT
			}
			save_event_target_as = bank_share_heir
			character_event = { id = bankruptcy.37 }
			break = yes
		}
		random_spouse = {
			limit = {
				is_alive = yes
				has_ROOT_bank_society_prerequisites = yes
				OR = {
					is_in_society = no
					AND = {
						same_society_as = ROOT
						society_rank < 3
						NAND = {
							society_rank == 2
							ROOT = { society_rank == 2 }
						}
					}
					ROOT = { trait = employmarshall } #can pass on as cash
				}
			}
			save_event_target_as = bank_share_heir
			character_event = { id = bankruptcy.37 }
			break = yes
		}
		if = {
			limit = { is_lowborn = no }
			random_dynasty_member = {
				limit = {
					is_alive = yes
					has_ROOT_bank_society_prerequisites = yes
					OR = {
						is_in_society = no
						AND = {
							same_society_as = ROOT
							society_rank < 3
							NAND = {
								society_rank == 2
								ROOT = { society_rank == 2 }
							}
						}
						ROOT = { trait = employmarshall } #can pass on as cash
					}
				}
				preferred_limit = {
					is_descendant_of = ROOT
				}
				preferred_limit = {
					is_parent_of = ROOT
				}
				preferred_limit = {
					sibling = ROOT
				}
				preferred_limit = {
					is_close_relative = ROOT
				}
				save_event_target_as = bank_share_heir
				character_event = { id = bankruptcy.37 }
				break = yes
			}
		}
		#If no heir found, cash out
		if = {
			limit = { society_rank > 2 }
			set_variable = { which = shares value = 5 }
		}
		else = {
			set_variable = { which = shares value = 1 }
		}
		event_target:bank_society = {
			#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
			set_variable = { which = shares value = 0 }
			any_society_member = {
				limit = { society_rank > 2 }
				society = { change_variable = { which = shares value = 5 } }
			}
			any_society_member = {
				limit = { society_rank == 2 }
				society = { change_variable = { which = shares value = 1 } }
			}

			#Determine bank value
			set_variable = { which = bank_value which = cash_reserve }
			change_variable = { which = bank_value which = outstanding_loans }

			#Value per share
			divide_variable = { which = bank_value which = shares }
			if = {
				limit = { NOT = { check_variable = { which = bank_value value = 0 } } }
				set_variable = { which = bank_value value = 0 }
			}

			#Value of ROOT's shares
			ROOT = {
				set_variable = { which = bank_value which = PREV }
				multiply_variable = { which = bank_value which = shares }
				wealth = bank_value
			}

			set_variable = { which = bank_value which = ROOT }
			multiply_variable = { which = bank_value value = -1 }

			change_variable = { which = cash_reserve which = bank_value }
			set_variable = { which = bank_value value = 0 }
			any_society_member = { #Inform society
				limit = { ai = no }
				character_event = { id = bankruptcy.38 }
			}
		}
		set_variable = { which = bank_value value = 0 }
		set_variable = { which = shares value = 0 }
	}

	option = {
		name = OK
		event_target:bank_share_heir = {

			##Split inheritances
			if = {
				limit = { ROOT = { has_character_flag = split_bank_shares_on_inheritance } }
				ROOT = {
					if = { #If sole shareholder, extra heirs become shareholders
						limit = {
							society = {
								NOT = {
									any_society_member = {
										society_rank > 2
										NOT = { character = ROOT }
									}
								}
							}
						}
						add_trait = employspy
					}
					any_dynasty_member = { #Closest 4 relatives become extra heirs
						count = 4
						limit = {
							NOT = { character = ROOT }
							NOT = { character = event_target:bank_share_heir }
							is_alive = yes
							NOT = { is_child_of = event_target:bank_share_heir }
							NOT = {
								father = {
									same_society_as = ROOT
									society_rank == 3
									NOT = { character = ROOT }
								}
							}
							NOT = {
								mother = {
									same_society_as = ROOT
									society_rank == 3
									NOT = { character = ROOT }
								}
							}
							has_ROOT_bank_society_prerequisites = yes
							OR = {
								is_in_society = no
								AND = {
									same_society_as = ROOT
									society_rank == 1
								}
								AND = {
									same_society_as = ROOT
									society_rank == 2
									ROOT = { trait = employspy }
								}
							}
						}
						score_value = {
							value = 1
							additive_modifier = {
								value = 180
								is_child_of = ROOT
							}
							additive_modifier = {
								value = 150
								is_grandchild_of = ROOT
								NOT = { is_child_of = ROOT }
							}
							additive_modifier = {
								value = 120
								sibling = ROOT
							}
							additive_modifier = {
								value = 90
								is_nibling_of = ROOT
							}
							additive_modifier = {
								value = 60
								is_aunt_uncle_of = ROOT
							}
							additive_modifier = {
								value = 30
								is_close_relative = ROOT
								NOT = { is_nibling_of = ROOT }
								NOT = { sibling = ROOT }
								NOT = { is_grandchild_of = ROOT }
								NOT = { is_child_of = ROOT }
								NOT = { is_aunt_uncle_of = ROOT }
							}
							additive_modifier = {
								value = 45
								OR = {
									AND = {
										is_female = no
										ROOT = { trait = employpriest }
									}
									AND = {
										is_female = yes
										ROOT = { trait = employdebutante }
									}
								}
							}
							additive_modifier = {
								value = 45
								can_inherit_titles_trigger = yes
							}
							additive_modifier = {
								value = 1
								age = 5
							}
							additive_modifier = {
								value = 1
								age = 10
							}
							additive_modifier = {
								value = 1
								age = 15
							}
							additive_modifier = {
								value = 1
								age = 20
							}
							additive_modifier = {
								value = 1
								age = 25
							}
							additive_modifier = {
								value = 1
								age = 30
							}
							additive_modifier = {
								value = 1
								age = 35
							}
							additive_modifier = {
								value = 1
								age = 40
							}
							additive_modifier = {
								value = 1
								age = 45
							}
							additive_modifier = {
								value = 1
								age = 50
							}
							additive_modifier = {
								value = 1
								age = 55
							}
							additive_modifier = {
								value = 1
								age = 60
							}
						}
						join_society = event_target:bank_society
						if = { #Shareholder
							limit = { ROOT = { trait = employspy } }
							if = {
								limit = { society_rank == 2 }
								society_rank_up = 1
							}
							else_if = {
								limit = { society_rank == 1 }
								society_rank_up = 2
							}
							set_variable = { which = shares value = 5 }
						}
						else = { #Keyholder
							society_rank_up = 1
							set_variable = { which = shares value = 1 }
						}
						character_event = { id = bankruptcy.37 }
					}
					clr_character_flag = split_bank_shares_on_inheritance
					remove_trait = employspy
				}
			}
			##
			if = { #Will receive inheritance as cash (must be keyholder/1 share)
				limit = {
					NOR = {
						is_in_society = no
						AND = {
							same_society_as = ROOT
							society_rank < 3
							NAND = {
								society_rank == 2
								ROOT = { society_rank == 2 }
							}
						}
					}
				}
				ROOT = {
					set_variable = { which = shares value = 1 }
					event_target:bank_society = {
						#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
						set_variable = { which = shares value = 0 }
						any_society_member = {
							limit = { society_rank > 2 }
							society = { change_variable = { which = shares value = 5 } }
						}
						any_society_member = {
							limit = { society_rank == 2 }
							society = { change_variable = { which = shares value = 1 } }
						}

						#Determine bank value
						set_variable = { which = bank_value which = cash_reserve }
						change_variable = { which = bank_value which = outstanding_loans }

						#Value per share
						divide_variable = { which = bank_value which = shares }
						if = {
							limit = { NOT = { check_variable = { which = bank_value value = 0 } } }
							set_variable = { which = bank_value value = 0 }
						}

						#Value of ROOT's shares
						event_target:bank_share_heir = {
							set_variable = { which = bank_value which = PREV }
							wealth = bank_value
						}

						multiply_variable = { which = bank_value value = -1 }

						change_variable = { which = cash_reserve which = bank_value }
						set_variable = { which = bank_value value = 0 }
					}
					event_target:bank_share_heir = { set_variable = { which = bank_value value = 0 } }
					set_variable = { which = shares value = 0 }
				}
			}
			else = { #Join society
				join_society = event_target:bank_society
				if = {
					limit = { ROOT = { trait = employchancelor } } #Is rank 3+
					if = {
						limit = { society_rank == 2 }
						society_rank_up = 1
					}
					else_if = {
						limit = { society_rank == 1 }
						society_rank_up = 2
					}
					set_variable = { which = shares value = 5 }
					ROOT = { remove_trait = employchancelor }
				}
				else = {
					if = {
						limit = { society_rank < 2 }
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
					}
				}
				if = {
					limit = { ROOT = { trait = employsteward } } #make new grandmaster
					set_society_grandmaster = yes
					ROOT = { remove_trait = employsteward }
				}
			}
		}
		if = {
			limit = { trait = employsteward } #new grandmaster needed
			event_target:bank_society = {
				random_society_member = {
					limit = {
						is_society_grandmaster = yes
						NOT = { character = ROOT }
					}
					set_variable = { which = shares value = 5 }
				}
			}
			remove_trait = employsteward
		}
		remove_trait = employmarshall
		remove_trait = employdebutante
		remove_trait = employpriest
		#clr_character_flag = prefer_male_bank_heir
		#clr_character_flag = prefer_female_bank_heir
	}
}
character_event = { #Inform
	id = bankruptcy.37
	desc = EVTDESCbankruptcy.37
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.37
	}
}
character_event = { #Inform society cashed out
	id = bankruptcy.38
	desc = EVTDESCbankruptcy.38
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = OK
	}
}
##DEALING WITH ROGUE DEBTORS
character_event = {
	id = bankruptcy.45

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_ruler = yes
		OR = {
			has_character_flag = offended_moneylenders
			has_character_flag = loan_default
		}
		check_variable = { which = loan_amount value = 1 }
		NOT = {
			any_quester_targeting_this = {
				has_quest = quest_bank_recover_debt
			}
		}
	}

	immediate = {
		persistent_event_target:loan_bank = {
			if = {
				limit = {
					NOT = {
						any_society_member = {
							is_society_grandmaster = yes
						}
					}
				}
				random_society_member = {
					limit = {
						society_rank == 4
						is_adult = yes
						is_incapable = no
					}
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = {
						society_rank == 3
						is_adult = yes
						is_incapable = no
					}
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 4 }
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 3 }
					set_society_grandmaster = yes
					break = yes
				}
				random_society_member = {
					limit = { society_rank == 2 }
					set_society_grandmaster = yes
					set_variable = { which = shares value = 5 }
					break = yes
				}
				random_society_member = {
					set_society_grandmaster = yes
					set_variable = { which = shares value = 5 }
					break = yes
				}
			}
		}
	}

	option = {
		name = OK
		#If this is a high value/rank debtor, the high council votes
		if = {
			limit = {
				OR = {
					higher_tier_than = DUKE
					check_variable = { which = loan_amount value = 400 }
				}
				NOT = { has_character_flag = looted_bank }
				persistent_event_target:loan_bank = {
					any_society_member = {
						count = 2

						society_rank == 4
						is_adult = yes
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
						NOT = { character = ROOT }
					}
				}
			}
			persistent_event_target:loan_bank = {
				any_society_member = {
					limit = {
						society_rank == 4
						is_adult = yes
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
						NOT = { character = ROOT }
					}
					character_event = { id = bankruptcy.90 }
				}
				any_society_member = {	#inform society result
					limit = { ai = no	}
					character_event = { id = bankruptcy.91 days = 2 }
				}
			}
			character_event = { id = bankruptcy.92 days = 3 }
		}
		else_if = { #If not, a random high councillor decides
			limit = { persistent_event_target:loan_bank = { always = yes } }
			persistent_event_target:loan_bank = {
				random_society_member = {
					limit = {
						society_rank == 4
						NOT = { character = ROOT }
					}
					preferred_limit = {
						NOR = { #conflict of interest
							is_close_relative = ROOT
							has_blood_oath_with = ROOT
							is_lover = ROOT
							is_friend = ROOT
							is_married = ROOT
							is_allied_with = ROOT
							current_heir = { character = ROOT }
						}
						NAND = {
							ai = no
							has_character_flag = minor_debtor_event_block
						}
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
					}
					preferred_limit = {
						NAND = {
							ai = no
							has_character_flag = minor_debtor_event_block
						}
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
					}
					preferred_limit = {
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
					}
					character_event = { id = bankruptcy.46 }
				}
			}
		}
		else_if = { #Loan was from a minor bank
			limit = { has_character_flag = loan_bank_minor }
			persistent_event_target:minor_bank_location = { #recorded minor bank location for consistentcy
				owner = {
					random_courtier = {
						limit = {
							can_be_minor_bank_envoy_trigger = yes
						}
						character_event = { id = bankruptcy.95 }
						break = yes
					}
				}
			}
			#Find random nearby character to act as a banker
			random_playable_ruler = {
				limit = {
					is_within_diplo_range = ROOT
					NOT_mythical_creature_trigger = yes
					NOT = { trait = pirate }
					NOT = { trait = wildling }
					NOT = { character = ROOT }
					is_nomadic = no
					any_courtier = {
						can_be_minor_bank_envoy_trigger = yes
					}
				}
				preferred_limit = {
					NOT = { same_realm = ROOT }
					OR = {
						is_patrician = yes
						capital_scope = { any_province_holding = { is_richer_holding = yes } }
						has_landed_title = c_oldtown
					}
				}
				preferred_limit = {
					OR = {
						is_patrician = yes
						capital_scope = { any_province_holding = { is_richer_holding = yes } }
						has_landed_title = c_oldtown
					}
				}
				preferred_limit = {
					yearly_income = 100
				}
				capital_scope = { ROOT = { save_persistent_event_target = { name = minor_bank_location scope = PREV } } }
				random_courtier = {
					limit = {
						can_be_minor_bank_envoy_trigger = yes
					}
					character_event = { id = bankruptcy.95 }
					break = yes
				}
			}
			#if none found, create a random
			random_playable_ruler = {
				limit = {
					is_within_diplo_range = ROOT
					NOT_mythical_creature_trigger = yes
					NOT = { trait = pirate }
					NOT = { trait = wildling }
					is_nomadic = no
					NOT = { character = ROOT }
				}
				preferred_limit = {
					OR = {
						is_patrician = yes
						capital_scope = { any_province_holding = { is_richer_holding = yes } }
						has_landed_title = c_oldtown
					}
				}
				preferred_limit = {
					yearly_income = 100
				}
				capital_scope = {
					ROOT = { save_persistent_event_target = { name = minor_bank_location scope = PREV } }
					owner = {
						create_random_steward = {
							random_traits = yes
							dynasty = none
							culture = PREV
							religion = PREV
							female = no
							historical = yes
						}
						new_character = {
							set_immune_to_pruning = yes
							remove_trait = slow
							remove_trait = slow_1
							remove_trait = imbecile
							remove_trait = imbecile_1
							remove_trait = dull

							remove_lifestyle_trait_effect = yes

							random_list = { # Flavor Randomization
								35 = {
									# Nothing
								}
								15 = {
									change_stewardship = 2
								}
								10 = {
									add_trait = architect
								}
								10 = {
									add_trait = administrator
								}
								10 = {
									change_stewardship = 4
								}
								5 = {
									change_stewardship = 6
								}
								5 = {
									trigger = {
										is_smart_incl_genius_trigger = no
									}
									add_trait = shrewd
								}
							}
							if = {
								limit = {
									culture_group = hyrkoon_group
								}
								add_trait = eunuch
							}
							while = {
								limit = { stewardship < 8 }
								change_stewardship = 1
							}
							character_event = { id = bankruptcy.95 }
						}
					}
				}
			}
		}
	}
}
character_event = { #High councillor decides
	id = bankruptcy.46
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	#Default on interest
	desc = {
		text = EVTDESCbankruptcy.46
		trigger = {
			FROM = {
				NOT = { has_character_flag = imprisoned_bank_envoy }
				NOT = { has_character_flag = offended_moneylenders }
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.46B
		trigger = {
			FROM = {
				has_character_flag = imprisoned_bank_envoy
				NOT = { has_character_flag = offended_moneylenders }
			}
		}
	}
	#Dishonoured loan
	desc = {
		text = EVTDESCbankruptcy.46C
		trigger = {
			FROM = {
				has_character_flag = offended_moneylenders
				NOT = { has_character_flag = looted_bank }
				NOT = { has_character_flag = imprisoned_bank_envoy }
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.46D
		trigger = {
			FROM = {
				has_character_flag = offended_moneylenders
				NOT = { has_character_flag = looted_bank }
				has_character_flag = imprisoned_bank_envoy
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.46E
		trigger = {
			FROM = {
				has_character_flag = offended_moneylenders
				has_character_flag = looted_bank
			}
		}
	}

	immediate = {
		hidden_tooltip = {
			#Round loan to down to integer for the player
			if = {
				limit = { ai = no }
				FROM = { round_loan_to_integer_effect = yes }
			}
			society = {
				random_society_member = {
					limit = {
						society_rank < 4
						has_any_quest = no
						NOT = { has_character_modifier = quest_cooldown_timer }
						is_adult = yes
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
						NOT = { character = ROOT }
						NOT = { character = FROM }
					}
					preferred_limit = {
						FROM = { higher_tier_than = DUKE }
						society_rank > 1
						NAND = { #monarchs wont stoop to this level
							can_wear_a_crown_trigger = yes
							NOT = { trait = humble }
						}
						NOR = { #conflict of interest
							is_close_relative = FROM
							has_blood_oath_with = FROM
							is_lover = FROM
							is_friend = FROM
							is_married = FROM
							is_allied_with = FROM
							current_heir = { character = FROM }
						}
					}
					preferred_limit = {
						FROM = { lower_tier_than = DUKE }
						society_rank == 1
						NAND = { #high rank rulers wont stoop to this level
							is_feudal = yes
							higher_tier_than = COUNT
							NOT = { trait = humble }
						}
						NOR = { #conflict of interest
							is_close_relative = FROM
							has_blood_oath_with = FROM
							is_lover = FROM
							is_friend = FROM
							is_married = FROM
							is_allied_with = FROM
							current_heir = { character = FROM }
						}
					}
					preferred_limit = {
						NOR = { #conflict of interest
							is_close_relative = FROM
							has_blood_oath_with = FROM
							is_lover = FROM
							is_friend = FROM
							is_married = FROM
							is_allied_with = FROM
							current_heir = { character = FROM }
						}
					}
					save_event_target_as = delegate_target
					break = yes
				}
			}
			#If no envoy found, create a random
			capital_scope = {
				ROOT = {
					create_random_steward = {
						random_traits = yes
						dynasty = none
						culture = PREV
						religion = PREV
						female = no
						historical = yes
					}
					new_character = {
						join_society = ROOT
						save_event_target_as = delegate_target
						set_immune_to_pruning = yes

						remove_trait = slow
						remove_trait = slow_1
						remove_trait = imbecile
						remove_trait = imbecile_1
						remove_trait = dull

						remove_lifestyle_trait_effect = yes

						random_list = { # Flavor Randomization
							35 = {
								# Nothing
							}
							15 = {
								change_stewardship = 2
							}
							10 = {
								add_trait = architect
							}
							10 = {
								add_trait = administrator
							}
							10 = {
								change_stewardship = 4
							}
							5 = {
								change_stewardship = 6
							}
							5 = {
								trigger = {
									is_smart_incl_genius_trigger = no
								}
								add_trait = shrewd
							}
						}
						if = {
							limit = {
								culture_group = hyrkoon_group
							}
							add_trait = eunuch
						}
						while = {
							limit = { stewardship < 10 }
							change_stewardship = 1
						}
					}
				}
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.46 #Delegate
		ai_chance = {
			factor = 50
		}
		show_portrait = event_target:delegate_target
		event_target:delegate_target = {
			society_quest_event = { id = bankruptcy.47 tooltip = TOOLTIPbankruptcy.47 }
		}
	}
	option = {
		name = EVTOPTBbankruptcy.46 #Sort myself
		trigger = {
			is_adult = yes
			prisoner = no
			is_incapable = no
			NOT = { is_inaccessible_trigger = yes }
			has_any_quest = no
		}
		ai_chance = {
			factor = 25

			modifier = { #conflict of interest
				factor = 0
				FROM = {
					OR = {
						is_close_relative = ROOT
						has_blood_oath_with = ROOT
						is_lover = ROOT
						is_friend = ROOT
						is_married = ROOT
						is_allied_with = ROOT
						current_heir = { character = ROOT }
					}
				}
			}

			modifier = {
				factor = 0
				trait = slothful
			}
			modifier = {
				factor = 0.25
				trait = proud
			}
			modifier = {
				factor = 0
				trait = proud
				FROM = { lower_tier_than = DUKE }
			}
			modifier = {
				factor = 0
				NOT = { can_wear_a_crown_trigger = yes } #monarchs wont stoop to this level
				NOT = { trait = humble }
			}
			modifier = { #high rank rulers wont stoop to this level
				factor = 0
				FROM = { lower_tier_than = KING }
				is_feudal = yes
				higher_tier_than = COUNT
				NOT = { trait = humble }
			}

			modifier = {
				factor = 2
				trait = diligent
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 0.25
				trait = shy
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.5
				FROM = { tier = DUKE }
			}
			modifier = {
				factor = 0
				FROM = { lower_tier_than = DUKE }
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.46B
		}
		hidden_tooltip = {
			clear_event_target = delegate_target
			FROM = {
				set_quest_target = {
					id = quest_bank_recover_debt
					holder = ROOT
				}
			}
			character_event = { id = bankruptcy.48 days = 5 }
		}
	}
	option = {
		name = EVTOPTCbankruptcy.46 #Do nothing
		trigger = { NOT = { has_character_flag = council_voted_for_action } }
		ai_chance = {
			factor = 1

			modifier = {
				factor = 5
				is_allied_with = FROM
			}
			modifier = {
				factor = 5
				is_close_relative = FROM
			}
			modifier = {
				factor = 5
				opinion = { who = FROM value = 60 }
			}
			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = FROM value = 30 } }
			}
		}
		detract_society_currency_major_effect = yes
	}
	option = {
		name = EVTOPTDbankruptcy.46 #Do not bother me with minor debtors (must have AI available to take on duty)
		trigger = {
			ai = no
			NOT = { has_character_flag = council_voted_for_action }
			society = {
				any_society_member = {
					society_rank > 2
					NOT = { character = ROOT }
					prisoner = no
					is_incapable = no
					NOT = { is_inaccessible_trigger = yes }
					ai = yes
				}
			}
		}
		society = {
			if = { #Promote someone if neccessary
				limit = {
					NOT = {
						any_society_member = {
							society_rank == 4
							NOT = { character = ROOT }
							prisoner = no
							is_incapable = no
							NOT = { is_inaccessible_trigger = yes }
							ai = yes
						}
					}
				}
				random_society_member = {
					limit = {
						society_rank == 3
						NOT = { character = ROOT }
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
						ai = yes
					}
					society_rank_up = 1
				}
			}
		}
		detract_society_currency_medium_effect = yes
		set_character_flag = minor_debtor_event_block
		event_target:delegate_target = {
			society_quest_event = { id = bankruptcy.47 tooltip = TOOLTIPbankruptcy.47 }
		}
	}
	after = {
		clr_character_flag = council_voted_for_action
	}
}
society_quest_event = { #Delegated mission
	id = bankruptcy.47
	quest_target = FROMFROM

	is_triggered_only = yes

	#Default on interest
	desc = {
		text = EVTDESCbankruptcy.47
		trigger = {
			FROMFROM = {
				NOT = { has_character_flag = offended_moneylenders }
			}
		}
	}
	#Dishonoured loan
	desc = {
		text = EVTDESCbankruptcy.47B
		trigger = {
			FROMFROM = {
				has_character_flag = offended_moneylenders
				NOT = { has_character_flag = looted_bank }
			}
		}
	}
	#Looted Bank
	desc = {
		text = EVTDESCbankruptcy.47C
		trigger = {
			FROMFROM = {
				has_character_flag = offended_moneylenders
				has_character_flag = looted_bank
			}
		}
	}

	immediate = {
		#Round loan to down to integer for the player
		if = {
			limit = { ai = no }
			FROMFROM = { round_loan_to_integer_effect = yes }
		}
	}

	option = { #accept
		name = ACCEPT
		custom_tooltip = {
			text = TOOLTIPbankruptcy.47B
		}
		hidden_tooltip = {
			FROMFROM = {
				set_quest_target = {
					id = quest_bank_recover_debt
					holder = ROOT
				}
			}
			character_event = { id = bankruptcy.48 days = 5 }
		}
	}
	option = { #nah thx
		name = DECLINE
		custom_tooltip = { text = decline_quest_tooltip }

		hidden_tooltip = {
			add_character_modifier = {
				name = quest_cooldown_timer
				hidden = yes
				days = 365
			}
			FROMFROM = { character_event = { id = bankruptcy.45 } } #start again
		}
		ai_chance = { factor = 0 }
	}
}
character_event = { #Quest maintenance
	id = bankruptcy.48

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = {
			limit = {
				NOT = { has_quest = quest_bank_recover_debt }
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			break = yes
		}
		if = { #Quest no longer valid
			limit = {
				OR = {
					prisoner = yes
					is_incapable = yes
					is_inaccessible_trigger = yes
					NOT = { society = { has_flag = bank_society } }
					quest_target = {
						OR = {
							is_alive = no
							is_ruler = no
							NOT = { check_variable = { which = loan_amount value = 1 } }
							NOR = {
								has_character_flag = offended_moneylenders
								has_character_flag = loan_default
							}
							persistent_event_target:loan_bank = { ROOT = { NOT = { society_member_of = PREV } } }
							has_character_flag = loan_bank_minor
						}
					}
				}
			}
			character_event = { id = bankruptcy.50 }
			break = yes
		}
		if = { #Check progress of enemy funding
			limit = { has_character_flag = quest_bank_recover_debt_FUNDING_ENEMY }
			if = { #is the war still going?
				limit = {
					quest_target = {
						any_current_enemy = {
							persistent_event_target:loan_insurance_target = {
								character = PREVPREV
							}
						}
					}
				}
				character_event = { id = bankruptcy.48 days = 180 } #check progress again
				break = yes
			}
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
		}
		character_event = { id = bankruptcy.49 }
	}

	option = {
		name = OK
	}
}
character_event = { #Decide recover debt action
	id = bankruptcy.49
	desc = EVTDESCbankruptcy.49
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		quest_target = { save_event_target_as = debtor_target }
		hidden_tooltip = {
			if = { #Only go for assasination if it would help
				limit = {
					quest_target = {
						OR = {
							has_character_flag = offended_moneylenders #Debtor is purposefully dishonourable
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_rejected_delegation } #Debtor has rejected a delegation
							has_character_flag = imprisoned_bank_envoy
							current_heir = { #Heir has means to pay
								OR = {
									is_liege_of = PREV
									wealth = 250
								}
							}
						}
					}
				}
				#Determine faceless/sorrowful man hit cost
				if = {
					limit = {
						OR = {
							year = 7600
							location = {
								OR = {
									region = world_far_east
									region = world_jade_sea
									region = world_ghiscar
									region = world_dothraki
								}
							}
						}
					}

					quest_target = {
						if = {
							limit = {
								tier = EMPEROR
								check_variable = { which = loan_amount value = 800 } #Loan must be at least 4X cost
								ROOT = { society = { check_variable = { which = cash_reserve value = 200 } } }
							}
							ROOT = { society = { set_variable = { which = faceless_cost value = -200 } } }
						}
						else_if = {
							limit = {
								tier = KING
								check_variable = { which = loan_amount value = 600 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 150 } } }
							}
							ROOT = { society = { set_variable = { which = faceless_cost value = -150 } } }
						}
						else_if = {
							limit = {
								tier = DUKE
								check_variable = { which = loan_amount value = 400 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 100 } } }
							}
							ROOT = { society = { set_variable = { which = faceless_cost value = -100 } } }
						}
						else_if = {
							limit = {
								tier = COUNT
								check_variable = { which = loan_amount value = 300 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 75 } } }
							}
							ROOT = { society = { set_variable = { which = faceless_cost value = -75 } } }
						}
						else_if = {
							limit = {
								tier = BARON
								check_variable = { which = loan_amount value = 100 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 25 } } }
							}
							ROOT = { society = { set_variable = { which = faceless_cost value = -25 } } }
						}
					}
				}
				#Determine normal hit cost
				if = {
					limit = { NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN } }
					quest_target = {
						if = {
							limit = {
								tier = EMPEROR
								check_variable = { which = loan_amount value = 240 } #Loan must be at least 4X cost
								ROOT = { society = { check_variable = { which = cash_reserve value = 60 } } }
							}
							ROOT = { society = { set_variable = { which = assassin_cost value = -60 } } }
						}
						else_if = {
							limit = {
								tier = KING
								check_variable = { which = loan_amount value = 160 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 40 } } }
							}
							ROOT = { society = { set_variable = { which = assassin_cost value = -40 } } }
						}
						else_if = {
							limit = {
								tier = DUKE
								check_variable = { which = loan_amount value = 120 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 30 } } }
							}
							ROOT = { society = { set_variable = { which = assassin_cost value = -30 } } }
						}
						else_if = {
							limit = {
								tier = COUNT
								check_variable = { which = loan_amount value = 80 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 20 } } }
							}
							ROOT = { society = { set_variable = { which = assassin_cost value = -20 } } }
						}
						else_if = {
							limit = {
								tier = BARON
								check_variable = { which = loan_amount value = 40 }
								ROOT = { society = { check_variable = { which = cash_reserve value = 10 } } }
							}
							ROOT = { society = { set_variable = { which = assassin_cost value = -10 } } }
						}
					}
				}
			}
			#Check if letter to liege/top liege is valid
			if = {
				limit = {
					NOT = { has_character_flag = quest_bank_recover_debt_LIEGE_LETTER }
					quest_target = {
						check_variable = { which = loan_amount value = 15 } #min loan to petition liege
						OR = {
							check_variable = { which = loan_amount value = 50 }
							NOT = { tier = COUNT }
							top_liege = { NOT = { tier = EMPEROR } }
						}
						liege = {
							NOT = { character = PREV }
							NOT = { character = ROOT }
							NAND = {
								society_rank == 4
								same_society_as = ROOT
							}
						}
						NOT = { has_character_flag = looted_bank }
					}
				}
				set_character_flag = can_send_liege_letter
			}
			if = {
				limit = {
					has_character_flag = quest_bank_recover_debt_LIEGE_LETTER #has attempted direct liege
					NOT = { has_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER }
					quest_target = {
						check_variable = { which = loan_amount value = 30 } #min loan to petition top liege
						OR = {
							check_variable = { which = loan_amount value = 100 }
							NOT = { tier = COUNT }
							top_liege = { NOT = { tier = EMPEROR } }
						}
						top_liege = {
							NOT = { is_liege_of = PREV }
							NOT = { character = ROOT }
							NAND = {
								society_rank == 4
								same_society_as = ROOT
							}
						}
						NOT = { has_character_flag = looted_bank }
						NOT = { liege = { character = PREV } }
					}
				}
				set_character_flag = can_send_top_liege_letter
			}
			#Find potential artifact to claim
			clear_event_target = artifact_debt
			if = {
				limit = { NOT = { has_character_flag = quest_bank_recover_debt_ARTIFACT } }
				quest_target = {
					random_artifact = {
						limit = {
							NOT = { has_artifact_flag = no_usurp_transfer }
							NOT = { has_artifact_flag = curse }
							OR = {
								AND = {
									NOT = { has_artifact_flag = valyrian_steel }
									NOT = { has_artifact_flag = valyrian_armour }
									NOT = { has_artifact_flag = book }
									OR = {
										AND = {
											quality == 1
											owner = { NOT = { check_variable = { which = loan_amount value = 33 } } }
										}
										AND = {
											quality == 2
											owner = {
												check_variable = { which = loan_amount value = 33 }
												NOT = { check_variable = { which = loan_amount value = 67 } }
											}
										}
										AND = {
											quality == 3
											owner = {
												check_variable = { which = loan_amount value = 67 }
												NOT = { check_variable = { which = loan_amount value = 133 } }
											}
										}
										AND = {
											quality == 4
											owner = {
												check_variable = { which = loan_amount value = 133 }
												NOT = { check_variable = { which = loan_amount value = 267 } }
											}
										}
										AND = {
											quality > 4
											owner = {
												check_variable = { which = loan_amount value = 267 }
												NOT = { check_variable = { which = loan_amount value = 533 } }
											}
										}
									}
								}
								AND = {
									has_artifact_flag = valyrian_steel
									quality == 3
									owner = {
										check_variable = { which = loan_amount value = 150 }
										NOT = { check_variable = { which = loan_amount value = 208 } }
									}
								}
								AND = {
									has_artifact_flag = valyrian_steel
									quality == 4
									owner = {
										check_variable = { which = loan_amount value = 300 }
										NOT = { check_variable = { which = loan_amount value = 416 } }
									}
								}
								AND = {
									has_artifact_flag = valyrian_armour
									owner = {
										check_variable = { which = loan_amount value = 533 }
										NOT = { check_variable = { which = loan_amount value = 833 } }
									}
								}
								AND = {
									has_artifact_flag = book
									quality == 2
									owner = {
										NOT = { check_variable = { which = loan_amount value = 33 } }
									}
								}
								AND = {
									has_artifact_flag = book
									quality == 3
									owner = {
										check_variable = { which = loan_amount value = 33 }
										NOT = { check_variable = { which = loan_amount value = 67 } }
									}
								}
							}
						}
						save_event_target_as = artifact_debt
					}
				}
			}
			clear_event_target = potential_debt_insurer
			if = {
				limit = {
					NOT = { has_character_flag = quest_bank_recover_debt_ENEMY_LOAN }
					quest_target = { check_variable = { which = loan_amount value = 100 } }
				}
				#Find a potential enemy to fund
				quest_target = {
					#Determine loan (50% of debt)
					set_variable = { which = insurance_loan which = loan_amount }
					ROOT = {
						set_variable = { which = insurance_loan which = PREV }

						#Determine merc cost (25% of debt)
						set_variable = { which = insurance_mercs which = insurance_loan }

						multiply_variable = { which = insurance_loan value = 0.5 }
						multiply_variable = { which = insurance_mercs value = 0.25 }
					}
					set_variable = { which = insurance_loan value = 0 }

					primary_title = { save_event_target_as = debtor_title }
					random_current_enemy = {	 #Contesting debtor's title
						limit = {
							is_nomadic = no
							is_adult = yes
							prisoner = no
							OR = { #Has not rejected this offer recently
								NOT = { has_character_flag = no_to_iron_bank_insurance }
								had_character_flag = { flag = no_to_iron_bank_insurance days = 1800 }
							}
							OR = { #Is not already currently insuring a loan
								NOT = { has_character_flag = loan_insurer }
								had_character_flag = { flag = loan_insurer days = 3650 }
							}
							#Has not defaulted on debts in the past
							NOT = { has_character_flag = offended_moneylenders }
							NOT = { has_character_flag = has_had_loan_default }
							OR = { #either has no existing loans, or has a small loan
								NOT = { has_character_flag = loan_taken }
								NOT = { check_variable = { which = loan_amount value = 100 } }
							}
							NOT = { is_vassal_or_below = event_target:debtor_target }
							NOT = { reverse_has_opinion_modifier = { who = event_target:debtor_target modifier = opinion_de_facto_liege } }
							event_target:debtor_title = {
								any_war = {
									attacker = { character = PREVPREVPREV }
									war_score = -35 #Not already losing horribly
									OR = {
										using_cb = claim
										using_cb = claim_on_liege
										using_cb = claim_iron_throne_ACOK
										using_cb = liberation_revolt
										using_cb = invasion
										using_cb = duchy_adventure
										using_cb = war_of_liberation
										using_cb = war_of_enslavement
										using_cb = unjust_conquest
										using_cb = AGOT_invasion
										#using_cb = invasion_ironborn
										using_cb = claim_all_RB
										using_cb = claim_stormlands_ACOK
										AND = { #These CB only take title if different culture/religion or lower tier
											using_cb = invasion_ambition
											attacker = {
												OR = {
													NOT = { higher_tier_than = PREVPREVPREVPREV }
													NOR = {
														culture_group = PREVPREVPREVPREV
														religion_group = PREVPREVPREVPREV
													}
												}
											}
										}
										AND = { #These CB only take title if lower tier
											attacker = {
												NOT = { higher_tier_than = PREVPREVPREVPREV }
											}
											OR = {
												using_cb = dragon_conquest
												using_cb = pirate_invasion
												using_cb = old_ones_scourge_cb
											}
										}
									}
								}
							}
						}
						preferred_limit = {
							character = ROOT #The debt recoverer if possible
						}
						preferred_limit = {
							relative_power = { who = PREV power = 1 }
						}
						preferred_limit = {
							OR = {
								trait = honest
								trait = honorable
								trait = just
							}
						}
						preferred_limit = {
							NOR = {
								trait = deceitful
								trait = ruthless
								trait = arbitrary
							}
						}
						save_event_target_as = potential_debt_insurer
						break = yes
					}
					random_opinion_modifier_target = {
						limit = {
							reverse_has_opinion_modifier = { who = PREV modifier = opinion_targeted_by_adventurer }
							has_character_modifier = planning_claimant_adventure
							is_ruler = no
							OR = { #To start adventurer must have means
								wealth = 400
								AND = {
									wealth = 300
									ROOT = { check_variable = { which = insurance_loan value = 100 } }
								}
								AND = {
									wealth = 200
									ROOT = { check_variable = { which = insurance_loan value = 200 } }
								}
								AND = {
									wealth = 100
									ROOT = { check_variable = { which = insurance_loan value = 300 } }
								}
								ROOT = { check_variable = { which = insurance_loan value = 400 } }
								AND = {
									trait = dragon_rider
									any_friend = {
										trait = dragon
										NOT = { trait = maimed_dragon }
										martial = 20
									}
								}
								trait = chosen_by_rhllor #religious fervour
								AND = { #Patricularly charismatic
									diplomacy = 11
									martial = 9
									OR = {
										is_genius_trigger = yes
										trait = master_warrior
										trait = authoritative
										trait = inspiring_leader
										trait = brilliant_strategist
									}
								}
								any_claim = { #Has the support of the claimant faction
									holder_scope = {
										reverse_has_opinion_modifier = {
											who = PREVPREV
											modifier = opinion_claimant_adventure_target
										}
										any_vassal = {
											leads_faction = faction_claimant
											supported_claimant = { character = PREVPREVPREVPREV }
											faction_power = {
												faction = faction_claimant
												power = 0.5
											}
										}
									}
									OR = {
										tier = KING
										holder_scope = { tier = PREV }
									}
								}
							}

							prisoner = no
							is_incapable = no
							war = no
							is_nomadic = no
							is_adult = yes
							OR = { #Has not rejected this offer recently
								NOT = { has_character_flag = no_to_iron_bank_insurance }
								had_character_flag = { flag = no_to_iron_bank_insurance days = 1800 }
							}
							OR = { #Is not already currently insuring a loan
								NOT = { has_character_flag = loan_insurer }
								had_character_flag = { flag = loan_insurer days = 3650 }
							}
							#Has not defaulted on debts in the past
							NOT = { has_character_flag = offended_moneylenders }
							NOT = { has_character_flag = has_had_loan_default }
							OR = { #either has no existing loans, or has a small loan
								NOT = { has_character_flag = loan_taken }
								NOT = { check_variable = { which = loan_amount value = 100 } }
							}
						}
						preferred_limit = {
							character = ROOT #The debt recoverer if possible
						}
						preferred_limit = {
							OR = {
								trait = honest
								trait = honorable
								trait = just
							}
						}
						preferred_limit = {
							NOR = {
								trait = deceitful
								trait = ruthless
								trait = arbitrary
							}
						}
						save_event_target_as = potential_debt_insurer
						break = yes
					}
					random_vassal = {
						limit = {
							prisoner = no
							is_incapable = no
							war = no
							is_nomadic = no
							is_adult = yes
							NOT = { tier = BARON }
							OR = { #Has not rejected this offer recently
								NOT = { has_character_flag = no_to_iron_bank_insurance }
								had_character_flag = { flag = no_to_iron_bank_insurance days = 1800 }
							}
							OR = { #Is not already currently insuring a loan
								NOT = { has_character_flag = loan_insurer }
								had_character_flag = { flag = loan_insurer days = 3650 }
							}
							#Has not defaulted on debts in the past
							NOT = { has_character_flag = offended_moneylenders }
							NOT = { has_character_flag = has_had_loan_default }
							OR = { #either has no existing loans, or has a small loan
								NOT = { has_character_flag = loan_taken }
								NOT = { check_variable = { which = loan_amount value = 100 } }
							}
							OR = {
								AND = { #Is Pretender
									has_claim = event_target:debtor_title
									relative_power = { who = PREV power = 0.3 }
								}
								relative_power = { who = PREV power = 0.5 } #Is Powerful
								AND = { #Leads claimant faction
									leads_faction = faction_claimant
									faction_power = { faction = faction_claimant power = 0.5 }
									is_decision_potential = faction_claimant_ultimatum
									is_decision_allowed = faction_claimant_ultimatum
									supported_claimant = {
										OR = {
											NOT = { has_character_flag = loan_insurer }
											had_character_flag = { flag = loan_insurer days = 3650 }
										}
										NOT = { has_character_flag = offended_moneylenders }
										NOT = { has_character_flag = loan_default }
										NOT = { has_character_flag = loan_taken }
									}
								}
							}
							liege = { #Cannot fund small vassals during mega war
								OR = {
									NOT = { tier = EMPEROR }
									NOT = { trait = civil_war }
									war = no
									PREV = { #Leads claimant faction
										leads_faction = faction_claimant
										faction_power = {
											faction = faction_claimant
											power = 4.5
										}
									}
								}
							}
						}
						preferred_limit = {
							character = ROOT #The debt recoverer if possible
						}
						preferred_limit = {
							OR = {
								relative_power = { who = PREV power = 0.75 }
								AND = { #Leads claimant faction
									leads_faction = faction_claimant
									faction_power = {
										faction = faction_claimant
										power = 0.75
									}
								}
							}
							NAND = {
								opinion = { who = PREV value = 50 }
								NOT = { trait = ruthless }
								NOT = { trait = lunatic }
							}
							NOT = { trait = honorable }
						}
						preferred_limit = {
							OR = {
								relative_power = { who = PREV power = 0.4 }
								NOT = { opinion = { who = PREV value = -50 } }
								trait = ambitious
								trait = ruthless
							}
							NAND = {
								opinion = { who = PREV value = 50 }
								NOT = { trait = ruthless }
								NOT = { trait = lunatic }
							}
							NOT = { trait = honorable }
						}
						preferred_limit = {
							NAND = {
								opinion = { who = PREV value = 50 }
								NOT = { trait = ruthless }
								NOT = { trait = lunatic }
							}
							NOT = { trait = honorable }
						}
						save_event_target_as = potential_debt_insurer
						break = yes
					}
					#Already wealthy claimant
					if = {
						limit = {
							demesne_size = 1
							is_nomadic = no
							OR = {
								independent = yes # Only do this vs independent rulers or Kings
								tier = KING
							}
							OR = { #Cannot attack vassals made 'independent' via mega war
								higher_tier_than = DUKE
								primary_title = { NOT = { check_variable = { which = "de_facto_empire" value = 1 } } }
							}
							can_press_claims_trigger = yes #not kingsguard, night's watch etc
						}
						primary_title = {
							any_claimant = {
								count = 1
								limit = {
									is_adult = yes
									NOT = { age = 50 }
									is_ruler = no
									prisoner = no
									is_incapable = no
									OR = { #To start adventurer must have means
										wealth = 400
										AND = {
											wealth = 300
											ROOT = { check_variable = { which = insurance_loan value = 100 } }
										}
										AND = {
											wealth = 200
											ROOT = { check_variable = { which = insurance_loan value = 200 } }
										}
										AND = {
											wealth = 100
											ROOT = { check_variable = { which = insurance_loan value = 300 } }
										}
										ROOT = { check_variable = { which = insurance_loan value = 400 } }
										AND = {
											trait = dragon_rider
											any_friend = {
												trait = dragon
												NOT = { trait = maimed_dragon }
												martial = 20
											}
										}
										trait = chosen_by_rhllor #religious fervour
										AND = { #Patricularly charismatic
											diplomacy = 11
											martial = 9
											OR = {
												is_genius_trigger = yes
												trait = master_warrior
												trait = authoritative
												trait = inspiring_leader
												trait = brilliant_strategist
											}
										}
									}

									diplomacy = 8
									OR = {
										is_female = no
										culture_group = dornish
										trait = ambitious
									}
									OR = { #extra agnatic female restriction
										is_female = no
										NOT = { agnatic_culture_trigger = yes }
										martial = 16
										diplomacy = 16
									}
									is_ill = no
									in_battle = no
									NOT = { trait = infirm }
									NOT = { trait = content }
									NOT = { trait = craven }

									can_press_claims_trigger = yes
									NOT = { trait = wikid }
									NOT = { trait = on_reaving }
									NAND = {
										trait = eunuch
										culture_group = hyrkoon_group
									}
									OR = {
										NOT = { pacifist = yes }
										trait = cynical
									}
									NOR = {
										obedient = PREVPREV
										non_interference = PREVPREV
									}

									OR = { #Has not rejected this offer recently
										NOT = { has_character_flag = no_to_iron_bank_insurance }
										had_character_flag = { flag = no_to_iron_bank_insurance days = 1800 }
									}
									OR = { #Is not already currently insuring a loan
										NOT = { has_character_flag = loan_insurer }
										had_character_flag = { flag = loan_insurer days = 3650 }
									}
									#Has not defaulted on debts in the past
									NOT = { has_character_flag = offended_moneylenders }
									NOT = { has_character_flag = has_had_loan_default }
									OR = { #either has no existing loans, or has a small loan
										NOT = { has_character_flag = loan_taken }
										NOT = { check_variable = { which = loan_amount value = 100 } }
									}
									##AI Target Logic##
									NOT = { opinion = { who = PREVPREV value = 40 } } #Don't target people they like
									NAND = { #Have to dislike close family to attack them
										opinion = { who = PREVPREV value = -15 }
										OR = {
											is_married = PREVPREV
											is_parent_of = PREVPREV
											is_child_of = PREVPREV
										}
									}
									NAND = { #Have to not like other close relatives or be ambitious/ruthless
										is_close_relative = PREVPREV
										opinion = { who = PREVPREV value = 15 }
										NOR = {
											trait = ambitious
											trait = ruthless
										}
									}
									NAND = { #Some characters will not attack older siblings
										sibling = PREVPREV
										NOT = { is_older_than = PREVPREV }
										OR = {
											PREV = { has_law = true_cognatic_succession }
											AND = {
												PREVPREV = { is_female = no }
												PREV = {
													OR = {
														has_law = agnatic_succession
														has_law = cognatic_succession
													}
												}
											}
											AND = {
												PREVPREV = { is_female = yes }
												PREV = {
													OR = {
														has_law = enatic_succession
														has_law = enatic_cognatic_succession
													}
												}
											}
										}
										opinion = { who = PREVPREV value = -39 }
										OR = {
											trait = just
											trait = honorable
											trait = honest
										}
									}
									OR = { #If Dragon rider, ROOT has to have competitive dragon or be an idiot
										PREVPREV = { NOT = { trait = dragon_rider } }
										PREVPREV = { NOT = { any_friend = { trait = dragon martial = 40 } } }
										trait = lunatic
										trait = wroth
										learning < 3
										AND = {
											trait = dragon_rider
											any_friend = {
												trait = dragon
												NOT = { trait = maimed_dragon }
												martial = 40
											}
										}
									}
								}
								save_event_target_as = potential_debt_insurer
								break = yes
								score_value = {
									value = 1
									additive_modifier = {
										value = 1
										wealth = 100
									}
									additive_modifier = {
										value = 1
										wealth = 200
									}
									additive_modifier = {
										value = 1
										wealth = 300
									}
									additive_modifier = {
										value = 1
										wealth = 400
									}
									additive_modifier = {
										value = 1
										wealth = 500
									}
									additive_modifier = {
										value = 1
										martial = 9
									}
									additive_modifier = {
										value = 1
										prestige = 500
									}
									additive_modifier = {
										value = 2
										trait = dragon_rider
									}
								}
							}
						}
					}
					random_playable_ruler = { #random powerful neighbor
						limit = {
							OR = {
								same_liege = event_target:debtor_target
								AND = {
									NOT = { lower_tier_than = event_target:debtor_target }
									event_target:debtor_target = { independent = yes }
								}
							}
							OR = {
								capital_scope = { event_target:debtor_target = { capital_scope = { NOT = { distance = { where = PREVPREV value = 250 } } } } }
								any_neighbor_independent_ruler = { character = event_target:debtor_target }
							}
							relative_power_including_allies_attacker = { who = event_target:debtor_target power = 0.9 }

							prisoner = no
							is_incapable = no
							war = no
							is_nomadic = no
							is_adult = yes
							NOT = { tier = BARON }
							can_press_claims_trigger = yes
							NOT = { is_vassal_or_below = event_target:debtor_target }
							NOT = { reverse_has_opinion_modifier = { who = event_target:debtor_target modifier = opinion_de_facto_liege } }

							OR = { #Has not rejected this offer recently
								NOT = { has_character_flag = no_to_iron_bank_insurance }
								had_character_flag = { flag = no_to_iron_bank_insurance days = 1800 }
							}
							OR = { #Is not already currently insuring a loan
								NOT = { has_character_flag = loan_insurer }
								had_character_flag = { flag = loan_insurer days = 3650 }
							}
							#Has not defaulted on debts in the past
							NOT = { has_character_flag = offended_moneylenders }
							NOT = { has_character_flag = has_had_loan_default }
							OR = { #either has no existing loans, or has a small loan
								NOT = { has_character_flag = loan_taken }
								NOT = { check_variable = { which = loan_amount value = 100 } }
							}
						}
						preferred_limit = {
							character = ROOT #The debt recoverer if possible
						}
						preferred_limit = {
							has_claim = event_target:debtor_title
						}
						preferred_limit = {
							relative_power_including_allies_attacker = { who = event_target:debtor_target power = 2 }
							NAND = {
								opinion = { who = event_target:debtor_target value = 50 }
								NOT = { trait = ruthless }
								NOT = { trait = lunatic }
							}
							NOT = { trait = honorable }
						}
						preferred_limit = {
							OR = {
								relative_power_including_allies_attacker = { who = event_target:debtor_target power = 1.5 }
								NOT = { opinion = { who = PREV value = -50 } }
								trait = ambitious
								trait = ruthless
							}
							NAND = {
								opinion = { who = PREV value = 50 }
								NOT = { trait = ruthless }
								NOT = { trait = lunatic }
							}
							NOT = { trait = honorable }
						}
						preferred_limit = {
							NAND = {
								opinion = { who = PREV value = 50 }
								NOT = { trait = ruthless }
								NOT = { trait = lunatic }
							}
							NOT = { trait = honorable }
						}
						save_event_target_as = potential_debt_insurer
						break = yes
					}
				}
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.49 #Write letter to liege
		trigger = {
			has_character_flag = can_send_liege_letter
		}
		ai_chance = {
			factor = 9999
		}
		set_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		quest_target = {
			show_portrait = THIS
			liege = {
				show_portrait = THIS
				letter_event = { id = bankruptcy.51 tooltip = TOOLTIPbankruptcy.51 }
			}
		}
	}
	option = {
		name = EVTOPTBbankruptcy.49 #Write letter to top liege
		trigger = {
			has_character_flag = can_send_top_liege_letter
		}
		ai_chance = {
			factor = 9999
		}
		set_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		quest_target = {
			show_portrait = THIS
			top_liege = {
				show_portrait = THIS
				letter_event = { id = bankruptcy.51 tooltip = TOOLTIPbankruptcy.51 }
			}
		}
	}
	option = {
		name = EVTOPTCbankruptcy.49 #Send delegation
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_DELEGATION }
			quest_target = {
				check_variable = { which = loan_amount value = 50 }
				NOT = { has_character_flag = imprisoned_bank_envoy }
				#NOT = { has_character_flag = looted_bank }
			}
		}
		ai_chance = {
			factor = 9999
			modifier = {
				factor = 0
				has_character_flag = can_send_liege_letter
			}
			modifier = {
				factor = 0
				has_character_flag = can_send_top_liege_letter
			}
			modifier = {
				factor = 0
				society = {
					NAND = {
						check_variable = { which = cash_reserve value = 20 }
						ROOT = { quest_target = { check_variable = { which = loan_amount value = 100 } } }
					}
				}
				wealth < 20
			}
			modifier = { #may prefer to go straight to funding enemy/assasination
				factor = 0.001
				OR = {
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
						quest_target = { #Only low rank, low value debtors
							lower_tier_than = DUKE
							NOT = { check_variable = { which = loan_amount value = 100 } }
						}
					}
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
						society = { NOT = { check_variable = { which = assassin_cost value = 0 } } }
					}
					society = { NOT = { check_variable = { which = faceless_cost value = 0 } } }
					event_target:potential_debt_insurer = {
						OR = {
							relative_power = { who = event_target:debtor_target power = 1 }
							trait = honest
							trait = honorable
							trait = just
						}
						ROOT = { NOT = { is_foe = PREV } }
					}
				}
				OR = {
					trait = ruthless
					trait = deceitful
					trait = cruel
					is_foe = event_target:debtor_target
					quest_target = { check_variable = { which = loan_amount value = 300 } }
				}
				NOR = {
					trait = kind
					trait = honorable
					trait = honest
				}
			}
		}
		set_character_flag = quest_bank_recover_debt_DELEGATION
		quest_target = { show_portrait = THIS }
		custom_tooltip = {
			text = TOOLTIPbankruptcy.48A
			add_trait = travelling
			character_event = { id = bankruptcy.65 days = 50 random = 100 }
		}
		society = {
			if = {
				limit = { #Bank will fund it
					check_variable = { which = cash_reserve value = 20 }
					ROOT = { quest_target = { check_variable = { which = loan_amount value = 100 } } }
				}
				change_variable = { which = cash_reserve value = -20 }
				hidden_tooltip = { change_variable = { which = expenses value = -20 } }
			}
			else = { #If not, ROOT must fund it
				ROOT = { wealth = -20 }
			}
		}
	}

	option = {
		name =  EVTOPTJbankruptcy.49 #Offer to take artifact instead
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_ARTIFACT }
			event_target:artifact_debt = { always = yes }
		}
		ai_chance = {
			factor = 9999
			modifier = {
				factor = 0
				has_character_flag = can_send_liege_letter
			}
			modifier = {
				factor = 0
				has_character_flag = can_send_top_liege_letter
			}
			modifier = { #may prefer to go straight to funding enemy/assasination
				factor = 0.001
				OR = {
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
						quest_target = { #Only low rank, low value debtors
							lower_tier_than = DUKE
							NOT = { check_variable = { which = loan_amount value = 100 } }
						}
					}
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
						society = { NOT = { check_variable = { which = assassin_cost value = 0 } } }
					}
					society = { NOT = { check_variable = { which = faceless_cost value = 0 } } }
					event_target:potential_debt_insurer = {
						OR = {
							relative_power = { who = event_target:debtor_target power = 1 }
							trait = honest
							trait = honorable
							trait = just
						}
						ROOT = { NOT = { is_foe = PREV } }
					}
				}
				OR = {
					trait = ruthless
					trait = deceitful
					trait = cruel
					is_foe = event_target:debtor_target
					quest_target = { check_variable = { which = loan_amount value = 300 } }
				}
				NOR = {
					trait = kind
					trait = honorable
					trait = honest
				}
			}
		}
		set_character_flag = quest_bank_recover_debt_ARTIFACT
		quest_target = {
			show_portrait = THIS
			letter_event = { id = bankruptcy.220 tooltip = TOOLTIPbankruptcy.220 }
		}
	}
	option = {
		name = EVTOPTIbankruptcy.49 #Send in the heavies
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
			quest_target = { #Only low rank, low value debtors
				lower_tier_than = DUKE
				NOT = { check_variable = { which = loan_amount value = 100 } }
			}
		}
		ai_chance = {
			factor = 20

			modifier = {
				factor = 0
				NOT = { quest_target = { check_variable = { which = loan_amount value = 40 } } }
				wealth < 10
			}
			modifier = {
				factor = 0.5
				OR = {
					trait = kind
					trait = honorable
				}
			}
			modifier = {
				factor = 0.25
				quest_target = {
					OR = {
						is_child_of = ROOT # Not my own children
						is_grandchild_of = ROOT
						has_blood_oath_with = ROOT
						is_lover = ROOT
						is_friend = ROOT
					}
				}
			}
			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 1.5
				trait = arbitrary
			}
			modifier = {
				factor = 2.0
				trait = cruel
			}
			modifier = {
				factor = 2.0
				trait = deceitful
			}
			modifier = {
				factor = 2.0
				trait = wroth
			}
			modifier = {
				factor = 3.0
				trait = ambitious
			}

			modifier = {
				factor = 0.5
				trait = honest
			}
			modifier = {
				factor = 0.5
				trait = patient
			}
			modifier = {
				factor = 10
				is_foe = event_target:debtor_target
			}
		}
		set_character_flag = quest_bank_recover_debt_HEAVIES
		society = {
			if = {
				limit = { #Bank will fund it
					ROOT = { quest_target = { check_variable = { which = loan_amount value = 40 } } }
				}
				change_variable = { which = cash_reserve value = -10 }
				hidden_tooltip = { change_variable = { which = expenses value = -10 } }
			}
			else = { #If not, ROOT must fund it
				ROOT = { wealth = -10 }
			}
		}
		quest_target = { show_portrait = THIS }
		random_list = {
			100 = { #Success
				modifier = {
					factor = 0.66
					martial < 2
				}
				modifier = {
					factor = 0.66
					martial < 5
				}
				modifier = {
					factor = 1.5
					martial = 8
				}
				modifier = {
					factor = 1.5
					martial = 11
				}
				modifier = {
					factor = 1.5
					martial = 14
				}
				modifier = {
					factor = 1.5
					martial = 17
				}
				modifier = {
					factor = 1.5
					martial = 20
				}
				quest_target = { character_event = { id = bankruptcy.130 tooltip = TOOLTIPbankruptcy.130 } }
			}
			50 = { #Fail
				modifier = { #Harder to recover full debt
					factor = 2
					quest_target = { has_character_flag = offended_moneylenders }
				}
				modifier = {
					factor = 0.66
					quest_target = { martial < 2 }
				}
				modifier = {
					factor = 0.66
					quest_target = { martial < 5 }
				}
				modifier = {
					factor = 1.5
					quest_target = { martial = 8 }
				}
				modifier = {
					factor = 1.5
					quest_target = { martial = 11 }
				}
				modifier = {
					factor = 1.5
					quest_target = { martial = 14 }
				}
				modifier = {
					factor = 1.5
					quest_target = { martial = 17 }
				}
				modifier = {
					factor = 1.5
					quest_target = { martial = 20 }
				}
				quest_target = { character_event = { id = bankruptcy.132 tooltip = TOOLTIPbankruptcy.132 } }
			}
		}
	}

	option = {
		name = EVTOPTDbankruptcy.49 #Kill
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
			society = { NOT = { check_variable = { which = assassin_cost value = 0 } } }
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 1000
				OR = {
					has_plot = plot_kill_character
					has_plot = plot_kill_spouse
				}
				plot_target_char = { character = event_target:debtor_target }
			}
			modifier = {
				factor = 0
				OR = {
					trait = kind
					trait = honorable
				}
			}
			modifier = {
				factor = 0
				quest_target = {
					OR = {
						is_child_of = ROOT # Not my own children
						is_grandchild_of = ROOT
						has_blood_oath_with = ROOT
						is_lover = ROOT
						is_friend = ROOT
					}
				}
			}
			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 0.01
				# Kinslaying is generally discouraged
				OR = {
					AND = {
						is_lowborn = no
						dynasty = event_target:debtor_target
					}
					is_close_relative = event_target:debtor_target
				}
				NOT = { trait = arbitrary }
				NOT = { trait = ruthless }
				NOT = { trait = cruel }
				NOT = { trait = lunatic }
				NOT = { trait = possessed }
			}

			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 1.5
				trait = arbitrary
			}
			modifier = {
				factor = 2.0
				trait = cruel
			}
			modifier = {
				factor = 2.0
				trait = deceitful
			}
			modifier = {
				factor = 2.0
				trait = wroth
			}
			modifier = {
				factor = 3.0
				trait = ambitious
			}

			modifier = {
				factor = 0.5
				trait = honest
			}
			modifier = {
				factor = 0.5
				trait = patient
			}
			modifier = {
				factor = 10
				is_foe = event_target:debtor_target
			}
		}
		set_character_flag = quest_bank_recover_debt_ASSASSIN
		society = {
			change_variable = { which = cash_reserve which = assassin_cost }
			hidden_tooltip = { change_variable = { which = expenses which = assassin_cost } }
		}
		quest_target = { show_portrait = THIS }
		random_list = {
			50 = { #Success
				modifier = {
					factor = 0.66
					intrigue < 2
				}
				modifier = {
					factor = 0.66
					intrigue < 5
				}
				modifier = {
					factor = 1.5
					intrigue = 8
				}
				modifier = {
					factor = 1.5
					intrigue = 11
				}
				modifier = {
					factor = 1.5
					intrigue = 14
				}
				modifier = {
					factor = 1.5
					intrigue = 17
				}
				modifier = {
					factor = 1.5
					intrigue = 20
				}
				quest_target = { character_event = { id = bankruptcy.80 tooltip = TOOLTIPbankruptcy.80 } }
			}
			50 = { #Fail
				modifier = {
					factor = 0.66
					quest_target = { intrigue < 2 }
				}
				modifier = {
					factor = 0.66
					quest_target = { intrigue < 5 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 8 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 11 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 14 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 17 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 20 }
				}
				quest_target = { character_event = { id = bankruptcy.82 tooltip = TOOLTIPbankruptcy.82 } }
			}
		}
	}
	option = {
		name = {
			text = EVTOPTEbankruptcy.49 #Faceless Man
			trigger = {
				location = {
					NOR = {
						region = world_far_east
						region = world_jade_sea
						region = world_ghiscar
						region = world_dothraki
					}
				}
			}
		}
		name = {
			text = EVTOPTEbankruptcy.49B #Sorrowful Man
			trigger = {
				location = {
					OR = {
						region = world_far_east
						region = world_jade_sea
						region = world_ghiscar
						region = world_dothraki
					}
				}
			}
		}
		trigger = {
			society = { NOT = { check_variable = { which = faceless_cost value = 0 } } }
		}
		ai_chance = {
			factor = 100

			modifier = {
				factor = 1000
				OR = {
					has_plot = plot_kill_character
					has_plot = plot_kill_spouse
				}
				plot_target_char = { character = event_target:debtor_target }
			}
			modifier = {
				factor = 0
				OR = {
					trait = kind
					trait = honorable
				}
			}
			modifier = {
				factor = 0
				quest_target = {
					OR = {
						is_child_of = ROOT # Not my own children
						is_grandchild_of = ROOT
						has_blood_oath_with = ROOT
						is_lover = ROOT
						is_friend = ROOT
					}
				}
			}
			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 0.01
				# Kinslaying is generally discouraged
				OR = {
					AND = {
						is_lowborn = no
						dynasty = event_target:debtor_target
					}
					is_close_relative = event_target:debtor_target
				}
				NOT = { trait = arbitrary }
				NOT = { trait = ruthless }
				NOT = { trait = cruel }
				NOT = { trait = lunatic }
				NOT = { trait = possessed }
			}

			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 1.5
				trait = arbitrary
			}
			modifier = {
				factor = 2.0
				trait = cruel
			}
			modifier = {
				factor = 2.0
				trait = deceitful
			}
			modifier = {
				factor = 2.0
				trait = wroth
			}
			modifier = {
				factor = 3.0
				trait = ambitious
			}

			modifier = {
				factor = 0.5
				trait = honest
			}
			modifier = {
				factor = 0.5
				trait = patient
			}
			modifier = {
				factor = 10
				is_foe = event_target:debtor_target
			}
		}
		society = {
			change_variable = { which = cash_reserve which = faceless_cost }
			hidden_tooltip = { change_variable = { which = expenses which = faceless_cost } }
		}
		if = { #Sorrowful
			limit = {
				location = {
					OR = {
						region = world_far_east
						region = world_jade_sea
						region = world_ghiscar
						region = world_dothraki
					}
				}
			}
			quest_target = {
				show_portrait = THIS
				character_event = { id = bankruptcy.84 tooltip = TOOLTIPbankruptcy.84A }
			}
			hidden_tooltip = {
				society = {
					multiply_variable = { which = faceless_cost value = -1 }
					d_sorrowful_men = {
						holder_scope = {
							set_variable = { which = faceless_cost which = PREVPREV }
							wealth = faceless_cost
							set_variable = { which = faceless_cost value = 0 }
						}
						set_variable = { which = faceless_cost which = PREV }
						change_variable = { which = hits_revenue which = faceless_cost }
						set_variable = { which = faceless_cost value = 0 }
					}
				}
			}
		}
		else = { #Faceless
			quest_target = {
				show_portrait = THIS
				character_event = { id = bankruptcy.84 tooltip = TOOLTIPbankruptcy.84B }
			}
			hidden_tooltip = {
				society = {
					multiply_variable = { which = faceless_cost value = -1 }
					d_faceless_men = {
						holder_scope = {
							set_variable = { which = faceless_cost which = PREVPREV }
							wealth = faceless_cost
							set_variable = { which = faceless_cost value = 0 }
						}
						set_variable = { which = faceless_cost which = PREV }
						change_variable = { which = hits_revenue which = faceless_cost }
						set_variable = { which = faceless_cost value = 0 }
					}
				}
			}
		}
	}
	option = {
		name = {
			text = EVTOPTFbankruptcy.49 #Fund Enemy
			trigger = { event_target:potential_debt_insurer = { NOT = { character = ROOT } } }
		}
		name = {
			text = EVTOPTFbankruptcy.49B #Fund own claim
			trigger = { event_target:potential_debt_insurer = { character = ROOT } }
		}
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_ENEMY_LOAN }
			event_target:potential_debt_insurer = { always = yes }
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 2
				event_target:potential_debt_insurer = { character = ROOT }
			}
			modifier = {
				factor = 0.05
				event_target:potential_debt_insurer = { NOT = { character = ROOT } }
				quest_target = {
					OR = {
						is_child_of = ROOT
						is_grandchild_of = ROOT
						has_blood_oath_with = ROOT
						is_parent_of = ROOT
						is_grandparent_of = ROOT
						is_lover = ROOT
						is_friend = ROOT
						is_married = ROOT
						is_allied_with = ROOT
						current_heir = { character = ROOT }
					}
				}
			}
			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 3.0
				trait = ambitious
			}

			modifier = {
				factor = 0.5
				trait = honorable
			}
			modifier = {
				factor = 10
				is_foe = event_target:debtor_target
			}
		}
		set_character_flag = quest_bank_recover_debt_ENEMY_LOAN

		set_character_flag = quest_bank_recover_debt_ENEMY_LOAN_B #temp so variables are not cleared below
		quest_target = { show_portrait = THIS }
		event_target:potential_debt_insurer = {
			show_portrait = THIS
			character_event = { id = bankruptcy.100 tooltip = TOOLTIPbankruptcy.100 }
		}
	}
	option = {
		name = EVTOPTGbankruptcy.49 #Do nothing for now
		trigger = {
			NAND = { #NOT if all these actions have been tried or are not possible
				NOT = { has_character_flag = can_send_liege_letter }
				NOT = { has_character_flag = can_send_top_liege_letter }
				OR = {
					has_character_flag = quest_bank_recover_debt_DELEGATION
					NOT = {
						quest_target = {
							check_variable = { which = loan_amount value = 50 }
							NOT = { has_character_flag = imprisoned_bank_envoy }
							#NOT = { has_character_flag = looted_bank }
						}
					}
				}
				OR = {
					has_character_flag = quest_bank_recover_debt_ARTIFACT
					NOT = { event_target:artifact_debt = { always = yes } }
				}
				# OR = {
					# has_character_flag = quest_bank_recover_debt_HEAVIES
					# NOT = {
						# quest_target = { #Only low rank, low value debtors
							# lower_tier_than = DUKE
							# NOT = { check_variable = { which = loan_amount value = 100 } }
						# }
					# }
				# }
				# OR = {
					# has_character_flag = quest_bank_recover_debt_ASSASSIN
					# NOT = { society = { NOT = { check_variable = { which = assassin_cost value = 0 } } } }
				# }
				# NOT = { society = { NOT = { check_variable = { which = faceless_cost value = 0 } } } }
				has_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			}
		}
		ai_chance = {
			factor = 1
		}
		quest_target = { show_portrait = THIS }
		hidden_tooltip = { character_event = { id = bankruptcy.48 days = 90 random = 50 } }
	}
	option = {
		name = EVTOPTHbankruptcy.49 #Failed
		trigger = {
			#Only if these actions have been tried/not possible
			NOT = { has_character_flag = can_send_liege_letter }
			NOT = { has_character_flag = can_send_top_liege_letter }
			OR = {
				has_character_flag = quest_bank_recover_debt_DELEGATION
				NOT = {
					quest_target = {
						check_variable = { which = loan_amount value = 50 }
						NOT = { has_character_flag = imprisoned_bank_envoy }
						#NOT = { has_character_flag = looted_bank }
					}
				}
			}
			OR = {
				has_character_flag = quest_bank_recover_debt_ARTIFACT
				NOT = { event_target:artifact_debt = { always = yes } }
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0
				quest_target = {
					OR = {
						higher_tier_than = DUKE
						check_variable = { which = loan_amount value = 400 }
					}
				}
			}
			modifier = {
				factor = 0.33
				quest_target = {
					OR = {
						higher_tier_than = COUNT
						check_variable = { which = loan_amount value = 100 }
					}
				}
			}
			modifier = {
				factor = 2
				trait = slothful
			}
			modifier = {
				factor = 0.5
				trait = diligent
			}
		}
		quest_target = { show_portrait = THIS }
		if = {
			limit = {
				quest_target = {
					OR = {
						higher_tier_than = DUKE
						check_variable = { which = loan_amount value = 400 }
					}
				}
			}
			detract_society_currency_medium_effect = yes
			add_mission_fail_influence_effect = yes
		}
		else_if = {
			limit = {
				quest_target = {
					OR = {
						higher_tier_than = COUNT
						check_variable = { which = loan_amount value = 100 }
					}
				}
			}
			detract_society_currency_minor_effect = yes
			add_mission_fail_influence_effect = yes
		}
		else = {
			detract_society_currency_tiny_effect = yes
		}
		clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_DELEGATION
		clr_character_flag = quest_bank_recover_debt_ASSASSIN
		clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
		clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
		clr_character_flag = quest_bank_recover_debt_HEAVIES
		clr_character_flag = quest_bank_recover_debt_ARTIFACT
		clr_quest = { id = quest_bank_recover_debt failure = yes }
	}
	after = {
		hidden_tooltip = {
			society = {
				set_variable = { which = assassin_cost value = 0 }
				set_variable = { which = faceless_cost value = 0 }
			}
			if = {
				limit = { NOT = { has_character_flag = quest_bank_recover_debt_ENEMY_LOAN_B } }
				set_variable = { which = insurance_loan value = 0 }
				set_variable = { which = insurance_mercs value = 0 }
			}
			else = {
				clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN_B
			}
			clr_character_flag = can_send_liege_letter
			clr_character_flag = can_send_top_liege_letter
		}
	}
}
character_event = { #Mission no longer valid
	id = bankruptcy.50
	desc = EVTDESCbankruptcy.50
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = OK
		clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_DELEGATION
		clr_character_flag = quest_bank_recover_debt_ASSASSIN
		clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
		clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
		clr_character_flag = quest_bank_recover_debt_HEAVIES
		clr_character_flag = quest_bank_recover_debt_ARTIFACT
		hidden_tooltip = { clr_quest = quest_bank_recover_debt }
	}
}
letter_event = { #Liege of debtor receives letter
	id = bankruptcy.51
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	desc = {
		text = EVTDESCbankruptcy.51
		trigger = { event_target:debtor_target = { has_character_flag = offended_moneylenders } }
	}
	desc = {
		text = EVTDESCbankruptcy.51B
		trigger = { event_target:debtor_target = { NOT = { has_character_flag = offended_moneylenders } } }
	}

	immediate = {
		event_target:debtor_target = {
			if = { #Determine interest owed
				limit = { NOT = { has_character_flag = offended_moneylenders } }
				set_variable = { which = interest_payment which = loan_amount }
				multiply_variable = { which = interest_payment which = loan_interest }
				multiply_variable = { which = interest_payment value = -1 }
				ROOT = { set_variable = { which = interest_payment which = PREV } }
				set_variable = { which = interest_payment value = 0 }
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.51 #Order to pay debt
		trigger = { event_target:debtor_target = { has_character_flag = offended_moneylenders } }
		ai_chance = {
			factor = 10
			modifier = {
				factor = 4
				trait = just
			}
			modifier = {
				factor = 4
				trait = honorable
			}
			modifier = {
				factor = 4
				trait = honest
			}

			modifier = {
				factor = 0.75
				event_target:debtor_target = { among_most_powerful_vassals = 3 }
			}
			modifier = {
				factor = 0.75
				event_target:debtor_target = { relative_power = { who = ROOT power = 0.2 } }
			}
			modifier = {
				factor = 0.75
				event_target:debtor_target = { relative_power = { who = ROOT power = 0.4 } }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { NOT = { relative_power = { who = ROOT power = 0.1 } } }
			}
			modifier = {
				factor = 2
				event_target:debtor_target = { NOT = { relative_power = { who = ROOT power = 0.05 } } }
			}
			modifier = {
				factor = 0.66
				opinion = { who = event_target:debtor_target value = 50 }
			}
			modifier = {
				factor = 0.66
				opinion = { who = event_target:debtor_target value = 20 }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = event_target:debtor_target value = -20 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = event_target:debtor_target value = -50 } }
			}
		}
		event_target:debtor_target = {
			opinion = { who = ROOT modifier = opinion_ordered_loan_payment months = 60 }
			letter_event = { id = bankruptcy.52 }
		}
	}
	option = {
		name = EVTOPTBbankruptcy.51 #Pay interest
		trigger = { event_target:debtor_target = { NOT = { has_character_flag = offended_moneylenders } } }
		ai_chance = {
			factor = 2

			modifier = {
				factor = 0
				wealth < 750
				event_target:debtor_target = { check_variable = { which = loan_amount value = 250 } }
			}
			modifier = {
				factor = 0
				wealth < 100
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = event_target:debtor_target value = 0 } }
				NOT = { is_close_relative = event_target:debtor_target }
				NOT = { is_married = event_target:debtor_target }
			}
			modifier = {
				factor = 0
				trait = greedy
			}
			modifier = {
				factor = 4
				trait = charitable
			}
			modifier = {
				factor = 4
				trait = kind
			}
			modifier = {
				factor = 4
				trait = honorable
			}
			modifier = {
				factor = 1.5
				OR = {
					is_close_relative = event_target:debtor_target
					is_married = event_target:debtor_target
				}
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:debtor_target value = 50 }
			}
			modifier = {
				factor = 1.5
				opinion = { who = event_target:debtor_target value = 20 }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = event_target:debtor_target value = -20 } }
			}
			modifier = {
				factor = 0.5
				NOT = { opinion = { who = event_target:debtor_target value = -50 } }
			}
		}
		wealth = interest_payment
		event_target:debtor_target = {
			opinion = { who = ROOT modifier = opinion_paid_my_interest months = 60 }
			letter_event = { id = bankruptcy.57 }
			hidden_tooltip = {
				persistent_event_target:loan_bank = { #Adjust bank's records
					set_variable = { which = interest_payment which = ROOT }
					multiply_variable = { which = interest_payment value = -1 }
					change_variable = { which = cash_reserve which = interest_payment }
					set_variable = { which = interest_payment value = 0 }
				}
			}
		}
		FROM = { letter_event = { id = bankruptcy.58 } }
	}
	option = {
		name = EVTOPTCbankruptcy.51 #Reprimand
		trigger = { event_target:debtor_target = { NOT = { has_character_flag = offended_moneylenders } } }
		ai_chance = {
			factor = 10
			modifier = {
				factor = 4
				trait = just
			}
			modifier = {
				factor = 4
				trait = honorable
			}
			modifier = {
				factor = 4
				trait = honest
			}

			modifier = {
				factor = 0.75
				event_target:debtor_target = { among_most_powerful_vassals = 3 }
			}
			modifier = {
				factor = 0.75
				event_target:debtor_target = { relative_power = { who = ROOT power = 0.2 } }
			}
			modifier = {
				factor = 0.75
				event_target:debtor_target = { relative_power = { who = ROOT power = 0.4 } }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { NOT = { relative_power = { who = ROOT power = 0.1 } } }
			}
			modifier = {
				factor = 2
				event_target:debtor_target = { NOT = { relative_power = { who = ROOT power = 0.05 } } }
			}
			modifier = {
				factor = 0.66
				opinion = { who = event_target:debtor_target value = 50 }
			}
			modifier = {
				factor = 0.66
				opinion = { who = event_target:debtor_target value = 20 }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = event_target:debtor_target value = -20 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = event_target:debtor_target value = -50 } }
			}
		}
		event_target:debtor_target = {
			letter_event = { id = bankruptcy.59 }
			opinion = { who = ROOT modifier = opinion_reprimanded_me months = 60 }
		}
		FROM = { letter_event = { id = bankruptcy.60 } }
	}
	option = {
		name = EVTOPTDbankruptcy.51 #Placate with diplomacy
		trigger = { diplomacy = 12 }
		ai_chance = {
			factor = 10
			modifier = {
				factor = 4
				trait = arbitrary
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 4
				trait = deceitful
			}
			modifier = {
				factor = 0.5
				trait = just
			}
			modifier = {
				factor = 0.5
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
		}
		tooltip_info = diplomacy
		event_target:debtor_target = { opinion = { who = ROOT modifier = opinion_supported_me months = 60 } }
		FROM = { letter_event = { id = bankruptcy.61 } }
	}
	option = {
		name = EVTOPTEbankruptcy.51 #Not my problem
		trigger = { diplomacy < 12 }
		ai_chance = {
			factor = 3
			modifier = {
				factor = 0.5
				event_target:debtor_target = { persistent_event_target:loan_bank = { society_influence = 3 } }
			}
			modifier = {
				factor = 0.5
				event_target:debtor_target = { persistent_event_target:loan_bank = { society_influence = 5 } }
			}

			modifier = {
				factor = 0.05
				trait = just
			}
			modifier = {
				factor = 0.05
				trait = honorable
			}
			modifier = {
				factor = 0.25
				trait = craven
			}
			modifier = {
				factor = 0.25
				trait = honest
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
				}
			}
		}
		if = {
			limit = { NOT = { has_character_flag = has_had_loan_default } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy.51DEFAULT
				set_character_flag = has_had_loan_default #effects trust/interest rates
			}
		}
		event_target:debtor_target = { opinion = { who = ROOT modifier = opinion_supported_me months = 60 } }
		FROM = { letter_event = { id = bankruptcy.62 } }
	}
	after = {
		hidden_tooltip = {
			set_variable = { which = interest_payment value = 0 }
		}
	}
}
letter_event = { #Debtor ordered to honour debt
	id = bankruptcy.52
	desc = EVTDESCbankruptcy.52
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	immediate = {
		calculate_loan_repayable_effect = yes
	}

	option = {
		name = EVTOPTAbankruptcy.52 #Fine
		ai_chance = {
			factor = 50

			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 20 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 40 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 60 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 80 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 100 }
			}
			modifier = {
				factor = 2
				NOT = { relative_power = { who = FROM power = 0.05 } }
			}
			modifier = {
				factor = 2
				NOT = { relative_power = { who = FROM power = 0.1 } }
			}
			modifier = {
				factor = 1.5
				NOT = { relative_power = { who = FROM power = 0.2 } }
			}
			modifier = {
				factor = 2
				trait = content
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 4
				trait = just
			}
		}
		prestige = -100
		wealth = loan_interest_payable_negative
		custom_tooltip = {
			text = TOOLTIPbankruptcy.52
			clr_character_flag = offended_moneylenders
			clr_character_flag = looted_bank
			set_character_flag = loan_taken
			set_variable = { which = loan_interest value = 0.35 }
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
			persistent_event_target:loan_bank = { #Adjust bank's records
				ROOT = {
					set_variable = { which = loan_losses which = loan_amount }
					multiply_variable = { which = loan_losses value = -1 }
					set_variable = { which = cash_reserve which = loan_total_repayable }
					set_variable = { which = loan_profits which = loan_interest_payable }
				}
				change_variable = { which = loan_losses which = ROOT }
				change_variable = { which = cash_reserve which = ROOT }
				change_variable = { which = loan_profits which = ROOT }
			}
			set_variable = { which = loan_losses value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = loan_profits value = 0 }
		}
		FROM = { letter_event = { id = bankruptcy.53 } }
		FROMFROM = { letter_event = { id = bankruptcy.54 } }
	}
	option = {
		name = EVTOPTBbankruptcy.52 #No!
		ai_chance = {
			factor = 50

			modifier = {
				factor = 0
				trait = honorable
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -19 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -39 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -59 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -79 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -99 } }
			}
			modifier = {
				factor = 1.5
				relative_power = { who = FROM power = 0.33 }
			}
			modifier = {
				factor = 2
				relative_power = { who = FROM power = 0.5 }
			}
			modifier = {
				factor = 2
				relative_power = { who = FROM power = 0.75 }
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = greedy
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 4
				trait = arbitrary
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
		}
		FROM = {
			opinion = { who = ROOT modifier = opinion_traitor }
			letter_event = { id = bankruptcy.55 }
		}
		FROMFROM = { letter_event = { id = bankruptcy.56 } }
	}
}
letter_event = { #Inform liege debtor agreed to pay debt
	id = bankruptcy.53
	desc = EVTDESCbankruptcy.53
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.53
	}
}
letter_event = { #Inform envoy debtor agreed to pay debt
	id = bankruptcy.54
	desc = EVTDESCbankruptcy.54
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes
	show_from_from = yes

	immediate = {
		FROM = {
			set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.54
		show_portrait = FROM
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			add_mission_succeed_influence_effect = yes
			hidden_tooltip = {
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
		}
		hidden_tooltip = {
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }
		}
	}
}
letter_event = { #Inform liege debtor rejected to pay debt
	id = bankruptcy.55
	desc = EVTDESCbankruptcy.55
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.55
		tiered_prestige_negative_effect = yes
	}
}
letter_event = { #Inform envoy debtor rejected to pay debt
	id = bankruptcy.56
	desc = EVTDESCbankruptcy.56
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes
	show_from_from = yes

	option = {
		name = EVTOPTAbankruptcy.56
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
letter_event = { #Inform debtor liege paid interest
	id = bankruptcy.57
	desc = EVTDESCbankruptcy.57
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.57
		clr_character_flag = loan_default
		tiered_prestige_negative_effect = yes
	}
}
letter_event = { #Inform envoy liege paid interest
	id = bankruptcy.58
	desc = EVTDESCbankruptcy.58
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	immediate = {
		event_target:debtor_target = {
			set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.58
		show_portrait = event_target:debtor_target
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			hidden_tooltip = {
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
		}
		hidden_tooltip = {
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }
		}
	}
}
letter_event = { #Inform debtor liege reprimanded
	id = bankruptcy.59
	desc = EVTDESCbankruptcy.59
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.59
		FROM = { opinion = { who = ROOT modifier = opinion_failed_bank_payment months = 60 } }
		tiered_prestige_negative_effect = yes
	}
}
letter_event = { #Inform envoy liege reprimanded
	id = bankruptcy.60
	desc = EVTDESCbankruptcy.60
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.60
		show_portrait = event_target:debtor_target
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				event_target:debtor_target = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
letter_event = { #Inform envoy liege placated
	id = bankruptcy.61
	desc = EVTDESCbankruptcy.61
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.61
		show_portrait = event_target:debtor_target
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_trivial_effect = yes
		}
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				event_target:debtor_target = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
letter_event = { #Inform envoy liege rejected
	id = bankruptcy.62
	desc = EVTDESCbankruptcy.62
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.62
		show_portrait = event_target:debtor_target
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				event_target:debtor_target = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
character_event = { #Arrived at debtor
	id = bankruptcy.65
	desc = EVTDESCbankruptcy.65
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	portrait = event_target:debtor_target

	trigger = {
		prisoner = no
		is_incapable = no
		OR = {
			AND = {
				has_quest = quest_bank_recover_debt
				society = { has_flag = bank_society }
				quest_target = {
					is_alive = yes
					is_ruler = yes
					check_variable = { which = loan_amount value = 1 }
					OR = {
						has_character_flag = offended_moneylenders
						has_character_flag = loan_default
					}
				}
			}
			FROMFROM = {
				has_character_flag = loan_bank_minor
				is_alive = yes
				is_ruler = yes
				check_variable = { which = loan_amount value = 1 }
				OR = {
					has_character_flag = offended_moneylenders
					has_character_flag = loan_default
				}
			}
		}
	}

	fail_trigger_effect = {
		clr_character_flag = quest_bank_recover_debt_DELEGATION
		remove_trait = travelling
		if = {
			limit = { FROMFROM = { has_character_flag = loan_bank_minor } }
			FROMFROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
		}
		else = {
			character_event = { id = bankruptcy.48 days = 7 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.65 #Offer compromise (interest default)
		trigger = {
			event_target:debtor_target = {
				NOT = { has_character_flag = offended_moneylenders }
				NOT = { check_variable = { which = loan_interest value = 0.45 } }
			}
		}
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = just
			}
			modifier = {
				factor = 2
				trait = honorable
			}
		}
		event_target:debtor_target = {
			show_portrait = THIS
			character_event = { id = bankruptcy.66 tooltip = TOOLTIPbankruptcy.66 }
		}
	}
	option = {
		name = EVTOPTBbankruptcy.65 #Offer compromise (dishonoured)
		trigger = { event_target:debtor_target = { has_character_flag = offended_moneylenders } }
		ai_chance = {
			factor = 50
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = just
			}
			modifier = {
				factor = 2
				trait = honorable
			}
		}
		event_target:debtor_target = {
			character_event = { id = bankruptcy.66 tooltip = TOOLTIPbankruptcy.66 }
		}
	}
	option = {
		name = EVTOPTCbankruptcy.65 #Threaten
		ai_chance = {
			factor = 10

			modifier = {
				factor = 2
				society_influence = 3
			}
			modifier = {
				factor = 2
				society_influence = 5
			}
			modifier = {
				factor = 0
				trait = patient
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 2
				trait = greedy
			}
		}
		event_target:debtor_target = {
			character_event = { id = bankruptcy.70 tooltip = TOOLTIPbankruptcy.70 }
		}
	}
	option = {
		name = EVTOPTDbankruptcy.65 #Reason
		ai_chance = {
			factor = 5

			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 0.5
				trait = wroth
			}
			modifier = {
				factor = 0.66
				event_target:debtor_target = { NOT = { opinion = { who = ROOT value = -80 } } }
			}
			modifier = {
				factor = 0.66
				event_target:debtor_target = { NOT = { opinion = { who = ROOT value = -50 } } }
			}
			modifier = {
				factor = 0.8
				event_target:debtor_target = { NOT = { opinion = { who = ROOT value = -20 } } }
			}
			modifier = {
				factor = 1.25
				event_target:debtor_target = { opinion = { who = ROOT value = 20 } }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { opinion = { who = ROOT value = 50 } }
			}
			modifier = {
				factor = 1.5
				event_target:debtor_target = { opinion = { who = ROOT value = 80 } }
			}
		}
		event_target:debtor_target = {
			character_event = { id = bankruptcy.73 tooltip = TOOLTIPbankruptcy.73 }
		}
	}
}
character_event = { #Envoy present compromise
	id = bankruptcy.66
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	desc = {
		text = EVTDESCbankruptcy.66
		trigger = { NOT = { has_character_flag = offended_moneylenders } }
	}
	desc = {
		text = EVTDESCbankruptcy.66B
		trigger = {
			has_character_flag = offended_moneylenders
			NOT = { has_character_flag = looted_bank }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.66C
		trigger = {
			has_character_flag = offended_moneylenders
			has_character_flag = looted_bank
		}
	}

	immediate = {
		calculate_loan_repayable_effect = yes
		set_variable = { which = compensation which = loan_amount }
		if = {
			limit = { NOT = { has_character_flag = offended_moneylenders } }
			multiply_variable = { which = compensation value = -0.05 }
		}
		else = {
			multiply_variable = { which = compensation value = -0.2 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.66 #Agree
		ai_chance = {
			factor = 75

			modifier = {
				factor = 0.5
				has_character_flag = offended_moneylenders
				has_character_flag = looted_bank
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 20 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 40 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 60 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 80 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 100 }
			}
			modifier = {
				factor = 2
				FROM = { society_influence = 3 }
			}
			modifier = {
				factor = 2
				FROM = { society_influence = 5 }
			}
			modifier = {
				factor = 2
				trait = content
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = honorable
			}
			modifier = {
				factor = 4
				trait = just
			}
		}
		clr_character_flag = loan_default
		clr_character_flag = offended_moneylenders
		clr_character_flag = looted_bank
		set_character_flag = loan_taken
		custom_tooltip = {
			text = TOOLTIPbankruptcy.67A
		}
		wealth = compensation
		if = {
			limit = { NOT = { has_character_flag = offended_moneylenders } }
			custom_tooltip = {
				text = TOOLTIPbankruptcy_interest_10
				change_variable = { which = loan_interest value = 0.1 }
			}
		}
		else = {
			custom_tooltip = {
				text = TOOLTIPbankruptcy_interest_35
				set_variable = { which = loan_interest value = 0.35 }
			}
		}
		hidden_tooltip = {
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1095
			}
		}
		FROM = { character_event = { id = bankruptcy.67 } }
	}
	option = {
		name = EVTOPTBbankruptcy.66 #Reject
		ai_chance = {
			factor = 50

			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -19 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -39 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -59 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -79 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -99 } }
			}
			modifier = {
				factor = 2
				FROM = { NOT = { society_influence = 1 } }
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = greedy
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 4
				trait = arbitrary
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
		}
		FROM = {
			character_event = { id = bankruptcy.68 }
			opinion = { who = ROOT modifier = opinion_rejected_delegation months = 60 }
		}
	}
	option = {
		name = EVTOPTCbankruptcy.66 #Imprison the envoy!
		trigger = {
			NOT = { trait = honorable }
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 0
				NOR = {
					trait = lunatic
					trait = ruthless
					trait = wroth
					trait = cruel
					trait = arbitrary
					opinion = { who = FROM value = 20 }
				}
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = arbitrary
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 0.25
				trait = just
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0.25
				trait = kind
			}
		}
		FROM = {
			imprison = ROOT
			character_event = { id = bankruptcy.69 }
		}
		change_variable = { which = "dishonorable" value = 10 }
		character_event = { id = maintenance.3 } #dishonorable trait

		set_character_flag = imprisoned_bank_envoy
		character_event = { id = bankruptcy.45 days = 5 } #consequences
	}
}
character_event = { #Inform envoy compromise reached
	id = bankruptcy.67
	desc = EVTDESCbankruptcy.67
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = {
			set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }

			multiply_variable = { which = compensation value = -1 }
			set_variable = { which = cash_reserve which = compensation }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.67
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			society = { change_variable = { which = cash_reserve which = FROM } }
			add_mission_succeed_influence_effect = yes
		}
		hidden_tooltip = {
			remove_trait = travelling
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }
			FROM = {
				set_variable = { which = compensation value = 0 }
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #Inform envoy compromise rejected
	id = bankruptcy.68
	desc = EVTDESCbankruptcy.68
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.68
		hidden_tooltip = {
			remove_trait = travelling
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
character_event = { #Inform envoy imprisoned!
	id = bankruptcy.69
	desc = EVTDESCbankruptcy.69
	picture = GFX_evt_into_the_dungeon
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.69
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			detract_society_currency_medium_effect = yes
			if = {
				limit = { FROM = { higher_tier_than = COUNT } }
				add_mission_fail_influence_effect = yes
			}
			hidden_tooltip = { clr_quest = { id = quest_bank_recover_debt failure = yes } }
		}
		hidden_tooltip = {
			remove_trait = travelling
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
		}
	}
}
character_event = { #Envoy threatens
	id = bankruptcy.70
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	desc = {
		text = EVTDESCbankruptcy.70
		trigger = { NOT = { has_character_flag = offended_moneylenders } }
	}
	desc = {
		text = EVTDESCbankruptcy.70B
		trigger = {
			has_character_flag = offended_moneylenders
			NOT = { has_character_flag = looted_bank }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.70C
		trigger = {
			has_character_flag = offended_moneylenders
			has_character_flag = looted_bank
		}
	}

	immediate = {
		calculate_loan_repayable_effect = yes
	}

	option = {
		name = EVTOPTAbankruptcy.70 #Agree
		ai_chance = {
			factor = 50

			modifier = {
				factor = 0.5
				has_character_flag = offended_moneylenders
			}
			modifier = {
				factor = 3
				trait = craven
			}

			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 20 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 40 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 60 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 80 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 100 }
			}
			modifier = {
				factor = 3
				FROM = { society_influence = 3 }
			}
			modifier = {
				factor = 3
				FROM = { society_influence = 5 }
			}
			modifier = {
				factor = 2
				trait = content
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = honorable
			}
			modifier = {
				factor = 4
				trait = just
			}
		}
		clr_character_flag = loan_default
		clr_character_flag = offended_moneylenders
		clr_character_flag = looted_bank
		hidden_tooltip = { set_variable = { which = success_bonus which = loan_amount } } #envoy gets 5% commission
		if = {
			limit = {
				NOT = { has_character_flag = offended_moneylenders }
			}
			custom_tooltip = {
				text = TOOLTIPbankruptcy.70A
			}
			wealth = loan_interest_payable_negative
			if = {
				limit = { NOT = { check_variable = { which = loan_interest value = 0.45 } } }
				custom_tooltip = {
					text = TOOLTIPbankruptcy_interest_10
					change_variable = { which = loan_interest value = 0.1 }
				}
			}
			hidden_tooltip = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_interest_payable }
						set_variable = { which = loan_profits which = loan_interest_payable }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
				remove_character_modifier = loan_timer
				add_character_modifier = {
					name = "loan_timer"
					duration = 730
				}
				set_variable = { which = cash_reserve value = 0 }
				set_variable = { which = loan_profits value = 0 }
			}
		}
		else = {
			custom_tooltip = {
				text = TOOLTIPbankruptcy.70B
			}
			wealth = loan_total_repayable_negative
			hidden_tooltip = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_total_repayable }
						set_variable = { which = loan_losses which = loan_amount }
						multiply_variable = { which = loan_losses value = -1 }
						set_variable = { which = loan_profits which = loan_amount }
						multiply_variable = { which = loan_profits which = loan_interest }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_losses which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
				clear_loan_flags_and_variables_effect = yes
			}
		}
		FROM = { character_event = { id = bankruptcy.71 } }
	}
	option = {
		name = EVTOPTBbankruptcy.70 #Reject
		ai_chance = {
			factor = 50

			modifier = {
				factor = 2
				trait = brave
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -19 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -39 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -59 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -79 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -99 } }
			}
			modifier = {
				factor = 2
				FROM = { NOT = { society_influence = 1 } }
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = greedy
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 4
				trait = arbitrary
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
		}
		FROM = {
			character_event = { id = bankruptcy.72 }
			opinion = { who = ROOT modifier = opinion_rejected_delegation months = 60 }
		}
	}
	option = {
		name = EVTOPTCbankruptcy.70 #Imprison the envoy!
		trigger = {
			NOT = { trait = honorable }
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 0
				NOR = {
					trait = lunatic
					trait = ruthless
					trait = wroth
					trait = cruel
					trait = arbitrary
					opinion = { who = FROM value = 20 }
				}
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = arbitrary
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 0.25
				trait = just
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0.25
				trait = kind
			}
		}
		FROM = {
			imprison = ROOT
			character_event = { id = bankruptcy.73 }
		}
		change_variable = { which = "dishonorable" value = 10 }
		character_event = { id = maintenance.3 } #dishonorable trait
	}
}
character_event = { #Inform envoy debtor caves to threats
	id = bankruptcy.71
	desc = EVTDESCbankruptcy.71
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = {
			#envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.71
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			add_mission_succeed_influence_effect = yes
		}
		hidden_tooltip = {
			remove_trait = travelling
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }

			FROM = {
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #Inform envoy threat rejected
	id = bankruptcy.72
	desc = EVTDESCbankruptcy.72
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.72
		hidden_tooltip = {
			remove_trait = travelling
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
character_event = { #Envoy reasons
	id = bankruptcy.73
	picture = GFX_tyroshi
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	desc = {
		text = EVTDESCbankruptcy.73
		trigger = { NOT = { has_character_flag = offended_moneylenders } }
	}
	desc = {
		text = EVTDESCbankruptcy.73B
		trigger = {
			has_character_flag = offended_moneylenders
			NOT = { has_character_flag = looted_bank }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.73C
		trigger = {
			has_character_flag = offended_moneylenders
			has_character_flag = looted_bank
		}
	}

	immediate = {
		calculate_loan_repayable_effect = yes
	}

	option = {
		name = EVTOPTAbankruptcy.73 #Agree
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.5
				has_character_flag = offended_moneylenders
			}
			modifier = {
				factor = 1.5
				FROM = { diplomacy = 10 }
			}
			modifier = {
				factor = 1.5
				FROM = { diplomacy = 14 }
			}
			modifier = {
				factor = 1.5
				FROM = { diplomacy = 18 }
			}

			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 20 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 40 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 60 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 80 }
			}
			modifier = {
				factor = 1.25
				opinion = { who = FROM value = 100 }
			}
			modifier = {
				factor = 2
				FROM = { society_influence = 3 }
			}
			modifier = {
				factor = 2
				FROM = { society_influence = 5 }
			}
			modifier = {
				factor = 2
				trait = content
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = honorable
			}
			modifier = {
				factor = 4
				trait = just
			}
		}
		clr_character_flag = loan_default
		clr_character_flag = offended_moneylenders
		clr_character_flag = looted_bank
		hidden_tooltip = { set_variable = { which = success_bonus which = loan_amount } } #envoy gets 5% commission
		if = {
			limit = {
				NOT = { has_character_flag = offended_moneylenders }
			}
			custom_tooltip = {
				text = TOOLTIPbankruptcy.70A
			}
			wealth = loan_interest_payable_negative
			if = {
				limit = { NOT = { check_variable = { which = loan_interest value = 0.45 } } }
				custom_tooltip = {
					text = TOOLTIPbankruptcy_interest_10
					change_variable = { which = loan_interest value = 0.1 }
				}
			}
			hidden_tooltip = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_interest_payable }
						set_variable = { which = loan_profits which = loan_interest_payable }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
				remove_character_modifier = loan_timer
				add_character_modifier = {
					name = "loan_timer"
					duration = 730
				}
				set_variable = { which = cash_reserve value = 0 }
				set_variable = { which = loan_profits value = 0 }
			}
		}
		else = {
			custom_tooltip = {
				text = TOOLTIPbankruptcy.70B
			}
			wealth = loan_total_repayable_negative
			hidden_tooltip = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_total_repayable }
						set_variable = { which = loan_losses which = loan_amount }
						multiply_variable = { which = loan_losses value = -1 }
						set_variable = { which = loan_profits which = loan_amount }
						multiply_variable = { which = loan_profits which = loan_interest }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_losses which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
				clear_loan_flags_and_variables_effect = yes
			}
		}
		FROM = { character_event = { id = bankruptcy.74 } }
	}
	option = {
		name = EVTOPTBbankruptcy.73 #Reject
		ai_chance = {
			factor = 50

			modifier = {
				factor = 1.5
				FROM = { diplomacy < 6 }
			}
			modifier = {
				factor = 1.5
				FROM = { diplomacy < 2 }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -19 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -39 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -59 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -79 } }
			}
			modifier = {
				factor = 1.25
				NOT = { opinion = { who = FROM value = -99 } }
			}
			modifier = {
				factor = 2
				FROM = { NOT = { society_influence = 1 } }
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = greedy
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 4
				trait = arbitrary
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
		}
		FROM = {
			character_event = { id = bankruptcy.75 }
			opinion = { who = ROOT modifier = opinion_rejected_delegation months = 60 }
		}
	}
	option = {
		name = EVTOPTCbankruptcy.73 #Imprison the envoy!
		trigger = {
			NOT = { trait = honorable }
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 0
				NOR = {
					trait = lunatic
					trait = ruthless
					trait = wroth
					trait = cruel
					trait = arbitrary
					opinion = { who = FROM value = 20 }
				}
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = arbitrary
			}
			modifier = {
				factor = 2
				trait = ruthless
			}
			modifier = {
				factor = 0.25
				trait = just
			}
			modifier = {
				factor = 0.25
				trait = patient
			}
			modifier = {
				factor = 0.25
				trait = kind
			}
		}
		FROM = {
			imprison = ROOT
			character_event = { id = bankruptcy.73 }
		}
		change_variable = { which = "dishonorable" value = 10 }
		character_event = { id = maintenance.3 } #dishonorable trait
	}
}
character_event = { #Inform envoy debtor listens to reason
	id = bankruptcy.74
	desc = EVTDESCbankruptcy.74
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = {
			#envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.74
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			add_mission_succeed_influence_effect = yes
		}
		hidden_tooltip = {
			remove_trait = travelling
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }

			FROM = {
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #Inform envoy reasoning rejected
	id = bankruptcy.75
	desc = EVTDESCbankruptcy.75
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.75
		hidden_tooltip = {
			remove_trait = travelling
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}
character_event = { #Debtor killed by bank assassins
	id = bankruptcy.80
	desc = EVTDESC_WOL_2111_DEATH #Use same text as intrigue focus events, to make identity of attacker unclear
	picture = GFX_evt_shadow
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes
	hide_from = yes

	option = {
		name = EVTOPT_WOL_2111_DEATH
		hidden_tooltip = {
			FROM = {
				character_event = { id = bankruptcy.81 }
			}
			FROM_murder_red_god_resurrect_effect = yes #check for rhllor resurrection
			set_character_flag = killed_by_bank_envoy #this enables the envoy to continue on the heir
			if = {
				limit = { is_patrician = yes }
				family_palace = { current_heir = { save_event_target_as = debt_inheritor } }
			}
			else = {
				current_heir = { save_event_target_as = debt_inheritor }
			}
			inherit_debt_effect = yes
		}
		death = {
			death_reason = death_murder_unknown
			killer = FROM
		}
	}
}
character_event = { #Inform envoy assassin success
	id = bankruptcy.81
	desc = EVTDESCbankruptcy.81
	picture = GFX_evt_shadow
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.81
	}
}
character_event = { #Debtor attacked by bank assassins
	id = bankruptcy.82
	desc = EVTDESC_WOL_2111_LIVES #Use same text as intrigue focus events, to make identity of attacker unclear
	picture = GFX_evt_shadow
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes
	hide_from = yes

	option = {
		name = EVTOPT_WOL_2111_UNKNOWN
		hidden_tooltip = {
			FROM = {
				character_event = { id = bankruptcy.83 }
			}
		}
	}
}
character_event = { #Inform envoy assassin fail
	id = bankruptcy.83
	desc = EVTDESCbankruptcy.83
	picture = GFX_evt_shadow
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.83
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			character_event = { id = bankruptcy.48 days = 7 }
		}
		else = {
			FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
		}
	}
}
character_event = { #Debtor killed by faceless man
	id = bankruptcy.84
	picture = GFX_evt_shadowy_cabal
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes
	hide_from = yes

	desc = {
		text = EVTDESCfaceless.7 #Use same text as faceless events, to make identity of attacker unclear
		trigger = {
			FROM = {
				location = {
					NOR = {
						region = world_far_east
						region = world_jade_sea
						region = world_ghiscar
						region = world_dothraki
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCfaceless.700 #sorrowful man
		trigger = {
			FROM = {
				location = {
					OR = {
						region = world_far_east
						region = world_jade_sea
						region = world_ghiscar
						region = world_dothraki
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTAfaceless.7"
		hidden_tooltip = {
			FROM = {
				character_event = { id = bankruptcy.86 }
			}
			FROM_murder_red_god_resurrect_effect = yes #check for rhllor resurrection
			set_character_flag = killed_by_bank_envoy #this enables the envoy to continue on the heir
			if = {
				limit = { is_patrician = yes }
				family_palace = { current_heir = { save_event_target_as = debt_inheritor } }
			}
			else = {
				current_heir = { save_event_target_as = debt_inheritor }
			}
			inherit_debt_effect = yes
		}
		death = {
			death_reason = death_murder_unknown
			killer = FROM
		}
	}
}
character_event = { #Inform envoy faceless success
	id = bankruptcy.86
	desc = EVTDESCbankruptcy.86
	picture = GFX_evt_shadow
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.86
	}
}
character_event = { #Inform envoy heir paid after killing
	id = bankruptcy.87
	desc = EVTDESCbankruptcy.87
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = {
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.87
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			add_mission_succeed_influence_effect = yes
		}
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }

			FROM = {
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #Inform envoy heir refused after killing
	id = bankruptcy.88
	desc = EVTDESCbankruptcy.88
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.88
		clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_DELEGATION
		clr_character_flag = quest_bank_recover_debt_ASSASSIN
		clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
		clr_character_flag = quest_bank_recover_debt_HEAVIES
		clr_character_flag = quest_bank_recover_debt_ARTIFACT
		#clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			character_event = { id = bankruptcy.48 days = 7 }
		}
		else = {
			FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
		}
	}
}
character_event = { #High councillor votes on action for high value debtor
	id = bankruptcy.90
	border = GFX_event_normal_frame_economy
	picture = GFX_evt_council

	is_triggered_only = yes

	#Default on interest
	desc = {
		text = EVTDESCbankruptcy.90
		trigger = {
			FROM = {
				NOT = { has_character_flag = imprisoned_bank_envoy }
				NOT = { has_character_flag = offended_moneylenders }
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.90B
		trigger = {
			FROM = {
				has_character_flag = imprisoned_bank_envoy
				NOT = { has_character_flag = offended_moneylenders }
			}
		}
	}
	#Dishonoured loan
	desc = {
		text = EVTDESCbankruptcy.90C
		trigger = {
			FROM = {
				NOT = { has_character_flag = imprisoned_bank_envoy }
				has_character_flag = offended_moneylenders
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.90D
		trigger = {
			FROM = {
				has_character_flag = imprisoned_bank_envoy
				has_character_flag = offended_moneylenders
			}
		}
	}

	immediate = {
		#Round loan to down to integer for the player
		if = {
			limit = { ai = no }
			FROM = { round_loan_to_integer_effect = yes }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.90 #Vote for action
		ai_chance = {
			factor = 25

			modifier = {
				factor = 2
				trait = diligent
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 0.5
				trait = slothful
			}
			modifier = {
				factor = 0.5
				trait = humble
			}
			modifier = {
				factor = 0.5
				trait = patient
			}
			modifier = {
				factor = 0.5
				trait = content
			}

			modifier = {
				factor = 2
				NOT = { opinion = { who = FROM value = 0 } }
			}
			modifier = {
				factor = 2
				NOT = { opinion = { who = FROM value = -35 } }
			}
		}
		set_character_flag = bank_council_vote_for
		FROM = { change_variable = { which = bank_votes_for value = 1 } }
	}
	option = {
		name = EVTOPTBbankruptcy.90 #Vote against action
		ai_chance = {
			factor = 1

			modifier = {
				factor = 0
				trait = just
			}
			modifier = {
				factor = 0
				NOT = { opinion = { who = FROM value = 30 } }
			}
			modifier = {
				factor = 5
				is_allied_with = FROM
			}
			modifier = {
				factor = 5
				is_close_relative = FROM
			}
			modifier = {
				factor = 5
				is_friend = FROM
			}
			modifier = {
				factor = 5
				opinion = { who = FROM value = 60 }
			}
		}
		hidden_tooltip = { FROM = { change_variable = { which = bank_votes_for value = -1 } } }
		detract_society_currency_medium_effect = yes
	}
}
character_event = { #Inform society vote result
	id = bankruptcy.91
	desc = EVTDESCbankruptcy.91
	border = GFX_event_normal_frame_economy

	picture = {
		picture = GFX_evt_council_agreement
		trigger = { FROM = { check_variable = { which = bank_votes_for value = 1 } } }
	}
	picture = {
		picture = GFX_evt_council_quarrelling
		trigger = { NOT = { FROM = { check_variable = { which = bank_votes_for value = 1 } } } }
	}

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.91 #Council voted in favour
		trigger = { FROM = { check_variable = { which = bank_votes_for value = 1 } } }
	}
	option = {
		name = EVTOPTBbankruptcy.91 #Council voted against
		trigger = { FROM = { NOT = { check_variable = { which = bank_votes_for value = 1 } } } }
	}
	after = {
		society = {
			any_society_member = {
				limit = {
					society_rank == 4
					prisoner = no
					is_incapable = no
					NOT = { is_inaccessible_trigger = yes }
					NOT = { character = FROM }
				}
				if = {
					limit = { has_character_flag = bank_council_vote_for }
					custom_tooltip = { text = TOOLTIPbankruptcy.91FOR }
				}
				else = {
					custom_tooltip = { text = TOOLTIPbankruptcy.91AGAINST }
				}
			}
		}
	}
}
character_event = { #Debtor event
	id = bankruptcy.92

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = {
			limit = { check_variable = { which = bank_votes_for value = 1 } }
			persistent_event_target:loan_bank = {
				random_society_member = {
					limit = {
						society_rank == 4
						prisoner = no
						is_incapable = no
						NOT = { is_inaccessible_trigger = yes }
						NOT = { character = ROOT }
					}
					preferred_limit = {
						has_character_flag = bank_council_vote_for
						NOR = { #conflict of interest
							is_close_relative = ROOT
							has_blood_oath_with = ROOT
							is_lover = ROOT
							is_friend = ROOT
							is_married = ROOT
							is_allied_with = ROOT
							current_heir = { character = ROOT }
						}
					}
					preferred_limit = {
						has_character_flag = bank_council_vote_for
					}
					set_character_flag = council_voted_for_action
					character_event = { id = bankruptcy.46 days = 1 }
				}
			}
		}
	}

	option = {
		name = OK
		set_variable = { which = bank_votes_for value = 0 }
		persistent_event_target:loan_bank = {
			any_society_member = {
				limit = {
					society_rank == 4
				}
				clr_character_flag = bank_council_vote_for
			}
		}
	}
}
#Minor bank debt recovery options
character_event = {
	id = bankruptcy.95

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		hidden_tooltip = {
			#Check if letter to liege/top liege is valid
			if = {
				limit = {
					NOT = { has_character_flag = quest_bank_recover_debt_LIEGE_LETTER }
					FROM = {
						check_variable = { which = loan_amount value = 15 } #min loan to petition liege
						OR = {
							check_variable = { which = loan_amount value = 50 }
							NOT = { tier = COUNT }
							top_liege = { NOT = { tier = EMPEROR } }
						}
						liege = {
							NOT = { character = PREV }
							NOT = { character = ROOT }
						}
						NOT = { has_character_flag = looted_bank }
					}
				}
				set_character_flag = can_send_liege_letter
			}
			if = {
				limit = {
					has_character_flag = quest_bank_recover_debt_LIEGE_LETTER #has attempted direct liege
					NOT = { has_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER }
					FROM = {
						check_variable = { which = loan_amount value = 30 } #min loan to petition top liege
						OR = {
							check_variable = { which = loan_amount value = 100 }
							NOT = { tier = COUNT }
							top_liege = { NOT = { tier = EMPEROR } }
						}
						top_liege = {
							NOT = { is_liege_of = PREV }
							NOT = { character = ROOT }
						}
						NOT = { has_character_flag = looted_bank }
						NOT = { liege = { character = PREV } }
					}
				}
				set_character_flag = can_send_top_liege_letter
			}
			if = { #Only go for assasination if target purposefully reneged, or heir could pay
				limit = {
					FROM = {
						OR = {
							has_character_flag = offended_moneylenders
							has_character_flag = imprisoned_bank_envoy
							reverse_has_opinion_modifier = { who = ROOT modifier = opinion_rejected_delegation }
							current_heir = {
								OR = {
									is_liege_of = PREV
									wealth = 250
								}
							}
						}
					}
				}
				#Determine normal hit cost
				if = {
					limit = { NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN } }
					FROM = {
						if = {
							limit = {
								tier = EMPEROR
								check_variable = { which = loan_amount value = 240 } #Loan must be at least 4X cost
							}
							ROOT = { set_character_flag = can_use_assassin }
						}
						else_if = {
							limit = {
								tier = KING
								check_variable = { which = loan_amount value = 160 }
							}
							ROOT = { set_character_flag = can_use_assassin }
						}
						else_if = {
							limit = {
								tier = DUKE
								check_variable = { which = loan_amount value = 120 }
							}
							ROOT = { set_character_flag = can_use_assassin }
						}
						else_if = {
							limit = {
								tier = COUNT
								check_variable = { which = loan_amount value = 80 }
							}
							ROOT = { set_character_flag = can_use_assassin }
						}
						else_if = {
							limit = {
								tier = BARON
								check_variable = { which = loan_amount value = 40 }
							}
							ROOT = { set_character_flag = can_use_assassin }
						}
					}
				}
			}
			#Find potential artifact to claim
			clear_event_target = artifact_debt
			if = {
				limit = { NOT = { has_character_flag = quest_bank_recover_debt_ARTIFACT } }
				FROM = {
					random_artifact = {
						limit = {
							NOT = { has_artifact_flag = no_usurp_transfer }
							NOT = { has_artifact_flag = curse }
							OR = {
								AND = {
									NOT = { has_artifact_flag = valyrian_steel }
									NOT = { has_artifact_flag = valyrian_armour }
									NOT = { has_artifact_flag = book }
									OR = {
										AND = {
											quality == 1
											owner = { NOT = { check_variable = { which = loan_amount value = 33 } } }
										}
										AND = {
											quality == 2
											owner = {
												check_variable = { which = loan_amount value = 33 }
												NOT = { check_variable = { which = loan_amount value = 67 } }
											}
										}
										AND = {
											quality == 3
											owner = {
												check_variable = { which = loan_amount value = 67 }
												NOT = { check_variable = { which = loan_amount value = 133 } }
											}
										}
										AND = {
											quality == 4
											owner = {
												check_variable = { which = loan_amount value = 133 }
												NOT = { check_variable = { which = loan_amount value = 267 } }
											}
										}
										AND = {
											quality > 4
											owner = {
												check_variable = { which = loan_amount value = 267 }
												NOT = { check_variable = { which = loan_amount value = 533 } }
											}
										}
									}
								}
								AND = {
									has_artifact_flag = valyrian_steel
									quality == 3
									owner = {
										check_variable = { which = loan_amount value = 150 }
										NOT = { check_variable = { which = loan_amount value = 208 } }
									}
								}
								AND = {
									has_artifact_flag = valyrian_steel
									quality == 4
									owner = {
										check_variable = { which = loan_amount value = 300 }
										NOT = { check_variable = { which = loan_amount value = 416 } }
									}
								}
								AND = {
									has_artifact_flag = valyrian_armour
									owner = {
										check_variable = { which = loan_amount value = 533 }
										NOT = { check_variable = { which = loan_amount value = 833 } }
									}
								}
								AND = {
									has_artifact_flag = book
									quality == 2
									owner = {
										NOT = { check_variable = { which = loan_amount value = 33 } }
									}
								}
								AND = {
									has_artifact_flag = book
									quality == 3
									owner = {
										check_variable = { which = loan_amount value = 33 }
										NOT = { check_variable = { which = loan_amount value = 67 } }
									}
								}
							}
						}
						save_event_target_as = artifact_debt
					}
				}
			}
		}
		FROM = { save_event_target_as = debtor_target }
	}

	option = {
		name = EVTOPTAbankruptcy.49 #Write letter to liege
		trigger = {
			has_character_flag = can_send_liege_letter
		}
		ai_chance = {
			factor = 9999
			modifier = { #may prefer to go straight to funding enemy/assasination
				factor = 0.001
				OR = {
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
						FROM = { #Only low rank, low value debtors
							lower_tier_than = DUKE
							NOT = { check_variable = { which = loan_amount value = 100 } }
						}
					}
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
						has_character_flag = can_use_assassin
					}
				}
				OR = {
					trait = ruthless
					trait = deceitful
					trait = cruel
					is_foe = event_target:debtor_target
					FROM = { check_variable = { which = loan_amount value = 300 } }
				}
				NOR = {
					trait = kind
					trait = honorable
					trait = honest
				}
			}
		}
		set_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		FROM = {
			liege = {
				letter_event = { id = bankruptcy.51 tooltip = TOOLTIPbankruptcy.51 }
			}
		}
	}
	option = {
		name = EVTOPTBbankruptcy.49 #Write letter to top liege
		trigger = {
			has_character_flag = can_send_top_liege_letter
		}
		ai_chance = {
			factor = 9999
			modifier = { #may prefer to go straight to funding enemy/assasination
				factor = 0.001
				OR = {
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
						FROM = { #Only low rank, low value debtors
							lower_tier_than = DUKE
							NOT = { check_variable = { which = loan_amount value = 100 } }
						}
					}
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
						has_character_flag = can_use_assassin
					}
				}
				OR = {
					trait = ruthless
					trait = deceitful
					trait = cruel
					is_foe = event_target:debtor_target
					FROM = { check_variable = { which = loan_amount value = 300 } }
				}
				NOR = {
					trait = kind
					trait = honorable
					trait = honest
				}
			}
		}
		set_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		FROM = {
			top_liege = {
				letter_event = { id = bankruptcy.51 tooltip = TOOLTIPbankruptcy.51 }
			}
		}
	}
	option = {
		name = EVTOPTCbankruptcy.49 #Send delegation
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_DELEGATION }
		}
		ai_chance = {
			factor = 9999
			modifier = {
				factor = 0
				has_character_flag = can_send_liege_letter
			}
			modifier = {
				factor = 0
				has_character_flag = can_send_top_liege_letter
			}
			modifier = { #may prefer to go straight to funding enemy/assasination
				factor = 0.001
				OR = {
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
						FROM = { #Only low rank, low value debtors
							lower_tier_than = DUKE
							NOT = { check_variable = { which = loan_amount value = 100 } }
						}
					}
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
						has_character_flag = can_use_assassin
					}
				}
				OR = {
					trait = ruthless
					trait = deceitful
					trait = cruel
					is_foe = event_target:debtor_target
					FROM = { check_variable = { which = loan_amount value = 300 } }
				}
				NOR = {
					trait = kind
					trait = honorable
					trait = honest
				}
			}
		}
		set_character_flag = quest_bank_recover_debt_DELEGATION
		custom_tooltip = {
			text = TOOLTIPbankruptcy.48A
			add_trait = travelling
			character_event = { id = bankruptcy.65 days = 50 random = 100 }
		}
	}
	option = {
		name =  EVTOPTJbankruptcy.49 #Offer to take artifact instead
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_ARTIFACT }
			event_target:artifact_debt = { always = yes }
		}
		ai_chance = {
			factor = 9999
			modifier = {
				factor = 0
				has_character_flag = can_send_liege_letter
			}
			modifier = {
				factor = 0
				has_character_flag = can_send_top_liege_letter
			}
			modifier = { #may prefer to go straight to funding enemy/assasination
				factor = 0.001
				OR = {
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
						FROM = { #Only low rank, low value debtors
							lower_tier_than = DUKE
							NOT = { check_variable = { which = loan_amount value = 100 } }
						}
					}
					AND = {
						NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
						has_character_flag = can_use_assassin
					}
				}
				OR = {
					trait = ruthless
					trait = deceitful
					trait = cruel
					is_foe = event_target:debtor_target
					FROM = { check_variable = { which = loan_amount value = 300 } }
				}
				NOR = {
					trait = kind
					trait = honorable
					trait = honest
				}
			}
		}
		set_character_flag = quest_bank_recover_debt_ARTIFACT
		FROM = {
			show_portrait = THIS
			letter_event = { id = bankruptcy.220 tooltip = TOOLTIPbankruptcy.220 }
		}
	}
	option = {
		name = EVTOPTIbankruptcy.49 #Send in the heavies
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_HEAVIES }
			FROM = { #Only low rank, low value debtors
				lower_tier_than = DUKE
				NOT = { check_variable = { which = loan_amount value = 100 } }
			}
		}
		ai_chance = {
			factor = 20

			modifier = {
				factor = 0.5
				OR = {
					trait = kind
					trait = honorable
				}
			}
			modifier = {
				factor = 0.5
				FROM = {
					OR = {
						is_child_of = ROOT # Not my own children
						is_grandchild_of = ROOT
						has_blood_oath_with = ROOT
						is_lover = ROOT
						is_friend = ROOT
					}
				}
			}
			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 1.5
				trait = arbitrary
			}
			modifier = {
				factor = 2.0
				trait = cruel
			}
			modifier = {
				factor = 2.0
				trait = deceitful
			}
			modifier = {
				factor = 3.0
				trait = ambitious
			}

			modifier = {
				factor = 0.5
				trait = honest
			}
			modifier = {
				factor = 10
				is_foe = FROMFROMFROM
			}
		}
		set_character_flag = quest_bank_recover_debt_HEAVIES
		FROM = { show_portrait = THIS }
		random_list = {
			100 = { #Success
				modifier = {
					factor = 0.66
					martial < 2
				}
				modifier = {
					factor = 0.66
					martial < 5
				}
				modifier = {
					factor = 1.5
					martial = 8
				}
				modifier = {
					factor = 1.5
					martial = 11
				}
				modifier = {
					factor = 1.5
					martial = 14
				}
				modifier = {
					factor = 1.5
					martial = 17
				}
				modifier = {
					factor = 1.5
					martial = 20
				}
				FROM = { character_event = { id = bankruptcy.130 tooltip = TOOLTIPbankruptcy.130 } }
			}
			50 = { #Fail
				modifier = { #Harder to recover full debt
					factor = 2
					FROM = { has_character_flag = offended_moneylenders }
				}
				modifier = {
					factor = 0.66
					FROM = { martial < 2 }
				}
				modifier = {
					factor = 0.66
					FROM = { martial < 5 }
				}
				modifier = {
					factor = 1.5
					FROM = { martial = 8 }
				}
				modifier = {
					factor = 1.5
					FROM = { martial = 11 }
				}
				modifier = {
					factor = 1.5
					FROM = { martial = 14 }
				}
				modifier = {
					factor = 1.5
					FROM = { martial = 17 }
				}
				modifier = {
					factor = 1.5
					FROM = { martial = 20 }
				}
				FROM = { character_event = { id = bankruptcy.132 tooltip = TOOLTIPbankruptcy.132 } }
			}
		}
	}
	option = {
		name = EVTOPTDbankruptcy.49 #Kill
		trigger = {
			NOT = { has_character_flag = quest_bank_recover_debt_ASSASSIN }
			has_character_flag = can_use_assassin
		}
		ai_chance = {
			factor = 10

			modifier = {
				factor = 1000
				OR = {
					has_plot = plot_kill_character
					has_plot = plot_kill_spouse
				}
				plot_target_char = { character = FROM }
			}
			modifier = {
				factor = 0
				OR = {
					trait = kind
					trait = honorable
				}
			}
			modifier = {
				factor = 0
				FROM = {
					OR = {
						is_child_of = ROOT # Not my own children
						is_grandchild_of = ROOT
						has_blood_oath_with = ROOT
						is_lover = ROOT
						is_friend = ROOT
					}
				}
			}
			modifier = {
				factor = 0
				pacifist = yes
				NOT = { trait = cynical }
			}
			modifier = {
				factor = 0.01
				# Kinslaying is generally discouraged
				OR = {
					AND = {
						is_lowborn = no
						dynasty = FROM
					}
					is_close_relative = FROM
				}
				NOT = { trait = arbitrary }
				NOT = { trait = ruthless }
				NOT = { trait = cruel }
				NOT = { trait = lunatic }
				NOT = { trait = possessed }
			}

			modifier = {
				factor = 4
				trait = ruthless
			}
			modifier = {
				factor = 1.5
				trait = arbitrary
			}
			modifier = {
				factor = 2.0
				trait = cruel
			}
			modifier = {
				factor = 2.0
				trait = deceitful
			}
			modifier = {
				factor = 3.0
				trait = ambitious
			}

			modifier = {
				factor = 0.5
				trait = honest
			}
			modifier = {
				factor = 10
				is_foe = FROMFROMFROM
			}
		}
		set_character_flag = quest_bank_recover_debt_ASSASSIN
		random_list = {
			50 = { #Success
				modifier = {
					factor = 0.66
					intrigue < 2
				}
				modifier = {
					factor = 0.66
					intrigue < 5
				}
				modifier = {
					factor = 1.5
					intrigue = 8
				}
				modifier = {
					factor = 1.5
					intrigue = 11
				}
				modifier = {
					factor = 1.5
					intrigue = 14
				}
				modifier = {
					factor = 1.5
					intrigue = 17
				}
				modifier = {
					factor = 1.5
					intrigue = 20
				}
				FROM = { character_event = { id = bankruptcy.80 tooltip = TOOLTIPbankruptcy.80 } }
			}
			50 = { #Fail
				modifier = {
					factor = 0.66
					quest_target = { intrigue < 2 }
				}
				modifier = {
					factor = 0.66
					quest_target = { intrigue < 5 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 8 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 11 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 14 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 17 }
				}
				modifier = {
					factor = 1.5
					quest_target = { intrigue = 20 }
				}
				FROM = { character_event = { id = bankruptcy.82 tooltip = TOOLTIPbankruptcy.82 } }
			}
		}
	}
	option = {
		name = EVTOPTHbankruptcy.49 #Failed
		trigger = { #No further actions are possible
			NOT = { has_character_flag = can_send_liege_letter }
			NOT = { has_character_flag = can_send_top_liege_letter }
			has_character_flag = quest_bank_recover_debt_DELEGATION
			OR = {
				has_character_flag = quest_bank_recover_debt_ARTIFACT
				NOT = { event_target:artifact_debt = { always = yes } }
			}
			OR = {
				has_character_flag = quest_bank_recover_debt_HEAVIES
				NOT = {
					FROM = { #Only low rank, low value debtors
						lower_tier_than = DUKE
						NOT = { check_variable = { which = loan_amount value = 100 } }
					}
				}
			}
			OR = {
				has_character_flag = quest_bank_recover_debt_ASSASSIN
				NOT = { has_character_flag = can_use_assassin }
			}
		}
		clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
		clr_character_flag = quest_bank_recover_debt_DELEGATION
		clr_character_flag = quest_bank_recover_debt_ASSASSIN
		clr_character_flag = quest_bank_recover_debt_ARTIFACT
	}
	after = {
		hidden_tooltip = {
			clr_character_flag = can_use_assassin
			clr_character_flag = can_send_liege_letter
			clr_character_flag = can_send_top_liege_letter
		}
	}
}
character_event = { #Action failed, rescope to debtor
	id = bankruptcy.96

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = { #Quest no longer valid
			limit = {
				OR = {
					is_ruler = no
					NOT = { check_variable = { which = loan_amount value = 1 } }
					NOR = {
						has_character_flag = offended_moneylenders
						has_character_flag = loan_default
					}
					persistent_event_target:loan_bank = { always = yes }
				}
			}
			break = yes
		}
		if = {
			limit = {
				FROM = {
					OR = {
						society = { has_flag = bank_society } #check an actual banker has not somehow got this
						is_ruler = yes
						is_alive = no
						prisoner = yes
						is_incapable = yes
						is_inaccessible_trigger = yes
					}
				}
			}
			character_event = { id = bankruptcy.45 days = 5 } #try consequences again
			break = yes
		}
		FROM = { character_event = { id = bankruptcy.95 } }
	}

	option = {
		name = OK
	}
}

#Banker Hired
character_event = {
	id = bankruptcy.125
	desc = "EVTDESCbankruptcy.125"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		society = {
			persistent_event_target:location = {
				ROOT = {
					create_random_steward = {
						random_traits = yes
						dynasty = none
						female = no
						culture = PREV
						religion = PREV
						historical = yes
					}
					new_character = {
						save_event_target_as = new_banker
						join_society = PREVPREVPREV

						remove_trait = slow
						remove_trait = slow_1
						remove_trait = imbecile
						remove_trait = imbecile_1
						remove_trait = dull

						remove_lifestyle_trait_effect = yes

						random_list = { # Flavor Randomization
							35 = {
								# Nothing
							}
							15 = {
								change_stewardship = 2
							}
							10 = {
								add_trait = architect
							}
							10 = {
								add_trait = administrator
							}
							10 = {
								change_stewardship = 4
							}
							5 = {
								change_stewardship = 6
							}
							5 = {
								trigger = {
									is_smart_incl_genius_trigger = no
								}
								add_trait = shrewd
							}
						}
						if = {
							limit = {
								culture_group = hyrkoon_group
							}
							add_trait = eunuch
						}
						while = {
							limit = { stewardship < 12 }
							change_stewardship = 1
						}
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.125"
		event_target:new_banker = {
			tooltip = { move_character = ROOT }
			show_portrait = yes
		}
	}
}
#New bank Established
character_event = {
	id = bankruptcy.126
	title = "EVTTITLEbankruptcy.126"
	desc = "EVTDESCbankruptcy.126"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		if = { #patrician bank is usually located in republic capital
			limit = {
				is_patrician = yes
				is_merchant_republic = no
				lower_tier_than = KING
			}
			liege = { capital_scope = { save_event_target_as = bank_location } }
		}
		else = {
			capital_scope = { save_event_target_as = bank_location }
		}
		if = {
			limit = {
				event_target:bank_location = { region = world_braavos }
				NOT = { has_global_flag = iron_bank_founded }
			}
			set_global_flag = iron_bank_founded
			join_society = iron_bank
			event_target:bank_location = {
				set_province_flag = location_has_bank
				iron_bank = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				has_landed_title = e_new_valyria
				NOT = { has_global_flag = valyria_bank_founded }
			}
			set_global_flag = valyria_bank_founded
			join_society = valyria_bank
			event_target:bank_location = {
				set_province_flag = location_has_bank
				valyria_bank = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				event_target:bank_location = { region = world_lys }
				NOT = { has_global_flag = rogare_bank_founded }
			}
			set_global_flag = rogare_bank_founded
			join_society = rogare_bank
			event_target:bank_location = {
				set_province_flag = location_has_bank
				c_rogare_bank = { #name of the bank is based on this title, renaming the title renames the bank
					set_name = [Root.GetBankName]
					adjective = [Prev.GetName] #alters bank location in society description
				}
				rogare_bank = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				event_target:bank_location = { region = world_qarth }
				NOT = { has_global_flag = qarth_bank_founded }
			}
			set_global_flag = qarth_bank_founded
			join_society = qarth_bank
			event_target:bank_location = {
				set_province_flag = location_has_bank
				qarth_bank = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				NOT = { has_global_flag = bank_1_founded }
			}
			set_global_flag = bank_1_founded
			join_society = bank_1
			event_target:bank_location = {
				set_province_flag = location_has_bank
				c_bank_1 = { #name of the bank is based on this title, renaming the title renames the bank
					set_name = [Root.GetBankName]
					adjective = [Prev.GetName] #alters bank location in society description
				}
				bank_1 = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				NOT = { has_global_flag = bank_2_founded }
			}
			set_global_flag = bank_2_founded
			join_society = bank_2
			event_target:bank_location = {
				set_province_flag = location_has_bank
				c_bank_2 = {
					set_name = [Root.GetBankName]
					adjective = [Prev.GetName]
				}
				bank_2 = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				NOT = { has_global_flag = bank_3_founded }
			}
			set_global_flag = bank_3_founded
			join_society = bank_3
			event_target:bank_location = {
				set_province_flag = location_has_bank
				c_bank_3 = {
					set_name = [Root.GetBankName]
					adjective = [Prev.GetName]
				}
				bank_3 = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				NOT = { has_global_flag = bank_4_founded }
			}
			set_global_flag = bank_4_founded
			join_society = bank_4
			event_target:bank_location = {
				set_province_flag = location_has_bank
				c_bank_4 = {
					set_name = [Root.GetBankName]
					adjective = [Prev.GetName]
				}
				bank_4 = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		else_if = {
			limit = {
				NOT = { has_global_flag = bank_5_founded }
			}
			set_global_flag = bank_5_founded
			join_society = bank_5
			event_target:bank_location = {
				set_province_flag = location_has_bank
				c_bank_5 = {
					set_name = [Root.GetBankName]
					adjective = [Prev.GetName]
				}
				bank_5 = { save_persistent_event_target = { name = location scope = PREV } }
			}
		}
		society = {
			set_flag = bank_society
			set_flag = new_bank_society #this will trigger loan inform event for first few years
			set_variable = { which = cash_reserve value = 0 }
			set_variable = { which = loan_profits value = 0 }
			set_variable = { which = loan_losses value = 0 }
			set_variable = { which = outstanding_loans value = 0 }
		}
		society_rank_up = 3
		set_society_grandmaster = yes
		set_variable = { which = shares value = 5 }
	}

	option = {
		name = "EVTOPTAbankruptcy.126"
		society = {
			show_scope_change = no
			change_variable = { which = cash_reserve value = 700 }
			tooltip = {
				ROOT = {
					show_scope_change = no
					join_society = PREV
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.126_RENAME
		}
		add_society_currency_medium_effect = yes
		hidden_tooltip = {
			any_player = {
				limit = { NOT = { character = ROOT } }
				character_event = { id = bankruptcy.127 }
			}
			society = { save_event_target_as = new_bank_society }
			character_event = { id = bankruptcy.129 days = 50 } #find new members
		}
	}
}
character_event = { #Inform world
	id = bankruptcy.127
	title = "EVTTITLEbankruptcy.127"
	desc = "EVTDESCbankruptcy.127"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.127"
	}
}
character_event = { #Inform new bank of loan given
	id = bankruptcy.128
	desc = "EVTDESCbankruptcy.128"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = { #Round to down to integer for the player
			round_loan_to_integer_effect = yes
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.128"
	}
}
character_event = { #Find new members in months after bank founding
	id = bankruptcy.129

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		event_target:new_bank_society = {
			if = {
				limit = { NOT = { is_society_rank_full = { society = THIS rank = 1 } } }
				persistent_event_target:location = { #Find new members
					kingdom = {
						any_de_jure_vassal = {
							limit = {
								NOT_mythical_creature_trigger = yes
								capital_scope = { kingdom = { title = PREVPREVPREV } }
								has_tribal_or_nomadic_government_trigger = no
							}
							if = {
								limit = {
									is_adult = yes
									is_incapable = no
									prisoner = no
									is_in_society = no
									has_ROOT_bank_society_prerequisites = yes
									ai = yes
									NOT = { has_character_flag = offended_moneylenders }
								}
								character_event = { id = bankruptcy.2298 days = 1 random = 365 }
							}
							any_courtier = {
								limit = {
									is_ruler = no
									OR = {
										stewardship = 10
										prestige = 200
										wealth = 75
									}
									OR = {
										is_female = no
										stewardship = 15
										prestige = 400
										wealth = 125
									}

									is_adult = yes
									is_incapable = no
									prisoner = no
									is_in_society = no
									has_ROOT_bank_society_prerequisites = yes
									ai = yes
									NOT = { has_character_flag = offended_moneylenders }
									NOT_mythical_creature_trigger = yes
								}
								character_event = { id = bankruptcy.2298 days = 1 random = 365 }
							}
						}
					}
				}
			}
		}
	}

	option = {
		name = OK
	}
}

character_event = { #Debtor raided by bank heavies
	id = bankruptcy.130
	desc = EVTDESCbankruptcy.130
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		calculate_loan_repayable_effect = yes
		#Take artifact if poss
		clear_event_target = looted_artifact
		random_artifact = {
			limit = {
				OR = {
					AND = {
						quality == 1
						ROOT = {
							OR = {
								NOT = { has_character_flag = offended_moneylenders }
								NOT = { check_variable = { which = loan_amount value = 50 } }
							}
						}
					}
					AND = {
						quality == 2
						ROOT = {
							has_character_flag = offended_moneylenders
							check_variable = { which = loan_amount value = 50 }
						}
					}
				}
				is_indestructible = no
				NOT = { has_flag = no_usurp_transfer }
				NOT = { has_flag = valyrian_steel }
				NOT = { has_flag = flagship }
			}
			save_event_target_as = looted_artifact
		}
	}

	option = {
		name = EVTOPTbankruptcy.130
		clr_character_flag = loan_default

		hidden_tooltip = { set_variable = { which = success_bonus which = loan_amount } } #envoy gets 5% commission
		#Heavies recover the debt
		if = { #Interest if default
			limit = {
				NOT = { has_character_flag = offended_moneylenders }
			}
			if = {
				limit = { event_target:looted_artifact = { always = yes } }
				tooltip = {
					event_target:looted_artifact = {
						transfer_artifact = { from = ROOT to = FROM }
					}
				}
			}
			else = {
				wealth = loan_interest_payable_negative
			}
			hidden_tooltip = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_interest_payable }
						set_variable = { which = loan_profits which = loan_interest_payable }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
				remove_character_modifier = loan_timer
				add_character_modifier = {
					name = "loan_timer"
					duration = 730
				}
				set_variable = { which = cash_reserve value = 0 }
				set_variable = { which = loan_profits value = 0 }
			}
		}
		else = {  #Full amount if full refusal
			if = {
				limit = { event_target:looted_artifact = { always = yes } }
				tooltip = {
					event_target:looted_artifact = {
						transfer_artifact = { from = ROOT to = FROM }
					}
				}
			}
			else = {
				wealth = loan_total_repayable_negative
			}
			hidden_tooltip = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_total_repayable }
						set_variable = { which = loan_losses which = loan_amount }
						multiply_variable = { which = loan_losses value = -1 }
						set_variable = { which = loan_profits which = loan_amount }
						multiply_variable = { which = loan_profits which = loan_interest }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_losses which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
				clear_loan_flags_and_variables_effect = yes
			}
		}
		tiered_prestige_negative_effect = yes
		FROM = { character_event = { id = bankruptcy.131 } }
	}
}
character_event = { #Inform envoy heavy success
	id = bankruptcy.131
	desc = EVTDESCbankruptcy.131
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = {
			#envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
	}

	option = {
		name = EVTOPTAbankruptcy.131
		FROM = {
			event_target:looted_artifact = {
				destroy_artifact = yes
			}
		}
	}
	option = { #Buy the seized artifact
		name = EVTOPTBbankruptcy.131
		trigger = {
			event_target:looted_artifact = { always = yes }
			OR = {
				AND = {
					wealth = 40
					event_target:looted_artifact = { quality == 2 }
				}
				AND = {
					wealth = 20
					event_target:looted_artifact = { quality == 1 }
				}
			}
		}
		event_target:looted_artifact = {
			transfer_artifact = { from = FROM to = ROOT }
			if = {
				limit = { quality == 2 }
				ROOT = { wealth = -80 }
			}
			if = {
				limit = { quality == 1 }
				ROOT = { wealth = -40 }
			}
		}
	}

	after = {
		FROM = { opinion = { who = ROOT modifier = opinion_sent_bank_heavies months = 60 } }
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			add_mission_succeed_influence_effect = yes
		}
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }

			FROM = {
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #Debtor repels bank heavies
	id = bankruptcy.132
	desc = EVTDESCbankruptcy.132
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTbankruptcy.132
		hidden_tooltip = {
			FROM = {
				character_event = { id = bankruptcy.133 }
			}
		}
	}
}
character_event = { #Inform envoy heavy fail
	id = bankruptcy.133
	desc = EVTDESCbankruptcy.133
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.133
		FROM = { opinion = { who = ROOT modifier = opinion_sent_bank_heavies months = 60 } }
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			character_event = { id = bankruptcy.48 days = 7 }
		}
		else = {
			FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
		}
	}
}
#MISSIONS

#Mission tombola
character_event = {
    id = bankruptcy.135
    hide_window = yes

    is_triggered_only = yes

	is_in_society = yes

	trigger = {
		society = { has_flag = bank_society }
		has_any_quest = no
		NOT = { has_character_modifier = quest_cooldown_timer }
		NOT = { is_inaccessible_trigger = yes }
	}

    immediate = {
    	#Picks out mission giver
		if = {
			limit = { society_rank == 4 }
			save_event_target_as = bank_collaborator
		}
		else = {
			random_list = {
				1 = { #International society member
					society = {
						random_society_member = {
							limit = {
								NOT = { character = ROOT }
								is_within_diplo_range = ROOT
								opinion = { who = ROOT value = -20 }
								society_rank > 2
							}
							save_event_target_as = bank_collaborator
						}
					}
				}
				100 = { #Realm society member
					trigger = {
						society = {
							any_society_member = {
								NOT = { character = ROOT }
								is_within_diplo_range = ROOT
								opinion = { who = ROOT value = -20 }
								same_realm = ROOT
								society_rank > 2
							}
						}
					}
					society = {
						random_society_member = {
							limit = {
								NOT = { character = ROOT }
								is_within_diplo_range = ROOT
								opinion = { who = ROOT value = -20 }
								same_realm = ROOT
								society_rank > 2
							}
							save_event_target_as = bank_collaborator
						}
					}
				}
			}
		}
		if = {
			limit = { event_target:bank_collaborator = { always = yes } }
			#Randomizes mission
			random_list = {
				1 = {
				}
				50 = { #Work at the bank
					trigger = {
						NOT = { has_character_flag = worked_at_bank }
						society_rank < 3
						OR = {
							is_ruler = no
							NOT = { age = 25 }
						}
						NOT = { can_wear_a_crown_trigger = yes } #monarchs wont stoop to this level
						NAND = { #high rank rulers wont stoop to this level
							is_feudal = yes
							higher_tier_than = COUNT
							NOT = { trait = humble }
						}
						NOT = { liege = { regent = { character = ROOT } } }
						war = no
						in_command = no
					}
					event_target:bank_collaborator = { character_event = { id = bankruptcy.136 } }
				}
				50 = { #Commission bank fortifications
					trigger = {
						society_rank == 4
						is_playable = yes
						society = {
							check_variable = { which = cash_reserve value = 1500 }
							persistent_event_target:location = {
								capital_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
									NOR = {
										has_building = ca_bank_fortifications
										has_building = ct_bank_fortifications
									}
								}
							}
						}
					}
					society_quest_event = { id = bankruptcy.175 }
				}
				# 20 = { #invest bank cash
					# trigger = {
						# society_rank > 2
					# }
					# event_target:bank_collaborator = { character_event = { id =  } }
				# }
			}
		}
    }
}
#MISSION: Work at the bank
#Ping event for mission
character_event = {
	id = bankruptcy.136
	hide_window = yes

	is_triggered_only = yes

	immediate = {
		FROM = { society_quest_event = { id = bankruptcy.137 } }
	}
}
society_quest_event = {
	id = bankruptcy.137
	desc = EVTDESCbankruptcy.137
	quest_target = ROOT

	is_triggered_only = yes

	immediate = {
	}

	option = { #accept
		name = ACCEPT
		add_trait = working_at_bank
		custom_tooltip = {
			text = TOOLTIPbankruptcy.137
		}
		hidden_tooltip = {
			set_quest_target = {
				id = quest_work_at_bank
				holder = ROOT
			}
			#Outcome
			random_list = {
				10 = { #Great success
					modifier = {
						factor = 1.5
						trait = diligent
					}
					modifier = {
						factor = 1.5
						trait = ambitious
					}
					modifier = {
						factor = 1.5
						trait = patient
					}
					modifier = {
						factor = 1.5
						trait = humble
					}
					modifier = {
						factor = 1.5
						trait = administrator
					}
					modifier = {
						factor = 1.5
						trait = architect
					}
					modifier = {
						factor = 1.5
						learning = 8
					}
					modifier = {
						factor = 1.5
						learning = 12
					}
					modifier = {
						factor = 1.5
						learning = 16
					}
					character_event = { id = bankruptcy.138 days = 365 }
				}
				25 = { #Success
					modifier = {
						factor = 1.5
						trait = diligent
					}
					modifier = {
						factor = 1.5
						trait = ambitious
					}
					modifier = {
						factor = 1.5
						trait = patient
					}
					modifier = {
						factor = 1.5
						trait = humble
					}
					modifier = {
						factor = 1.5
						trait = administrator
					}
					modifier = {
						factor = 1.5
						trait = architect
					}
					modifier = {
						factor = 1.5
						learning = 8
					}
					modifier = {
						factor = 1.5
						learning = 12
					}
					modifier = {
						factor = 1.5
						learning = 16
					}
					character_event = { id = bankruptcy.139 days = 365 }
				}
				25 = { #Some success
					modifier = {
						factor = 1.5
						trait = slothful
					}
					modifier = {
						factor = 1.5
						trait = content
					}
					modifier = {
						factor = 1.5
						trait = wroth
					}
					modifier = {
						factor = 1.5
						trait = proud
					}
					modifier = {
						factor = 1.5
						learning < 4
					}
					modifier = {
						factor = 1.5
						learning < 1
					}
					character_event = { id = bankruptcy.140 days = 365 }
				}
				10 = { #Fail
					modifier = {
						factor = 1.5
						trait = slothful
					}
					modifier = {
						factor = 1.5
						trait = content
					}
					modifier = {
						factor = 1.5
						trait = wroth
					}
					modifier = {
						factor = 1.5
						trait = proud
					}
					modifier = {
						factor = 1.5
						learning < 4
					}
					modifier = {
						factor = 1.5
						learning < 1
					}
					character_event = { id = bankruptcy.141 days = 365 }
				}
			}
			#Flavour
			random_list = {
				10 = { #Stressed
					trigger = { NOT = { trait = stressed } }
					modifier = {
						factor = 2
						trait = diligent
					}
					modifier = {
						factor = 0.5
						trait = slothful
					}
					character_event = { id = bankruptcy.142 days = 100 random = 100 }
				}
				10 = { #Make friend
					trigger = {
						society = {
							any_society_member = {
								OR = {
									trait = working_at_bank
									AND = {
										is_ruler = no
										society_rank == 1
									}
								}
								NOT = { character = ROOT }
								war = no
								is_incapable = no
								in_command = no
								prisoner = no
								age = 16
								NOT = { is_friend = ROOT }
								NOT = { is_rival = ROOT }
								opinion = { who = ROOT value = 0 }
								reverse_opinion = { who = ROOT value = 0 }
								NOT = { is_inaccessible_trigger = yes }
							}
						}
					}
					modifier = {
						factor = 2
						trait = patient
					}
					modifier = {
						factor = 0.5
						trait = wroth
					}
					modifier = {
						factor = 2
						trait = humble
					}
					modifier = {
						factor = 0.5
						trait = proud
					}
					modifier = {
						factor = 2
						trait = gregarious
					}
					modifier = {
						factor = 0.5
						trait = shy
					}
					character_event = { id = bankruptcy.143 days = 100 random = 100 }
				}
				10 = { #Make rival
					trigger = {
						society = {
							any_society_member = {
								OR = {
									trait = working_at_bank
									AND = {
										is_ruler = no
										society_rank == 1
									}
								}
								NOT = { character = ROOT }
								war = no
								is_incapable = no
								in_command = no
								prisoner = no
								age = 16
								NOT = { is_friend = ROOT }
								NOT = { is_rival = ROOT }
								NOT = { opinion = { who = ROOT value = -20 } }
								NOT = { reverse_opinion = { who = ROOT value = -20 } }
								NOT = { is_inaccessible_trigger = yes }
							}
						}
					}
					modifier = {
						factor = 0.5
						trait = patient
					}
					modifier = {
						factor = 2
						trait = wroth
					}
					modifier = {
						factor = 0.5
						trait = humble
					}
					modifier = {
						factor = 2
						trait = proud
					}
					character_event = { id = bankruptcy.145 days = 100 random = 100 }
				}
				10 = { #Find lover
					trigger = {
						NOT = { trait = chaste }
						NOT = { trait = celibate }
						NOT = { trait = eunuch }
						is_pregnant = no
						OR = {
							NOT = { age = 40 }
							is_female = no
						}
						OR = {
							trait = lustful
							has_lover = no
						}
					}
					modifier = {
						factor = 2
						has_focus = focus_seduction
					}
					modifier = {
						factor = 2
						trait = lustful
					}
					modifier = {
						factor = 2
						OR = {
							trait = seducer
							trait = seductress
						}
					}
					modifier = {
						factor = 2
						trait = gregarious
					}
					modifier = {
						factor = 0.5
						trait = shy
					}
					character_event = { id = bankruptcy.147 days = 100 random = 100 }
				}
				10 = { #lose coin
					trigger = {
						society = { check_variable = { which = cash_reserve value = 1000 } }
					}
					modifier = {
						factor = 0.5
						trait = diligent
					}
					modifier = {
						factor = 2
						trait = slothful
					}
					modifier = {
						factor = 2
						learning < 4
					}
					modifier = {
						factor = 0.5
						learning = 10
					}
					character_event = { id = bankruptcy.148 days = 100 random = 100 }
				}
				10 = { #bonus
					trigger = {
						society = { check_variable = { which = cash_reserve value = 1000 } }
					}
					modifier = {
						factor = 2
						trait = diligent
					}
					modifier = {
						factor = 0.5
						trait = slothful
					}
					modifier = {
						factor = 0.5
						learning < 4
					}
					modifier = {
						factor = 2
						learning = 10
					}
					character_event = { id = bankruptcy.149 days = 100 random = 100 }
				}
				5 = { #No event
				}
			}
		}
	}
	option = { #nah thx
		name = DECLINE
		custom_tooltip = { text = decline_quest_tooltip }

		hidden_tooltip = {
			add_character_modifier = {
				name = quest_cooldown_timer
				hidden = yes
				days = 1000
			}
		}
		ai_chance = { factor = 0 }
	}
}
character_event = { #Great success
	id = bankruptcy.138
	desc = EVTDESCbankruptcy.138
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
	}

	fail_trigger_effect = {
		remove_trait = working_at_bank
		clr_quest = quest_work_at_bank
	}

	option = {
		name = EVTOPTAbankruptcy.138
		remove_trait = working_at_bank
		add_society_currency_major_effect = yes
		#Promote 2 stewardship education levels
		if = {
			limit = { trait = indulgent_wastrel }
			add_trait = fortune_builder
			hidden_tooltip = { remove_trait = indulgent_wastrel }
		}
		else_if = {
			limit = { trait = thrifty_clerk }
			add_trait = midas_touched
			hidden_tooltip = { remove_trait = thrifty_clerk }
		}
		else_if = {
			limit = { trait = fortune_builder }
			add_trait = midas_touched
			change_stewardship = 1
			hidden_tooltip = { remove_trait = fortune_builder }
		}
		else = {
			change_stewardship = 3
		}
		hidden_tooltip = {
			set_character_flag =  worked_at_bank
			clr_quest = quest_work_at_bank
		}
	}
}
character_event = { #Success
	id = bankruptcy.139
	desc = EVTDESCbankruptcy.139
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
	}

	fail_trigger_effect = {
		remove_trait = working_at_bank
		clr_quest = quest_work_at_bank
	}

	option = {
		name = EVTOPTAbankruptcy.139
		remove_trait = working_at_bank
		add_society_currency_medium_effect = yes
		#Promote 1 stewardship education levels
		if = {
			limit = { trait = indulgent_wastrel }
			add_trait = thrifty_clerk
			hidden_tooltip = { remove_trait = indulgent_wastrel }
		}
		else_if = {
			limit = { trait = thrifty_clerk }
			add_trait = fortune_builder
			hidden_tooltip = { remove_trait = thrifty_clerk }
		}
		else_if = {
			limit = { trait = fortune_builder }
			add_trait = midas_touched
			hidden_tooltip = { remove_trait = fortune_builder }
		}
		else = {
			change_stewardship = 2
		}
		hidden_tooltip = {
			set_character_flag =  worked_at_bank
			clr_quest = quest_work_at_bank
		}
	}
}
character_event = { #Some Success
	id = bankruptcy.140
	desc = EVTDESCbankruptcy.140
	picture = GFX_evt_stressed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
	}

	fail_trigger_effect = {
		remove_trait = working_at_bank
		clr_quest = quest_work_at_bank
	}

	option = {
		name = EVTOPTAbankruptcy.140
		remove_trait = working_at_bank
		add_society_currency_minor_effect = yes
		change_stewardship = 1
		hidden_tooltip = {
			set_character_flag =  worked_at_bank
			clr_quest = quest_work_at_bank
		}
	}
}
character_event = { #Fail
	id = bankruptcy.141
	desc = EVTDESCbankruptcy.141
	picture = GFX_evt_stressed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
	}

	fail_trigger_effect = {
		remove_trait = working_at_bank
		clr_quest = quest_work_at_bank
	}

	option = {
		name = EVTOPTAbankruptcy.141
		remove_trait = working_at_bank
		detract_society_currency_minor_effect = yes
		hidden_tooltip = {
			set_character_flag =  worked_at_bank
			clr_quest = { id = quest_work_at_bank failure = yes }
		}
	}
}
character_event = { #Stressed
	id = bankruptcy.142
	desc = EVTDESCbankruptcy.142
	picture = GFX_evt_stressed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
		NOT = { trait = stressed }
	}

	option = {
		name = EVTOPTAbankruptcy.142
		add_trait = stressed
	}
}
character_event = { #Make friend
	id = bankruptcy.143
	desc = EVTDESCbankruptcy.143
	picture = GFX_evt_courtiers_talking
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
		society = {
			any_society_member = {
				OR = {
					trait = working_at_bank
					AND = {
						is_ruler = no
						society_rank == 1
					}
				}
				NOT = { character = ROOT }
				war = no
				is_incapable = no
				in_command = no
				prisoner = no
				age = 16
				NOT = { is_friend = ROOT }
				NOT = { is_rival = ROOT }
				opinion = { who = ROOT value = 0 }
				reverse_opinion = { who = ROOT value = 0 }
				NOT = { is_inaccessible_trigger = yes }
			}
		}
	}

	immediate = {
		society = {
			random_society_member = {
				limit = {
					OR = {
						trait = working_at_bank
						AND = {
							is_ruler = no
							society_rank == 1
						}
					}
					NOT = { character = ROOT }
					war = no
					is_incapable = no
					in_command = no
					prisoner = no
					age = 16
					NOT = { is_friend = ROOT }
					NOT = { is_rival = ROOT }
					opinion = { who = ROOT value = 0 }
					reverse_opinion = { who = ROOT value = 0 }
					NOT = { is_inaccessible_trigger = yes }
				}
				save_event_target_as = bank_friend
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.143
		event_target:bank_friend = {
			add_friend  = ROOT
			character_event = { id = bankruptcy.144 }
		}
	}
}
character_event = { #Inform second
	id = bankruptcy.144
	desc = EVTDESCbankruptcy.144
	picture = GFX_evt_courtiers_talking
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.144
		add_friend  = FROM
	}
}
character_event = { #Make rival
	id = bankruptcy.145
	desc = EVTDESCbankruptcy.145
	picture = GFX_evt_courtiers_talking
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
		society = {
			any_society_member = {
				OR = {
					trait = working_at_bank
					AND = {
						is_ruler = no
						society_rank == 1
					}
				}
				NOT = { character = ROOT }
				war = no
				is_incapable = no
				in_command = no
				prisoner = no
				age = 16
				NOT = { is_friend = ROOT }
				NOT = { is_rival = ROOT }
				NOT = { opinion = { who = ROOT value = -20 } }
				NOT = { reverse_opinion = { who = ROOT value = -20 } }
				NOT = { is_inaccessible_trigger = yes }
			}
		}
	}

	immediate = {
		society = {
			random_society_member = {
				limit = {
					OR = {
						trait = working_at_bank
						AND = {
							is_ruler = no
							society_rank == 1
						}
					}
					NOT = { character = ROOT }
					war = no
					is_incapable = no
					in_command = no
					prisoner = no
					age = 16
					NOT = { is_friend = ROOT }
					NOT = { is_rival = ROOT }
					NOT = { opinion = { who = ROOT value = -20 } }
					NOT = { reverse_opinion = { who = ROOT value = -20 } }
					NOT = { is_inaccessible_trigger = yes }
				}
				save_event_target_as = bank_rival
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.145
		event_target:bank_rival = {
			add_rival = ROOT
			character_event = { id = bankruptcy.146 }
		}
	}
}
character_event = { #Inform second
	id = bankruptcy.146
	desc = EVTDESCbankruptcy.146
	picture = GFX_evt_courtiers_talking
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.146
		add_rival = FROM
	}
}
character_event = { #Find lover
	id = bankruptcy.147
	desc = EVTDESCbankruptcy.147
	picture = GFX_evt_lovers
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
		NOT = { trait = chaste }
		NOT = { trait = celibate }
		NOT = { trait = eunuch }
		is_pregnant = no
		OR = {
			NOT = { age = 40 }
			is_female = no
		}
		OR = {
			trait = lustful
			has_lover = no
		}
	}

	immediate = {
		society = {
			persistent_event_target:location = {
				ROOT = {
					if = {
						limit = { prefers_men_trigger = yes }
						create_random_steward = {
							random_traits = yes
							dynasty = none
							female = no
							culture = PREV
							religion = PREV
						}
					}
					else = {
						create_random_steward = {
							random_traits = yes
							dynasty = none
							female = yes
							culture = PREV
							religion = PREV
						}
					}
					new_character = {
						save_event_target_as = bank_lover
						join_society = PREVPREVPREV
						if = {
							limit = { ROOT = { is_ruler = no } }
							ROOT = { liege = { reverse_banish = PREVPREV } }
						}
						if = {
							limit = { same_sex = ROOT }
							add_trait = homosexual
						}
						random = {
							chance = 25
							add_trait = fair
							remove_trait = ugly
							remove_trait = ugly_1
							remove_trait = ugly_2
						}
						remove_trait = slow
						remove_trait = slow_1
						remove_trait = imbecile
						remove_trait = imbecile_1
						remove_trait = dull

						remove_lifestyle_trait_effect = yes

						random_list = { # Flavor Randomization
							35 = {
								# Nothing
							}
							15 = {
								change_stewardship = 2
							}
							10 = {
								add_trait = architect
							}
							10 = {
								add_trait = administrator
							}
							10 = {
								change_stewardship = 4
							}
							5 = {
								change_stewardship = 6
							}
							5 = {
								trigger = {
									is_smart_incl_genius_trigger = no
								}
								add_trait = shrewd
							}
						}
						if = {
							limit = {
								culture_group = hyrkoon_group
							}
							add_trait = eunuch
						}
						while = {
							limit = { stewardship < 8 }
							change_stewardship = 1
						}
					}
				}
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.147
		event_target:bank_lover = {
			add_lover = ROOT
		}
	}
	option = {
		name = EVTOPTBbankruptcy.147
		trigger = { ai = no }
		hidden_tooltip = {
			event_target:bank_lover = {
				death = { death_reason = death_missing }
			}
		}
	}
}
character_event = { #Lose coin
	id = bankruptcy.148
	desc = EVTDESCbankruptcy.148
	picture = GFX_evt_bad_news
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
	}

	option = {
		name = EVTOPTAbankruptcy.148
		detract_society_currency_tiny_effect = yes
		society = {
			change_variable = { which = cash_reserve value = -25 }
			hidden_tooltip = {
				change_variable = { which = lost_coin value = -25 }
			}
		}
	}
}
character_event = { #Earn bonus
	id = bankruptcy.149
	desc = EVTDESCbankruptcy.149
	picture = GFX_evt_relaxed_ruler
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	prisoner = no
	only_capable = yes

	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_work_at_bank
	}

	option = {
		name = EVTOPTAbankruptcy.149
		wealth = 25
		add_society_currency_tiny_effect = yes
		society = {
			change_variable = { which = cash_reserve value = -25 }
			hidden_tooltip = {
				change_variable = { which = expenses value = -25 }
			}
		}
	}
}
#Ruler attacking debtor of rival rank offered cheap bank loan
letter_event = { #Proposal sent
	id = bankruptcy.160
	desc = "EVTDESCbankruptcy.160"
	border = GFX_event_letter_frame_diplomacy

	is_triggered_only = yes
	show_from_from = yes

	only_independent = yes
	war = yes

	trigger = {
		FROMFROM = {
			is_alive = yes
			society = { has_flag = bank_society }
			NOT = { war_with = ROOT }
		}
		NOT = { has_character_flag = loan_taken }
		NOT = { has_character_flag = offended_moneylenders }
		NOT = { has_character_flag = has_had_loan_default }
		NOT = { has_character_flag = personal_loan_default }
		NOT = { society = { has_flag = bank_society } }
		FROMFROMFROM = {
			independent = yes
			war_with = ROOT
			#any_current_enemy = { character = ROOT }

			has_character_flag = loan_taken
			NOT = { has_character_flag = offended_moneylenders }
			persistent_event_target:loan_bank = {
				ROOT_FROMFROM = { NOT = { society_member_of = PREV } }
			}
		}
	}

	immediate = {
		FROMFROMFROM = { save_event_target_as = loan_enemy_target }
		#Find loan amount
		export_to_variable = { which = loan_amount value = yearly_income who = ROOT }
		multiply_variable = { which = loan_amount value = 2 }
		#Round to down to integer for the player
		if = {
			limit = {
				OR = {
					ai = no
					FROMFROM = { ai = no }
				}
			}
			round_loan_to_integer_effect = yes
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.160" #Yes
		show_portrait = event_target:loan_enemy_target
		wealth = loan_amount
		clr_character_flag = loan_bank_minor
		hidden_tooltip = {
			clr_character_flag = loan_taken
			set_character_flag = loan_taken
			remove_character_modifier = loan_timer
			add_character_modifier = {
				name = "loan_timer"
				duration = 1825
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.160B
			FROMFROM = {
				society = {
					ROOT = { save_persistent_event_target = { name = loan_bank scope = PREV } }
					#Adjust banks records
					set_variable = { which = loan_amount which = ROOT }

					change_variable = { which = outstanding_loans which = loan_amount } #add loan to outstanding total

					multiply_variable = { which = loan_amount value = -1 }	#Then subtract from cash reserve
					change_variable = { which = cash_reserve which = loan_amount }

					set_variable = { which = loan_amount value = 0 } #clear variable
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.1_INTEREST_10
			set_variable = { which = loan_interest value = 0.1 }
		}
		FROMFROM = {
			hidden_tooltip = {
				letter_event = { id = bankruptcy.161 }
			}
		}
		event_target:loan_enemy_target = {
			hidden_tooltip = {
				character_event = { id = bankruptcy.163 }
				persistent_event_target:loan_bank = {
					any_society_member = {
						limit = {
							ai = no
							society_rank > 1
						}
						character_event = { id = bankruptcy.164 }
					}
				}
			}
		}
		hidden_tooltip = {
			if = { #this is calculated for the player so they can repay instantly
				limit = {
					ai = no
				}
				calculate_loan_repayable_effect = yes
			}
		}
	}

	option = {
		name = "EVTOPTBbankruptcy.160" #No
		trigger = { ai = no } #logic already applied in decision
		FROMFROM = {
			hidden_tooltip = { letter_event = { id = bankruptcy.162 } }
		}
		hidden_tooltip = {
			set_variable = { which = loan_amount value = 0 }
		}
	}
}
letter_event = { #Accepted
	id = bankruptcy.161
	desc = "EVTDESCbankruptcy.161"
	border = GFX_event_letter_frame_diplomacy

	is_triggered_only = yes

	option = {
		name = OK
		clr_character_flag = offer_cheap_loan
		detract_society_currency_medium_effect = yes
		show_portrait = event_target:loan_enemy_target
	}
}
letter_event = { #Rejected
	id = bankruptcy.162
	desc = "EVTDESCbankruptcy.162"
	border = GFX_event_letter_frame_diplomacy

	is_triggered_only = yes

	option = {
		name = OK
		clr_character_flag = offer_cheap_loan
		show_portrait = event_target:loan_enemy_target
	}
}
character_event = { #Inform Target
	id = bankruptcy.163
	desc = "EVTDESCbankruptcy.163"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.163"
		show_portrait = FROMFROMFROM
	}
}
character_event = { #Inform Target bank
	id = bankruptcy.164
	desc = "EVTDESCbankruptcy.164"
	border = GFX_event_normal_frame_war

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.164"
		show_portrait = event_target:loan_enemy_target
		show_portrait = FROMFROMFROM
	}
}
###Loot bank after siege of province###
character_event = {
	id = bankruptcy.170
	desc = "EVTDESCbankruptcy.170"
	border = GFX_event_normal_frame_war
	picture = GFX_bank

	is_triggered_only = yes

	trigger = {
		FROM = {
			is_capital = yes
			location = {
				has_province_flag = location_has_bank
				NOT = { has_province_modifier = bank_looted }
				any_society_member = {
					society = {
						persistent_event_target:location = { province_id = PREVPREVPREV }
						check_variable = { which = cash_reserve value = 150 }
						ROOT = { NOT = { society_member_of = PREV } }
					}
				}
				owner = {
					war_with = ROOT
					NOR = {
						character = ROOT
						same_realm = ROOT
						is_allied_with = ROOT
					}
				}
			}
		}
		#Has not taken a loan/stolen from a different bank
		NAND = {
			OR = {
				has_character_flag = loan_taken
				has_character_flag = offended_moneylenders
			}
			OR = {
				persistent_event_target:loan_bank = {
					persistent_event_target:location = {
						FROM = {
							location = {
								NOT = { province_id = PREVPREV }
							}
						}
					}
				}
				has_character_flag = loan_bank_minor
			}
			check_variable = { which = loan_amount value = 1 }
		}
	}

	immediate = {
		FROM = {
			location = {
				random_society_member = {
					limit = {
						society = {
							persistent_event_target:location = { province_id = PREVPREVPREV }
							check_variable = { which = cash_reserve value = 150 }
							ROOT = { NOT = { society_member_of = PREV } }
						}
					}
					society = {
						save_event_target_as = looted_bank

						#Take 33% of cash reserve (max 600)
						set_variable = { which = looted_cash_local which = cash_reserve }
						divide_variable = { which = looted_cash_local value = 3 }
						random_list = { #randomise amount
							1 = { multiply_variable = { which = looted_cash_local value = 1.75 } }
							1 = { multiply_variable = { which = looted_cash_local value = 1.5 } }
							1 = { multiply_variable = { which = looted_cash_local value = 1.25 } }
							1 = {  }
							1 = { multiply_variable = { which = looted_cash_local value = 0.8 } }
							1 = { multiply_variable = { which = looted_cash_local value = 0.66 } }
							1 = { multiply_variable = { which = looted_cash_local value = 0.57 } }
						}
						if = {
							limit = { check_variable = { which = looted_cash_local value = 600 } }
							set_variable = { which = looted_cash_local value = 600 }
						}
						ROOT = { set_variable = { which = looted_cash_local which = PREV } }
						multiply_variable = { which = looted_cash_local value = -1 }
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.170"
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0
				OR = {
					trait = just
					trait = honorable
					trait = honest
				}
			}
			modifier = {
				factor = 0
				has_character_flag = loan_taken
				NOR = {
					trait = wroth
					trait = arbitrary
					trait = greedy
					trait = selfish
					trait = lunatic
					trait = possessed
				}
			}
			modifier = {
				factor = 3
				is_allowed_to_loot = yes
			}
			modifier = {
				factor = 0.33
				has_character_flag = loan_taken
			}
			modifier = {
				factor = 0.5
				event_target:looted_bank = { society_influence = 3 }
			}
			modifier = {
				factor = 0.5
				event_target:looted_bank = { society_influence = 5 }
			}
			modifier = {
				factor = 3
				trait = zealous
				is_allowed_to_loot = yes
			}
			modifier = {
				factor = 3
				trait = ambitious
			}
			modifier = {
				factor = 3
				trait = greedy
			}
			modifier = {
				factor = 3
				trait = arbitrary
			}
			modifier = {
				factor = 3
				trait = ruthless
			}
			modifier = {
				factor = 3
				trait = deceitful
			}
			modifier = {
				factor = 0.33
				trait = content
			}
			modifier = {
				factor = 0.33
				trait = craven
			}
			modifier = {
				factor = 0.33
				trait = charitable
			}
		}
		wealth = looted_cash_local
		FROM = {
			location = {
				add_province_modifier = {
					name = bank_looted
					duration = 2555
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.170
			#Banks will not lend money. Target bank will pursue
			set_character_flag = offended_moneylenders
			set_character_flag = looted_bank
			change_variable = { which = loan_amount which = looted_cash_local }
			save_persistent_event_target = { name = loan_bank scope = event_target:looted_bank }
			set_variable = { which = loan_interest value = 0.45 }

			clr_character_flag = loan_taken
			remove_character_modifier = loan_timer
			character_event = { id = bankruptcy.45 days = 5 } #consequences
		}
		hidden_tooltip = {
			event_target:looted_bank = {
				change_variable = { which = cash_reserve which = looted_cash_local }
				change_variable = { which = looted_cash which = looted_cash_local }
				random_society_member = {
					limit = { is_society_grandmaster = yes }
					add_society_modifier = { modifier = bank_looted_b years = 7 }
				}
				any_society_member = {
					limit = { ai = no }
					character_event = { id = bankruptcy.171 }
				}
			}
			set_variable = { which = looted_cash_local value = 0 }
		}
	}
	option = {
		name = "EVTOPTBbankruptcy.170" #No
	}
}
character_event = { #Inform members
	id = bankruptcy.171
	desc = "EVTDESCbankruptcy.171"
	border = GFX_event_normal_frame_war
	picture = GFX_bank

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.171"
		tooltip = {
			event_target:looted_bank = {
				change_variable = { which = cash_reserve which = looted_cash_local }
			}
			add_society_modifier = { modifier = bank_looted_b years = 7 }
		}
	}
}
#Build bank fortifications
society_quest_event = { #Delegated mission
	id = bankruptcy.175
	desc = EVTDESCbankruptcy.175
	quest_target = event_target:bank_holding

	is_triggered_only = yes

	immediate = {
		society = {
			persistent_event_target:location = {
				save_event_target_as = bank_holding
			}
		}
	}

	option = { #accept
		name = ACCEPT
		custom_tooltip = {
			text = TOOLTIPbankruptcy.175
		}
		hidden_tooltip = {
			event_target:bank_holding = {
				set_quest_target = {
					id = quest_bank_build_fortification
					holder = ROOT
				}
			}
		}
	}
	option = { #nah thx
		name = DECLINE
		custom_tooltip = { text = decline_quest_tooltip }

		hidden_tooltip = {
			add_character_modifier = {
				name = quest_cooldown_timer
				hidden = yes
				days = 1825
			}
		}
		ai_chance = { factor = 0 }
	}
}
character_event = { #Project started
	id = bankruptcy.176
	desc = EVTDESCbankruptcy.176
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		quest_target = { save_event_target_as = bank_capital }
	}

	option = {
		name = EVTOPTAbankruptcy.176
		add_trait = working_at_bank
		hidden_tooltip = {
			society = {
				persistent_event_target:location = {
					province_event = { id = bankruptcy.177 days = 180 random = 180 }
				}
			}
		}
	}
}
province_event = { #Project finished
	id = bankruptcy.177

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		has_province_flag = location_has_bank
	}

	fail_trigger_effect = {
		FROM = {
			remove_trait = working_at_bank
			clr_quest = quest_bank_build_fortification
		}
	}

	immediate = {
		capital_holding = {
			if = {
				limit = { holding_type = castle }
				add_building = ca_bank_fortifications
			}
			if = {
				limit = { holding_type = city }
				add_building = ct_bank_fortifications
			}
		}
		FROM = { character_event = { id = bankruptcy.178 } }
	}

	option = {
		name = OK
	}
}
character_event = { #Project finished
	id = bankruptcy.178
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	desc = {
		text = EVTDESCbankruptcy.178
		trigger = { event_target:bank_capital = { port = no } }
	}
	desc = {
		text = EVTDESCbankruptcy.178B
		trigger = { event_target:bank_capital = { port = yes } }
	}
	trigger = {
		society = { has_flag = bank_society }
		has_quest = quest_bank_build_fortification
	}

	immediate = {
		quest_target = { save_event_target_as = bank_capital }
	}

	fail_trigger_effect = {
		remove_trait = working_at_bank
		clr_quest = quest_bank_build_fortification
	}

	option = {
		name = EVTOPTAbankruptcy.178
		tooltip = {
			FROM = {
				capital_holding = {
					if = {
						limit = { holding_type = castle }
						add_building = ca_bank_fortifications
					}
					if = {
						limit = { holding_type = city }
						add_building = ct_bank_fortifications
					}
				}
			}
		}
		remove_trait = working_at_bank
		add_society_currency_major_effect = yes
		hidden_tooltip = { clr_quest = quest_bank_build_fortification }
	}
}
#Bank location is usurped, new holder acquires shares
character_event = {
	id = bankruptcy.185
	desc = "EVTDESCbankruptcy.185"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	trigger = {
		FROM = {
			tier = COUNT
			location = {
				has_province_flag = location_has_bank
				any_society_member = {
					society = {
						persistent_event_target:location = { province_id = PREVPREVPREV }
						ROOT = { NOT = { society_member_of = PREV } }
					}
				}
			}
		}
	}

	immediate = {
		FROM = {
			location = {
				random_society_member = {
					limit = {
						society = {
							persistent_event_target:location = { province_id = PREVPREVPREV }
							ROOT = { NOT = { society_member_of = PREV } }
						}
					}
					society = {
						save_event_target_as = target_bank
						####Bank loses 25% of cash in chaos of handover###
						if = {
							limit = { check_variable = { which = cash_reserve value = 0 } }
							set_variable = { which = cash_loss which = cash_reserve }
							multiply_variable = { which = cash_loss value = -0.25 }
							change_variable = { which = cash_reserve which = cash_loss }
							change_variable = { which = expenses which = cash_loss }
							set_variable = { which = cash_loss value = 0 }
						}

						####Find value of shares before ROOT's takeover###
						#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
						set_variable = { which = shares value = 0 }
						any_society_member = {
							limit = {
								society_rank > 2
								NOT = { character = ROOT }
							}
							society = { change_variable = { which = shares value = 5 } }
						}
						any_society_member = {
							limit = {
								society_rank == 2
								NOT = { character = ROOT }
							}
							society = { change_variable = { which = shares value = 1 } }
						}

						#Determine bank value
						set_variable = { which = bank_value which = cash_reserve }
						change_variable = { which = bank_value which = outstanding_loans }

						#Value per share
						divide_variable = { which = bank_value which = shares }
						if = {
							limit = { NOT = { check_variable = { which = bank_value value = 0 } } }
							set_variable = { which = bank_value value = 0 }
						}
						multiply_variable = { which = bank_value value = 0.3 } #exiles only take 30% the value of their shares

						###Remove all now invalid members###
						any_society_member = {
							limit = {
								NOR = { #Is no longer located in bank location
									AND = {
										is_ruler = yes
										capital_scope = {
											kingdom = {
												event_target:target_bank = {
													persistent_event_target:location = {
														kingdom = { title = PREVPREVPREV }
													}
												}
											}
										}
									}
									AND = {
										is_ruler = no
										liege = {
											capital_scope = {
												kingdom = {
													event_target:target_bank = {
														persistent_event_target:location = {
															kingdom = { title = PREVPREVPREV }
														}
													}
												}
											}
										}
									}
								}
							}
							if = { #Take portion of share value
								limit = { society_rank > 1 }
								set_variable = { which = bank_value which = PREV }
								if = {
									limit = { society_rank > 2 }
									multiply_variable = { which = bank_value value = 5 }
								}
								set_variable = { which = cash_reserve which = bank_value }
								if = { #Make sure enough cash is in reserve
									limit = { society = { check_variable = { which = cash_reserve which = PREV } } }
									multiply_variable = { which = cash_reserve value = -1 }
									set_variable = { which = expenses which = cash_reserve }
									society = {
										change_variable = { which = cash_reserve which = PREV }
										change_variable = { which = expenses which = PREV }
									}
								}
								set_variable = { which = cash_reserve value = 0 }
								set_variable = { which = expenses value = 0 }
								opinion = { who = ROOT modifier = opinion_seized_bank months = 240 }
								character_event = { id = bankruptcy.186 }
							}
							set_variable = { which = shares value = 0 }
							leave_society = yes
						}

						###Find ROOT's value of new shares###
						#Count number of shares (Rank 2 has 1, Ranks 3+ have 5)
						set_variable = { which = shares value = 5 } #ROOT's new shares
						any_society_member = {
							limit = {
								society_rank > 2
								NOT = { character = ROOT }
							}
							society = { change_variable = { which = shares value = 5 } }
						}
						any_society_member = {
							limit = {
								society_rank == 2
								NOT = { character = ROOT }
							}
							society = { change_variable = { which = shares value = 1 } }
						}

						#Determine bank value
						set_variable = { which = bank_value which = cash_reserve }
						change_variable = { which = bank_value which = outstanding_loans }

						#Value per share
						divide_variable = { which = bank_value which = shares }
						if = {
							limit = { NOT = { check_variable = { which = bank_value value = 0 } } }
							set_variable = { which = bank_value value = 0 }
						}

						#Value of ROOT's shares
						ROOT = {
							set_variable = { which = bank_value which = PREV }
							multiply_variable = { which = bank_value value = 5 }
						}

						set_variable = { which = bank_value which = ROOT }
						if = { #Make sure enough cash is in reserve. if not ROOT gets remaining cash reserve
							limit = { NOT = { check_variable = { which = cash_reserve which = bank_value } } }
							set_variable = { which = bank_value which = cash_reserve }
							ROOT = { set_variable = { which = bank_value which = PREV } }
						}
						multiply_variable = { which = bank_value value = -1 }
					}
				}
			}
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.185"	#Acquire shares
		trigger = { is_in_society = no }
		join_society = event_target:target_bank
		set_variable = { which = shares value = 5 }
		hidden_tooltip = { society_rank_up = 3 }
		clr_character_flag = has_been_bank_shareholder
	}
	option = {
		name = "EVTOPTBbankruptcy.185"	#Take cash share
		ai_chance = {
			factor = 0
		}
		wealth = bank_value
		hidden_tooltip = {
			event_target:target_bank = {
				change_variable = { which = cash_reserve which = bank_value }
				change_variable = { which = expenses which = bank_value }
			}
		}
	}

	after = {
		hidden_tooltip = { #Find grandmaster
			set_variable = { which = bank_value value = 0 }
			event_target:target_bank = {
				set_variable = { which = bank_value value = 0 }
				if = { #If the new grandmaster is NOT a shareholder, promote all members
					limit = {
						any_society_member = {
							is_society_grandmaster = yes
							NOT = { check_variable = { which = shares value = 1 } }
						}
					}
					any_society_member = {
						limit = {
							society_rank == 2
							is_adult = yes
							is_incapable = no
							prisoner = no
						}
						society_rank_up = 1
						set_variable = { which = shares value = 5 }
					}
					any_society_member = {
						limit = {
							society_rank == 1
							is_adult = yes
							is_incapable = no
							prisoner = no
						}
						society_rank_up = 1
						set_variable = { which = shares value = 1 }
					}
				}
				random_society_member = {
					limit = {
						is_society_grandmaster = yes
					}
					set_variable = { which = shares value = 5 }
				}
				any_society_member = {
					limit = {
						ai = no
						NOT = { character = ROOT }
					}
					character_event = { id = bankruptcy.187 days = 1 }
				}
			}
		}
	}
}
character_event = { #inform lost members
	id = bankruptcy.186
	desc = "EVTDESCbankruptcy.186"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.186"
		wealth = bank_value
		tooltip = { leave_society = yes }
		hidden_tooltip = { set_variable = { which = bank_value value = 0 } }
	}
}
character_event = { #inform other members
	id = bankruptcy.187
	desc = "EVTDESCbankruptcy.187"
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = "EVTOPTAbankruptcy.187"
	}
}
##Non-heir child demands shares
character_event = {
	id = bankruptcy.200
	desc = "EVTDESCbankruptcy.200"
	picture = GFX_evt_son_asking_father
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes
	only_playable = yes
	is_in_society = yes

	portrait = event_target:demanding_bank_shares

	trigger = {
		society_rank == 4
		society = { has_flag = bank_society }
		NOT = { has_character_flag = split_bank_shares_on_inheritance }
		any_close_relative = {
			is_alive = yes
			NOT = { ROOT = { current_heir = { character = PREVPREV } } }
			NOT = { ROOT = { family_palace = { current_heir = { character = PREVPREVPREV } } } }
			same_society_as = ROOT
			society_rank == 1
			NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_refused_bank_share_split } }

			dynasty = ROOT
			OR = {
				is_child_of = ROOT
				sibling = ROOT
			}
			OR = {
				is_female = no
				liege = {
					primary_title = {
						OR = {
							has_law = enatic_cognatic_succession
							has_law = enatic_succession
							has_law = true_cognatic_succession
						}
					}
				}
			}
			OR = {
				is_female = yes
				liege = {
					primary_title = {
						OR = {
							has_law = cognatic_succession
							has_law = agnatic_succession
							has_law = true_cognatic_succession
						}
					}
				}
			}
			ai = yes
			is_adult = yes
			is_incapable = no
			prisoner = no
			OR = {
				trait = ambitious
				trait = greedy
				trait = proud
				trait = envious
				trait = selfish
			}
			NOT = { trait = content }
		}
		OR = {
			is_patrician = yes
			current_heir = {
				OR = {
					dynasty = ROOT
					is_close_relative = ROOT
				}
			}
		}
		OR = {
			society = { #sole shareholder
				NOT = {
					any_society_member = {
						society_rank > 2
						NOT = { character = ROOT }
					}
				}
			}
			has_society_currency_medium_trigger = yes
		}
	}

	immediate = {
		random_close_relative = {
			limit = {
				is_alive = yes
				NOT = { ROOT = { current_heir = { character = PREVPREV } } }
				NOT = { ROOT = { family_palace = { current_heir = { character = PREVPREVPREV } } } }
				same_society_as = ROOT
				society_rank == 1
				NOT = { has_opinion_modifier = { who = ROOT modifier = opinion_refused_bank_share_split } }

				dynasty = ROOT
				OR = {
					is_child_of = ROOT
					sibling = ROOT
				}
				OR = {
					is_female = no
					liege = {
						primary_title = {
							OR = {
								has_law = enatic_cognatic_succession
								has_law = enatic_succession
								has_law = true_cognatic_succession
							}
						}
					}
				}
				OR = {
					is_female = yes
					liege = {
						primary_title = {
							OR = {
								has_law = cognatic_succession
								has_law = agnatic_succession
								has_law = true_cognatic_succession
							}
						}
					}
				}
				ai = yes
				is_adult = yes
				is_incapable = no
				prisoner = no
				OR = {
					trait = ambitious
					trait = greedy
					trait = proud
					trait = envious
					trait = selfish
				}
				NOT = { trait = content }
			}
			save_event_target_as = demanding_bank_shares
		}
		if = {
			limit = { is_patrician = yes }
			family_palace = { current_heir = { save_event_target_as = current_bank_share_heir } }
		}
		else = {
			current_heir = { save_event_target_as = current_bank_share_heir }
		}
	}

	option = {
		name = "EVTOPTAbankruptcy.200" #OK
		custom_tooltip = {
			text = TOOLTIPbankruptcy.200
			set_character_flag = split_bank_shares_on_inheritance
			any_dynasty_member = {
				limit = {
					NOT = { character = ROOT }
					is_close_relative = ROOT
					is_alive = yes

					has_ROOT_bank_society_prerequisites = yes
					OR = {
						is_in_society = no
						AND = {
							same_society_as = ROOT
							society_rank < 3
						}
					}
					NOT = { character = event_target:demanding_bank_shares }
					NOT = { character = event_target:current_bank_share_heir }
				}
				opinion = { who = ROOT modifier = opinion_likes_bank_share_split months = 120 }
			}
		}
		if = { #If not sole shareholder, this is NOT expected
			limit = {
				society = {
					any_society_member = {
						society_rank > 2
						NOT = { character = ROOT }
					}
				}
			}
			detract_society_currency_medium_effect = yes
		}
		event_target:demanding_bank_shares = {
			opinion = { who = ROOT modifier = opinion_likes_bank_share_split multiplier = 2 months = 120 }
			show_portrait = THIS
		}
		event_target:current_bank_share_heir = {
			opinion = { who = ROOT modifier = opinion_dislikes_bank_share_split months = 120 }
			show_portrait = THIS
		}
	}

	option = {
		name = "EVTOPTBbankruptcy.200"
		custom_tooltip = {
			text = TOOLTIPbankruptcy.200B
			any_dynasty_member = {
				limit = {
					NOT = { character = ROOT }
					is_close_relative = ROOT
					is_alive = yes

					has_ROOT_bank_society_prerequisites = yes
					OR = {
						is_in_society = no
						AND = {
							same_society_as = ROOT
							society_rank < 3
						}
					}
					NOT = { character = event_target:demanding_bank_shares }
					NOT = { character = event_target:current_bank_share_heir }
				}
				opinion = { who = ROOT modifier = opinion_refused_bank_share_split months = 120 }
			}
		}
		if = { #If sole shareholder, this is expected
			limit = {
				society = {
					NOT = {
						any_society_member = {
							society_rank > 2
							NOT = { character = ROOT }
						}
					}
				}
			}
			prestige = -150
			detract_society_currency_major_effect = yes
		}
		event_target:demanding_bank_shares = {
			opinion = { who = ROOT modifier = opinion_refused_bank_share_split multiplier = 2 months = 120 }
		}
		event_target:current_bank_share_heir = {
			opinion = { who = ROOT modifier = opinion_defended_bank_share_split months = 120 }
		}
	}
}

#Envoy offers to take artifact to pay off debt
letter_event = {
	id = bankruptcy.220
	border = GFX_event_letter_frame_economy

	is_triggered_only = yes

	desc = {
		text = EVTDESCbankruptcy.220
		trigger = { NOT = { has_character_flag = offended_moneylenders } }
	}
	desc = {
		text = EVTDESCbankruptcy.220B
		trigger = {
			has_character_flag = offended_moneylenders
			NOT = { has_character_flag = looted_bank }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.220C
		trigger = {
			has_character_flag = offended_moneylenders
			has_character_flag = looted_bank
		}
	}

	immediate = {
		calculate_loan_repayable_effect = yes
	}

	option = {
		name = EVTOPTAbankruptcy.220 #Agree
		ai_chance = {
			factor = 75

			modifier = {
				factor = 0.25
				event_target:artifact_debt = {
					OR = {
						has_artifact_flag = title_heirloom_@ROOT
						any_artifact_owner = {
							dynasty = ROOT
							is_lowborn = no
							#event_target:artifact_debt = { has_artifact_flag = heirloom_@PREV }
						}
					}
				}
			}
			modifier = {
				factor = 0.33
				event_target:artifact_debt = { quality > 3 }
			}
			modifier = {
				factor = 0.5
				event_target:artifact_debt = { quality == 3 }
			}
			modifier = {
				factor = 1.25
				event_target:artifact_debt = { quality == 1 }
			}
			modifier = {
				factor = 1.5
				event_target:artifact_debt = { has_artifact_flag = book }
			}

			modifier = {
				factor = 0.2
				has_character_flag = offended_moneylenders
				has_character_flag = looted_bank
			}
			modifier = {
				factor = 2
				FROM = { society_influence = 3 }
			}
			modifier = {
				factor = 2
				FROM = { society_influence = 5 }
			}
			modifier = {
				factor = 2
				trait = content
			}
			modifier = {
				factor = 2
				trait = charitable
			}
			modifier = {
				factor = 2
				trait = humble
			}
			modifier = {
				factor = 2
				trait = patient
			}
			modifier = {
				factor = 2
				trait = honorable
			}
			modifier = {
				factor = 4
				trait = just
			}
		}
		custom_tooltip = {
			text = TOOLTIPbankruptcy.220A
			clr_character_flag = loan_default
			set_variable = { which = success_bonus which = loan_amount } #envoy gets 5% commission

			if = {
				limit = { NOT = { has_character_flag = offended_moneylenders } }
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_total_repayable }
						set_variable = { which = outstanding_loans which = loan_amount }
						multiply_variable = { which = outstanding_loans value = -1 }
						set_variable = { which = loan_profits which = loan_interest_payable }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = outstanding_loans which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
			}
			else = {
				#Adjust bank's records
				persistent_event_target:loan_bank = {
					ROOT = {
						set_variable = { which = cash_reserve which = loan_total_repayable }
						set_variable = { which = loan_losses which = loan_amount }
						multiply_variable = { which = loan_losses value = -1 }
						set_variable = { which = loan_profits which = loan_amount }
						multiply_variable = { which = loan_profits which = loan_interest }
					}
					change_variable = { which = cash_reserve which = ROOT }
					change_variable = { which = loan_losses which = ROOT }
					change_variable = { which = loan_profits which = ROOT }
				}
			}
			clear_loan_flags_and_variables_effect = yes
		}

		FROM = { character_event = { id = bankruptcy.221 } }
	}
	option = {
		name = EVTOPTBbankruptcy.220 #Reject
		ai_chance = {
			factor = 50

			modifier = {
				factor = 2
				FROM = { NOT = { society_influence = 1 } }
			}
			modifier = {
				factor = 2
				trait = ambitious
			}
			modifier = {
				factor = 2
				trait = greedy
			}
			modifier = {
				factor = 2
				trait = proud
			}
			modifier = {
				factor = 2
				trait = wroth
			}
			modifier = {
				factor = 4
				trait = arbitrary
			}
			modifier = {
				factor = 4
				trait = ruthless
			}
		}
		FROM = {
			character_event = { id = bankruptcy.222 }
		}
	}
}
character_event = { #Inform envoy compromise reached
	id = bankruptcy.221
	desc = EVTDESCbankruptcy.221
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	immediate = {
		FROM = {
			#envoy gets 5% commission
			ROOT = {
				set_variable = { which = success_bonus which = PREV }
				multiply_variable = { which = success_bonus value = 0.05 }
			}
			set_variable = { which = success_bonus value = 0 }
		}
		event_target:artifact_debt = {
			#Get Value
			ROOT = { set_variable = { which = artifact_value value = 0 } }
			if = {
				limit = { quality == 1 }
				ROOT = { set_variable = { which = artifact_value value = 40 } }
			}
			else_if = {
				limit = { quality == 2 }
				ROOT = { set_variable = { which = artifact_value value = 80 } }
			}
			else_if = {
				limit = { quality == 3 }
				ROOT = { set_variable = { which = artifact_value value = 160 } }
			}
			else_if = {
				limit = { quality == 4 }
				ROOT = { set_variable = { which = artifact_value value = 320 } }
			}
			else_if = {
				limit = {
					OR = {
						quality == 5
						quality > 5
					}
				}
				ROOT = { set_variable = { which = artifact_value value = 640 } }
			}
			if = { #books are cheaper
				limit = { has_artifact_flag = book }
				ROOT = { divide_variable = { which = artifact_value value = 2 } }
			}
			if = { #valyrian steel is more expensive (500)
				limit = { has_artifact_flag = valyrian_steel }
				ROOT = { multiply_variable = { which = artifact_value value = 1.5625 } }
			}
			if = { #valyrian armour is more expensive (1000)
				limit = { has_artifact_flag = valyrian_armour }
				ROOT = { set_variable = { which = artifact_value value = 1000 } }
			}
			ROOT = {
				set_variable = { which = artifact_value_negative which = artifact_value }
				multiply_variable = { which = artifact_value_negative value = -1 }
			}
			clr_artifact_flag = title_heirloom_@ROOT
			any_artifact_owner = {
				limit = {
					dynasty = FROM
					NOT = { character = FROM }
					is_lowborn = no
					#event_target:artifact_debt = { has_artifact_flag = heirloom_@PREV }
				}
				event_target:artifact_debt = { clr_artifact_flag = heirloom_@PREV }
			}
		}
		FROM = {
			any_demesne_title = {
				limit = {
					higher_tier_than = DUKE
					event_target:artifact_debt = { has_artifact_flag = heirloom_@PREV }
				}
				event_target:artifact_debt = { clr_artifact_flag = heirloom_@PREV }
			}
		}
	}

	option = {
		name = EVTOPTAbankruptcy.221
		event_target:artifact_debt = {
			if = {
				limit = {
					is_indestructible = no
					quality < 3
				}
				destroy_artifact = yes
			}
			else = {
				random_playable_ruler = {
					limit = {
						ai = yes
						has_regent = no
						is_within_diplo_range = ROOT
						NOT = { character = ROOT_FROM }
						opinion = { who = ROOT value = -25 }
						reverse_opinion = { who = ROOT value = -25 }
						OR = {
							wealth = 640
							monthly_income = 15
							AND = {
								OR = {
									wealth = 500
									monthly_income = 10
								}
								ROOT = { NOT = { check_variable = { which = artifact_value value = 550 } } }
							}
							AND = {
								OR = {
									wealth = 320
									monthly_income = 8
								}
								ROOT = { NOT = { check_variable = { which = artifact_value value = 350 } } }
							}
							AND = {
								OR = {
									wealth = 160
									monthly_income = 5
								}
								ROOT = { NOT = { check_variable = { which = artifact_value value = 200 } } }
							}
							AND = {
								wealth = 80
								ROOT = { NOT = { check_variable = { which = artifact_value value = 100 } } }
							}
							AND = {
								wealth = 40
								ROOT = { NOT = { check_variable = { which = artifact_value value = 50 } } }
							}
						}
						NOT = { has_character_flag = loan_taken }
						NOT = { has_character_modifier = loan_timer }
						NOT = { has_character_flag = offended_moneylenders }
						war = no
						is_nomadic = no
						NOT = { trait = wildling }
						can_press_claims_trigger = yes
						NOT = { is_inaccessible_trigger = yes }
						NOT_mythical_creature_trigger = yes
						NOT = { trait = temperate }

						event_target:artifact_debt = { artifact_can_be_gifted_to = PREV }
						trigger_if = {
							limit = {
								event_target:artifact_debt = {
									has_artifact_flag = combat_weapon
									NOT = { has_artifact_flag = valyrian_steel }
								}
							}
							NOT = {
								any_artifact = {
									has_artifact_flag = combat_weapon
									quality >= event_target:artifact_debt
								}
							}
						}
						trigger_if = {
							limit = { event_target:artifact_debt = { has_artifact_flag = flagship } }
							OR = {
								tier = EMPEROR
								AND = {
									independent = yes
									tier = KING
									primary_title = { NOT = { check_variable = { which = "de_facto_empire" value = 1 } } }
								}
								is_patrician = yes
								trait = pirate
								is_seafarer = yes
							}
							NOT = {
								any_artifact = {
									has_artifact_flag = flagship
									quality >= event_target:artifact_debt
								}
							}
						}
						trigger_if = {
							limit = { event_target:artifact_debt = { has_artifact_flag = armor } }
							NOT = {
								any_artifact = {
									has_artifact_flag = armor
									quality >= event_target:artifact_debt
								}
							}
						}
						trigger_if = {
							limit = { event_target:artifact_debt = { has_artifact_flag = ceremonial_weapon } }
							NOT = {
								any_artifact = {
									has_artifact_flag = ceremonial_weapon
									quality >= event_target:artifact_debt
								}
							}
						}
						trigger_if = {
							limit = { event_target:artifact_debt = { has_artifact_flag = crown_jewel } }
							OR = {
								is_feudal_monarch_trigger = yes
								trait = proud
							}
							NOT = {
								any_artifact = {
									has_artifact_flag = crown_jewel
									quality > event_target:artifact_debt
								}
							}
						}
						OR = {
							event_target:artifact_debt = { NOT = { has_artifact_flag = book } }
							event_target:artifact_debt = { quality > 1 }
							can_use_book_trigger = yes
						}
					}
					show_portrait = THIS
					custom_tooltip = {
						text = TOOLTIPbankruptcy.221B
						event_target:artifact_debt = {
							transfer_artifact = { from = FROM to = PREV }
						}
						set_variable = { which = artifact_value_negative which = ROOT }
						wealth = artifact_value_negative
						set_variable = { which = artifact_value_negative value = 0 }
					}
					break = yes
				}
				custom_tooltip = {
					text = TOOLTIPbankruptcy.221C
					ROOT = {
						capital_scope = {
							create_random_steward = {
								random_traits = yes
								dynasty = none
								female = no
								culture = PREV
								religion = PREV
								historical = yes
							}
							new_character = {
								set_immune_to_pruning = yes
								wealth = 50
								remove_trait = imbecile
								remove_trait = imbecile_1
								remove_trait = slow
								remove_trait = slow_1
								remove_trait = inbred
								remove_trait = infirm
								remove_trait = incapable
								remove_trait = leper
								remove_trait = possessed
								remove_trait = ill
								remove_trait = pneumonic
								remove_trait = maimed
								remove_lifestyle_trait_effect = yes
								random_list = { # Flavor Randomization
									35 = {
										# Nothing
									}
									15 = {
										change_stewardship = 2
									}
									10 = {
										add_trait = gardener
									}
									10 = {
										add_trait = architect
									}
									10 = {
										add_trait = administrator
									}
									10 = {
										change_stewardship = 4
									}
									5 = {
										change_stewardship = 6
									}
									5 = {
										trigger = {
											is_smart_incl_genius_trigger = no
										}
										add_trait = shrewd
									}
								}
								if = {
									limit = {
										culture_group = hyrkoon_group
									}
									add_trait = eunuch
								}
								while = {
									limit = { stewardship < 10 }
									change_stewardship = 1
								}
								random_list = {
									10 = { add_trait = trained_warrior }
									30 = { add_trait = poor_warrior }
									60 = { }
								}
								event_target:artifact_debt = {
									transfer_artifact = { from = FROM to = PREV }
								}
							}
						}
					}

				}
			}
		}
	}
	option = { #Buy the seized artifact
		name = EVTOPTBbankruptcy.221
		trigger = {
			event_target:artifact_debt = { always = yes }
			wealth = artifact_value
		}
		event_target:artifact_debt = {
			transfer_artifact = { from = FROM to = ROOT }
		}
		wealth = artifact_value_negative
	}

	after = {
		wealth = success_bonus
		if = {
			limit = { has_quest = quest_bank_recover_debt }
			add_society_currency_medium_effect = yes
			add_mission_succeed_influence_effect = yes
		}
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				society = {
					set_variable = { which = success_bonus which = ROOT }
					multiply_variable = { which = success_bonus value = -1 }
					change_variable = { which = cash_reserve which = success_bonus }
					change_variable = { which = expenses which = success_bonus }
					set_variable = { which = success_bonus value = 0 }
				}
				clr_quest = quest_bank_recover_debt
			}
			clr_character_flag = quest_bank_recover_debt_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_TOP_LIEGE_LETTER
			clr_character_flag = quest_bank_recover_debt_DELEGATION
			clr_character_flag = quest_bank_recover_debt_ASSASSIN
			clr_character_flag = quest_bank_recover_debt_ENEMY_LOAN
			clr_character_flag = quest_bank_recover_debt_FUNDING_ENEMY
			clr_character_flag = quest_bank_recover_debt_HEAVIES
			clr_character_flag = quest_bank_recover_debt_ARTIFACT
			set_variable = { which = success_bonus value = 0 }
			set_variable = { which = artifact_value_negative value = 0 }
			set_variable = { which = artifact_value value = 0 }

			FROM = {
				set_variable = { which = cash_reserve value = 0 }
			}
		}
	}
}
character_event = { #Inform envoy rejected
	id = bankruptcy.222
	desc = EVTDESCbankruptcy.222
	border = GFX_event_normal_frame_economy

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.222
		hidden_tooltip = {
			if = {
				limit = { has_quest = quest_bank_recover_debt }
				character_event = { id = bankruptcy.48 days = 7 }
			}
			else = {
				FROM = { character_event = { id = bankruptcy.96 days = 7 } } #minor bank, scope back to debtor
			}
		}
	}
}

#Random bank prosperity
character_event = {
	id = bankruptcy.230

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_society_grandmaster = yes
		society = {
			has_flag = bank_society
			NOT = {
				persistent_event_target:location = {
					NOR = { #no chance if under siege/occupied/diseased
						any_province_holding = {
							has_siege = yes
						}
						any_province_holding = {
							is_occupied = yes
						}
						has_disease = yes
					}
				}
			}
		}
	}

	weight_multiplier = {
		factor = 1

		modifier = {
			factor = 0.5
			has_regent = yes
		}
		modifier = {
			factor = 0.57
			stewardship < 2
		}
		modifier = {
			factor = 0.57
			stewardship < 6
		}
		modifier = {
			factor = 1.75
			stewardship = 10
		}
		modifier = {
			factor = 1.75
			stewardship = 14
		}
		modifier = {
			factor = 1.75
			stewardship = 18
		}
		modifier = {
			factor = 1.75
			stewardship = 22
		}

		modifier = {
			factor = 2.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = prosperity_modifier_3
				}
			}
		}
		modifier = {
			factor = 2
			society = {
				persistent_event_target:location = {
					has_province_modifier = prosperity_modifier_2
				}
			}
		}
		modifier = {
			factor = 1.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = prosperity_modifier_1
				}
			}
		}
		modifier = {
			factor = 0.4
			society = {
				persistent_event_target:location = {
					has_province_modifier = depopulated_3
				}
			}
		}
		modifier = {
			factor = 0.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = depopulated_2
				}
			}
		}
		modifier = {
			factor = 0.66
			society = {
				persistent_event_target:location = {
					has_province_modifier = depopulated_1
				}
			}
		}

		modifier = {
			factor = 0.7 #slightly lower chance if helping in a war
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							AND = {
								NOR = {
									is_primary_war_defender = yes
									is_primary_war_attacker = yes
								}
								any_war = { always = yes }
							}
							any_liege = {
								NOR = {
									is_primary_war_defender = yes
									is_primary_war_attacker = yes
								}
								any_war = { always = yes }
							}
						}
					}
				}
			}
		}
		modifier = {
			factor = 0.5 #low chance if defending in a war
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							AND = {
								is_primary_war_defender = yes
								NOT = { is_primary_war_attacker = yes }
							}
							any_liege = {
								is_primary_war_defender = yes
								NOT = { is_primary_war_attacker = yes }
							}
						}
					}
				}
			}
		}
		modifier = {
			factor = 0.2 #very low chance if attacking in a war
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							is_primary_war_attacker = yes
							any_liege = {
								is_primary_war_attacker = yes
							}
						}
					}
				}
			}
		}
		modifier = {
			factor = 0.5
			is_winter_trigger = yes
		}
		modifier = {
			factor = 0.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = asoiaf_mild_winter
				}
			}
		}
		modifier = {
			factor = 0.25
			society = {
				persistent_event_target:location = {
					has_province_modifier = asoiaf_normal_winter
				}
			}
		}
		modifier = {
			factor = 0.1
			society = {
				persistent_event_target:location = {
					has_province_modifier = asoiaf_harsh_winter
				}
			}
		}
		modifier = {
			factor = 1.5
			society = {
				persistent_event_target:location = {
					NOT = { revolt_risk = 0.01 }
				}
			}
		}
		modifier = {
			factor = 0.5
			society = {
				persistent_event_target:location = {
					OR = {
						has_province_modifier = incompetent_rule
						has_province_modifier = thieves_guild
						has_province_modifier = smugglers_ring
						has_province_modifier = highway_robber_band
						has_province_modifier = heretic_stronghold
						has_province_modifier = religious_tension
						has_province_modifier = temple_corruption
						has_province_modifier = local_death_cult
						has_province_modifier = extra_tax
						has_province_modifier = africa_drought_risk
						has_province_modifier = africa_drought
					}
				}
			}
		}
	}

	immediate = {
		society = { #hide actual effect in this hidden event for grand master. Player members get informed subsequently
			if = {
				limit = { check_variable = { which = bank_value value = 10000 } }
				change_variable = { which = cash_reserve value = 750 }
				hidden_tooltip = { change_variable = { which = investment_profits value = 750 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 7500 } }
				change_variable = { which = cash_reserve value = 700 }
				hidden_tooltip = { change_variable = { which = investment_profits value = 700 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 5000 } }
				change_variable = { which = cash_reserve value = 600 }
				hidden_tooltip = { change_variable = { which = investment_profits value = 600 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 3500 } }
				change_variable = { which = cash_reserve value = 500 }
				hidden_tooltip = { change_variable = { which = investment_profits value = 500 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 2000 } }
				change_variable = { which = cash_reserve value = 400 }
				hidden_tooltip = { change_variable = { which = investment_profits value = 400 } }
			}
			else = {
				change_variable = { which = cash_reserve value = 200 }
				hidden_tooltip = { change_variable = { which = investment_profits value = 200 } }
			}
			persistent_event_target:location = {
				save_event_target_as = bank_location
			}
			any_society_member = {
				limit = {
					ai = no
				}
				character_event = { id = bankruptcy.231 }
			}
		}

	}

	option = {
		name = OK
	}
}
character_event = {
	id = bankruptcy.231
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	desc = {
		text = EVTDESCbankruptcy.231A
	}
	desc = {
		text = EVTDESCbankruptcy.231B #Leadership
		picture = GFX_evt_relaxed_ruler
		trigger = {
			FROM = { stewardship = 14 }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.231C #Prosperity
		picture = GFX_evt_busy_trading_dock_republic
		trigger = {
			society = {
				persistent_event_target:location = {
					OR = {
						has_province_modifier = prosperity_modifier_2
						has_province_modifier = prosperity_modifier_3
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.231D #Peace
		picture = GFX_evt_prospering_province
		trigger = {
			is_winter_trigger = no
			society = {
				persistent_event_target:location = {
					NOT = { revolt_risk = 0.01 }
					owner = {
						war = no
						NOT = { any_liege = { war = yes } }
					}
					NOR = {
						has_province_modifier = incompetent_rule
						has_province_modifier = thieves_guild
						has_province_modifier = smugglers_ring
						has_province_modifier = highway_robber_band
						has_province_modifier = heretic_stronghold
						has_province_modifier = religious_tension
						has_province_modifier = temple_corruption
						has_province_modifier = local_death_cult
						has_province_modifier = extra_tax
						has_province_modifier = africa_drought_risk
						has_province_modifier = africa_drought
					}
				}
			}
		}
	}

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.231
		tooltip = {
			society = {
				if = {
					limit = { check_variable = { which = bank_value value = 10000 } }
					change_variable = { which = cash_reserve value = 750 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 7500 } }
					change_variable = { which = cash_reserve value = 700 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 5000 } }
					change_variable = { which = cash_reserve value = 600 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 3500 } }
					change_variable = { which = cash_reserve value = 500 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 2000 } }
					change_variable = { which = cash_reserve value = 400 }
				}
				else = {
					change_variable = { which = cash_reserve value = 200 }
				}
			}
		}
	}
}
#Random bank struggle
character_event = {
	id = bankruptcy.232

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		is_society_grandmaster = yes
		society = {
			has_flag = bank_society
		}
	}

	weight_multiplier = {
		factor = 1

		modifier = {
			factor = 4
			society = {
				persistent_event_target:location = {
					OR = {
						any_province_holding = {
							has_siege = yes
						}
						any_province_holding = {
							is_occupied = yes
						}
					}
				}
			}
		}
		modifier = {
			factor = 4
			society = {
				persistent_event_target:location = {
					has_disease = yes
				}
			}
		}

		modifier = {
			factor = 2
			has_regent = yes
		}
		modifier = {
			factor = 1.75
			stewardship < 2
		}
		modifier = {
			factor = 1.75
			stewardship < 6
		}
		modifier = {
			factor = 0.66
			stewardship = 10
		}
		modifier = {
			factor = 0.66
			stewardship = 14
		}
		modifier = {
			factor = 0.66
			stewardship = 18
		}
		modifier = {
			factor = 0.66
			stewardship = 22
		}

		modifier = {
			factor = 0.4
			society = {
				persistent_event_target:location = {
					has_province_modifier = prosperity_modifier_3
				}
			}
		}
		modifier = {
			factor = 0.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = prosperity_modifier_2
				}
			}
		}
		modifier = {
			factor = 0.66
			society = {
				persistent_event_target:location = {
					has_province_modifier = prosperity_modifier_1
				}
			}
		}
		modifier = {
			factor = 2.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = depopulated_3
				}
			}
		}
		modifier = {
			factor = 2
			society = {
				persistent_event_target:location = {
					has_province_modifier = depopulated_2
				}
			}
		}
		modifier = {
			factor = 1.5
			society = {
				persistent_event_target:location = {
					has_province_modifier = depopulated_1
				}
			}
		}

		modifier = {
			factor = 1.5 #slightly lower chance if helping in a war
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							AND = {
								NOR = {
									is_primary_war_defender = yes
									is_primary_war_attacker = yes
								}
								any_war = { always = yes }
							}
							any_liege = {
								NOR = {
									is_primary_war_defender = yes
									is_primary_war_attacker = yes
								}
								any_war = { always = yes }
							}
						}
					}
				}
			}
		}
		modifier = {
			factor = 2 #low chance if defending in a war
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							AND = {
								is_primary_war_defender = yes
								NOT = { is_primary_war_attacker = yes }
							}
							any_liege = {
								is_primary_war_defender = yes
								NOT = { is_primary_war_attacker = yes }
							}
						}
					}
				}
			}
		}
		modifier = {
			factor = 5 #very low chance if attacking in a war
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							is_primary_war_attacker = yes
							any_liege = {
								is_primary_war_attacker = yes
							}
						}
					}
				}
			}
		}
		modifier = {
			factor = 2
			is_winter_trigger = yes
		}
		modifier = {
			factor = 2
			society = {
				persistent_event_target:location = {
					has_province_modifier = asoiaf_mild_winter
				}
			}
		}
		modifier = {
			factor = 3
			society = {
				persistent_event_target:location = {
					has_province_modifier = asoiaf_normal_winter
				}
			}
		}
		modifier = {
			factor = 4
			society = {
				persistent_event_target:location = {
					has_province_modifier = asoiaf_harsh_winter
				}
			}
		}
		modifier = {
			factor = 0.66
			society = {
				persistent_event_target:location = {
					NOT = { revolt_risk = 0.01 }
				}
			}
		}
		modifier = {
			factor = 2
			society = {
				persistent_event_target:location = {
					OR = {
						has_province_modifier = incompetent_rule
						has_province_modifier = thieves_guild
						has_province_modifier = smugglers_ring
						has_province_modifier = highway_robber_band
						has_province_modifier = heretic_stronghold
						has_province_modifier = religious_tension
						has_province_modifier = temple_corruption
						has_province_modifier = local_death_cult
						has_province_modifier = extra_tax
						has_province_modifier = africa_drought_risk
						has_province_modifier = africa_drought
					}
				}
			}
		}
	}

	immediate = {
		society = { #hide actual effect in this hidden event for grand master. Player members get informed subsequently
			if = {
				limit = { check_variable = { which = bank_value value = 10000 } }
				change_variable = { which = cash_reserve value = -750 }
				hidden_tooltip = { change_variable = { which = investment_profits value = -750 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 7500 } }
				change_variable = { which = cash_reserve value = -700 }
				hidden_tooltip = { change_variable = { which = investment_profits value = -700 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 5000 } }
				change_variable = { which = cash_reserve value = -600 }
				hidden_tooltip = { change_variable = { which = investment_profits value = -600 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 3500 } }
				change_variable = { which = cash_reserve value = -500 }
				hidden_tooltip = { change_variable = { which = investment_profits value = -500 } }
			}
			else_if = {
				limit = { check_variable = { which = bank_value value = 2000 } }
				change_variable = { which = cash_reserve value = -400 }
				hidden_tooltip = { change_variable = { which = investment_profits value = -400 } }
			}
			else = {
				change_variable = { which = cash_reserve value = -200 }
				hidden_tooltip = { change_variable = { which = investment_profits value = -200 } }
			}
			persistent_event_target:location = {
				save_event_target_as = bank_location
			}
			any_society_member = {
				limit = {
					ai = no
				}
				character_event = { id = bankruptcy.233 }
			}
		}
	}

	option = {
		name = OK
	}
}
character_event = {
	id = bankruptcy.233
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	desc = {
		text = EVTDESCbankruptcy.233A
		picture = GFX_evt_bad_news
	}
	desc = {
		text = EVTDESCbankruptcy.233B #siege
		picture = GFX_evt_siege
		trigger = {
			society = {
				persistent_event_target:location = {
					OR = {
						any_province_holding = {
							has_siege = yes
						}
						any_province_holding = {
							is_occupied = yes
						}
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.233C #disease
		picture = GFX_evt_bring_out_your_dead
		trigger = {
			society = {
				persistent_event_target:location = {
					has_disease = yes
				}
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.233D #leadership
		picture = GFX_evt_stressed_ruler
		trigger = {
			FROM = { stewardship < 6 }
		}
	}
	desc = {
		text = EVTDESCbankruptcy.233E #depopulation
		picture = GFX_evt_depopulated_town
		trigger = {
			society = {
				persistent_event_target:location = {
					OR = {
						has_province_modifier = depopulated_3
						has_province_modifier = depopulated_2
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.233F #war
		picture = GFX_evt_merchant_ship_at_sea_republic
		trigger = {
			society = {
				persistent_event_target:location = {
					owner = {
						OR = {
							any_war = { always = yes }
							any_liege = { any_war = { always = yes } }
						}
					}
				}
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.233G #winter
		picture = GFX_winter_2
		trigger = {
			is_winter_trigger = yes
		}
	}
	desc = {
		text = EVTDESCbankruptcy.233H #unrest
		picture = GFX_evt_peasants
		trigger = {
			society = {
				persistent_event_target:location = {
					OR = {
						has_province_modifier = incompetent_rule
						has_province_modifier = thieves_guild
						has_province_modifier = smugglers_ring
						has_province_modifier = highway_robber_band
						has_province_modifier = heretic_stronghold
						has_province_modifier = religious_tension
						has_province_modifier = temple_corruption
						has_province_modifier = local_death_cult
						has_province_modifier = extra_tax
						has_province_modifier = africa_drought_risk
						has_province_modifier = africa_drought
					}
				}
			}
		}
	}

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.233
		tooltip = {
			society = {
				if = {
					limit = { check_variable = { which = bank_value value = 10000 } }
					change_variable = { which = cash_reserve value = -750 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 7500 } }
					change_variable = { which = cash_reserve value = -700 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 5000 } }
					change_variable = { which = cash_reserve value = -600 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 3500 } }
					change_variable = { which = cash_reserve value = -500 }
				}
				else_if = {
					limit = { check_variable = { which = bank_value value = 2000 } }
					change_variable = { which = cash_reserve value = -400 }
				}
				else = {
					change_variable = { which = cash_reserve value = -200 }
				}
			}
		}
	}
}
#Set interest strategy
character_event = {
	id = bankruptcy.240
	picture = GFX_bank
	border = GFX_event_normal_frame_economy

	desc = {
		text = EVTDESCbankruptcy.240A
		trigger = { society = { has_flag = interest_strategy_high } }
	}
	desc = {
		text = EVTDESCbankruptcy.240B
		trigger = {
			society = {
				NOT = { has_flag = interest_strategy_high }
				NOT = { has_flag = interest_strategy_low }
			}
		}
	}
	desc = {
		text = EVTDESCbankruptcy.240C
		trigger = { society = { has_flag = interest_strategy_low } }
	}

	is_triggered_only = yes

	option = {
		name = EVTOPTAbankruptcy.240 #High
		ai_chance = {
			factor = 5
			modifier = {
				factor = 3
				trait = greedy
			}
			modifier = { #unpredictable
				factor = 4
				OR = {
					trait = lunatic
					stewardship < 4
				}
			}
			modifier = { #no competitors
				factor = 20
				NOT = {
					any_society_member = {
						is_society_grandmaster = yes
						society = { has_flag = bank_society }
						NOT = { character = ROOT }
					}
				}
			}
			modifier = { #competitor has high rate
				factor = 4
				any_society_member = {
					is_society_grandmaster = yes
					society = {
						has_flag = bank_society
						has_flag = interest_strategy_high
					}
					NOT = { character = ROOT }
				}
			}
			modifier = { #competitor has low rate
				factor = 0.5
				any_society_member = {
					is_society_grandmaster = yes
					society = {
						has_flag = bank_society
						has_flag = interest_strategy_low
					}
					NOT = { character = ROOT }
				}
			}
			modifier = { #can afford to be greedy
				factor = 2
				society = {
					check_variable = { which = cash_reserve value = 5000 }
				}
			}
			modifier = { #cant afford to be greedy
				factor = 0.5
				society = {
					NOT = { check_variable = { which = cash_reserve value = 1500 } }
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPinterest_strategy_high
			society = {
				set_flag = interest_strategy_high
				clr_flag = interest_strategy_low
			}
		}
		if = { #find other bank strategies
			limit = { ai = no }
			any_society_member = {
				limit = {
					is_society_grandmaster = yes
					society = { has_flag = bank_society }
					NOT = { character = ROOT }
				}
				show_scope_change = no
				if = {
					limit = { society = { has_flag = interest_strategy_high } }
					custom_tooltip = {
						text = TOOLTIPinterest_strategy_high_CURRENT
					}
				}
				else_if = {
					limit = { society = { has_flag = interest_strategy_low } }
					custom_tooltip = {
						text = TOOLTIPinterest_strategy_high_LOW
					}
				}
				else = {
					custom_tooltip = {
						text = TOOLTIPinterest_strategy_high_NORMAL
					}
				}
			}
		}
	}
	option = {
		name = EVTOPTBbankruptcy.240 #Normal
		ai_chance = {
			factor = 30
		}
		custom_tooltip = {
			text = TOOLTIPinterest_strategy_normal
			society = {
				clr_flag = interest_strategy_high
				clr_flag = interest_strategy_low
			}
		}
	}
	option = {
		name = EVTOPTCbankruptcy.240 #Low
		ai_chance = {
			factor = 10

			modifier = {
				factor = 3
				trait = charitable
			}

			modifier = { #unpredictable
				factor = 3
				OR = {
					trait = lunatic
					stewardship < 4
				}
			}
			modifier = { #competitor has low rate
				factor = 3
				any_society_member = {
					is_society_grandmaster = yes
					society = {
						has_flag = bank_society
						has_flag = interest_strategy_low
					}
					NOT = { character = ROOT }
				}
			}
			modifier = { #can afford to be greedy
				factor = 0.5
				society = {
					check_variable = { which = cash_reserve value = 5000 }
				}
			}
			modifier = { #cant afford to be greedy
				factor = 2
				society = {
					NOT = { check_variable = { which = cash_reserve value = 1500 } }
				}
			}
		}
		custom_tooltip = {
			text = TOOLTIPinterest_strategy_low
			society = {
				clr_flag = interest_strategy_high
				set_flag = interest_strategy_low
			}
		}
	}
}